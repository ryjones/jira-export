<Issue id="45017" key="FABN-1554" number="1554" project="10604" reporter="thienbuinguyen" assignee="davidkel" creator="thienbuinguyen" type="10004" summary="Incorrect HSM Slot Check" priority="4" resolution="10000" status="6" created="2020-05-08 04:49:12.0" updated="2021-06-29 09:04:33.0" resolutiondate="2021-06-29 09:04:33.0" votes="0" watches="2" workflowId="58923" archived="N"> <description><! CDATA For HSM integration, the slot number that must be supplied to the _HsmX509Provider_ is incorrectly the index of a slot rather the actual slot ID.   In particular, when a token is initialised on a slot with SoftHSM2, it is given a randomised ID (e.g. 2013651327). Passing this ID to _HsmX509Provider_ will not work since an incorrect check is performed on  line 294 of fabric-common/lib/impl/bccsp_pkcs11.js| https://github.com/hyperledger/fabric-sdk-node/blob/v2.1.0/fabric-common/lib/impl/bccsp_pkcs11.js#L294   that treats the slot as an index rather than the ID. This results in a "PKCS11 slot number non-exist" error even when a slot with that ID does exist.  This is unexpected since order of initialising the slot does not guarantee their order in the slots array. Either the token's label should be given to _HsmX509Provider_ rather than the slot number (which is how HSM integration works with the _fabric_ and _fabric-ca_ repositories) or the correct slot ID should be used. The code in _bccsp_pkcs11_ should then resolve the correct slot by going through each slot and comparing it's label or ID.  ></description> </Issue>
