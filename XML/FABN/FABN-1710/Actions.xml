<Action id="71701" issue="46708" author="JIRAUSER21810" type="comment" created="2021-04-23 04:19:06.0" updateauthor="JIRAUSER21810" updated="2021-04-23 04:19:06.0"> <body><! CDATA We also faced the same problem when using SoftHSM.  In addition to the reported one, we found an another problem on persistence. In the current implementation, HSMX509IdentityProvider assumes a private key in a wallet as an object handle, which however is not necessarily persistent across sessions according to PKCS#11 specification. Because of this, we cannot access to keys in SoftHSM token in a newly established PKCS session.  We believe that what should be stored in wallets are not object handles, but subject key identifiers (ski). As a quick fix, we put a ski into a wallet, {code:javascript} // enroll as usual const enrollmentResults = await hsmCAClient.enroll(options); // from the enrollment results get the info to save const identity: HsmX509Identity = { credentials: { certificate: enrollmentResults.certificate, -            privateKey: enrollmentResults.key.toBytes() +            privateKey: enrollmentResults.key.toSKI() }, mspId: 'org1', type: 'HSM-X.509' }; await wallet.put('bob', identity); {code} and made following modification in hsmx509identity.js, so that the provider can reacquires an object handle to the key in HSM token on the PKCS session by looking up with ski. {code:javascript} @@ -85,10 +85,11 @@ class HsmX509Provider { } const user = new fabric_common_1.User(name); user.setCryptoSuite(this.cryptoSuite); -        const handle = Buffer.from(identity.credentials.privateKey, 'hex'); +        const ski = Buffer.from(identity.credentials.privateKey, 'hex'); +        const handle = Buffer.from((await this.cryptoSuite.getKey(ski)).getHandle(), 'hex'); const privateKey = new fabric_common_1.Pkcs11EcdsaKey({ priv: handle }, this.cryptoSuite.getKeySize()); await user.setEnrollment(privateKey, identity.credentials.certificate, identity.mspId); return user; } } {code} We confirmed this enables the persisted key to being accessible across PKCS#11 sessions.  ></body> </Action>
<Action id="71716" issue="46708" author="JIRAUSER21681" type="comment" created="2021-04-25 10:26:23.0" updateauthor="JIRAUSER21681" updated="2021-04-25 10:26:23.0"> <body><! CDATA Hi  ~rkojima ,  Yes, I can confirm your fix works for me. Thanks.  ></body> </Action>
<Action id="71722" issue="46708" author="JIRAUSER21681" type="comment" body="I created a merge request for this -Â https://github.com/hyperledger/fabric-sdk-node/pull/450" created="2021-04-26 14:15:50.0" updateauthor="JIRAUSER21681" updated="2021-04-26 14:15:50.0"/>
