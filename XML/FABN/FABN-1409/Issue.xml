<Issue id="42987" key="FABN-1409" number="1409" project="10604" reporter="dongming" creator="dongming" type="10004" summary="Invokes fail when using service discovery layout, old lifecycle" priority="3" resolution="10204" status="6" created="2019-10-24 19:10:45.0" updated="2019-10-29 20:31:05.0" resolutiondate="2019-10-29 20:31:05.0" votes="0" watches="2" workflowId="56090"> <description><! CDATA PTE invoke proposals fail when using service discovery, with the following images  fabric: f75da78633022d0d63cc01c1df6a1a3d8d061082  fabric-ca:  4cd4192f0366570aa4bed9374b17f98fc0d6015f  sdk-node npm packages:   ├─┬ *fabric*-ca-client@2.0.0-snapshot.296  │ ├─┬ *fabric*-common@2.0.0-snapshot.289  └─┬ *fabric*-client@2.0.0-snapshot.293    ├── *fabric*-ca-client@2.0.0-snapshot.296 deduped    ├── *fabric*-common@2.0.0-snapshot.289 deduped    ├─┬ *fabric*-protos@2.0.0-snapshot.147     The logs show grpc 'Failed to connect before the deadline'.  The relevant debug logs are below:  The detailed log is attached, including when the service discovery layout is acquired from the peer. We see two problems: # Why doesn't the layout return two options? Our test network has two peers, and either one could do the endorsement, but the layout returned contains only one peer in one layout. # Why does the SDK fail to connect to the peer? _Note that the test fails the same way if we wait several minutes and try again to send invokes using serv discov._  _Note that, PTE sends invokes to the same peer0.org1 successfully if not using service discovery.  The network is configured with mutual TLS enabled._        info:  2019-10-24T19:00:35.642Z PTE 0 main : stderr: 2019-10-24T19:00:35.642Z - debug:  Remote.js : getUrl::grpcs://peer0.org1.example.com:7061     info:  2019-10-24T19:00:35.643Z PTE 0 main : stderr: 2019-10-24T19:00:35.642Z - debug:  Peer.js : sendProposal - Start ----peer0.org1.example.com:7061 grpcs://peer0.org1.example.com:7061     info:  2019-10-24T19:00:38.644Z PTE 0 main : stderr: 2019-10-24T19:00:38.642Z - debug:  Remote.js : getUrl::grpcs://peer0.org1.example.com:7061  2019-10-24T19:00:38.642Z - error:  Remote.js : Error: Failed to connect before the deadline URL:grpcs://peer0.org1.example.com:7061 timeout:3000  2019-10-24T19:00:38.643Z - debug:  DiscoveryEndorsementHandler : _build_endorse_group_member >> G1:0 - not able to get a completed endorsement  2019-10-24T19:00:38.643Z - debug:  DiscoveryEndorsementHandler : _execute_endorsements - endorsement failed: Error: Failed to connect before the deadline URL:grpcs://peer0.org1.example.com:7061 timeout:3000  2019-10-24T19:00:38.643Z - debug:  DiscoveryEndorsementHandler : _endorse - layout plan 0 did not complete successfully, try another layout plan  2019-10-24T19:00:38.643Z - error:  DiscoveryEndorsementHandler : _endorse - endorsement failed::Error: Endorsement has failed      at DiscoveryEndorsementHandler._endorse (/home/ibmadmin/gopath/src/github.com/hyperledger/fabric-test/tools/PTE/node_modules/fabric-client/lib/impl/DiscoveryEndorsementHandler.js:185:19)      at <anonymous>      at process._tickCallback (internal/process/next_tick.js:188:7)  error:  2019-10-24T19:00:38.643Z PTE 0 exec :  Nid:chan:org:id=0:testorgschannel1:org1:0 invoke_move_dist_evtBlock  Failed to send transaction proposal due to error:  Error: Endorsement has failed      at DiscoveryEndorsementHandler._endorse (/home/ibmadmin/gopath/src/github.com/hyperledger/fabric-test/tools/PTE/node_modules/fabric-client/lib/impl/DiscoveryEndorsementHandler.js:185:19)      at <anonymous>      at process._tickCallback (internal/process/next_tick.js:188:7)     info:  2019-10-24T19:00:38.646Z PTE 0 main : stderr: (node:27691) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): TypeError: Cannot read property 'getName' of undefined  (node:27691)  DEP0018  DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero exit code.     ></description> </Issue>
