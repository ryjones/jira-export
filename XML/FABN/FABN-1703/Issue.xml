<Issue id="46605" key="FABN-1703" number="1703" project="10604" reporter="JIRAUSER20631" creator="JIRAUSER20631" type="10002" summary="How can I set TLS communication in the client using an HSM" priority="3" resolution="10001" status="6" created="2021-02-27 19:15:59.0" updated="2021-08-20 08:58:58.0" resolutiondate="2021-08-20 08:58:58.0" votes="0" watches="1" workflowId="60550" archived="N"> <description><! CDATA I use Hyperledger Fabric V1.4 and I'm moving all my private keys to an HSM. Looking at my code when I create a gateway to use my contracts I add a TLS certificate and a Private key, but the private key is required and with the HSM I wont get access to it, so how can I connect to my gateway?  This is how I connect to the gateway:   {code:javascript} const gateway = new Gateway(); const ccpPath = path.resolve(this.ccpPath); await gateway.connect(ccpPath, { wallet:this.wallet, identity: userId, discovery: { enabled: true, asLocalhost: this.asLocalhost } }); const client = gateway.getClient(); client.setTlsClientCertAndKey(identityUsuarioTLS.certificate, identityUsuarioTLS.privateKey); {code}  I see that I can add a CryptoSuite, and I'm guessing with it I can tell the client it has an HSM for its private keys, but I don't see where can I tell the client what identity to use for the TLS communication.  Looking inside the code if I use the setTlsClientCertAndKey() without parameters then it creates and self-sign a certificate, but I already have one in my HSM.   {code:javascript} setTlsClientCertAndKey(clientCert, clientKey) { logger.debug('setTlsClientCertAndKey - start'); if (clientCert && clientKey) { this._tls_mutual.clientCert = clientCert; this._tls_mutual.clientKey = clientKey; this._tls_mutual.clientCertHash = null; this._tls_mutual.selfGenerated = false; } else { if (this._userContext) { logger.debug('setTlsClientCertAndKey - generating self-signed TLS client certificate');             // generate X509 cert pair // use the default software cryptosuite, not the client assigned cryptosuite, which may be // HSM, or the default has been set to HSM. FABN-830 const key = Client.newCryptoSuite({software: true}).generateEphemeralKey();             this._tls_mutual.clientKey = key.toBytes(); this._tls_mutual.clientCert = key.generateX509Certificate(this._userContext.getName());             this._tls_mutual.selfGenerated = true; } } } {code}  I haven't found documentation about this, so any help leading me in the right direction would be great.  Thanks  ></description> </Issue>
