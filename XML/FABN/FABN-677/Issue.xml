<Issue id="30249" key="FABN-677" number="677" project="10604" reporter="davidkhala" creator="davidkhala" type="10001" summary="fabric-ca self-generated tls-cert.pem cannot be used in node-sdk" priority="1" resolution="10001" status="6" created="2018-05-16 08:52:42.0" updated="2019-10-30 06:25:36.0" resolutiondate="2019-10-29 16:17:20.0" votes="1" watches="3" workflowId="34742"> <description><! CDATA I want to play fabric-ca with more state-less style,  So I run it as docker container with command  "{color:#6a8759}rm {color}$\{caKey}{color:#6a8759};rm {color}$\{caCert}{color:#6a8759};fabric-ca-server start -d“{color}  and with config like   {color:#9876aa}csr{color}: \{  {color:#9876aa}    cn{color}: container_name{color:#cc7832}, {color}    {color:#9876aa}hosts{color}:  container_name {color:#cc7832}, {color}}{color:#cc7832}, {color}{color:#9876aa}    tls{color}: \{         {color:#9876aa}enabled{color}: true{color:#cc7832}, {color}}{color:#cc7832},{color}  {color:#cc7832}....{color}  the container started OK, but when I use fabric-node-sdk as client to access it, it prompted with  Error: Calling enrollment endpoint failed with error  Error: write EPROTO 140384308950848:error:1411713E:SSL routines:ssl_check_srvr_ecc_cert_and_alg:ecc cert not for signing:../deps/openssl/openssl/ssl/ssl_lib.c:2520: 140384308950848:error:14082130:SSL routines:ssl3_check_cert_and_algorithm:bad ecc cert:../deps/openssl/openssl/ssl/s3_clnt.c:3550:  In using fabric-node-sdk, I imported the tls-cert.pem as trusted root already.     logs from ca container  2018/05/16 08:13:04  INFO  Configuration file location: /etc/hyperledger/fabric-ca-server/fabric-ca-server-config.yaml 2018/05/16 08:13:04  INFO  Starting server in home directory: /etc/hyperledger/fabric-ca-server 2018/05/16 08:13:04  INFO  Server Version: 1.1.0 2018/05/16 08:13:04  INFO  Server Levels: &\{Identity:1 Affiliation:1 Certificate:1} 2018/05/16 08:13:04  DEBUG  Making server filenames absolute 2018/05/16 08:13:04  DEBUG  Initializing default CA in directory /etc/hyperledger/fabric-ca-server 2018/05/16 08:13:04  DEBUG  Init CA with home /etc/hyperledger/fabric-ca-server and config \{Version: Cfg:\{Identities:\{AllowRemove:false} Affiliations:\{AllowRemove:false}} CA:\{Name: Keyfile: Certfile:ca-cert.pem Chainfile:ca-chain.pem} Signing:<nil> CSR:\{CN:ca.Delphi.com Names: \{C:US ST:California L:San Francisco O: OU: SerialNumber:}  Hosts: ca.Delphi.com  KeyRequest:<nil> CA:<nil> SerialNumber:} Registry:\{MaxEnrollments:-1 Identities: \{ Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:0 Attrs:map hf.Revoker:1 hf.IntermediateCA:1 hf.GenCRL:1 hf.Registrar.Attributes:* hf.AffiliationMgr:1 hf.Registrar.Roles:peer,orderer,client,user hf.Registrar.DelegateRoles:peer,orderer,client,user   } } Affiliations:map   LDAP:\{ Enabled:false URL: UserFilter:(uid=%s) GroupFilter:(memberUid=%s) Attribute:\{      map  } TLS:\{false    \{ }}  } DB:\{ Type:sqlite3 Datasource:fabric-ca-server.db TLS:\{false    \{ }}  } CSP:<nil> Client:<nil> Intermediate:\{ParentServer:\{ URL: CAName:  } TLS:\{Enabled:false CertFiles:   Client:\{KeyFile: CertFile:}} Enrollment:\{ Name: Secret:**** Profile: Label: CSR:<nil> CAName: AttrReqs:    }} CRL:\{Expiry:24h0m0s}} 2018/05/16 08:13:04  DEBUG  CA Home Directory: /etc/hyperledger/fabric-ca-server 2018/05/16 08:13:04  DEBUG  Checking configuration file version '0' against server version: '1.1.0' 2018/05/16 08:13:04  DEBUG  Initializing BCCSP: &\{ProviderName:SW SwOpts:0xc4202895c0 PluginOpts:<nil> Pkcs11Opts:<nil>} 2018/05/16 08:13:04  DEBUG  Initializing BCCSP with software options &\{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:0xc4202ba5f0 DummyKeystore:<nil>} 2018/05/16 08:13:04  DEBUG  Initialize key material 2018/05/16 08:13:04  DEBUG  Making CA filenames absolute 2018/05/16 08:13:04  DEBUG  Root CA certificate request: \{CN:ca.Delphi.com Names: \{C:US ST:California L:San Francisco O: OU: SerialNumber:}  Hosts: ca.Delphi.com  KeyRequest:0xc4202aafa0 CA:0xc4202aae40 SerialNumber:} 2018/05/16 08:13:04  INFO  generating key: &\{A:ecdsa S:256} 2018/05/16 08:13:04  DEBUG  generate key from request: algo=ecdsa, size=256 2018/05/16 08:13:04  INFO  encoded CSR 2018/05/16 08:13:04  DEBUG  validating configuration 2018/05/16 08:13:04  DEBUG  validate local profile 2018/05/16 08:13:04  DEBUG  profile is valid 2018/05/16 08:13:04  INFO  signed certificate with serial number 279827261986328058200621168663428610101244004258 2018/05/16 08:13:04  INFO  The CA key and certificate were generated for CA  2018/05/16 08:13:04  INFO  The key was stored by BCCSP provider 'SW' 2018/05/16 08:13:04  INFO  The certificate is at: /etc/hyperledger/fabric-ca-server/ca-cert.pem 2018/05/16 08:13:04  DEBUG  Initializing DB 2018/05/16 08:13:04  DEBUG  Initializing 'sqlite3' database at '/etc/hyperledger/fabric-ca-server/fabric-ca-server.db' 2018/05/16 08:13:04  DEBUG  Using sqlite database, connect to database in home (/etc/hyperledger/fabric-ca-server/fabric-ca-server.db) directory 2018/05/16 08:13:04  DEBUG  Creating SQLite database (/etc/hyperledger/fabric-ca-server/fabric-ca-server.db) if it does not exist... 2018/05/16 08:13:04  DEBUG  Creating users table if it does not exist 2018/05/16 08:13:04  DEBUG  Creating affiliations table if it does not exist 2018/05/16 08:13:04  DEBUG  Creating certificates table if it does not exist 2018/05/16 08:13:04  DEBUG  Creating properties table if it does not exist 2018/05/16 08:13:05  DEBUG  Successfully opened sqlite3 DB 2018/05/16 08:13:05  DEBUG  Checking database schema... 2018/05/16 08:13:05  DEBUG  Update SQLite schema, if using outdated schema 2018/05/16 08:13:05  DEBUG  Upgrade identities table 2018/05/16 08:13:05  DEBUG  Creating users table if it does not exist 2018/05/16 08:13:05  DEBUG  Upgrade affiliation table 2018/05/16 08:13:05  DEBUG  Creating affiliations table if it does not exist 2018/05/16 08:13:05  DEBUG  Upgrade certificates table 2018/05/16 08:13:05  DEBUG  Creating certificates table if it does not exist 2018/05/16 08:13:06  DEBUG  Initializing identity registry 2018/05/16 08:13:06  DEBUG  Initialized DB identity registry 2018/05/16 08:13:06  DEBUG  DB: Get properties  identity.level affiliation.level certificate.level  2018/05/16 08:13:06  DEBUG  Checking database levels 'map affiliation.level:0 certificate.level:0 identity.level:0 ' against server levels '&\{Identity:1 Affiliation:1 Certificate:1}' 2018/05/16 08:13:06  DEBUG  Loading identity table 2018/05/16 08:13:06  DEBUG  Loading identity 'Admin' 2018/05/16 08:13:06  DEBUG  DB: Getting identity Admin 2018/05/16 08:13:06  DEBUG  Max enrollment value verification - User specified max enrollment: 0, CA max enrollment: -1 2018/05/16 08:13:06  DEBUG  DB: Add identity Admin 2018/05/16 08:13:06  DEBUG  Successfully added identity Admin to the database 2018/05/16 08:13:06  DEBUG  Registered identity: \{ Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:-1 Attrs:map hf.GenCRL:1 hf.Registrar.Attributes:* hf.AffiliationMgr:1 hf.Registrar.Roles:peer,orderer,client,user hf.Registrar.DelegateRoles:peer,orderer,client,user hf.Revoker:1 hf.IntermediateCA:1   } 2018/05/16 08:13:06  DEBUG  Successfully loaded identity table 2018/05/16 08:13:06  DEBUG  Loading affiliations table 2018/05/16 08:13:06  DEBUG  Successfully loaded affiliations table 2018/05/16 08:13:06  DEBUG  Checking and performing migration, if needed 2018/05/16 08:13:06  DEBUG  Migrating user 'Admin' to level 1 2018/05/16 08:13:06  DEBUG  Updating database level to &\{Identity:1 Affiliation:1 Certificate:1} 2018/05/16 08:13:07  INFO  Initialized sqlite3 database at /etc/hyperledger/fabric-ca-server/fabric-ca-server.db 2018/05/16 08:13:07  DEBUG  Initializing enrollment signer 2018/05/16 08:13:07  DEBUG  validating configuration 2018/05/16 08:13:07  DEBUG  validate local profile 2018/05/16 08:13:07  DEBUG  profile is valid 2018/05/16 08:13:07  DEBUG  validate local profile 2018/05/16 08:13:07  DEBUG  profile is valid 2018/05/16 08:13:07  DEBUG  validate local profile 2018/05/16 08:13:07  DEBUG  profile is valid 2018/05/16 08:13:07  DEBUG  CA initialization successful 2018/05/16 08:13:07  INFO  Home directory for default CA: /etc/hyperledger/fabric-ca-server 2018/05/16 08:13:07  DEBUG  1 CA instance(s) running on server 2018/05/16 08:13:07  DEBUG  TLS is enabled 2018/05/16 08:13:07  DEBUG  TLS enabled but no certificate or key provided, automatically generate TLS credentials 2018/05/16 08:13:07  DEBUG  TLS CSR: \{CN:ca.Delphi.com Names: \{C:US ST:California L:San Francisco O: OU: SerialNumber:}  Hosts: ca.Delphi.com  KeyRequest:0xc4202aaf80 CA:<nil> SerialNumber:} 2018/05/16 08:13:07  DEBUG  GenCSR &\{CN:ca.Delphi.com Names: \{C:US ST:California L:San Francisco O: OU: SerialNumber:}  Hosts: ca.Delphi.com  KeyRequest:0xc4202aaf80 CA:<nil> SerialNumber:} 2018/05/16 08:13:07  DEBUG  Initializing client with config: &\{URL: MSPDir: TLS:\{Enabled:false CertFiles:   Client:\{KeyFile: CertFile:}} Enrollment:\{ Name: Secret:**** Profile: Label: CSR:<nil> CAName: AttrReqs:    } CSR:\{CN: Names:   Hosts:   KeyRequest:<nil> CA:<nil> SerialNumber:} ID:\{Name: Type: Secret: MaxEnrollments:0 Affiliation: Attributes:   CAName:} Revoke:\{Name: Serial: AKI: Reason: CAName: GenCRL:false} CAInfo:\{CAName:} CAName: CSP:0xc420289590} 2018/05/16 08:13:07  DEBUG  Initializing BCCSP: &\{ProviderName:SW SwOpts:0xc4202895c0 PluginOpts:<nil> Pkcs11Opts:<nil>} 2018/05/16 08:13:07  DEBUG  Initializing BCCSP with software options &\{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:0xc4202ba5f0 DummyKeystore:<nil>} 2018/05/16 08:13:07  INFO  generating key: &\{A:ecdsa S:256} 2018/05/16 08:13:07  DEBUG  generate key from request: algo=ecdsa, size=256 2018/05/16 08:13:07  INFO  encoded CSR 2018/05/16 08:13:07  INFO  signed certificate with serial number 611535347575979179731889007531367518825256331296 2018/05/16 08:13:07  DEBUG  DB: Insert Certificate 2018/05/16 08:13:07  DEBUG  Saved serial number as hex 6b1e3182025f73f39ae0777284a39d113f782820 2018/05/16 08:13:07  DEBUG  saved certificate with serial number 611535347575979179731889007531367518825256331296 2018/05/16 08:13:07  DEBUG  TLS Certificate: /etc/hyperledger/fabric-ca-server/tls-cert.pem, TLS Key:  2018/05/16 08:13:07  DEBUG  Client authentication type requested: noclientcert 2018/05/16 08:13:07  INFO  Listening on https://0.0.0.0:7054 2018/05/16 08:13:14 http: TLS handshake error from 172.18.0.1:58540: EOF  ></description> </Issue>
