<Issue id="44549" key="FABN-1515" number="1515" project="10604" reporter="JIRAUSER19930" assignee="JIRAUSER19930" creator="JIRAUSER19930" type="10004" summary="fabric-ca-client on latest snapshot (90) throws instantiation errors on FabricCAServices.enroll" priority="2" resolution="10204" status="6" created="2020-03-12 15:21:25.0" updated="2020-06-19 10:20:23.0" resolutiondate="2020-06-19 10:20:22.0" votes="0" watches="1" workflowId="58462" archived="N"> <description><! CDATA When using FabricCAServices on the latest snapshot and attempting to call `enroll` on an instance of `FabricCAServices` I recieve this error: {code:java} error:  FabricCAClientService.js : Failed to enroll admin, error:%o message=Failed to generate key for enrollment due to error  TypeError: CKS(...).then is not a function    at /Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:413:63    at new Promise (<anonymous>)    at CryptoKeyStore._getKeyStore (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:409:10)    at CryptoSuite_ECDSA_AES.generateKey (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-common/lib/impl/CryptoSuite_ECDSA_AES.js:104:44)    at FabricCAServices.enroll (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/FabricCAServices.js:216:47)    at /Users/louis.murray@ibm.com/development/project/ts/service/fabirc.integration.test.ts:69:32    at Test.callFn (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:552:21)    at Test.run (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:565:23)    at Runner.runSingle (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:261:33)    at Runner.runTest (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:324:30) , stack=Error: Failed to generate key for enrollment due to error  TypeError: CKS(...).then is not a function    at /Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:413:63    at new Promise (<anonymous>)    at CryptoKeyStore._getKeyStore (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:409:10)    at CryptoSuite_ECDSA_AES.generateKey (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-common/lib/impl/CryptoSuite_ECDSA_AES.js:104:44)    at FabricCAServices.enroll (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/FabricCAServices.js:216:47)    at /Users/louis.murray@ibm.com/development/project/ts/service/fabirc.integration.test.ts:69:32    at Test.callFn (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:552:21)    at Test.run (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:565:23)    at Runner.runSingle (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:261:33)    at Runner.runTest (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:324:30)     at FabricCAServices.enroll (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/FabricCAServices.js:219:12)    at processTicksAndRejections (internal/process/task_queues.js:94:5)Error: Failed to generate key for enrollment due to error  TypeError: CKS(...).then is not a function    at /Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:413:63    at new Promise (<anonymous>)    at CryptoKeyStore._getKeyStore (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/utils.js:409:10)    at CryptoSuite_ECDSA_AES.generateKey (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-common/lib/impl/CryptoSuite_ECDSA_AES.js:104:44)    at FabricCAServices.enroll (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/FabricCAServices.js:216:47)    at /Users/louis.murray@ibm.com/development/project/ts/service/fabirc.integration.test.ts:69:32    at Test.callFn (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:552:21)    at Test.run (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/test.js:565:23)    at Runner.runSingle (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:261:33)    at Runner.runTest (/Users/louis.murray@ibm.com/development/project/node_modules/ava/lib/runner.js:324:30)     at FabricCAServices.enroll (/Users/louis.murray@ibm.com/development/project/node_modules/fabric-ca-client/lib/FabricCAServices.js:219:12)    at processTicksAndRejections (internal/process/task_queues.js:94:5) {code} looking at the calling code,  https://github.com/hyperledger/fabric-sdk-node/blob/release-1.4/fabric-client/lib/impl/CryptoKeyStore.js#L72  doesn't seem to be promise based.  I tried to convert that call to not expect the result to be a promise but i had other weird failures where the promise returned by `enroll` on an instance of FabricCAServices. looking at the code, it seemed like the constructor of FileKeyValueStore never got triggered when a crypto suite isn't provided to the instance of FileKeyValueStore. I'm not sure if that is a side effect of my local modification to remove the promise expectation or not though.  This project uses typescript 3.7 and node 12.15  ></description> </Issue>
