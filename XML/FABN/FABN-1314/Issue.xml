<Issue id="41202" key="FABN-1314" number="1314" project="10604" reporter="huxd" assignee="huxd" creator="huxd" type="10004" summary="FabricCAServices.enroll failed when using CryptoSuite_PKCS11" priority="1" resolution="10000" status="6" created="2019-07-15 06:49:31.0" updated="2019-07-24 04:45:37.0" resolutiondate="2019-07-24 04:45:37.0" votes="0" watches="1" workflowId="54203"> <description><! CDATA when using FabricCAServices.enroll with CryptoSuite_PKCS11 as the crypto suite, it failed with error: {code:java} 2019-07-15T06:35:45.734Z - error:  FabricCAClientService.js : Failed to enroll admin, error:%o message=Failed to generate key for enrollment due to error  ReferenceError: key is not defined , stack=Error: Failed to generate key for enrollment due to error  ReferenceError: key is not defined  at FabricCAServices.enroll (/home/huxd/hyperledger/fabric-sdk-node/fabric-ca-client/lib/FabricCAServices.js:219:12) {code}    test code used:    {code:java} 'use strict';  const FabricCAService = require('fabric-ca-client/lib/FabricCAServices'); const User = require('fabric-common/lib/User') const utils = require('fabric-common/lib/Utils');  async function test() {  utils.setConfigSetting('crypto-hsm', true); utils.setConfigSetting('crypto-pkcs11-lib', '/usr/local/lib/softhsm/libsofthsm2.so'); utils.setConfigSetting('crypto-pkcs11-slot', 0); utils.setConfigSetting('crypto-pkcs11-pin', '98765432'); utils.setConfigSetting('crypto-pkcs11-usertype', 1); utils.setConfigSetting('crypto-pkcs11-readwrite', true);  const service = new FabricCAService('http://localhost:7054', null, ''); // console.log(service.getCaName()); const result = await service.enroll({enrollmentID: 'admin', enrollmentSecret: 'admin'}); console.log(result);  }  test();{code}       ></description> </Issue>
