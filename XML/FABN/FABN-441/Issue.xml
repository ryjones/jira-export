<Issue id="15204" key="FABN-441" number="441" project="10604" reporter="jjjjibm" assignee="jimthematrix" creator="jjjjibm" type="10004" summary=" node-SDK  pkcs11.js  assign PKCS libpath based on search " priority="3" resolution="10000" status="6" created="2017-03-04 01:59:24.0" updated="2018-07-19 00:54:06.0" resolutiondate="2017-05-24 15:19:22.0" votes="0" watches="1" workflowId="34172"> <environment><! CDATA fabric-sdk-node commit d99495fe674dad5061860ffc9bd537962ce649b7 vlaunch VM   ></environment> <description><! CDATA Test fabric-sdk-node/test/unit/pkcs11.js identifies the PKCS11 libpath based on the value of process.platform.   The assumption was that when process.platform is equal to 'linux', the PKCS library provided will be /usr/local/lib/softhsm/libsofthsm2.so.  This is true when softHSM2 is installed by downloading the product from this link suggested in the test case: https://wiki.opendnssec.org/display/SoftHSMDOCS/SoftHSM+Documentation+v2  However, an alternate method to install softHSM2 is with apt-get install.  When installed with apt-get on a Vagrant Ubuntu VM, the PKCS11 library is located at /usr/lib/x86_64-linux-gnu/softhsm/libsofthsm2.so.  Thus setting the PKCS11 libpath based on process.platform is not reliable.  The solution is to port _findPKCS11Lib()_ in +fabric/bccsp/pkcs11/impl_test.g+o to Nodejs and use that method.   This function searches for the library in five directories.  I have added /usr/local/lib/softhsm/libsofthsm2.so to the search based on the installation on my vLaunch Ubuntu VM.   Another goal of this fix is to enable fabric-sdk-node/test/unit/pkcs11.js to run in the CI.  A fabric  PKCS11 test case is already running successfully in CI.  I have changed the user pin coded in pkcs11.js to the one used by this other test case so both tests can run.  I also added some tracing to fabric-sdk-node/./fabric-client/lib/impl/bccsp_pkcs11.js to help debug issues in CI.   One consequence of this fix is that all users of 'gulp test-headless' need to install softHSM version 2, or else accept that pkcs11.js fails.   I added a sample softhsm2-util command line configuration to test case comments for the convenience of testers.   ></description> </Issue>
