<Issue id="13823" key="FABB-52" number="52" project="10608" reporter="wayoon" creator="wayoon" type="10004" summary="TLS for p2p communicaitons fail in dev mode (--peer-chaincodedev)" priority="2" resolution="10000" status="6" created="2016-12-15 15:50:00.0" updated="2018-07-18 14:53:55.0" resolutiondate="2016-12-31 20:11:48.0" votes="0" watches="2" workflowId="32120"> <description><! CDATA I enabled p2p TLS, and started peer in dev mode. It fails when I tyr to run chaincode, saying "grpc: Server.Serve failed to complete security handshake from "127.0.0.1:55808": tls: first record does not look like a TLS handshake" (please see the last part of the peer log below).   in core.yaml {code} peer:  # TLS Settings for p2p communications tls: enabled:  true cert: file: testdata/server1.crt key: file: testdata/server1.key # The server name use to verify the hostname returned by TLS handshake serverhostoverride: VP0 {code}  starting peer in dev mode: {code} vagrant@hyperledger-devenv:v0.0.11-ed90562:/opt/gopath/src/github.com/hyperledger/fabric$ peer node start --peer-chaincodedev  15:29:31.479  logging  LoggingInit -> DEBU 001 Setting default logging level to DEBUG for command 'node' 15:29:31.480  nodeCmd  serve -> INFO 002 Running in chaincode development mode 15:29:31.480  nodeCmd  serve -> INFO 003 Set consensus to NOOPS and user starts chaincode 15:29:31.480  nodeCmd  serve -> INFO 004 Disable loading validity system chaincode 15:29:31.487  eventhub_producer  AddEventType -> DEBU 005 registering BLOCK 15:29:31.488  eventhub_producer  AddEventType -> DEBU 006 registering CHAINCODE 15:29:31.488  eventhub_producer  AddEventType -> DEBU 007 registering REJECTION 15:29:31.488  eventhub_producer  AddEventType -> DEBU 008 registering REGISTER 15:29:31.488  nodeCmd  serve -> INFO 009 Security enabled status: true 15:29:31.488  nodeCmd  serve -> INFO 00b Privacy enabled status: true 15:29:31.489  db  open -> DEBU 00c Is db path  /var/hyperledger/production/db  empty  false  15:29:31.488  eventhub_producer  start -> INFO 00a event processor started 15:29:31.490  db  open -> INFO 00d Setting rocksdb maxLogFileSize to 10485760 15:29:31.490  db  open -> INFO 00e Setting rocksdb keepLogFileNum to 10 15:29:31.680  nodeCmd  func1 -> DEBU 00f Registering validator with enroll ID: vp 15:29:31.680  crypto  RegisterValidator -> INFO 010 Registering validator  vp  with name  vp ... 15:29:31.682  crypto  Debugf -> DEBU 011  validator.vp  Data will be stored at  /var/hyperledger/production/crypto/validator/vp  15:29:31.683  crypto  Debugf -> DEBU 012  validator.vp  Keystore path  /var/hyperledger/production/crypto/validator/vp/ks  missing  false :  <clean>  15:29:31.683  crypto  Debugf -> DEBU 013  validator.vp  Keystore  /var/hyperledger/production/crypto/validator/vp/ks/db  missing  false : <clean>  15:29:31.683  crypto  Debugf -> DEBU 014  validator.vp  Keystore opened at  /var/hyperledger/production/crypto/validator/vp/ks ...done 15:29:31.683  crypto  Debug -> DEBU 015  validator.vp   Registering node crypto engine... 15:29:31.684  crypto  Debug -> DEBU 016  validator.vp   Initiliazing TLS... 15:29:31.684  crypto  Debugf -> DEBU 017  validator.vp  Loading external certificate at  testdata/server.crt ... 15:29:31.685  crypto  Debug -> DEBU 018  validator.vp   Initiliazing TLS...Done 15:29:31.686  crypto  Debug -> DEBU 019  validator.vp   Registering node crypto engine...done! 15:29:31.686  crypto  Debugf -> DEBU 01a  validator.vp  Registration of node  %!s(crypto.NodeType=2)  with name  vp  completed 15:29:31.686  crypto  Debug -> DEBU 01b  validator.vp   Closing keystore... 15:29:31.687  crypto  Debug -> DEBU 01c  validator.vp   Closing keystore...done! 15:29:31.687  crypto  RegisterValidator -> INFO 01d Registering validator  vp  with name  vp ...done! 15:29:31.687  nodeCmd  func1 -> DEBU 01e Initializing validator with enroll ID: vp 15:29:31.687  crypto  InitValidator -> INFO 01f Initializing validator  vp ... 15:29:31.689  crypto  Debugf -> DEBU 020  validator.vp  Data will be stored at  /var/hyperledger/production/crypto/validator/vp  15:29:31.689  crypto  Debugf -> DEBU 021  validator.vp  Keystore path  /var/hyperledger/production/crypto/validator/vp/ks  missing  false :  <clean>  15:29:31.689  crypto  Debugf -> DEBU 022  validator.vp  Keystore  /var/hyperledger/production/crypto/validator/vp/ks/db  missing  false : <clean>  15:29:31.689  crypto  Debugf -> DEBU 023  validator.vp  Keystore opened at  /var/hyperledger/production/crypto/validator/vp/ks ...done 15:29:31.689  crypto  Debug -> DEBU 024  validator.vp   Initializing node crypto engine... 15:29:31.690  crypto  Debug -> DEBU 025  validator.vp   Loading ECA certificates chain... 15:29:31.690  crypto  Debugf -> DEBU 026  validator.vp  Loading certificate  eca.cert.chain  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/eca.cert.chain ... 15:29:31.690  crypto  Debug -> DEBU 027  validator.vp   Loading TCA certificates chain... 15:29:31.690  crypto  Debugf -> DEBU 028  validator.vp  Loading certificate  tca.cert.chain  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/tca.cert.chain ... 15:29:31.690  crypto  Debug -> DEBU 029  validator.vp   Loading enrollment key... 15:29:31.691  crypto  Debugf -> DEBU 02a  validator.vp  Loading private key  enrollment.key  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/enrollment.key ... 15:29:31.707  crypto  Debug -> DEBU 02b  validator.vp   Loading enrollment certificate... 15:29:31.707  crypto  Debugf -> DEBU 02c  validator.vp  Loading certificate  enrollment.cert  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/enrollment.cert ... 15:29:31.708  crypto  Debugf -> DEBU 02d  validator.vp  Setting id to  5c e6 b6 13 80 eb a3 a9 26 5b 2b f8 b5 7e e1 6b 27 b1 b5 4f 25 0d 45 36 8d 5b 99 0b 5c 57 cb c1 . 15:29:31.708  crypto  Debugf -> DEBU 02e  validator.vp  Setting enrollCertHash to  5c e6 b6 13 80 eb a3 a9 26 5b 2b f8 b5 7e e1 6b 27 b1 b5 4f 25 0d 45 36 8d 5b 99 0b 5c 57 cb c1 . 15:29:31.708  crypto  Debugf -> DEBU 02f  validator.vp  Loading enrollment id at  /var/hyperledger/production/crypto/validator/vp/ks/raw/enrollment.id ... 15:29:31.708  crypto  Debugf -> DEBU 030  validator.vp  Setting enrollment id to  vp . 15:29:31.708  crypto  Debug -> DEBU 031  validator.vp   Loading enrollment chain key... 15:29:31.708  crypto  Debugf -> DEBU 032  validator.vp  Loading private key  chain.key  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/chain.key ... 15:29:31.709  crypto  Debug -> DEBU 033  validator.vp   Loading TLSCA certificates chain... 15:29:31.709  crypto  Debugf -> DEBU 034  validator.vp  Loading external certificate at  testdata/server.crt ... 15:29:31.710  crypto  Debug -> DEBU 035  validator.vp   Loading TLSCA certificates chain...done 15:29:31.710  crypto  Debug -> DEBU 036  validator.vp   Loading tls certificate... 15:29:31.710  crypto  Debugf -> DEBU 037  validator.vp  Loading certificate  tls.cert  at  /var/hyperledger/production/crypto/validator/vp/ks/raw/tls.cert ... 15:29:31.710  crypto  Debug -> DEBU 038  validator.vp   Initializing node crypto engine...done! 15:29:31.710  crypto  Debug -> DEBU 039  validator.vp   Init keystore... 15:29:31.710  crypto  Debugf -> DEBU 03a  validator.vp  Create Table  Certificates  if not exists 15:29:31.719  crypto  Debug -> DEBU 03b  validator.vp   Init keystore...done. 15:29:31.719  crypto  InitValidator -> INFO 03c Initializing validator  vp ...done! 15:29:31.720  chaincode  NewChaincodeSupport -> INFO 03d Chaincode support using peerAddress: 0.0.0.0:7051 15:29:31.720  chaincode  NewChaincodeSupport -> DEBU 03e Turn off keepalive(value 0) 15:29:31.721  sysccapi  RegisterSysCC -> WARN 03f Currently system chaincode does support security(noop,github.com/hyperledger/fabric/bddtests/syschaincode/noop) 15:29:31.721  nodeCmd  serve -> DEBU 040 Running as validating peer - making genesis block if needed 15:29:31.723  state  loadConfig -> INFO 041 Loading configurations... 15:29:31.724  state  loadConfig -> INFO 042 Configurations loaded. stateImplName= buckettree , stateImplConfigs=map bucketCacheSize:%!s(int=100) numBuckets:%!s(int=1000003) maxGroupingAtEachLevel:%!s(int=5) , deltaHistorySize= 500  15:29:31.724  state  NewState -> INFO 043 Initializing state implementation  buckettree  15:29:31.724  buckettree  initConfig -> INFO 044 configs passed during initialization = map string interface {}{"numBuckets":1000003, "maxGroupingAtEachLevel":5, "bucketCacheSize":100} 15:29:31.725  buckettree  initConfig -> INFO 045 Initializing bucket tree state implemetation with configurations &{maxGroupingAtEachLevel:5 lowestLevel:9 levelToNumBucketsMap:map 4:321 2:13 7:40001 3:65 9:1000003 6:8001 1:3 0:1 8:200001 5:1601  hashFunc:0xab1fb0} 15:29:31.725  buckettree  newBucketCache -> INFO 046 Constructing bucket-cache with max bucket cache size =  100  MBs 15:29:31.726  buckettree  loadAllBucketNodesFromDB -> INFO 047 Loaded buckets data in cache. Total buckets in DB =  0 . Total cache size:=0 15:29:31.726  nodeCmd  serve -> DEBU 048 Running as validating peer - installing consensus noops 15:29:31.726  peer  initDiscovery -> DEBU 049 Retrieved discovery list from disk:    15:29:31.727  consensus/controller  NewConsenter -> INFO 04a Creating default consensus plugin (noops) 15:29:31.728  consensus/noops  newNoops -> DEBU 04b Creating a NOOPS object 15:29:31.731  consensus/noops  newNoops -> INFO 04c NOOPS consensus type = *noops.Noops 15:29:31.731  consensus/noops  newNoops -> INFO 04d NOOPS block size = 500 15:29:31.732  consensus/noops  newNoops -> INFO 04e NOOPS block wait = 1s 15:29:31.732  peer  chatWithSomePeers -> DEBU 04f Starting up the first peer of a new network 15:29:31.734  consensus/statetransfer  verifyAndRecoverBlockchain -> DEBU 050 Validating existing blockchain, highest validated block is 0, valid through 0 15:29:31.734  consensus/statetransfer  blockThread -> INFO 051 Validated blockchain to the genesis block 15:29:31.734  consensus/handler  1 -> DEBU 052 Starting up message thread for consenter 15:29:31.734  nodeCmd  serve -> INFO 053 Starting peer with ID=name:"jdoe" , network ID=dev, address=0.0.0.0:7051, rootnodes=, validator=true 15:29:31.735  peer  ensureConnected -> DEBU 054 Starting Peer reconnect service (touch service), with period = 6s 15:29:31.736  rest  StartOpenchainRESTServer -> INFO 055 Initializing the REST service on 0.0.0.0:7050, TLS is enabled. 2016/12/15 15:29:37 grpc: Server.Serve failed to complete security handshake from "127.0.0.1:55807": tls: first record does not look like a TLS handshake 15:29:37.741  peer  ensureConnected -> DEBU 056 Touch service indicates no dropped connections 15:29:37.741  peer  ensureConnected -> DEBU 057 Connected to:    15:29:37.741  peer  ensureConnected -> DEBU 058 Discovery knows about:    2016/12/15 15:29:38 grpc: Server.Serve failed to complete security handshake from "127.0.0.1:55808": tls: first record does not look like a TLS handshake 2016/12/15 15:29:39 grpc: Server.Serve failed to complete security handshake from "127.0.0.1:55809": tls: first record does not look like a TLS handshake 15:29:43.741  peer  ensureConnected -> DEBU 059 Touch service indicates no dropped connections 15:29:43.741  peer  ensureConnected -> DEBU 05a Connected to:    15:29:43.741  peer  ensureConnected -> DEBU 05b Discovery knows about:    {code}  starting chaincode: {code} vagrant@hyperledger-devenv:v0.0.11-ed90562:/opt/gopath/src/consentmanager$ CORE_CHAINCODE_ID_NAME=consentmanager CORE_PEER_ADDRESS=0.0.0.0:7051 ./cc 2016/12/15 15:29:37 ----starting chaincode---- 2016/12/15 15:29:37 Set CORE_LOGGING_CHAINCODE=DEBUG 2016/12/15 15:29:37 Set CORE_REST_ADDRESS=0.0.0.0:7050 15:29:37.153  shim  DEBU : Peer address: 0.0.0.0:7051 2016/12/15 15:29:37 transport: http2Client.notifyError got notified that the client transport was broken unexpected EOF. 2016/12/15 15:29:38 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp 127.0.0.1:55807->127.0.0.1:7051: write: connection reset by peer"; Reconnecting to {"0.0.0.0:7051" <nil>} 2016/12/15 15:29:39 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp 127.0.0.1:55808->127.0.0.1:7051: write: broken pipe"; Reconnecting to {"0.0.0.0:7051" <nil>} 15:29:40.154  shim  ERRO : Error trying to connect to local peer: grpc: timed out when dialing Error starting Simple chaincode: Error trying to connect to local peer: grpc: timed out when dialing  {code}   ></description> </Issue>
