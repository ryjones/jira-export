<Issue id="33408" key="IS-919" number="919" project="10401" reporter="sklump" assignee="vladimirwork" creator="sklump" type="10004" summary="Upgrade path broken from indy-pool.dockerfile in indy-sdk 1.4.0 to current indy-node protocol version" environment="ubuntu 16.04" priority="3" resolution="10000" status="10001" created="2018-08-31 18:09:30.0" updated="2018-09-21 13:03:19.0" resolutiondate="2018-09-21 13:03:19.0" votes="0" watches="2" timeoriginalestimate="57600" timeestimate="57600" workflowId="51523"> <description><! CDATA I'm not sure whether this belongs properly in indy-node or indy-sdk.  I need to simulate: * running current von_anchor (based on current indy-sdk) on the existing sovrin node pool, which runs indy-node 1.3.62 * generating some credentials in indy-sdk 1.6.x wallets * upgrading the node pool * working with the credentials to create and verify proof, make sure nothing breaks  before the SLN upgrade runs for real.  I've had to tweak the indy-pool.dockerfile a bit to get it to build, using versions on which indy-node 1.3.62 depends: ``` ARG indy_plenum_ver=1.2.42 ARG indy_anoncreds_ver=1.0.11 ARG indy_node_ver=1.3.62 ARG python3_indy_crypto_ver=0.4.1 ARG indy_crypto_ver=0.4.0  RUN apt-get update -y && apt-get install -y \ python3-base58=0.2.4 \ indy-plenum=${indy_plenum_ver} \ indy-anoncreds=${indy_anoncreds_ver} \ indy-node=${indy_node_ver} \ python3-indy-crypto=${python3_indy_crypto_ver} \ libindy-crypto=${indy_crypto_ver} \ vim ``` (adding python3-base58 version that indy-plenum requires) and ```  program:node1 \n\ command=start_indy_node Node1 9701 9702\n\ ... ``` etc (taking out IP addresses).  I build and start the container, get a bash prompt on it as root `docker exec -u root -it jovial_payne bash` and `start_node_control_tool`.  I start the test suite and finish it with  ```  in_1_min = '{}+00:00'.format((datetime.utcnow() + timedelta(seconds=60)).isoformat())  req_json = await build_pool_upgrade_request(      tan.did,     'upgrade-pool',     '1.6.71',     'start',     'f6f2ea8f45d8a057c9566a33f99474da2e5c6a6604d736121650e2730c6fb0a3',     None,     json.dumps(  {         'Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv': in_1_min,         '8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb': in_1_min,         'DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya': in_1_min,         '4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA': in_1_min}  ),     None,     False,     True,     None)     print('\n\n== 79 == Upgrade request: {}'.format(ppjson(req_json)))      resp_json = await sign_and_submit_request(tan.pool.handle, tan.wallet.handle, tan.did,  req_json)     print('\n\n== 80 == Upgrade response: {}'.format(ppjson(resp_json))) ```  and the output shows that the request seems OK. In a minute, the output on the docker container shows the node control script attempting to perform the upgrade: ```  2018-08-31 17:59:57,895 | DEBUG | __init__.py ( 60) | register | Registered VCS backend: git 2018-08-31 17:59:57,960 | DEBUG | __init__.py ( 60) | register | Registered VCS backend: hg 2018-08-31 17:59:58,027 | DEBUG | __init__.py ( 60) | register | Registered VCS backend: svn 2018-08-31 17:59:58,029 | DEBUG | __init__.py ( 60) | register | Registered VCS backend: bzr 2018-08-31 17:59:58,176 | INFO | node_control_tool.py ( 75) | __init__ | Node control tool is starting up on localh ost port 30003 2018-08-31 17:59:59,339 | DEBUG | node_control_tool.py ( 288) | start | Waiting for the next event  2018-08-31 18:03:24,226 | DEBUG | node_control_tool.py ( 297) | start | New connection from ('127.0.0.1', 59466) on f d 4 2018-08-31 18:03:24,226 | DEBUG | node_control_tool.py ( 288) | start | Waiting for the next event 2018-08-31 18:03:24,228 | DEBUG | node_control_tool.py ( 305) | start | Received "b'\{"version": "1.6.71"}'" from ('12 7.0.0.1', 59466) on fd 4 2018-08-31 18:03:24,228 | DEBUG | node_control_tool.py ( 243) | _process_data | Decoded 2018-08-31 18:03:24,229 | INFO | node_control_tool.py ( 225) | _upgrade | Trying to upgrade from 1.3.62 to 1.6.71 2018-08-31 18:03:24,230 | INFO | node_control_tool.py ( 139) | _call_upgrade_script | Upgrading indy node to version 1.6.71, test_mode 0 2018-08-31 18:03:24,231 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-node=1 .6.71  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:03:28,437 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-plenum =1.6.50  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:03:31,890 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for python3-indy-crypto=0.4.1  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:03:35,382 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-anoncreds=1.0.11  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  + deps=' indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71' + ' ' -z ' indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71' ' ' + echo 'Try to donwload indy version indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1. 6.71' Try to donwload indy version indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71 + apt-get -y update Hit:1  http://archive.ubuntu.com/ubuntu  xenial InRelease Get:2  http://security.ubuntu.com/ubuntu  xenial-security InRelease  107 kB  Get:3  http://archive.ubuntu.com/ubuntu  xenial-updates InRelease  109 kB  Ign:4  https://repo.sovrin.org/deb  xenial InRelease Hit:5  http://archive.ubuntu.com/ubuntu  xenial-backports InRelease Hit:6  https://repo.sovrin.org/deb  xenial Release Fetched 216 kB in 1s (206 kB/s) Reading package lists... Done + apt-get --download-only -y --allow-downgrades --allow-change-held-packages install indy-anoncreds=1.0.11 python3-indy- crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71 Reading package lists... Done Building dependency tree Reading state information... Done indy-anoncreds is already the newest version (1.0.11). python3-indy-crypto is already the newest version (0.4.1). The following package was automatically installed and is no longer required: python3-pkg-resources Use 'apt autoremove' to remove it. The following NEW packages will be installed: python3-pympler The following held packages will be changed: indy-node indy-plenum The following packages will be upgraded: indy-node indy-plenum python3-base58 3 upgraded, 1 newly installed, 0 to remove and 0 not upgraded. Need to get 1474 kB of archives. After this operation, 1192 kB of additional disk space will be used. Get:1  https://repo.sovrin.org/deb  xenial/stable amd64 indy-node amd64 1.6.71  587 kB  Get:2  https://repo.sovrin.org/deb  xenial/stable amd64 indy-plenum amd64 1.6.50  735 kB  Get:3  https://repo.sovrin.org/deb  xenial/stable amd64 python3-base58 amd64 1.0.0  5268 B  Get:4  https://repo.sovrin.org/deb  xenial/stable amd64 python3-pympler amd64 0.5  147 kB  Fetched 1474 kB in 2s (648 kB/s) Download complete and in download only mode + ret=0 + ' ' 0 -ne 0 ' ' + ' ' '' = '' ' ' + echo 'Stop indy-node' Stop indy-node + systemctl stop indy-node Failed to connect to bus: No such file or directory + echo 'Run indy upgrade to indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71' Run indy upgrade to indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71 + apt-get -y --allow-downgrades --allow-change-held-packages --reinstall install indy-anoncreds=1.0.11 python3-indy-cryp to=0.4.1 indy-plenum=1.6.50 indy-node=1.6.71 Reading package lists... Done Building dependency tree Reading state information... Done The following package was automatically installed and is no longer required: python3-pkg-resources Use 'apt autoremove' to remove it. The following additional packages will be installed: python3-base58 python3-pympler The following NEW packages will be installed: python3-pympler The following held packages will be changed: indy-node indy-plenum The following packages will be upgraded: indy-node indy-plenum python3-base58 3 upgraded, 1 newly installed, 2 reinstalled, 0 to remove and 0 not upgraded. Need to get 46.4 kB/1520 kB of archives. After this operation, 1192 kB of additional disk space will be used. Get:1  https://repo.sovrin.org/deb  xenial/stable amd64 indy-anoncreds amd64 1.0.11  41.0 kB  Get:2  https://repo.sovrin.org/deb  xenial/stable amd64 python3-indy-crypto amd64 0.4.1  5456 B  Fetched 46.4 kB in 0s (48.3 kB/s) debconf: delaying package configuration, since apt-utils is not installed (Reading database ... 21530 files and directories currently installed.) Preparing to unpack .../indy-node_1.6.71_amd64.deb ... Unpacking indy-node (1.6.71) over (1.3.62) ... Selecting previously unselected package python3-pympler. Preparing to unpack .../python3-pympler_0.5_amd64.deb ... Unpacking python3-pympler (0.5) ... Preparing to unpack .../indy-plenum_1.6.50_amd64.deb ... Unpacking indy-plenum (1.6.50) over (1.2.42) ... Preparing to unpack .../python3-base58_1.0.0_amd64.deb ... Unpacking python3-base58 (1.0.0) over (0.2.4) ... Preparing to unpack .../indy-anoncreds_1.0.11_amd64.deb ... Unpacking indy-anoncreds (1.0.11) over (1.0.11) ... Preparing to unpack .../python3-indy-crypto_0.4.1_amd64.deb ... Unpacking python3-indy-crypto (0.4.1) over (0.4.1) ... Setting up python3-base58 (1.0.0) ... Setting up python3-pympler (0.5) ... Setting up python3-indy-crypto (0.4.1) ... Setting up indy-plenum (1.6.50) ... Setting up indy-anoncreds (1.0.11) ... Setting up indy-node (1.6.71) ... + ret=0 + ' ' 0 -ne 0 ' ' 2018-08-31 18:03:54,524 | DEBUG | node_control_tool.py ( 170) | _create_backup | Creating backup for 1.3.62 2018-08-31 18:03:54,664 | INFO | migration_tool.py ( 52) | migrate | Migrating from 1.3.62 to 1.6.71 on Ubunt u 2018-08-31 18:03:54,668 | DEBUG | migration_tool.py ( 54) | migrate | Found migration scripts:  '1_0_28_to_1_0 _29', '1_1_37_to_1_1_38', '1_1_43_to_1_2_44', '1_2_44_to_1_2_45', '1_2_50_to_1_2_51', '1_2_51_to_1_2_52', '1_3_396_to _1_3_397', '1_3_428_to_1_3_429', '1_3_433_to_1_3_434', '1_4_500_to_1_4_501', 'disabled_1_0_29_to_1_0_28', 'helper_1_0 _28_to_1_0_29', 'helper_1_1_37_to_1_1_38'  2018-08-31 18:03:54,671 | INFO | migration_tool.py ( 61) | migrate | Following migrations will be applied:  ' 1_3_396_to_1_3_397', '1_3_428_to_1_3_429', '1_3_433_to_1_3_434', '1_4_500_to_1_4_501'  2018-08-31 18:03:54,673 | INFO | migration_tool.py ( 63) | migrate | Applying migration 1_3_396_to_1_3_397 2018-08-31 18:03:54,674 | INFO | migration_tool.py ( 35) | _call_migration_script | script path /usr/local/li b/python3.5/dist-packages/data/migrations/deb/1_3_396_to_1_3_397.py Traceback (most recent call last): File "/usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_396_to_1_3_397.py", line 79, in migrate_storage leveldb_storage = KeyValueStorageLeveldbCls(level_db_dir, db_name, read_only=True) File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_leveldb_int_keys.py", line 12, in __init__ super().__init__(db_dir, db_name, open, read_only) File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_leveldb.py", line 22, in __init__ self.open() File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_leveldb_int_keys.py", line 16, in open 'IntegerComparator', integer_comparator)) leveldb.LevelDBError: IO error: lock /var/lib/indy/sandbox/data/Node4/pool_transactions/LOCK: Resource temporarily unavailable None Could not open leveldb storage: /var/lib/indy/sandbox/data/Node4/pool_transactions Could not migrate pool_transactions, DB path: /var/lib/indy/sandbox/data/Node4/pool_transactions Storages migration from LevelDB to RocksDB failed! 2018-08-31 18:03:55,570 | ERROR | migration_tool.py ( 44) | _call_migration_script | Migration failed: script returned 1 2018-08-31 18:03:55,571 | DEBUG | node_control_tool.py ( 175) | _restore_from_backup | Restoring from backup for 1.3.62 2018-08-31 18:03:55,572 | WARNING | node_control_tool.py ( 182) | _restore_from_backup | Copying last_version failed due to  Errno 2  No such file or directory: '/var/lib/indy/sandbox/last_version' 2018-08-31 18:03:55,572 | WARNING | node_control_tool.py ( 182) | _restore_from_backup | Copying next_version failed due to  Errno 2  No such file or directory: '/var/lib/indy/sandbox/next_version' 2018-08-31 18:03:55,573 | WARNING | node_control_tool.py ( 182) | _restore_from_backup | Copying upgrade_log failed due to  Errno 2  No such file or directory: '/var/lib/indy/sandbox/upgrade_log' 2018-08-31 18:03:55,573 | WARNING | node_control_tool.py ( 182) | _restore_from_backup | Copying last_version_file failed due to  Errno 2  No such file or directory: '/var/lib/indy/sandbox/last_version_file' 2018-08-31 18:03:55,721 | WARNING | node_control_tool.py ( 191) | _restore_from_backup | Copying last_version failed due to  Errno 2  No such file or directory: '/tmp/.indy_tmp/last_version' 2018-08-31 18:03:55,721 | WARNING | node_control_tool.py ( 191) | _restore_from_backup | Copying next_version failed due to  Errno 2  No such file or directory: '/tmp/.indy_tmp/next_version' 2018-08-31 18:03:55,722 | WARNING | node_control_tool.py ( 191) | _restore_from_backup | Copying upgrade_log failed due to  Errno 2  No such file or directory: '/tmp/.indy_tmp/upgrade_log' 2018-08-31 18:03:55,722 | WARNING | node_control_tool.py ( 191) | _restore_from_backup | Copying last_version_file failed due to  Errno 2  No such file or directory: '/tmp/.indy_tmp/last_version_file' 2018-08-31 18:03:55,726 | ERROR | node_control_tool.py ( 259) | _declare_upgrade_failed | Upgrade from 1.3.62 to 1.6.71 failed: Migration failed: script returned 1 2018-08-31 18:03:55,726 | ERROR | node_control_tool.py ( 235) | _upgrade | Trying to rollback to the previous version Migration failed: script returned 1 2018-08-31 18:03:55,727 | INFO | node_control_tool.py ( 225) | _upgrade | Trying to upgrade from 1.3.62 to 1.3.62 2018-08-31 18:03:55,728 | INFO | node_control_tool.py ( 139) | _call_upgrade_script | Upgrading indy node to version 1.3.62, test_mode 0 2018-08-31 18:03:55,729 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-node=1.3.62  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:03:59,368 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-plenum=1.2.42  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:04:02,668 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for python3-indy-crypto=0.4.1  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  2018-08-31 18:04:06,156 | INFO | node_control_tool.py ( 118) | _get_deps_list | Getting dependencies for indy-anoncreds=1.0.11  WARNING: apt does not have a stable CLI interface. Use with caution in scripts.  + deps=' indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62' + ' ' -z ' indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62' ' ' + echo 'Try to donwload indy version indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62' Try to donwload indy version indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62 + apt-get -y update Get:1  http://security.ubuntu.com/ubuntu  xenial-security InRelease  107 kB  Hit:2  http://archive.ubuntu.com/ubuntu  xenial InRelease Get:3  http://archive.ubuntu.com/ubuntu  xenial-updates InRelease  109 kB  Ign:4  https://repo.sovrin.org/deb  xenial InRelease Hit:5  http://archive.ubuntu.com/ubuntu  xenial-backports InRelease Hit:6  https://repo.sovrin.org/deb  xenial Release Fetched 216 kB in 0s (224 kB/s) Reading package lists... Done + apt-get --download-only -y --allow-downgrades --allow-change-held-packages install indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62 Reading package lists... Done Building dependency tree Reading state information... Done indy-anoncreds is already the newest version (1.0.11). python3-indy-crypto is already the newest version (0.4.1). Some packages could not be installed. This may mean that you have requested an impossible situation or if you are using the unstable distribution that some required packages have not yet been created or been moved out of Incoming. The following information may help to resolve the situation:  The following packages have unmet dependencies: indy-plenum : Depends: python3-base58 (= 0.2.4) but 1.0.0 is to be installed E: Unable to correct problems, you have held broken packages. + ret=100 + ' ' 100 -ne 0 ' ' + echo 'Failed to obtain indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62' Failed to obtain indy-anoncreds=1.0.11 python3-indy-crypto=0.4.1 indy-plenum=1.2.42 indy-node=1.3.62 + exit 1  2018-08-31 18:06:31,572 | ERROR | node_control_tool.py ( 259) | _declare_upgrade_failed | Upgrade from 1.3.62 to 1.3.62 failed: upgrade script failed, exit code is 1 2018-08-31 18:06:31,575 | ERROR | node_control_tool.py ( 235) | _upgrade | Trying to rollback to the previous version upgrade script failed, exit code is 1 ```  It appears that different packages want different versions of base58 installed at the same time.  ></description> </Issue>
