<Issue id="34503" key="IS-1033" number="1033" project="10401" reporter="osesov" assignee="sergey.minaev" creator="osesov" type="10002" summary="Community PR: Android build script fails when host system contains libzmq.a" priority="3" resolution="10000" status="10001" created="2018-10-09 14:02:27.0" updated="2018-10-17 15:28:28.0" resolutiondate="2018-10-17 15:28:28.0" votes="0" watches="2" workflowId="51607"> <description><! CDATA There are two issues with android build script ({{android.build.sh}}) 1) build fails when host system contains {{/lib/libzmq.a}} with clang message {{"incompatible target"}}: {noformat} Output will be available at /tmp/android_build/libindy_armv7/lib/libindy.so + /tmp/android_build/toolchains/linux/arm/bin/arm-linux-androideabi-clang -v -shared -o/tmp/android_build/libindy_armv7/lib/libindy.so -Wl,--whole-archive /home/osesov/blockchain/projects/indy/indy-sdk/libindy/target/armv7-linux-androideabi/release/libindy.a /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/libz.so /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/libm.a /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/liblog.so /home/osesov/blockchain/projects/indy/indy-sdk/libindy/openssl_armv7/lib/libssl.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/openssl_armv7/lib/libcrypto.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/libsodium_armv7/lib/libsodium.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/libzmq_armv7/lib/libzmq.a /tmp/android_build/toolchains/linux/arm/arm-linux-androideabi/lib/libgnustl_shared.so -Wl,--no-whole-archive -z muldefs Android clang version 5.0.300080  (based on LLVM 5.0.300080) Target: armv7a-none-linux-android Thread model: posix InstalledDir: /tmp/android_build/toolchains/linux/arm/bin Found candidate GCC installation: /tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x Selected GCC installation: /tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x Candidate multilib: thumb;@thumb Candidate multilib: armv7-a;@armv7 Candidate multilib: armv7-a/thumb;@armv7@thumb Candidate multilib: .; Selected multilib: armv7-a;@armv7 "/tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld" --sysroot=/tmp/android_build/toolchains/linux/arm/bin/../sysroot -X --eh-frame-hdr -m armelf_linux_eabi -shared -o /tmp/android_build/libindy_armv7/lib/libindy.so /tmp/android_build/toolchains/linux/arm/bin/../sysroot/usr/lib/../lib/crtbegin_so.o -L/tmp/android_build/toolchains/linux/arm/lib64/clang/5.0.300080/lib/linux/arm -L/tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/armv7-a -L/tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/lib/../lib/armv7-a -L/tmp/android_build/toolchains/linux/arm/bin/../sysroot/usr/lib/../lib -L/tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/lib/armv7-a -L/tmp/android_build/toolchains/linux/arm/bin/../sysroot/usr/lib --whole-archive /home/osesov/blockchain/projects/indy/indy-sdk/libindy/target/armv7-linux-androideabi/release/libindy.a /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/libz.so /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/libm.a /tmp/android_build/toolchains/linux/arm/sysroot/usr/lib/liblog.so /home/osesov/blockchain/projects/indy/indy-sdk/libindy/openssl_armv7/lib/libssl.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/openssl_armv7/lib/libcrypto.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/libsodium_armv7/lib/libsodium.a /home/osesov/blockchain/projects/indy/indy-sdk/libindy/libzmq_armv7/lib/libzmq.a /tmp/android_build/toolchains/linux/arm/arm-linux-androideabi/lib/libgnustl_shared.so --no-whole-archive -z muldefs -lgcc -ldl -lc -lgcc -ldl /tmp/android_build/toolchains/linux/arm/bin/../sysroot/usr/lib/../lib/crtend_so.o /tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: /home/osesov/blockchain/projects/indy/indy-sdk/libindy/target/armv7-linux-androideabi/release/libindy.a(src_libzmq_la-address.o): incompatible target /tmp/android_build/toolchains/linux/arm/bin/../lib/gcc/arm-linux-androideabi/4.9.x/../../../../arm-linux-androideabi/bin/ld: error: /home/osesov/blockchain/projects/indy/indy-sdk/libindy/target/armv7-linux-androideabi/release/libindy.a(src_libzmq_la-client.o): incompatible target ... {noformat} {{That happens due to error in {{libindy/build.rs}}, which joins OPENSSL_DIR environment variable with absolute "{{/lib"}} path, resulting in "{{/lib", instead of expected"${OPENSSL_DIR}/lib"}}}}  2) when no openssl, sodium, or zmq libs are downloaded (run without -d flag), default behavior is to check for arch specific libs in the current folder (like openssl_${ABSOLUTE_ARCH}) and use relative path, however later build fails to find these (I guess, due to run with another work dir).  ></description> </Issue>
