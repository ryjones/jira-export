<Issue id="32509" key="IS-862" number="862" project="10401" reporter="sklump" assignee="sklump" creator="sklump" type="10002" summary="anoncreds prover_{search,fetch}_credentials_for_proof_req ignores restrictions in proof-req" priority="4" resolution="10000" status="10001" created="2018-08-02 16:07:47.0" updated="2018-08-09 11:20:22.0" resolutiondate="2018-08-09 11:20:22.0" votes="0" watches="2" timeoriginalestimate="57600" timeestimate="57600" workflowId="51486"> <description><! CDATA I have three cred defs: * fav-num v1.0: `WgWxqztrNooG92RXvxSTWv:3:CL:178:0` (on schema with attributes 'ident', 'num') * ident v1.0: `WgWxqztrNooG92RXvxSTWv:3:CL:179:0` (on schema with attributes 'ident', 'regEpoch') * fav-char v1.0: `WgWxqztrNooG92RXvxSTWv:3:CL:180:0` (on schema with attributes 'ident', 'char').  The wallet has 24 creds on each with ident=0..23, and, for the fav-num creds, * ident 0..3 have num=0 * ident 4..23 have num > 0.  I build a proof request using only the fav-num cred def; it looks like this:  {code:java} { "version": "0.0", "requested_attributes": { "178_ident_uuid": { "non_revoked": ..., "restrictions":   { "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:178:0" }  , "name": "ident" } }, "nonce": "1533125655", "requested_predicates": {}, "name": "proof_req" } {code}  I search the wallet with the above proof-req and extra WQL dict:  {code:java} { "178_ident_uuid": { "$or":   { "attr::ident::value": 1 }, { "attr::num::value": 0 }   } } {code}  After getting the search handle, I tracked what I got back from each call to `anoncreds.prover_fetch_credentials_for_proof_req()` per item referent and got:  {code:java} .. FETCHED 6 briefs for referent 178_ident_uuid:   { "interval": ..., "cred_info": { "referent": "57877da8-8c78-42a8-bcd1-d05f84240ef8", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:178:0", "attrs": ..., ... } }, { "interval": ..., "cred_info": { "referent": "cabe9a7b-0d90-427b-ab7b-976eebd3cff7", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:178:0", "attrs": ..., ... } }, { "interval": ..., "cred_info": { "referent": "7c1b830c-8b54-443f-8108-ae403a7d3ee8", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:179:0", "attrs": ..., ... } }, { "interval": ..., "cred_info": { "referent": "5461fbb1-2459-43a9-8e93-0c43f25e818b", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:180:0", "attrs": ..., ... } }, { "interval": ..., "cred_info": { "referent": "7e6e8fdd-286a-4317-81d8-0a4ff22dbf2f", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:178:0", "attrs": ..., ... } }, { "interval": ..., "cred_info": { "referent": "9ed40b12-60e0-442a-ab40-ac5ca46e8ffe", "cred_def_id": "WgWxqztrNooG92RXvxSTWv:3:CL:178:0", "attrs": ..., ... } }   {code}  The proof request clearly identifies the cred-def restriction on each item referent, but the search ignores it in the WQL fetch iteration that the item referent identifies. As I see it, no way should this search have found credentials on the fav-char or ident cred-defs.  For the moment, specifying the restrictions explicitly in the WQL suffices as a workaround.  ></description> </Issue>
