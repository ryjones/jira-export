<Issue id="33644" key="CE-477" number="477" project="10200" reporter="luckydogchina" assignee="luckydogchina" creator="luckydogchina" type="10004" summary="Kafka pods cannot be started successfully( sometimes)." priority="4" resolution="10000" status="10001" created="2018-09-11 07:39:59.0" updated="2018-09-12 08:51:21.0" resolutiondate="2018-09-12 07:10:47.0" votes="0" watches="2" timeoriginalestimate="43200" timeestimate="43200" workflowId="44940"> <environment><! CDATA docker Info: ``` Containers: 53 Running: 34 Paused: 0 Stopped: 19 Images: 244 Server Version: 17.03.0-ce Storage Driver: aufs Root Dir: /var/lib/docker/aufs Backing Filesystem: extfs Dirs: 732 Dirperm1 Supported: true Logging Driver: json-file Cgroup Driver: cgroupfs Plugins:  Volume: local Network: bridge host macvlan null overlay Swarm: inactive Runtimes: runc Default Runtime: runc Init Binary: docker-init containerd version: 977c511eda0925a723debdc94d09459af49d082a runc version: a01dafd48bc1c7cc12bdb01206f9fea7dd6feb70 init version: 949e6fa Security Options: apparmor seccomp Profile: default Kernel Version: 4.4.0-134-generic Operating System: Ubuntu 16.04.5 LTS OSType: linux Architecture: x86_64 CPUs: 4 Total Memory: 7.68 GiB Name: whty0-To-be-filled-by-O-E-M ID: GFAD:JTW6:6ZAE:CM4X:3JIE:76CV:W37J:LNB3:CPRO:FZAL:WOQ4:JB2X Docker Root Dir: /var/lib/docker Debug Mode (client): false Debug Mode (server): false Registry: https://index.docker.io/v1/ WARNING: No swap limit support Experimental: false Insecure Registries: 127.0.0.0/8 Live Restore Enabled: false ```  Kubernetes: v1.10.7 amd64  Kernel: Linux whty0-To-be-filled-by-O-E-M 4.4.0-134-generic #160-Ubuntu SMP Wed Aug 15 14:58:00 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux  cello: master  ></environment> <description><! CDATA Kafka pods cannot be started successfully in kubernetes clusters. and kubectl logs show:  ```  2018-09-11 06:31:11,302  INFO starting (kafka.server.KafkaServer)  2018-09-11 06:31:11,303  INFO Connecting to zookeeper on zookeeper0:2181,zookeeper1:2181,zookeeper2:2181 (kafka.server.KafkaServer)  2018-09-11 06:31:11,320  INFO Starting ZkClient event thread. (org.I0Itec.zkclient.ZkEventThread)  2018-09-11 06:31:11,323  INFO Client environment:zookeeper.version=3.4.10-39d3a4f269333c922ed3db283be479f9deacaa0f, built on 03/23/2017 10:13 GMT (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:host.name=kafka2-696dd549c8-26fhh (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.version=1.8.0_171 (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.vendor=Oracle Corporation (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.home=/usr/lib/jvm/java-8-openjdk-amd64/jre (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.class.path=:/opt/kafka/bin/../libs/aopalliance-repackaged-2.5.0-b32.jar:/opt/kafka/bin/../libs/argparse4j-0.7.0.jar:/opt/kafka/bin/../libs/commons-lang3-3.5.jar:/opt/kafka/bin/../libs/connect-api-1.0.0.jar:/opt/kafka/bin/../libs/connect-file-1.0.0.jar:/opt/kafka/bin/../libs/connect-json-1.0.0.jar:/opt/kafka/bin/../libs/connect-runtime-1.0.0.jar:/opt/kafka/bin/../libs/connect-transforms-1.0.0.jar:/opt/kafka/bin/../libs/guava-20.0.jar:/opt/kafka/bin/../libs/hk2-api-2.5.0-b32.jar:/opt/kafka/bin/../libs/hk2-locator-2.5.0-b32.jar:/opt/kafka/bin/../libs/hk2-utils-2.5.0-b32.jar:/opt/kafka/bin/../libs/jackson-annotations-2.9.1.jar:/opt/kafka/bin/../libs/jackson-core-2.9.1.jar:/opt/kafka/bin/../libs/jackson-databind-2.9.1.jar:/opt/kafka/bin/../libs/jackson-jaxrs-base-2.9.1.jar:/opt/kafka/bin/../libs/jackson-jaxrs-json-provider-2.9.1.jar:/opt/kafka/bin/../libs/jackson-module-jaxb-annotations-2.9.1.jar:/opt/kafka/bin/../libs/javassist-3.20.0-GA.jar:/opt/kafka/bin/../libs/javassist-3.21.0-GA.jar:/opt/kafka/bin/../libs/javax.annotation-api-1.2.jar:/opt/kafka/bin/../libs/javax.inject-1.jar:/opt/kafka/bin/../libs/javax.inject-2.5.0-b32.jar:/opt/kafka/bin/../libs/javax.servlet-api-3.1.0.jar:/opt/kafka/bin/../libs/javax.ws.rs-api-2.0.1.jar:/opt/kafka/bin/../libs/jersey-client-2.25.1.jar:/opt/kafka/bin/../libs/jersey-common-2.25.1.jar:/opt/kafka/bin/../libs/jersey-container-servlet-2.25.1.jar:/opt/kafka/bin/../libs/jersey-container-servlet-core-2.25.1.jar:/opt/kafka/bin/../libs/jersey-guava-2.25.1.jar:/opt/kafka/bin/../libs/jersey-media-jaxb-2.25.1.jar:/opt/kafka/bin/../libs/jersey-server-2.25.1.jar:/opt/kafka/bin/../libs/jetty-continuation-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-http-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-io-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-security-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-server-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-servlet-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-servlets-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jetty-util-9.2.22.v20170606.jar:/opt/kafka/bin/../libs/jopt-simple-5.0.4.jar:/opt/kafka/bin/../libs/kafka-clients-1.0.0.jar:/opt/kafka/bin/../libs/kafka-log4j-appender-1.0.0.jar:/opt/kafka/bin/../libs/kafka-streams-1.0.0.jar:/opt/kafka/bin/../libs/kafka-streams-examples-1.0.0.jar:/opt/kafka/bin/../libs/kafka-tools-1.0.0.jar:/opt/kafka/bin/../libs/kafka_2.11-1.0.0-sources.jar:/opt/kafka/bin/../libs/kafka_2.11-1.0.0-test-sources.jar:/opt/kafka/bin/../libs/kafka_2.11-1.0.0.jar:/opt/kafka/bin/../libs/log4j-1.2.17.jar:/opt/kafka/bin/../libs/lz4-java-1.4.jar:/opt/kafka/bin/../libs/maven-artifact-3.5.0.jar:/opt/kafka/bin/../libs/metrics-core-2.2.0.jar:/opt/kafka/bin/../libs/osgi-resource-locator-1.0.1.jar:/opt/kafka/bin/../libs/plexus-utils-3.0.24.jar:/opt/kafka/bin/../libs/reflections-0.9.11.jar:/opt/kafka/bin/../libs/rocksdbjni-5.7.3.jar:/opt/kafka/bin/../libs/scala-library-2.11.11.jar:/opt/kafka/bin/../libs/slf4j-api-1.7.25.jar:/opt/kafka/bin/../libs/slf4j-log4j12-1.7.25.jar:/opt/kafka/bin/../libs/snappy-java-1.1.4.jar:/opt/kafka/bin/../libs/validation-api-1.1.0.Final.jar:/opt/kafka/bin/../libs/zkclient-0.10.jar:/opt/kafka/bin/../libs/zookeeper-3.4.10.jar (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.library.path=/usr/java/packages/lib/amd64:/usr/lib/x86_64-linux-gnu/jni:/lib/x86_64-linux-gnu:/usr/lib/x86_64-linux-gnu:/usr/lib/jni:/lib:/usr/lib (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.io.tmpdir=/tmp (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:java.compiler=<NA> (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:os.name=Linux (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:os.arch=amd64 (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:os.version=4.4.0-134-generic (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:user.name=root (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:user.home=/root (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,324  INFO Client environment:user.dir=/ (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,325  INFO Initiating client connection, connectString=zookeeper0:2181,zookeeper1:2181,zookeeper2:2181 sessionTimeout=6000 watcher=org.I0Itec.zkclient.ZkClient@6572421 (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:11,353  INFO Waiting for keeper state SyncConnected (org.I0Itec.zkclient.ZkClient)  2018-09-11 06:31:17,354  INFO Terminate ZkClient event thread. (org.I0Itec.zkclient.ZkEventThread)  2018-09-11 06:31:21,366  INFO Opening socket connection to server 10.244.0.58/10.244.0.58:2181. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)  2018-09-11 06:31:21,402  INFO Socket connection established to 10.244.0.58/10.244.0.58:2181, initiating session (org.apache.zookeeper.ClientCnxn)  2018-09-11 06:31:21,450  INFO Session establishment complete on server 10.244.0.58/10.244.0.58:2181, sessionid = 0x165c75302c80003, negotiated timeout = 6000 (org.apache.zookeeper.ClientCnxn)  2018-09-11 06:31:21,479  INFO Session: 0x165c75302c80003 closed (org.apache.zookeeper.ZooKeeper)  2018-09-11 06:31:21,507  FATAL Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer) org.I0Itec.zkclient.exception.ZkTimeoutException: Unable to connect to zookeeper server 'zookeeper0:2181,zookeeper1:2181,zookeeper2:2181' with timeout of 6000 ms 	at org.I0Itec.zkclient.ZkClient.connect(ZkClient.java:1233) 	at org.I0Itec.zkclient.ZkClient.<init>(ZkClient.java:157) 	at org.I0Itec.zkclient.ZkClient.<init>(ZkClient.java:131) 	at kafka.utils.ZkUtils$.createZkClientAndConnection(ZkUtils.scala:115) 	at kafka.utils.ZkUtils$.withMetrics(ZkUtils.scala:92) 	at kafka.server.KafkaServer.initZk(KafkaServer.scala:346) 	at kafka.server.KafkaServer.startup(KafkaServer.scala:194) 	at kafka.server.KafkaServerStartable.startup(KafkaServerStartable.scala:38) 	at kafka.Kafka$.main(Kafka.scala:92) 	at kafka.Kafka.main(Kafka.scala)  2018-09-11 06:31:21,507  INFO EventThread shut down for session: 0x165c75302c80003 (org.apache.zookeeper.ClientCnxn)  2018-09-11 06:31:21,532  INFO shutting down (kafka.server.KafkaServer)  2018-09-11 06:31:21,543  INFO shut down completed (kafka.server.KafkaServer)  2018-09-11 06:31:21,544  FATAL Exiting Kafka. (kafka.server.KafkaServerStartable)  2018-09-11 06:31:21,549  INFO shutting down (kafka.server.KafkaServer)  ``` kubectl describe show:  ``` Name:           kafka1-6d9875cd46-8chqk Namespace:      test Node:           whty0-to-be-filled-by-o-e-m/192.168.1.185 Start Time:     Tue, 11 Sep 2018 15:03:39 +0800 Labels:         app=hyperledger kafka-id=kafka1 org=kafkacluster pod-template-hash=2854317802 role=kafka Annotations:    cni.projectcalico.org/podIP=10.244.0.68/32 Status:         Running IP:             10.244.0.68 Controlled By:  ReplicaSet/kafka1-6d9875cd46 Containers: kafka1: Container ID:   docker://6bc13da0c9b4624b5c0a60c6cc131c13cfd47b3b2183336a6206dae07291934f Image:          hyperledger/fabric-kafka:amd64-0.4.10 Image ID:       docker-pullable://hyperledger/fabric-kafka@sha256:4b935e0962a664f1181ab374e1a3b4e8ddfa5ec76e5ce38d673b19b1b5ed682d Port:           9092/TCP Host Port:      0/TCP State:          Running Started:      Tue, 11 Sep 2018 15:05:55 +0800 Last State:     Terminated Reason:       Error Exit Code:    1 Started:      Tue, 11 Sep 2018 15:04:56 +0800 Finished:     Tue, 11 Sep 2018 15:05:07 +0800 Ready:          True Restart Count:  4 Environment: KAFKA_MESSAGE_MAX_BYTES:               1048576 KAFKA_REPLICA_FETCH_MAX_BYTES:         1048576 KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE:  false KAFKA_BROKER_ID:                       1 KAFKA_MIN_INSYNC_REPLICAS:             2 KAFKA_DEFAULT_REPLICATION_FACTOR:      3 KAFKA_ZOOKEEPER_CONNECT:               zookeeper0:2181,zookeeper1:2181,zookeeper2:2181 KAFKA_ADVERTISED_HOST_NAME:            kafka1 Mounts: /var/run/secrets/kubernetes.io/serviceaccount from default-token-6l2r7 (ro) Conditions: Type           Status Initialized    True  Ready          True  PodScheduled   True  Volumes: default-token-6l2r7: Type:        Secret (a volume populated by a Secret) SecretName:  default-token-6l2r7 Optional:    false QoS Class:       BestEffort Node-Selectors:  <none> Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s node.kubernetes.io/unreachable:NoExecute for 300s Events: Type     Reason                 Age               From                                  Message ----     ------                 ----              ----                                  ------- Normal   Scheduled              2m                default-scheduler                     Successfully assigned kafka1-6d9875cd46-8chqk to whty0-to-be-filled-by-o-e-m Normal   SuccessfulMountVolume  2m                kubelet, whty0-to-be-filled-by-o-e-m  MountVolume.SetUp succeeded for volume "default-token-6l2r7" Warning  BackOff                20s (x6 over 1m)  kubelet, whty0-to-be-filled-by-o-e-m  Back-off restarting failed container Normal   Pulled                 4s (x5 over 2m)   kubelet, whty0-to-be-filled-by-o-e-m  Container image "hyperledger/fabric-kafka:amd64-0.4.10" already present on machine Normal   Created                3s (x5 over 2m)   kubelet, whty0-to-be-filled-by-o-e-m  Created container Normal   Started                3s (x5 over 2m)   kubelet, whty0-to-be-filled-by-o-e-m  Started container  ```   ></description> </Issue>
