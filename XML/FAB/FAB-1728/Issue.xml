<Issue id="14157" key="FAB-1728" number="1728" project="10002" reporter="wayoon" creator="wayoon" type="10004" summary="TLS between peer to peer not working  (v0.6)" environment="vm linux ubuntu 14.04" priority="1" resolution="10000" status="6" created="2017-01-18 15:28:55.0" updated="2018-07-20 14:11:16.0" resolutiondate="2017-03-29 19:44:20.0" votes="0" watches="4" workflowId="37089"> <description><! CDATA We are conducting PoT for HIPAA ready Hyperledger on WHC. We are currently working with v0.6 -- we are planning to migrate to 1.0 later this this after 1.0 is released.  During our testing we found that TLS enablement for peers not working for muti peer setting. (tested with 2 VPs)  Here's the setting: vm1 (ubuntu) for CA (tls enabled)  -- membersrvc.yamll attached vm2 (ubuntu) for VP0 (tls enabled) -- core.yaml attached (core_vp0.yaml) vm3 (ubuntu) for VP1 (tls enabled) -- core.yaml attached (core_vp1.yaml)  start CA from hyperledger/fabric dir of vm1 > build/bin/membersrvc debug log output snippet: {code} ... 13:53:41.090  logging  LoggingInit -> DEBU 373 Setting default logging level to DEBUG for command 'ca' 13:53:41.150  ca  readCAPrivateKey -> DEBU 374 Reading CA private key. 13:53:41.151  ca  createCAKeyPair -> DEBU 375 Creating CA key pair. 13:53:41.151  ca  readCACertificate -> DEBU 376 Reading CA certificate. 13:53:41.151  ca  createCACertificate -> DEBU 377 Creating CA certificate. 13:53:41.152  logging  LoggingInit -> DEBU 378 Setting default logging level to DEBUG for command 'tlsca' 13:53:41.152  server  main -> DEBU 379 TLS was enabled  security.tls_enabled == true  13:53:41.153  server  main -> DEBU 37a ACA was enabled  aca.enabled == true  13:53:41.153  aca  Start -> INFO 37b Staring ACA services... 13:53:41.153  aca  startACAP -> INFO 37c ACA PUBLIC gRPC API server started 13:53:41.153  aca  Start -> INFO 37d ACA services started 13:53:41.153  eca  Start -> INFO 37e Starting ECA... 13:53:41.153  eca  startECAP -> INFO 37f ECA PUBLIC gRPC API server started 13:53:41.153  eca  startECAA -> INFO 380 ECA ADMIN gRPC API server started 13:53:41.153  eca  Start -> INFO 381 ECA started. 13:53:41.153  tca  Start -> INFO 382 Staring TCA services... 13:53:41.153  tca  startTCAP -> INFO 383 TCA PUBLIC gRPC API server started 13:53:41.153  tca  startTCAA -> INFO 384 TCA ADMIN gRPC API server started 13:53:41.153  tca  Start -> INFO 385 TCA started. 13:53:41.153  tlsca  Start -> INFO 386 TLSCA started. 13:53:53.459  ecap  ReadCACertificate -> DEBU 387 gRPC ECAP:ReadCACertificate 13:53:53.467  tcap  ReadCACertificate -> DEBU 388 grpc TCAP:ReadCACertificate 13:53:53.473  ecap  CreateCertificatePair -> DEBU 389 gRPC ECAP:CreateCertificate 13:53:53.478  ca  readUser -> DEBU 38a Reading token for vp0. 13:53:53.659  ecap  CreateCertificatePair -> DEBU 38b gRPC ECAP:CreateCertificate 13:53:53.659  ca  readUser -> DEBU 38c Reading token for vp0. 13:53:53.660  ca  readRole -> DEBU 38d Reading role for vp0. 13:53:53.660  ca  createCertificateFromSpec -> DEBU 38e Creating certificate for vp0. 13:53:53.714  ca  readRole -> DEBU 38f Reading role for vp0. 13:53:53.714  ca  createCertificateFromSpec -> DEBU 390 Creating certificate for vp0. 13:53:53.879  tlsca  CreateCertificate -> DEBU 391 grpc TLSCAP:CreateCertificate 13:53:53.880  ca  createCertificateFromSpec -> DEBU 392 Creating certificate for vp0-832d9438-52fd-4bd1-9593-b1737c8c28ee. 13:55:35.864  ecap  ReadCACertificate -> DEBU 393 gRPC ECAP:ReadCACertificate 13:55:35.872  tcap  ReadCACertificate -> DEBU 394 grpc TCAP:ReadCACertificate 13:55:35.882  ecap  CreateCertificatePair -> DEBU 395 gRPC ECAP:CreateCertificate 13:55:35.882  ca  readUser -> DEBU 396 Reading token for vp1. 13:55:35.892  ecap  CreateCertificatePair -> DEBU 397 gRPC ECAP:CreateCertificate 13:55:35.893  ca  readUser -> DEBU 398 Reading token for vp1. 13:55:35.894  ca  readRole -> DEBU 399 Reading role for vp1. 13:55:35.894  ca  createCertificateFromSpec -> DEBU 39a Creating certificate for vp1. 13:55:35.899  ca  readRole -> DEBU 39b Reading role for vp1. 13:55:35.899  ca  createCertificateFromSpec -> DEBU 39c Creating certificate for vp1. 13:55:35.915  tlsca  CreateCertificate -> DEBU 39d grpc TLSCAP:CreateCertificate 13:55:35.915  ca  createCertificateFromSpec -> DEBU 39e Creating certificate for vp1-912d93d6-e6a4-4feb-a313-d20a9c836d70. ... {code}  start VP0 form hyperledger/fabric dir of vm2 > build/bin/peer node start debug log output snippet: {code} ... 13:53:55.670  nodeCmd  serve -> DEBU 073 Running as validating peer - installing consensus  13:53:55.670  peer  initDiscovery -> DEBU 074 Retrieved discovery list from disk:    13:53:55.670  consensus/controller  NewConsenter -> INFO 075 Creating default consensus plugin (noops) 13:53:55.670  consensus/noops  newNoops -> DEBU 076 Creating a NOOPS object 13:53:55.670  consensus/noops  newNoops -> INFO 077 NOOPS consensus type = *noops.Noops 13:53:55.670  consensus/noops  newNoops -> INFO 078 NOOPS block size = 500 13:53:55.670  consensus/noops  newNoops -> INFO 079 NOOPS block wait = 1s 13:53:55.671  peer  chatWithSomePeers -> DEBU 07a Starting up the first peer of a new network 13:53:55.671  nodeCmd  serve -> INFO 07b Starting peer with ID=name:"vp0" , network ID=dev, address=0.0.0.0:7051, rootnodes=, validator=true 13:53:55.671  consensus/statetransfer  verifyAndRecoverBlockchain -> DEBU 07c Validating existing blockchain, highest validated block is 0, valid through 0 13:53:55.671  consensus/statetransfer  blockThread -> INFO 07d Validated blockchain to the genesis block 13:53:55.671  consensus/handler  1 -> DEBU 07e Starting up message thread for consenter 13:53:55.672  peer  ensureConnected -> DEBU 07f Starting Peer reconnect service (touch service), with period = 6s 13:53:55.672  rest  StartOpenchainRESTServer -> INFO 080 Initializing the REST service on 0.0.0.0:7050, TLS is enabled. 13:54:01.672  peer  ensureConnected -> DEBU 081 Touch service indicates no dropped connections 13:54:01.672  peer  ensureConnected -> DEBU 082 Connected to:    13:54:01.672  peer  ensureConnected -> DEBU 083 Discovery knows about:    13:54:07.672  peer  ensureConnected -> DEBU 084 Touch service indicates no dropped connections ... 13:55:31.672  peer  ensureConnected -> DEBU 0af Connected to:    13:55:31.672  peer  ensureConnected -> DEBU 0b0 Discovery knows about:    2017/01/18 13:55:37 grpc: Server.Serve failed to complete security handshake from "192.168.56.103:42698": EOF 13:55:37.672  peer  ensureConnected -> DEBU 0b1 Touch service indicates no dropped connections 13:55:37.672  peer  ensureConnected -> DEBU 0b2 Connected to:    13:55:37.672  peer  ensureConnected -> DEBU 0b3 Discovery knows about:    2017/01/18 13:55:38 grpc: Server.Serve failed to complete security handshake from "192.168.56.103:42700": EOF 2017/01/18 13:55:40 grpc: Server.Serve failed to complete security handshake from "192.168.56.103:42702": EOF 13:55:43.672  peer  ensureConnected -> DEBU 0b4 Touch service indicates no dropped connections ... {code}  star VP1 from hyperledger/fabric dir of vm3 > build/bin/peer node start debug log output snippet:  {code} ... 13:55:35.974  nodeCmd  serve -> DEBU 073 Running as validating peer - installing consensus  13:55:35.974  peer  initDiscovery -> DEBU 074 Retrieved discovery list from disk:    13:55:35.975  consensus/controller  NewConsenter -> INFO 075 Creating default consensus plugin (noops) 13:55:35.975  consensus/noops  newNoops -> DEBU 076 Creating a NOOPS object 13:55:35.975  consensus/noops  newNoops -> INFO 077 NOOPS consensus type = *noops.Noops 13:55:35.976  consensus/noops  newNoops -> INFO 078 NOOPS block size = 500 13:55:35.976  consensus/noops  newNoops -> INFO 079 NOOPS block wait = 1s 13:55:35.976  nodeCmd  serve -> INFO 07a Starting peer with ID=name:"vp1" , network ID=dev, address=0.0.0.0:7051, rootnodes=test-vp0:7051, validator=true 13:55:35.977  rest  StartOpenchainRESTServer -> INFO 07b Initializing the REST service on 0.0.0.0:7050, TLS is enabled. 13:55:35.977  consensus/statetransfer  verifyAndRecoverBlockchain -> DEBU 07c Validating existing blockchain, highest validated block is 0, valid through 0 13:55:35.981  consensus/statetransfer  blockThread -> INFO 080 Validated blockchain to the genesis block 13:55:35.977  consensus/handler  1 -> DEBU 07d Starting up message thread for consenter 13:55:35.977  peer  ensureConnected -> DEBU 07e Starting Peer reconnect service (touch service), with period = 6s 13:55:35.977  peer  chatWithPeer -> DEBU 07f Initiating Chat with peer address: test-vp0:7051 2017/01/18 13:55:36 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: x509: certificate is valid for test-vp0, not test-vp1"; Reconnecting to {"test-vp0:7051" <nil>} 2017/01/18 13:55:38 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: x509: certificate is valid for test-vp0, not test-vp1"; Reconnecting to {"test-vp0:7051" <nil>} 13:55:38.986  peer  chatWithPeer -> ERRO 081 Error creating connection to peer address test-vp0:7051: grpc: timed out when dialing 2017/01/18 13:55:38 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: x509: certificate is valid for test-vp0, not test-vp1"; Reconnecting to {"test-vp0:7051" <nil>} 13:55:41.978  peer  ensureConnected -> DEBU 082 Touch service indicates no dropped connections 13:55:41.978  peer  ensureConnected -> DEBU 083 Connected to:    13:55:41.978  peer  ensureConnected -> DEBU 084 Discovery knows about:    13:55:47.977  peer  ensureConnected -> DEBU 085 Touch service indicates no dropped connections ... {code}  Please see the error message in the above output for vp1, it says {code} 2017/01/18 13:55:38 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: x509: certificate is valid for test-vp0, not test-vp1"; Reconnecting to {"test-vp0:7051" <nil>} 13:55:38.986  peer  chatWithPeer -> ERRO 081 Error creating connection to peer address test-vp0:7051: grpc: timed out when dialing {code}  Note: I have the following in hosts file: 192.168.56.101  test-ca 192.168.56.102  test-vp0 192.168.56.103  test-vp1    ></description> </Issue>
