<Action id="60675" issue="40367" author="mhbauer" type="comment" created="2019-06-05 00:11:46.0" updateauthor="mhbauer" updated="2019-06-05 00:11:46.0"> <body><! CDATA Massive set of races at the same time while attempting to repro: ================== WARNING: DATA RACE Write at 0x00c002d7b9e0 by goroutine 1205: github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).learnExistingMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:821 +0x6c2 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleAliveMessage() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:533 +0xcf1 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMsgFromComm() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:373 +0xe6a github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:297 +0x162  Previous read at 0x00c002d7b9e0 by goroutine 1895: github.com/hyperledger/fabric/gossip/discovery.(*NetworkMember).String() <autogenerated>:1 +0x77 fmt.(*pp).handleMethods() /Users/mhb/.go/src/fmt/print.go:616 +0x433 fmt.(*pp).printArg() /Users/mhb/.go/src/fmt/print.go:699 +0x24f fmt.(*pp).doPrintln() /Users/mhb/.go/src/fmt/print.go:1159 +0xb2 fmt.Sprintln() /Users/mhb/.go/src/fmt/print.go:282 +0x5f github.com/hyperledger/fabric/common/flogging.formatArgs() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:105 +0x50 github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Warning() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:79 +0x70 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).expireDeadMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:712 +0x430 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handlePresumedDeadPeers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:275 +0x2f1  Goroutine 1205 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:117 +0x838 github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163  Goroutine 1895 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:119 +0x87c github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163 ================== 2019-06-04 17:10:24.808 PDT  gossip.discovery#127.0.0.1:60533  expireDeadMembers -> WARN 221 Exiting ================== WARNING: DATA RACE Write at 0x00c002d7b9f0 by goroutine 1205: github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).learnExistingMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:822 +0x761 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleAliveMessage() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:533 +0xcf1 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMsgFromComm() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:373 +0xe6a github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:297 +0x162  Previous read at 0x00c002d7b9f0 by goroutine 1895: github.com/hyperledger/fabric/gossip/discovery.(*NetworkMember).String() <autogenerated>:1 +0x77 fmt.(*pp).handleMethods() /Users/mhb/.go/src/fmt/print.go:616 +0x433 fmt.(*pp).printArg() /Users/mhb/.go/src/fmt/print.go:699 +0x24f fmt.(*pp).doPrintln() /Users/mhb/.go/src/fmt/print.go:1159 +0xb2 fmt.Sprintln() /Users/mhb/.go/src/fmt/print.go:282 +0x5f github.com/hyperledger/fabric/common/flogging.formatArgs() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:105 +0x50 github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Warning() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:79 +0x70 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).expireDeadMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:712 +0x430 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handlePresumedDeadPeers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:275 +0x2f1  Goroutine 1205 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:117 +0x838 github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163  Goroutine 1895 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:119 +0x87c github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163 ================== ================== WARNING: DATA RACE Write at 0x00c002d7ba20 by goroutine 1205: github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).learnExistingMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:823 +0x7a9 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleAliveMessage() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:533 +0xcf1 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMsgFromComm() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:373 +0xe6a github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:297 +0x162  Previous read at 0x00c002d7ba20 by goroutine 1895: github.com/hyperledger/fabric/gossip/discovery.(*NetworkMember).String() <autogenerated>:1 +0x77 fmt.(*pp).handleMethods() /Users/mhb/.go/src/fmt/print.go:616 +0x433 fmt.(*pp).printArg() /Users/mhb/.go/src/fmt/print.go:699 +0x24f fmt.(*pp).doPrintln() /Users/mhb/.go/src/fmt/print.go:1159 +0xb2 fmt.Sprintln() /Users/mhb/.go/src/fmt/print.go:282 +0x5f github.com/hyperledger/fabric/common/flogging.formatArgs() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:105 +0x50 github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Warning() /Users/mhb/go/src/github.com/hyperledger/fabric/common/flogging/zap.go:79 +0x70 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).expireDeadMembers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:712 +0x430 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handlePresumedDeadPeers() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:275 +0x2f1  Goroutine 1205 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:117 +0x838 github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163  Goroutine 1895 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:119 +0x87c github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x1557 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidatorWithMetrics() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:389 +0x10b1 github.com/hyperledger/fabric/gossip/state.newPeerNodeWithGossipWithValidator() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:441 +0xf1 github.com/hyperledger/fabric/gossip/state.TestNewGossipStateProvider_SendingManyMessages() /Users/mhb/go/src/github.com/hyperledger/fabric/gossip/state/state_test.go:344 +0x70a testing.tRunner() /Users/mhb/.go/src/testing/testing.go:865 +0x163 ================== 2019-06-04 17:10:24.859 PDT  gossip.discovery#127.0.0.1:60533  learnExistingMembers -> WARN 222 pki_id:"127.0.0.1:60501"  has already expired --- FAIL: TestNewGossipStateProvider_SendingManyMessages (48.99s) state_test.go:1656: Started to spin off, until predicate will be satisfied. state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1111: Peer discovery has not finished yet state_test.go:1115: All peer discovered each other!!! state_test.go:1661: Done. state_test.go:1671: Stop waiting until timeout or true state_test.go:1119: Waiting for all blocks to arrive. state_test.go:1656: Started to spin off, until predicate will be satisfied. state_test.go:1121: Trying to see all peers get all blocks state_test.go:1128: All peers have same ledger height!!! state_test.go:1661: Done. state_test.go:1671: Stop waiting until timeout or true testing.go:809: race detected during execution of test FAIL exit status 1 FAIL	github.com/hyperledger/fabric/gossip/state	470.182s  ></body> </Action>
