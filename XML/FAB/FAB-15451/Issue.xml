<Issue id="39818" key="FAB-15451" number="15451" project="10002" reporter="mhbauer" creator="mhbauer" type="10004" summary="TestMembershipConvergence races with TestIdentityExpiration" priority="3" resolution="10000" status="6" created="2019-05-14 22:10:15.0" updated="2020-03-25 21:13:19.0" resolutiondate="2020-03-25 21:13:19.0" votes="0" watches="1" workflowId="52712"> <description><! CDATA on a239ae0ab290618597c0b4f33ae9c2e8ee5ff102  First race looks like because they share access to: var expirationTimes = map string time.Time{}  The second race I've seen before all over. Is it is somehow a connection being shared? Either way, it has to do with the conn.stopWG.Add() being called after conn.stopWG.Wait() has 0.  https://golang.org/pkg/sync/#WaitGroup.Add  The two races: ================== WARNING: DATA RACE Write at 0x00c00021ab40 by goroutine 8: runtime.mapassign_faststr() /home/mhb/.go/src/runtime/map_faststr.go:202 +0x0 github.com/hyperledger/fabric/gossip/gossip.TestIdentityExpiration() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:1455 +0x511 testing.tRunner() /home/mhb/.go/src/testing/testing.go:865 +0x163  Previous read at 0x00c00021ab40 by goroutine 266: runtime.mapaccess2_faststr() /home/mhb/.go/src/runtime/map_faststr.go:107 +0x0 github.com/hyperledger/fabric/gossip/gossip.(*naiveCryptoService).Expiration() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:147 +0xe5 github.com/hyperledger/fabric/gossip/identity.(*identityMapperImpl).Put() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/identity/identity.go:113 +0xcf github.com/hyperledger/fabric/gossip/comm.(*commImpl).authenticateRemotePeer() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:449 +0x9c9 github.com/hyperledger/fabric/gossip/comm.(*commImpl).GossipStream() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:550 +0x18a github.com/hyperledger/fabric/protos/gossip._Gossip_GossipStream_Handler() /home/mhb/go/src/github.com/hyperledger/fabric/protos/gossip/message.pb.go:2758 +0xcd github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processStreamingRPC() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1176 +0x1669 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1256 +0x12e5 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:691 +0xac  Goroutine 8 (running) created at: testing.(*T).Run() /home/mhb/.go/src/testing/testing.go:916 +0x65a testing.runTests.func1() /home/mhb/.go/src/testing/testing.go:1157 +0xa8 testing.tRunner() /home/mhb/.go/src/testing/testing.go:865 +0x163 testing.runTests() /home/mhb/.go/src/testing/testing.go:1155 +0x523 testing.(*M).Run() /home/mhb/.go/src/testing/testing.go:1072 +0x2eb main.main() _testmain.go:96 +0x222  Goroutine 266 (running) created at: github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:689 +0xb8 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).operateHeaders() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:421 +0x1622 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).HandleStreams() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:461 +0x37a github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:687 +0x170 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleRawConn.func1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:649 +0x50 ==================   ================== WARNING: DATA RACE Write at 0x00c0002f75e0 by goroutine 1941: sync.(*WaitGroup).Wait() /home/mhb/.go/src/internal/race/race.go:41 +0xef github.com/hyperledger/fabric/gossip/comm.(*connection).close() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/conn.go:247 +0x1c7 github.com/hyperledger/fabric/gossip/comm.(*connectionStore).onConnected() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/conn.go:163 +0x70c github.com/hyperledger/fabric/gossip/comm.(*commImpl).GossipStream() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:557 +0x494 github.com/hyperledger/fabric/protos/gossip._Gossip_GossipStream_Handler() /home/mhb/go/src/github.com/hyperledger/fabric/protos/gossip/message.pb.go:2758 +0xcd github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processStreamingRPC() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1176 +0x1669 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1256 +0x12e5 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:691 +0xac  Previous read at 0x00c0002f75e0 by goroutine 2075: sync.(*WaitGroup).Add() /home/mhb/.go/src/internal/race/race.go:37 +0x169 github.com/hyperledger/fabric/gossip/comm.(*connection).serviceConnection() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/conn.go:297 +0xf4  Goroutine 1941 (running) created at: github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:689 +0xb8 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).operateHeaders() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:421 +0x1622 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).HandleStreams() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:461 +0x37a github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:687 +0x170 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleRawConn.func1() /home/mhb/go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:649 +0x50  Goroutine 2075 (finished) created at: github.com/hyperledger/fabric/gossip/comm.(*connectionStore).getConnection() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/conn.go:124 +0x878 github.com/hyperledger/fabric/gossip/comm.(*commImpl).sendToEndpoint() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:231 +0x2ce github.com/hyperledger/fabric/gossip/comm.(*commImpl).Send.func1() /home/mhb/go/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:218 +0x51 ==================   ></description> </Issue>
