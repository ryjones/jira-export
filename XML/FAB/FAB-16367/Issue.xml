<Issue id="41934" key="FAB-16367" number="16367" project="10002" reporter="abel23" creator="abel23" type="10004" summary="peer crashed while trying to add peer to a channel" priority="3" resolution="10203" status="6" created="2019-08-21 10:57:36.0" updated="2019-09-24 17:08:15.0" resolutiondate="2019-09-23 20:32:44.0" votes="0" watches="3" workflowId="54975"> <description><! CDATA I created a network using solo ordering consisting of 2 orgs. The network is similar to the one in BYFN example. 2 peers for each org. I created the ordering service , certificate authority for org1, peers for org1 on host 1 and the rest on host 2. The network is a docker network in overlay mode using docker swarm.  I created a channel in peer 1 of org 1 and joined that peer to that channel. I fetched the newest block from each of the other peers and used it to join the channel. In the case of peer 1 of org 1, the peer crashed.  The following were the output from the cli of peer1.org1.example.com {code:java} root@bc9e9fc55e86:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer channel fetch newest -o orderer.example.com:7050 -c mychannel --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 2019-08-21 10:06:45.669 UTC  channelCmd  InitCmdFactory -> INFO 001 Endorser and orderer connections initialized 2019-08-21 10:06:45.699 UTC  cli.common  readBlock -> INFO 002 Received block: 0 root@bc9e9fc55e86:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer channel join -b mychannel_newest.block  2019-08-21 10:06:53.265 UTC  channelCmd  InitCmdFactory -> INFO 001 Endorser and orderer connections initialized Error: proposal failed (err: bad proposal response 500: cannot create ledger from genesis block: error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:Database does not exist.) root@bc9e9fc55e86:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer channel join -b mychannel_newest.block  2019-08-21 10:07:10.860 UTC  channelCmd  InitCmdFactory -> INFO 001 Endorser and orderer connections initialized Error: proposal failed (err: rpc error: code = Unavailable desc = transport is closing) root@bc9e9fc55e86:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer channel join -b mychannel_newest.block  Error: error getting endorser client for channel: endorser client failed to connect to peer1.org1.example.com:8051: failed to create new connection: context deadline exceeded {code} The logs of peer1.org1.example.com are the following {code:java} 2019-08-21 10:07:11.677 UTC  couchdb  handleRequest -> DEBU 23f2 Exiting handleRequest() 2019-08-21 10:07:11.677 UTC  couchdb  EnsureFullCommit -> DEBU 23f3  mychannel_  Exiting EnsureFullCommit() 2019-08-21 10:07:11.677 UTC  couchdb  SaveDoc -> DEBU 23f4  mychannel_  Entering SaveDoc() id= statedb_savepoint  2019-08-21 10:07:11.677 UTC  couchdb  ReadDoc -> DEBU 23f5  mychannel_  Entering ReadDoc()  id= statedb_savepoint  2019-08-21 10:07:11.677 UTC  couchdb  WarmIndexAllIndexes -> DEBU 23f6  mychannel_  Entering WarmIndexAllIndexes() 2019-08-21 10:07:11.677 UTC  couchdb  handleRequest -> DEBU 23f7 Entering handleRequest()  method=GET  url=http://couchdb1:5984  dbName=mychannel_ 2019-08-21 10:07:11.677 UTC  couchdb  handleRequest -> DEBU 23f8 Request URL: http://couchdb1:5984/mychannel_/statedb_savepoint?attachments=true 2019-08-21 10:07:11.677 UTC  couchdb  ListIndex -> DEBU 23f9  %s  Entering ListIndex() mychannel_ 2019-08-21 10:07:11.678 UTC  couchdb  handleRequest -> DEBU 23fa Entering handleRequest()  method=GET  url=http://couchdb1:5984  dbName=mychannel_ 2019-08-21 10:07:11.678 UTC  couchdb  handleRequest -> DEBU 23fb Request URL: http://couchdb1:5984/mychannel_/_index 2019-08-21 10:07:11.678 UTC  couchdb  handleRequest -> DEBU 23fc HTTP Request: GET /mychannel_/statedb_savepoint?attachments=true HTTP/1.1 | Host: couchdb1:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Authorization: Basic dXZpb25pY3M6dXZpb25pY3MxMjM= | Accept-Encoding: gzip |  |  2019-08-21 10:07:11.678 UTC  couchdb  handleRequest -> DEBU 23fd HTTP Request: GET /mychannel_/_index HTTP/1.1 | Host: couchdb1:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Authorization: Basic dXZpb25pY3M6dXZpb25pY3MxMjM= | Accept-Encoding: gzip |  |  2019-08-21 10:07:11.681 UTC  couchdb  handleRequest -> DEBU 23fe Error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:missing 2019-08-21 10:07:11.681 UTC  couchdb  ReadDoc -> DEBU 23ff  mychannel_  Document not found (404), returning nil value instead of 404 error 2019-08-21 10:07:11.681 UTC  couchdb  handleRequest -> DEBU 2400 Entering handleRequest()  method=PUT  url=http://couchdb1:5984  dbName=mychannel_ 2019-08-21 10:07:11.681 UTC  couchdb  handleRequest -> DEBU 2401 Request URL: http://couchdb1:5984/mychannel_/statedb_savepoint 2019-08-21 10:07:11.681 UTC  couchdb  handleRequest -> DEBU 2402 HTTP Request: PUT /mychannel_/statedb_savepoint HTTP/1.1 | Host: couchdb1:5984 | User-Agent: Go-http-client/1.1 | Content-Length: 24 | Accept: application/json | Authorization: Basic dXZpb25pY3M6dXZpb25pY3MxMjM= | Content-Type: application/json | Accept-Encoding: gzip |  |  2019-08-21 10:07:11.701 UTC  couchdb  handleRequest -> DEBU 2403 Exiting handleRequest() 2019-08-21 10:07:11.701 UTC  couchdb  ListIndex -> DEBU 2404  mychannel_  Exiting ListIndex() 2019-08-21 10:07:11.701 UTC  couchdb  WarmIndexAllIndexes -> DEBU 2405  mychannel_  Exiting WarmIndexAllIndexes() 2019-08-21 10:07:11.740 UTC  couchdb  handleRequest -> DEBU 2406 Error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:Database does not exist. 2019-08-21 10:07:11.740 UTC  statecouchdb  ensureFullCommitAndRecordSavepoint -> ERRO 2407 Failed to save the savepoint to DB error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:Database does not exist. 2019-08-21 10:07:11.740 UTC  statecouchdb  ApplyUpdates -> ERRO 2408 Error during recordSavepoint: error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:Database does not exist. 2019-08-21 10:07:11.741 UTC  pvtstatepurgemgmt  prepareWorkingsetFor -> DEBU 2409 Preparing potential purge list working-set for expiringAtBlk  1  2019-08-21 10:07:11.741 UTC  leveldbhelper  GetIterator -> DEBU 240b Getting iterator for range    byte{0x6d, 0x79, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x30, 0x0, 0x31, 0x1, 0x1, 0x0}  -    byte{0x6d, 0x79, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x30, 0x0, 0x31, 0x1, 0x2, 0x0}  2019-08-21 10:07:11.741 UTC  statecouchdb  executeBatches -> DEBU 240c Executing batches =    2019-08-21 10:07:11.741 UTC  lockbasedtxmgr  func1 -> DEBU 240a launched the background routine for preparing keys to purge with the next block 2019-08-21 10:07:11.741 UTC  statecouchdb  LoadCommittedVersions -> DEBU 240d nsKeysMap=map   2019-08-21 10:07:11.741 UTC  statecouchdb  LoadCommittedVersions -> DEBU 240e nsMetadataMap=map   panic: error during commit to txmgr: error handling CouchDB request. Error:not_found,  Status Code:404,  Reason:Database does not exist. 	panic: runtime error: invalid memory address or nil pointer dereference  signal SIGSEGV: segmentation violation code=0x1 addr=0x28 pc=0xd15686 goroutine 1102  running : github.com/hyperledger/fabric/core/chaincode/shim.(*Handler).triggerNextState(0xc0022b1860, 0x0, 0xc0022d44e0) 	/opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/shim/handler.go:35 +0x26 github.com/hyperledger/fabric/core/chaincode/shim.(*Handler).handleTransaction.func1.1(0xc0022b1860, 0xc0024f1eb0, 0xc0022d44e0) 	/opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/shim/handler.go:247 +0x42 panic(0x10e5440, 0xc002bbe0e0) 	/opt/go/src/runtime/panic.go:513 +0x1b9 github.com/hyperledger/fabric/core/ledger/kvledger.(*kvLedger).CommitWithPvtData(0xc00221e5b0, 0xc002690840, 0xc0021b1380, 0x0, 0x0) 	/opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger.go:402 +0xd5b github.com/hyperledger/fabric/core/ledger/kvledger.(*Provider).Create(0xc0001ea240, 0xc0021f8880, 0x27, 0xc0024f17a8, 0x1, 0x1) 	/opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger_provider.go:132 +0x331 github.com/hyperledger/fabric/core/ledger/ledgermgmt.CreateLedger(0xc0021f8880, 0x0, 0x0, 0x0, 0x0) 	/opt/gopath/src/github.com/hyperledger/fabric/core/ledger/ledgermgmt/ledger_mgmt.go:102 +0x17b github.com/hyperledger/fabric/core/peer.CreateChainFromBlock(0xc0021f8880, 0x13ca500, 0xc0003d4238, 0x13d5e20, 0xc0004334a0, 0x1, 0x1) 	/opt/gopath/src/github.com/hyperledger/fabric/core/peer/peer.go:501 +0x7b github.com/hyperledger/fabric/core/scc/cscc.joinChain(0xc0021ff500, 0x9, 0xc0021f8880, 0x13ca500, 0xc0003d4238, 0x13d5e20, 0xc0004334a0, 0x0, 0x0, 0x0, ...) 	/opt/gopath/src/github.com/hyperledger/fabric/core/scc/cscc/configure.go:236 +0x79 github.com/hyperledger/fabric/core/scc/cscc.(*PeerConfiger).InvokeNoShim(0xc0004338b0, 0xc002b40e70, 0x2, 0x2, 0xc002714e60, 0x0, 0x0, 0x0, 0x0, 0x0, ...) 	/opt/gopath/src/github.com/hyperledger/fabric/core/scc/cscc/configure.go:164 +0x692 github.com/hyperledger/fabric/core/scc/cscc.(*PeerConfiger).Invoke(0xc0004338b0, 0x13e32e0, 0xc0021c5080, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...) 	/opt/gopath/src/github.com/hyperledger/fabric/core/scc/cscc/configure.go:120 +0x29b github.com/hyperledger/fabric/core/chaincode/shim.(*Handler).handleTransaction.func1(0xc0022b1860, 0xc0022d44e0, 0xc0003edf00) 	/opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/shim/handler.go:273 +0x4eb created by github.com/hyperledger/fabric/core/chaincode/shim.(*Handler).handleTransaction 	/opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/shim/handler.go:242 +0x53  {code} This caused the peer to crash. It was surprising to note that after i restarted the peer, i tried to fetch the newest block to join the channel. Then used "peer channel join -b mychannelnewest.block". the output was as follows {code:java} root@bc9e9fc55e86:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer channel join -b mychannel_newest.block  2019-08-21 10:50:17.449 UTC  channelCmd  InitCmdFactory -> INFO 001 Endorser and orderer connections initialized Error: proposal failed (err: bad proposal response 500: cannot create ledger from genesis block: LedgerID already exists)  {code} i then check "peer channel list" the output was as follows {code:java} 2019-08-21 10:50:28.999 UTC  channelCmd  InitCmdFactory -> INFO 001 Endorser and orderer connections initialized Channels peers has joined:  mychannel {code} The peer has already joined the channel. The cause of the crash has to be handled i guess. Are you guys aware of such an issue?     ></description> </Issue>
