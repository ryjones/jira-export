<Issue id="33051" key="FAB-11658" number="11658" project="10002" reporter="swetharepakula" assignee="swetharepakula" creator="swetharepakula" type="10004" summary="Certain keys cause errors when running shim.PutState" priority="3" resolution="10000" status="6" created="2018-08-20 19:32:35.0" updated="2018-09-03 19:57:34.0" resolutiondate="2018-09-03 19:57:34.0" votes="0" watches="1" workflowId="44257"> <description><! CDATA Certain keys have non UTF characters causing shim.GetState and shim.PutState to fail when using TLS.  Errors from the chaincode container {code:java} 2018-08-20 19:25:32.326 UTC  shim  handlePutState -> ERRO 001  2bd925ba Received ERROR. Payload: PUT_STATE failed: transaction ID: 2bd925bac22aa786a768ab18032fa1f227c4ae4dcbaff5bb1e3b64fad88aa995: unmarshal failed: proto: invalid UTF-8 string 2018-08-20 19:25:32.328 UTC  shim  handlePutState -> ERRO 002  2bd925ba Received ERROR. Payload: PUT_STATE failed: transaction ID: 2bd925bac22aa786a768ab18032fa1f227c4ae4dcbaff5bb1e3b64fad88aa995: unmarshal failed: proto: invalid UTF-8 string 2018-08-20 19:25:32.329 UTC  shim  handlePutState -> ERRO 003  2bd925ba Received ERROR. Payload: PUT_STATE failed: transaction ID: 2bd925bac22aa786a768ab18032fa1f227c4ae4dcbaff5bb1e3b64fad88aa995: unmarshal failed: proto: invalid UTF-8 string 2018-08-20 19:25:32.331 UTC  shim  handlePutState -> ERRO 004  2bd925ba Received ERROR. Payload: PUT_STATE failed: transaction ID: 2bd925bac22aa786a768ab18032fa1f227c4ae4dcbaff5bb1e3b64fad88aa995: unmarshal failed: proto: invalid UTF-8 string 2018-08-20 19:25:32.331 UTC  shim  handlePutState -> ERRO 005  2bd925ba Received ERROR. Payload: PUT_STATE failed: transaction ID: 2bd925bac22aa786a768ab18032fa1f227c4ae4dcbaff5bb1e3b64fad88aa995: unmarshal failed: proto: invalid UTF-8 string 2018-08-20 19:26:55.878 UTC  shim  handleGetState -> ERRO 006  72a9e3d2 GetState received error ERROR {code} Error message from peer cli: {code:java} Error: endorsement failure during query. response: status:500 message:"failed to execute contract: call error: GET_STATE failed: transaction ID: 72a9e3d23935898fe2b564bd195f043fd99ea52cfece2f7c12cc93492b8524cb: unmarshal failed: proto: invalid UTF-8 string"{code} Â   Steps to Reproduce:  1. Run a network with tls enabled and install the evmcc 2. Using the peer cli install the voting smart contract: {code:java} peer chaincode invoke -n evmcc -C mychannel --tls true --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/tlsca/tlsca.example.com-cert.pem -c '{"Args": "0000000000000000000000000000000000000000","608060405234801561001057600080fd5b50604051610d8b380380610d8b833981018060405281019080805182019291905050506000336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060018060008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000181905550600090505b81518110156101735760026040805190810160405280848481518110151561010657fe5b90602001906020020151600019168152602001600081525090806001815401808255809150509060018203906000526020600020906002020160009091929091909150600082015181600001906000191690556020820151816001015550505080806001019150506100e2565b5050610c07806101846000396000f30060806040526004361061008e576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630121b93f14610093578063013cf08b146100c05780632e4176cf146101105780635c19a95c14610167578063609ff1bd146101aa5780639e7b8d61146101d5578063a3ec138d14610218578063e2ba53f0146102b4575b600080fd5b34801561009f57600080fd5b506100be600480360381019080803590602001909291905050506102e7565b005b3480156100cc57600080fd5b506100eb6004803603810190808035906020019092919050505061040d565b6040518083600019166000191681526020018281526020019250505060405180910390f35b34801561011c57600080fd5b50610125610440565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561017357600080fd5b506101a8600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610465565b005b3480156101b657600080fd5b506101bf61088a565b6040518082815260200191505060405180910390f35b3480156101e157600080fd5b50610216600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610905565b005b34801561022457600080fd5b50610259600480360381019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610b4f565b60405180858152602001841515151581526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182815260200194505050505060405180910390f35b3480156102c057600080fd5b506102c9610bac565b60405180826000191660001916815260200191505060405180910390f35b6000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060010160009054906101000a900460ff161515156103b1576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252600e8152602001807f416c726561647920766f7465642e00000000000000000000000000000000000081525060200191505060405180910390fd5b60018160010160006101000a81548160ff02191690831515021790555081816002018190555080600001546002838154811015156103eb57fe5b9060005260206000209060020201600101600082825401925050819055505050565b60028181548110151561041c57fe5b90600052602060002090600202016000915090508060000154908060010154905082565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600080600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002091508160010160009054906101000a900460ff16151515610530576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260128152602001807f596f7520616c726561647920766f7465642e000000000000000000000000000081525060200191505060405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141515156105d4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f53656c662d64656c65676174696f6e20697320646973616c6c6f7765642e000081525060200191505060405180910390fd5b5b600073ffffffffffffffffffffffffffffffffffffffff16600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561077b57600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1692503373ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515610776576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260198152602001807f466f756e64206c6f6f7020696e2064656c65676174696f6e2e0000000000000081525060200191505060405180910390fd5b6105d5565b60018260010160006101000a81548160ff021916908315150217905550828260010160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002090508060010160009054906101000a900460ff161561086e5781600001546002826002015481548110151561084b57fe5b906000526020600020906002020160010160008282540192505081905550610885565b816000015481600001600082825401925050819055505b505050565b6000806000809150600090505b60028054905081101561090057816002828154811015156108b457fe5b90600052602060002090600202016001015411156108f3576002818154811015156108db57fe5b90600052602060002090600202016001015491508092505b8080600101915050610897565b505090565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156109ef576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260288152602001807f4f6e6c79206368616972706572736f6e2063616e20676976652072696768742081526020017f746f20766f74652e00000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600160008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060010160009054906101000a900460ff16151515610ab4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260188152602001807f54686520766f74657220616c726561647920766f7465642e000000000000000081525060200191505060405180910390fd5b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060000154141515610b0557600080fd5b60018060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018190555050565b60016020528060005260406000206000915090508060000154908060010160009054906101000a900460ff16908060010160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020154905084565b60006002610bb861088a565b815481101515610bc457fe5b9060005260206000209060020201600001549050905600a165627a7a72305820a9e475626173c5190d9a5bdfd9a0000a01dd17edee4803594abd1029361d068100290000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000261000000000000000000000000000000000000000000000000000000000000006200000000000000000000000000000000000000000000000000000000000000" }'{code} This step should cause errors to show up in the evmcc container logs. The output of this step will give the contract address in the payload for the next step.  3. Run `votingContract.proposals(0)` using the peer cli. Following is querying the first object of an array. {code:java} peer chaincode query -n evmcc -C mychannel -c '{"Args": "<previous-paylod>","013cf08b0000000000000000000000000000000000000000000000000000000000000000" }'{code}  This will cause an error the GetState error.  ></description> </Issue>
