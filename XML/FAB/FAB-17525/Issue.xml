<Issue id="44395" key="FAB-17525" number="17525" project="10002" reporter="denyeart" assignee="denyeart" creator="denyeart" type="10004" summary="Peer panic with &quot;panic: inconsistent label cardinality: expected 2 label values but got 0 in prometheus.Labels{}&quot;" priority="3" resolution="10000" status="6" created="2020-02-24 04:09:18.0" updated="2020-02-24 12:38:33.0" resolutiondate="2020-02-24 12:38:30.0" votes="0" watches="1" workflowId="58303" archived="N"> <description><! CDATA During integration test for FAB-17523 where peer fails to endorse, I saw peer panic with error "panic: inconsistent label cardinality: expected 2 label values but got 0 in prometheus.Labels{}".  The full message:   e  Org1.peer0  2020-02-23 22:41:15.141 EST  gossip.service  DistributePrivateData -> ERRO 0c6 failed to distribute private collection, txID c0178e7fb48d0f67865ce3508363c8ab3ea09390ae49ed4b4a407a1c8b27a465, channel testchannel: could not build private data dissemination plan for chaincode marblespHighRequiredPeerCount and collection collectionMarblePrivateDetails: required to disseminate to at least 10 peers, but know of only 2 eligible peers   e  Org1.peer0  panic: inconsistent label cardinality: expected 2 label values but got 0 in prometheus.Labels{}  e  Org1.peer0    e  Org1.peer0  goroutine 1137  running :  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/prometheus/client_golang/prometheus.(*CounterVec).With(0xc000010c88, 0xc002b5a210, 0x0, 0xc002b5a210)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/prometheus/client_golang/prometheus/counter.go:217 +0xc2  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/go-kit/kit/metrics/prometheus.(*Counter).Add(0xc002acd0a0, 0x3ff0000000000000)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/go-kit/kit/metrics/prometheus/prometheus.go:45 +0x5c  e  Org1.peer0  github.com/hyperledger/fabric/core/endorser.(*Endorser).SimulateProposal(0xc002ace540, 0xc002a54c00, 0xc0037091c0, 0x1d, 0xc002e39310, 0x0, 0x0, 0x0, 0x0, 0x0, ...)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:230 +0x7b9  e  Org1.peer0  github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposalSuccessfullyOrError(0xc002ace540, 0xc002e39360, 0x0, 0x0, 0x0)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:392 +0x433  e  Org1.peer0  github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposal(0xc002ace540, 0x518ea40, 0xc002e557a0, 0xc002e38d20, 0x0, 0x0, 0x0)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:335 +0x380  e  Org1.peer0  github.com/hyperledger/fabric/core/handlers/auth/filter.(*expirationCheckFilter).ProcessProposal(0xc002aca8e0, 0x518ea40, 0xc002e557a0, 0xc002e38d20, 0x4dbac20, 0x4008500, 0x6e28c78)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/expiration.go:61 +0x8f  e  Org1.peer0  github.com/hyperledger/fabric/core/handlers/auth/filter.(*filter).ProcessProposal(0xc002aca880, 0x518ea40, 0xc002e557a0, 0xc002e38d20, 0xc002aca880, 0xc002a33300, 0x203001)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/filter.go:32 +0x51  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler.func1(0x518ea40, 0xc002e557a0, 0x4ec7980, 0xc002e38d20, 0xc000137dc8, 0x1, 0x4f97c7d, 0x16)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:107 +0x86  e  Org1.peer0  github.com/hyperledger/fabric/internal/peer/node.unaryGrpcLimiter.func1(0x518ea40, 0xc002e557a0, 0x4ec7980, 0xc002e38d20, 0xc002a73560, 0xc002a73580, 0x0, 0x0, 0x0, 0x0)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/internal/peer/node/grpc_limiters.go:51 +0x3ab  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518ea40, 0xc002e557a0, 0x4ec7980, 0xc002e38d20, 0x0, 0xc002a736fe, 0x518ea40, 0xc002e557a0)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63  e  Org1.peer0  github.com/hyperledger/fabric/common/grpclogging.UnaryServerInterceptor.func1(0x518ea40, 0xc002e55620, 0x4ec7980, 0xc002e38d20, 0xc002a73560, 0xc002a735a0, 0x40cef86, 0x5e5345db, 0xc007a6cd20, 0x7cfb52e73a204)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpclogging/server.go:92 +0x286  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518ea40, 0xc002e55620, 0x4ec7980, 0xc002e38d20, 0x5170880, 0xc0029da6e0, 0x4e414c0, 0x2e738287)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63  e  Org1.peer0  github.com/hyperledger/fabric/common/grpcmetrics.UnaryServerInterceptor.func1(0x518ea40, 0xc002e55620, 0x4ec7980, 0xc002e38d20, 0xc002a73560, 0xc002a735c0, 0x45c27ea, 0x4e688c0, 0xc002a735e0, 0xc002a73560)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpcmetrics/interceptor.go:31 +0x1c9  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518ea40, 0xc002e55620, 0x4ec7980, 0xc002e38d20, 0xc00010bb00, 0xc002a73500, 0xc002c77a10, 0x400ef98)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1(0x518ea40, 0xc002e55620, 0x4ec7980, 0xc002e38d20, 0xc002a73560, 0xc002a73580, 0xc002c77a80, 0x41ec688, 0x4e9b280, 0xc002e55620)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:34 +0xd5  e  Org1.peer0  github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler(0x4dbac20, 0xc002aca880, 0x518ea40, 0xc002e55620, 0xc0032ae480, 0xc000406030, 0x518ea40, 0xc002e55620, 0xc003424f00, 0x4b4)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:109 +0x14b  e  Org1.peer0  github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processUnaryRPC(0xc000170000, 0x519d9e0, 0xc003864900, 0xc00010bb00, 0xc002a112c0, 0x5b2c080, 0xc002d68400, 0x0, 0x0)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:995 +0x460  e  Org1.peer0  github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream(0xc000170000, 0x519d9e0, 0xc003864900, 0xc00010bb00, 0xc002d68400)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1275 +0xd97  e  Org1.peer0  github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1(0xc000492484, 0xc000170000, 0x519d9e0, 0xc003864900, 0xc00010bb00)  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:710 +0xbb  e  Org1.peer0  created by github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1  e  Org1.peer0  	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:708 +0xa1   ></description> </Issue>
