<Issue id="40901" key="FAB-15865" number="15865" project="10002" reporter="xixuejia" creator="xixuejia" type="10002" summary="block/tx indexing should be optimized to improve performance" priority="3" resolution="10002" status="6" created="2019-07-03 09:11:45.0" updated="2019-07-31 13:37:12.0" resolutiondate="2019-07-31 13:37:12.0" votes="0" watches="3" workflowId="53858"> <description><! CDATA With the current fabric implementation, committing peer will receive new blocks from orderer or other peers in a fabric network. After receiving new blocks, committers will verify the new blocks and transactions mainly in two steps: - 1). Verify tx envelope, signature, endorsement policy, txId, txID duplicate in the same block(if this capacity is enabled) and txIds of already committed txs. This step verification is mostly done with multiple goroutines now. The result of duplicate txIds check is stored in  block metadata|https://github.com/hyperledger/fabric/blob/release-1.4/core/committer/txvalidator/validator.go#L229   - 2). MVCC check; save Block into filesystem; Store Block/tx indexes; etc... Indexing txIds in this step will check duplicate txIds again by querying committed txIds in goleveldb instead of reusing the txIds duplicate check result in step 1.  code here|https://github.com/hyperledger/fabric/blob/release-1.4/common/ledger/blkstorage/fsblkstorage/blockindex.go#L184-L204   Checking duplicate txIds by querying goleveldb sometimes is not efficient, especially when there are a lot of, say 2000, txs in a single Block. That means we need to do 2000 queries against goleveldb to verify duplicate txIds, assuming there's no duplicate txId in the same Block. There's no need to hit goleveldb in step 2 as we can simply get the duplicate check result from block metadata in step 1.  I did a preliminary test to verify the impact of duplicate check in step 2 and the results are listed below. _maxMessageCount: 2000_ 1. markDuplicateTxids by querying goleveldb {color:#4c9aff}_txs_per_block:2000,blocks:1313,block_commit_total:314ms,state_validation:99ms,block_commit:214ms,state_commit:0ms_{color} 2. markDuplicateTxids by reusing the block metadata {color:#4c9aff} _txs_per_block:2000,blocks:1368,block_commit_total:239ms,state_validation:101ms,block_commit:137ms,state_commit:0ms_{color}  The duration metrics were extracted from log messages printed by  fabric code|https://github.com/hyperledger/fabric/blob/release-1.4/core/ledger/kvledger/kv_ledger.go#L415 . The elapsed time for block commit is decreased by ~24%. And the txs committing rate on the committer is increased by ~23%-33% with sufficient cpu resource.  ></description> </Issue>
