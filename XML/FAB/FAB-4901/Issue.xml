<Issue id="18505" key="FAB-4901" number="4901" project="10002" reporter="c0rwin" assignee="c0rwin" creator="c0rwin" type="10004" summary="Harden delivery client service unavailable test" priority="3" resolution="10000" status="6" created="2017-06-21 07:58:34.0" updated="2018-07-20 14:13:32.0" resolutiondate="2017-06-28 12:29:22.0" votes="0" watches="1" workflowId="39211" security="10001"> <description><! CDATA There are couple of intermittent failure of the {{TestDeliverServiceServiceUnavailable}} test discovered lately in CI, here one of the console output evidences: https://jenkins.hyperledger.org/job/fabric-verify-x86_64/13672/console  The stack trace is:  {code} 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.741 UTC  msp  getMspConfig -> INFO 001 intermediate certs folder not found at  /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts: no such file or directory  00:35:58 unit-tests_1  | 2017-06-21 00:35:17.742 UTC  msp  getMspConfig -> INFO 002 crls folder not found at  /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/gopath/src/github.com/hyperledger/fabric/sampleconfig/msp/crls: no such file or directory  00:35:58 unit-tests_1  | 2017-06-21 00:35:17.809 UTC  deliveryClient  connect -> ERRO 003 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.809 UTC  deliveryClient  connect -> ERRO 004 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.810 UTC  deliveryClient  connect -> ERRO 005 Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.811 UTC  deliveryClient  connect -> ERRO 006 Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.812 UTC  deliveryClient  afterConnect -> ERRO 007 Failed setting up broadcast: Setup failed 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.812 UTC  deliveryClient  afterConnect -> ERRO 008 Failed setting up broadcast: Setup failed 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.814 UTC  deliveryClient  connect -> ERRO 009 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.814 UTC  deliveryClient  connect -> ERRO 00a Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 00b Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 00c Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 00d Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 00e Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 00f Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 010 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.815 UTC  deliveryClient  connect -> ERRO 011 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 012 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 013 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 014 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 015 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 016 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 017 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.816 UTC  deliveryClient  connect -> ERRO 018 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 019 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01a Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01b Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01c Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01d Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01e Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 01f Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.817 UTC  deliveryClient  connect -> ERRO 020 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 021 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 022 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 023 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 024 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 025 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 026 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 027 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.818 UTC  deliveryClient  connect -> ERRO 028 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.819 UTC  deliveryClient  connect -> ERRO 029 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.826 UTC  deliveryClient  connect -> ERRO 02a Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.826 UTC  deliveryClient  connect -> ERRO 02b Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.826 UTC  deliveryClient  connect -> ERRO 02c Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.826 UTC  deliveryClient  connect -> ERRO 02d Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:17.826 UTC  deliveryClient  connect -> ERRO 02e Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:19.327 UTC  deliveryClient  connect -> ERRO 02f Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:20.827 UTC  deliveryClient  connect -> ERRO 030 Failed obtaining connection: Failed connecting 00:35:58 unit-tests_1  | 2017-06-21 00:35:22.830 UTC  deliveryClient  connect -> ERRO 031 Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 00:35:58 unit-tests_1  | 2017-06-21 00:35:23.831 UTC  deliveryClient  connect -> ERRO 032 Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 00:35:58 unit-tests_1  | 2017-06-21 00:35:26.936 UTC  deliveryClient  StartDeliverForChannel -> ERRO 033 Delivery service - block provider already exists for TEST_CHAINID found, can't start delivery 00:35:58 unit-tests_1  | 2017-06-21 00:35:26.936 UTC  deliveryClient  StopDeliverForChannel -> ERRO 034 Delivery service - no block provider for TEST_CHAINID2 found, can't stop delivery 00:35:58 unit-tests_1  | 2017-06-21 00:35:28.447 UTC  deliveryClient  StartDeliverForChannel -> ERRO 035 Delivery service is stopping cannot join a new channel TEST_CHAINID 00:35:58 unit-tests_1  | 2017-06-21 00:35:28.447 UTC  deliveryClient  StopDeliverForChannel -> ERRO 036 Delivery service is stopping, cannot stop delivery for channel TEST_CHAINID 00:35:58 unit-tests_1  | 2017-06-21 00:35:33.433 UTC  blocksProvider  DeliverBlocks -> WARN 037  TEST_CHAINID  Receive error: Client is closing 00:35:58 unit-tests_1  | 2017-06-21 00:35:38.937 UTC  ConnProducer  NewConnection -> ERRO 038 Failed connecting to localhost:5612 , error: context deadline exceeded 00:35:58 unit-tests_1  | 2017-06-21 00:35:40.942 UTC  blocksProvider  DeliverBlocks -> WARN 039  TEST_CHAINID  Receive error: Client is closing 00:35:58 unit-tests_1  | 2017-06-21 00:35:47.444 UTC  blocksProvider  DeliverBlocks -> WARN 03a  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | 2017-06-21 00:35:47.546 UTC  blocksProvider  DeliverBlocks -> WARN 03b  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | 2017-06-21 00:35:47.750 UTC  blocksProvider  DeliverBlocks -> WARN 03c  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | 2017-06-21 00:35:48.152 UTC  blocksProvider  DeliverBlocks -> WARN 03d  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | 2017-06-21 00:35:48.954 UTC  blocksProvider  DeliverBlocks -> WARN 03e  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | 2017-06-21 00:35:50.556 UTC  blocksProvider  DeliverBlocks -> WARN 03f  TEST_CHAINID  Got error &{SERVICE_UNAVAILABLE} 00:35:58 unit-tests_1  | --- FAIL: TestDeliverServiceServiceUnavailable (12.50s) 00:35:58 unit-tests_1  | 	assertions.go:225:   	Error Trace:	deliveryclient_test.go:429 00:35:58 unit-tests_1  | 		 			deliveryclient_test.go:304 00:35:58 unit-tests_1  | 		 	Error:		Didn't gossip a new block within a timely manner 00:35:58 unit-tests_1  | 		 00:35:58 unit-tests_1  | 2017-06-21 00:35:54.952 UTC  blocksProvider  DeliverBlocks -> WARN 040  TEST_CHAINID  Receive error: Client is closing 00:35:58 unit-tests_1  | FAIL 00:35:58 unit-tests_1  | coverage: 91.8% of statements 00:35:58 unit-tests_1  | FAIL	github.com/hyperledger/fabric/core/deliverservice	40.758s 00:35:58 unit-tests_1  | error: exit status 1 00:35:58 unit-tests_1  | panic: EOF 00:35:58 unit-tests_1  |  00:35:58 unit-tests_1  | goroutine 1  running : 00:35:58 unit-tests_1  | panic(0x4daca0, 0xc42006a020) 00:35:58 unit-tests_1  | 	/opt/go/src/runtime/panic.go:500 +0x1a1 00:35:58 unit-tests_1  | main.main() 00:35:58 unit-tests_1  | 	/opt/gotools/obj/gopath/src/github.com/AlekSi/gocov-xml/gocov-xml.go:60 +0x15fd 00:35:58 unittest_unit-tests_1 exited with code 2 00:35:58 Stopping couchdb ...  00:35:58 Stopping unittest_vp_1 ...  00:35:59  Stopping unittest_vp_1 ... done  Stopping couchdb ... done {code}  ></description> </Issue>
