<Issue id="29397" key="FAB-9515" number="9515" project="10002" reporter="yacovm" assignee="yacovm" creator="yacovm" type="10001" summary="MSP cache doesn&apos;t cache indirect calls to SatisfiesPrincipal" priority="3" resolution="10000" status="6" created="2018-04-13 23:56:03.0" updated="2018-07-20 18:49:44.0" resolutiondate="2018-04-18 14:16:03.0" votes="0" watches="2" workflowId="41840"> <description><! CDATA The MSP cache, caches the invocation of *SatisfiesPrincipal*, however - many of the invocations of *SatisfiesPrincipal* are invoked indirectly via the identities that the MSP returns via *DeserializeIdentity()*, and these invocations are *not* cached, because the bccsp msp's identity simply invokes the bccsp MSP's *SatisfiesPrincipal()* which bypasses the cache. {code:java} func (id *identity) SatisfiesPrincipal(principal *msp.MSPPrincipal) error { 	return id.msp.SatisfiesPrincipal(id, principal) } {code} The following test: {code:java} func TestSatisfiesPrincipalIndirectCall(t *testing.T) { 	mockMSP := &mocks.MockMSP{} 	mockMSPPrincipal := &msp2.MSPPrincipal{PrincipalClassification: msp2.MSPPrincipal_IDENTITY, Principal:   byte{1, 2, 3}}  	mockIdentity := &mocks.MockIdentity{ID: "Alice"} 	mockIdentity.On("SatisfiesPrincipal", mockMSPPrincipal).Run(func(_ mock.Arguments) { 		panic("shouldn't have invoked the identity method") 	}) 	mockIdentity.On("GetIdentifier").Return(&msp.IdentityIdentifier{Mspid: "MSP", Id: "Alice"}) 	mockMSP.On("SatisfiesPrincipal", mockIdentity, mockMSPPrincipal).Return(nil).Once() 	mockMSP.On("DeserializeIdentity", mock.Anything).Return(mockIdentity, nil).Once()  	cache, err := New(mockMSP) 	assert.NoError(t, err)  	cache.SatisfiesPrincipal(mockIdentity, mockMSPPrincipal) 	identity, err := cache.DeserializeIdentity(  byte{1,2,3}) 	assert.NoError(t, err) 	identity.SatisfiesPrincipal(mockMSPPrincipal) } {code} fails, and demonstrates this. Had the *SatisfiesPrincipal*() method been cached for the identity, it would not have run the method of the identity. {code:java} --- FAIL: TestSatisfiesPrincipalIndirectCall (0.00s) panic: shouldn't have invoked the identity method  recovered  {code}  ></description> </Issue>
