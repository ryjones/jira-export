<Issue id="42364" key="FAB-16611" number="16611" project="10002" reporter="silentspark" creator="silentspark" type="10004" summary="peer crash due to couch db timeout response" priority="2" resolution="10201" status="6" created="2019-09-16 10:21:05.0" updated="2020-11-19 22:16:07.0" resolutiondate="2020-11-19 21:04:30.0" votes="0" watches="7" workflowId="55420"> <description><! CDATA During block commit, couchdb somehow gets timeout but doesn't accept {{it}} as a possible response, then peer fails to process this response and crash.  There's a  couchdb fix|https://github.com/apache/couchdb/pull/2153  available but is not in release so far.  Fabric needs to package new couchdb image or tolerate the "invalid" response from couchdb.  peer fails with below error:    {code:java} 2019-09-10 07:34:40.768 UTC  gossip.state  commitBlock -> ERRO 231f Got error while committing(invalid byte in chunk length error reading response body github.com/hyperledger/fabric/core/ledger/util/couchdb.(*CouchDatabase).BatchRetrieveDocumentMetadata /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/util/couchdb/couchdb.go:1471 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.(*subNsMetadataRetriever).execute /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/metadata_retrieval.go:92 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.executeBatches /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/batch_util.go:26 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.retrieveNsMetadata /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/metadata_retrieval.go:67 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.(*nsMetadataRetriever).execute /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/metadata_retrieval.go:80 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.executeBatches.func1 /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/batch_util.go:35 runtime.goexit /opt/go/src/runtime/asm_amd64.s:1333 commit failed{code} couch db issues below error    {code:java} {"log":" error  2019-09-10T07:34:40.768246Z nonode@nohost \u003c0.5060.31\u003e 98bbb4d3fc req_err(1114665363) badmatch : timeout\n","stream":"stderr","time":"2019-09-10T07:34:40.769884261Z"} {"log":"     \u003c\u003c\"fabric_view_all_docs:go/5 L107\"\u003e\u003e,\u003c\u003c\"chttpd_db:all_docs_view/4 L690\"\u003e\u003e,\u003c\u003c\"chttpd:handle_req_after_auth/2 L317\"\u003e\u003e,\u003c\u003c\"chttpd:process_request/1 L300\"\u003e\u003e,\u003c\u003c\"chttpd:handle_request_int/1 L240\"\u003e\u003e,\u003c\u003c\"mochiweb_http:headers/6 L124\"\u003e\u003e,\u003c\u003c\"proc_lib:init_p_do_apply/3 L240\"\u003e\u003e \n","stream":"stderr","time":"2019-09-10T07:34:40.769897024Z"} {code}       ></description> </Issue>
