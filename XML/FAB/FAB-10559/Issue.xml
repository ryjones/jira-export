<Issue id="30914" key="FAB-10559" number="10559" project="10002" reporter="denyeart" assignee="senthil1" creator="denyeart" type="10004" summary="Errors in peer log when doing CouchDB JSON queries against private data" priority="3" resolution="10000" status="6" created="2018-06-06 10:40:23.0" updated="2018-07-20 14:16:55.0" resolutiondate="2018-06-15 09:36:29.0" votes="0" watches="1" workflowId="42417"> <description><! CDATA When testing private data against CouchDB as documented in FAB-10162, CouchDB JSON queries work against private data, however in the peer log we get error messages.  Sample query:  peer chaincode {color:#000000}query{color} {color:#000000}-C mycp{color} -n marbles{color:#000000}p{color} -c '\{"Args": "{color:#000000}query{color}Marbles{color:#000000}By{color}Owner","{color:#000000}tom{color}" }'  Sample peer log with errors: {code:java} 2018-06-06 06:28:43.941 EDT  couchdb  QueryDocuments -> DEBU 90d Adding json docment for id: marble1 2018-06-06 06:28:43.941 EDT  couchdb  QueryDocuments -> DEBU 90e Exiting QueryDocuments() 2018-06-06 06:28:43.941 EDT  statecouchdb  ExecuteQuery -> DEBU 90f Exiting ExecuteQuery 2018-06-06 06:28:43.941 EDT  chaincode  HandleGetQueryResult -> DEBU 910 Got keys and values. Sending RESPONSE 2018-06-06 06:28:43.941 EDT  chaincode  HandleTransaction -> DEBU 911  9a962e30  Completed GET_QUERY_RESULT. Sending RESPONSE 2018-06-06 06:28:43.942 EDT  chaincode  handleMessage -> DEBU 912  mycp  Fabric side handling ChaincodeMessage of type: QUERY_STATE_CLOSE in state ready 2018-06-06 06:28:43.942 EDT  chaincode  HandleTransaction -> DEBU 913  mycp  handling QUERY_STATE_CLOSE from chaincode 2018-06-06 06:28:43.942 EDT  chaincode  isValidTxSim -> ERRO 914 no ledger context github.com/hyperledger/fabric/core/chaincode.(*Handler).isValidTxSim     /Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/handler.go:503 github.com/hyperledger/fabric/core/chaincode.(*Handler).HandleTransaction     /Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/handler.go:237 runtime.goexit     /usr/local/go/src/runtime/asm_amd64.s:2361 2018-06-06 06:28:43.942 EDT  chaincode  HandleTransaction -> ERRO 915  mycp  Failed to handle QUERY_STATE_CLOSE. error: no ledger context github.com/hyperledger/fabric/core/chaincode.(*Handler).isValidTxSim     /Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/handler.go:503 github.com/hyperledger/fabric/core/chaincode.(*Handler).HandleTransaction     /Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/handler.go:237 runtime.goexit     /usr/local/go/src/runtime/asm_amd64.s:2361 QUERY_STATE_CLOSE failed: transaction ID: mycp github.com/hyperledger/fabric/core/chaincode.(*Handler).HandleTransaction     /Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/handler.go:246 runtime.goexit     /usr/local/go/src/runtime/asm_amd64.s:2361 2018-06-06 06:28:43.942 EDT  chaincode  HandleTransaction -> DEBU 916  mycp  Completed QUERY_STATE_CLOSE. Sending ERROR 2018-06-06 06:28:43.943 EDT  chaincode  handleMessage -> DEBU 917  9a962e30  Fabric side handling ChaincodeMessage of type: COMPLETED in state ready 2018-06-06 06:28:43.943 EDT  chaincode  Notify -> DEBU 918  9a962e30  notifying Txid:9a962e30b5c97ab77ed46115ef4458555936694011696da9febd1c62dc15aec7, channelID:mycp 2018-06-06 06:28:43.943 EDT  chaincode  Execute -> DEBU 919 Exit 2018-06-06 06:28:43.943 EDT  endorser  callChaincode -> DEBU 91a  mycp  9a962e30b5c97ab77ed46115ef4458555936694011696da9febd1c62dc15aec7  Exit 2018-06-06 06:28:43.943 EDT  lockbasedtxmgr  GetTxSimulationResults -> DEBU 91b Simulation completed, getting simulation results 2018-06-06 06:28:43.943 EDT  lockbasedtxmgr  Done -> DEBU 91c Done with transaction simulation / query execution  9a962e30b5c97ab77ed46115ef4458555936694011696da9febd1c62dc15aec7 {code} The same query against normal channel data works without the error messages in peer log: {code:java} 2018-06-06 06:27:30.717 EDT  couchdb  QueryDocuments -> DEBU 8a9 Adding json docment for id: marble1 2018-06-06 06:27:30.717 EDT  couchdb  QueryDocuments -> DEBU 8aa Exiting QueryDocuments() 2018-06-06 06:27:30.717 EDT  statecouchdb  ExecuteQuery -> DEBU 8ab Exiting ExecuteQuery 2018-06-06 06:27:30.717 EDT  lockbasedtxmgr  Next -> DEBU 8ac queryResultsItr.Next() returned a record:{"color":"blue","docType":"marble","name":"marble1","owner":"tom","size":35} 2018-06-06 06:27:30.717 EDT  chaincode  HandleGetQueryResult -> DEBU 8ad Got keys and values. Sending RESPONSE 2018-06-06 06:27:30.717 EDT  chaincode  HandleTransaction -> DEBU 8ae  c6c4046a  Completed GET_QUERY_RESULT. Sending RESPONSE 2018-06-06 06:27:30.717 EDT  chaincode  handleMessage -> DEBU 8af  c6c4046a  Fabric side handling ChaincodeMessage of type: QUERY_STATE_CLOSE in state ready 2018-06-06 06:27:30.718 EDT  chaincode  HandleTransaction -> DEBU 8b0  c6c4046a  handling QUERY_STATE_CLOSE from chaincode 2018-06-06 06:27:30.718 EDT  chaincode  HandleTransaction -> DEBU 8b1  c6c4046a  Completed QUERY_STATE_CLOSE. Sending RESPONSE 2018-06-06 06:27:30.718 EDT  chaincode  handleMessage -> DEBU 8b2  c6c4046a  Fabric side handling ChaincodeMessage of type: COMPLETED in state ready 2018-06-06 06:27:30.718 EDT  chaincode  Notify -> DEBU 8b3  c6c4046a  notifying Txid:c6c4046ac565f329c82ec77f60d3b980ca22b4fe7fc2a448346baa5eb1c2994b, channelID:myc 2018-06-06 06:27:30.718 EDT  chaincode  Execute -> DEBU 8b4 Exit 2018-06-06 06:27:30.718 EDT  endorser  callChaincode -> DEBU 8b5  myc  c6c4046ac565f329c82ec77f60d3b980ca22b4fe7fc2a448346baa5eb1c2994b  Exit 2018-06-06 06:27:30.718 EDT  lockbasedtxmgr  GetTxSimulationResults -> DEBU 8b6 Simulation completed, getting simulation results{code}  ></description> </Issue>
