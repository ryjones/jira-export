<Issue id="19317" key="FAB-5353" number="5353" project="10002" reporter="denyeart" assignee="c0rwin" creator="denyeart" type="10004" summary="Block validation logic is not deterministic with respect to error handling" priority="2" resolution="10000" status="6" created="2017-07-18 10:13:59.0" updated="2018-07-20 14:13:47.0" resolutiondate="2017-07-25 11:40:53.0" votes="0" watches="4" workflowId="39473"> <description><! CDATA If an unexpected error occurs during block validation for a certain transaction, the transaction will get marked as invalid and processing will continue, the block will get committed with the tran marked invalid.  Other peers that do not hit the unexpected error will pass validation and the block will get committed with the tran marked valid. Valid trans will cause state db to get updated. Invalid trans will not update state db.  txvalidator needs to carefully distinguish between unexpected errors and invalidations, to ensure deterministic behavior across peers.  Unexpected errors should result in a peer panic so that an administrator can identify the problem.  One specific example of the problem has been found, although there may be others.  In the specific example, if the state database is unavailable (e.g. couchdb container stopped), then VSCCValidateTx() returns an error and the Validate function simply marks the tran as invalid and continues.  VSCCValidateTx() should distinguish between normal invalidations and unexpected errors, and then the Validate function should panic if an unexpected error is hit.  Here is the peer log entry for this scenario:  {code} 2017-07-18 08:44:49.964 UTC  txvalidator  GetInfoForValidate -> ERRO 5f6 Unable to get chaincode data from ledger for txid 6b975cc80cf0605188460b6e9b9a15b6d102e5d9c5b25fbcda3538b335cf7963, due to Could not retrieve state for chaincode marbles, error Get  http://127.0.0.1:5984/myc/lscc%00marbles?attachments=true:  dial tcp 127.0.0.1:5984: getsockopt: connection refused 2017-07-18 08:44:49.964 UTC  txvalidator  VSCCValidateTx -> ERRO 5f7 GetInfoForValidate for txId = 6b975cc80cf0605188460b6e9b9a15b6d102e5d9c5b25fbcda3538b335cf7963 returned error Could not retrieve state for chaincode marbles, error Get  http://127.0.0.1:5984/myc/lscc%00marbles?attachments=true:  dial tcp 127.0.0.1:5984: getsockopt: connection refused 2017-07-18 08:44:49.964 UTC  txvalidator  Validate -> ERRO 5f8 VSCCValidateTx for transaction txId = 6b975cc80cf0605188460b6e9b9a15b6d102e5d9c5b25fbcda3538b335cf7963 returned error Could not retrieve state for chaincode marbles, error Get  http://127.0.0.1:5984/myc/lscc%00marbles?attachments=true:  dial tcp 127.0.0.1:5984: getsockopt: connection refused {code}     ></description> </Issue>
