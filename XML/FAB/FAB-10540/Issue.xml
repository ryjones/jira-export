<Issue id="30879" key="FAB-10540" number="10540" project="10002" reporter="luoguohui" assignee="sykesm" creator="luoguohui" type="10004" summary="user cc works,but qscc invoke timeout" priority="1" resolution="10000" status="6" created="2018-06-05 04:00:41.0" updated="2019-05-07 14:10:11.0" duedate="2018-06-05 00:00:00.0" resolutiondate="2018-08-30 11:49:27.0" votes="0" watches="10" workflowId="42408"> <environment><! CDATA Ubuntu 16.04 TLS  Fabric v1.1.0  ></environment> <description><! CDATA *We wrote a chaincode and then used a test script to invoke chaincode's insert data function 10 times per second. At the same time, the test script will call the "GetTransactionByID" function of the system chaincode qscc. At this time, there may be the following error:*  test_net_peer0_org1 |2018-06-02 07:29:56.563 UTC  endorser  simulateProposal -> ERRO 39c3 notaryinfochannel  61d0b2ba  failed to invoke chaincode name:"qscc" , error: timeout expired while executing transaction test_net_peer0_org1 |github.com/hyperledger/fabric/core/chaincode.(*ChaincodeSupport).Execute test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:813 test_net_peer0_org1 |github.com/hyperledger/fabric/core/chaincode.Execute test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/exectransaction.go:58 test_net_peer0_org1 |github.com/hyperledger/fabric/core/chaincode.ExecuteChaincode test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/chaincode/chaincodeexec.go:85 test_net_peer0_org1 |github.com/hyperledger/fabric/core/endorser.(*SupportImpl).Execute test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/endorser/support.go:93 test_net_peer0_org1 |github.com/hyperledger/fabric/core/endorser.(*Endorser).callChaincode test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/endorser/endorser.go:132 test_net_peer0_org1 |github.com/hyperledger/fabric/core/endorser.(*Endorser).simulateProposal test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/endorser/endorser.go:265 test_net_peer0_org1 |github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposal test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/endorser/endorser.go:491 test_net_peer0_org1 |github.com/hyperledger/fabric/core/handlers/auth/filter.(*expirationCheckFilter).ProcessProposal test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/handlers/auth/filter/expiration.go:61 test_net_peer0_org1 |github.com/hyperledger/fabric/core/handlers/auth/filter.(*filter).ProcessProposal test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/core/handlers/auth/filter/filter.go:31 test_net_peer0_org1 |github.com/hyperledger/fabric/protos/peer._Endorser_ProcessProposal_Handler test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/protos/peer/peer.pb.go:112 test_net_peer0_org1 |github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processUnaryRPC test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:781 test_net_peer0_org1 |github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:981 test_net_peer0_org1 |github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1 test_net_peer0_org1 | /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:551 test_net_peer0_org1 |runtime.goexit test_net_peer0_org1 | /opt/go/src/runtime/asm_amd64.s:2337 test_net_peer0_org1 |failed to execute transaction test_net_peer0_org1 |error executing chaincode      *We analyzed the log file and I think there is a deadlock problem. blockAPIsRWLock and commitRWLock are locked for 30 seconds*  blockAPIsRWLock - lock success 18654 test_net_peer0_org1 |2018-06-02 07:29:26.557 UTC  kvledger  CommitWithPvtData -> DEBU 3854 Channel  notaryinfochannel : Committing block  97  to storage  commitRWLock - read lock success 18670 test_net_peer0_org1 |2018-06-02 07:29:26.562 UTC  lockbasedtxmgr  NewTxSimulator -> DEBU 3860 constructing new tx simulator  blockApisRWLock - try to get read lock, wait 18695 test_net_peer0_org1 |2018-06-02 07:29:26.563 UTC  qscc  getTransactionByID -> DEBU 3876 Invoke function: GetTransactionByID on chain: 235f7b2e3e332ca86739c864420d3d38540435f483cf47c1d91b6dc6eb427f77, step: getTransactionByID  commitRWLock - try to get lock, wait 19078 test_net_peer0_org1 |2018-06-02 07:29:26.805 UTC  lockbasedtxmgr  Commit -> DEBU 3997 Committing updates to state database  ------------------ 30s ---------------------  19515 test_net_peer0_org1 |2018-06-02 07:29:56.563 UTC  lockbasedtxmgr  Done -> DEBU 39c5 Done with transaction simulation / query execution  61d0b2badbe2a64aa5513a485cbb9eb9aee3771f59edade8840d41f5e6e20c74  commitRWLock - read unlock, because of timeout  commitRWLock - lock success 19517 test_net_peer0_org1 |2018-06-02 07:29:56.563 UTC  lockbasedtxmgr  Commit -> DEBU 39c7 Write lock acquired for committing updates to state database  19531 test_net_peer0_org1 |2018-06-02 07:29:56.601 UTC  kvledger  CommitWithPvtData -> DEBU 39d5 Channel  notaryinfochannel : Committing block  97  transactions to history database blockApisRWLock - unlock  19582 test_net_peer0_org1 |2018-06-02 07:29:56.601 UTC  lockbasedtxmgr  Commit -> DEBU 39d2 Updates committed to state database commitRWLock - unlock  20018 test_net_peer0_org1 |2018-06-02 07:29:56.635 UTC  qscc  getTransactionByID -> DEBU 3b46 Invoke function: GetTransactionByID on chain: 235f7b2e3e332ca86739c864420d3d38540435f483cf47c1d91b6dc6eb427f77, step: vledger.GetTransactionByID blockApisRWLock - read lock success blockApisRWLock - read unlock     ******************************  *the following is the bug description*:   *my operation*: _peer chaincode query -C mychannel -n qscc -c '  {"Args": "GetBlockByNumber","mychannel","1" }  '_ （docker command line operation ）  *result:*  _Error: endorsement failure during query. response: status:500 message:"failed to execute transaction 5270da85cb878e93eb503db6e6d191a55aa760dd4318ebf08488c2ff1157205f: error sending: timeout expired while executing transaction"_  *_other information:_*  1. my chaincode `invoke` and `query` works                                    2. my peer contains up 3 weeks, and it worked (chaincode including qscc invoke) until today  ></description> </Issue>
