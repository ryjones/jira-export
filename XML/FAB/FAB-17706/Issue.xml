<Issue id="44730" key="FAB-17706" number="17706" project="10002" reporter="denyeart" creator="denyeart" type="10004" summary="grpc disconnect after 40 seconds when using grpc 1.25.0 through 1.28.0" priority="2" resolution="10000" status="6" created="2020-04-03 05:25:30.0" updated="2020-04-06 12:09:51.0" resolutiondate="2020-04-03 13:18:30.0" votes="0" watches="2" workflowId="58649" archived="N"> <description><! CDATA When using java chaincode or node chaincode, chaincode image build takes a long time.  After exactly 40 seconds, peer lifecycle chaincode install fails with following errors: {code:java} 2020-04-03 04:11:14.431 UTC  grpc  infof -> DEBU 038 Client received GoAway with http2.ErrCodeEnhanceYourCalm. 2020-04-03 04:11:14.432 UTC  grpc  infof -> DEBU 039 transport: loopyWriter.run returning. connection error: desc = "transport is closing" 2020-04-03 04:11:14.431 UTC  grpc  Infof -> DEBU 03a Subchannel Connectivity change to CONNECTING 2020-04-03 04:11:14.432 UTC  grpc  Infof -> DEBU 03b Subchannel picks a new address "peer0.org1.example.com:7051" to connect 2020-04-03 04:11:14.432 UTC  grpc  UpdateSubConnState -> DEBU 03c pickfirstBalancer: HandleSubConnStateChange: 0xc000422a80, {CONNECTING <nil>} 2020-04-03 04:11:14.432 UTC  grpc  Infof -> DEBU 03d Channel Connectivity change to CONNECTING 2020-04-03 04:11:14.437 UTC  grpc  Infof -> DEBU 03e Subchannel Connectivity change to READY 2020-04-03 04:11:14.437 UTC  grpc  UpdateSubConnState -> DEBU 03f pickfirstBalancer: HandleSubConnStateChange: 0xc000422a80, {READY <nil>} 2020-04-03 04:11:14.437 UTC  grpc  Infof -> DEBU 040 Channel Connectivity change to READY 2020-04-03 04:11:14.439 UTC  grpc  infof -> DEBU 041 Client received GoAway with http2.ErrCodeEnhanceYourCalm. 2020-04-03 04:11:14.439 UTC  grpc  Infof -> DEBU 042 Subchannel Connectivity change to CONNECTING 2020-04-03 04:11:14.440 UTC  grpc  UpdateSubConnState -> DEBU 043 pickfirstBalancer: HandleSubConnStateChange: 0xc000071990, {CONNECTING <nil>} 2020-04-03 04:11:14.440 UTC  grpc  Infof -> DEBU 044 Channel Connectivity change to CONNECTING Error: failed to endorse chaincode install: rpc error: code = Unavailable desc = transport is closing 2020-04-03 04:11:14.440 UTC  grpc  infof -> DEBU 045 transport: loopyWriter.run returning. connection error: desc = "transport is closing" !!!!!!!!!!!!!!! Chaincode installation on peer0.org1 has failed !!!!!!!!!!!!!!!! {code} Meanwhile peer shows the following errors: {code:java} 2020-04-03 04:11:14.430 UTC  grpc  errorf -> DEBU 351 transport: Got too many pings from the client, closing the connection. 2020-04-03 04:11:14.431 UTC  grpc  errorf -> DEBU 352 transport: loopyWriter.run returning. Err: transport: Connection closing 2020-04-03 04:11:14.439 UTC  grpc  errorf -> DEBU 353 transport: Got too many pings from the client, closing the connection. 2020-04-03 04:11:14.439 UTC  grpc  errorf -> DEBU 354 transport: loopyWriter.run returning. Err: transport: Connection closing 2020-04-03 04:11:14.440 UTC  grpc  warningf -> DEBU 355 transport: http2Server.HandleStreams failed to read frame: read tcp 192.168.192.4:7051->192.168.192.11:34836: use of closed network connection 2020-04-03 04:11:14.443 UTC  grpc  infof -> DEBU 356 transport: loopyWriter.run returning. connection error: desc = "transport is closing" {code} I tracked the problem down, it is due to keepalive ping behavior change in google.golang.org/grpc 1.25.0. Specifically change  https://github.com/grpc/grpc-go/pull/3102 . grpc default keepalive timeout is 20s, so likely related to multiples of this timeout value (40s). With google.golang.org/grpc commits prior to this change, the issue does not occur.  The Fabric issue was introduced in  https://github.com/hyperledger/fabric/pull/930  which updated grpc from 1.24.0 to 1.28.0.   Â   ></description> </Issue>
