<Issue id="31185" key="FAB-10718" number="10718" project="10002" reporter="sykesm" assignee="sykesm" creator="sykesm" type="10003" summary="Data race modifying viper config in TestDeliverServiceDisconnectReconnect" priority="4" resolution="10000" status="6" created="2018-06-19 20:00:51.0" updated="2018-07-20 14:16:59.0" resolutiondate="2018-07-02 12:06:24.0" votes="0" watches="1" workflowId="42486"> <description><! CDATA Basic maps are not safe for concurrent modification. Viper has no serialization around its configuration. The production code relies on go routines and is lazily getting configuration at runtime (instead of being told the values to use at instantiation). Result: races. {code:java} WARNING: DATA RACE Write at 0x00c4200f7048 by goroutine 18:   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:772 +0xd9   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:768 +0x72   github.com/hyperledger/fabric/core/deliverservice.TestDeliverServiceDisconnectReconnect.func1()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:564 +0x67   github.com/hyperledger/fabric/core/deliverservice.TestDeliverServiceDisconnectReconnect()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:612 +0x82c   testing.tRunner()       /usr/local/Cellar/go/1.10.3/libexec/src/testing/testing.go:777 +0x16d  Previous read at 0x00c4200f7048 by goroutine 73:   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).find()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:628 +0x189   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Get()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:404 +0x106   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).GetDuration()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:481 +0x4c   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.GetDuration()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:479 +0x5e   github.com/hyperledger/fabric/gossip/util.GetDurationOrDefault()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/util/misc.go:177 +0x87   github.com/hyperledger/fabric/core/deliverservice.getReConnectTotalTimeThreshold()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:41 +0x52   github.com/hyperledger/fabric/core/deliverservice.(*deliverServiceImpl).newClient.func2()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:225 +0x33   github.com/hyperledger/fabric/core/deliverservice.(*broadcastClient).try()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/client.go:94 +0x1fe   github.com/hyperledger/fabric/core/deliverservice.(*broadcastClient).Recv()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/client.go:58 +0x7b   github.com/hyperledger/fabric/core/deliverservice/blocksprovider.(*blocksProviderImpl).DeliverBlocks()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/blocksprovider/blocksprovider.go:131 +0xeb   github.com/hyperledger/fabric/core/deliverservice.(*deliverServiceImpl).launchBlockProvider()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:179 +0x26f{code} and {code:java} WARNING: DATA RACE Write at 0x00c4201c1080 by goroutine 18:   runtime.mapassign_faststr()       /usr/local/Cellar/go/1.10.3/libexec/src/runtime/hashmap_fast.go:694 +0x0   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:772 +0xc6   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:768 +0x72   github.com/hyperledger/fabric/core/deliverservice.TestDeliverServiceDisconnectReconnect.func1()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:564 +0x67   github.com/hyperledger/fabric/core/deliverservice.TestDeliverServiceDisconnectReconnect()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:612 +0x82c   testing.tRunner()       /usr/local/Cellar/go/1.10.3/libexec/src/testing/testing.go:777 +0x16d  Previous read at 0x00c4201c1080 by goroutine 73:   runtime.mapaccess2_faststr()       /usr/local/Cellar/go/1.10.3/libexec/src/runtime/hashmap_fast.go:261 +0x0   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).find()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:628 +0x16a   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Get()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:404 +0x106   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).GetFloat64()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:469 +0x4c   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.GetFloat64()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:467 +0x5e   github.com/hyperledger/fabric/gossip/util.GetFloat64OrDefault()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/util/misc.go:165 +0x87   github.com/hyperledger/fabric/core/deliverservice.getReConnectBackoffThreshold()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:49 +0x51   github.com/hyperledger/fabric/core/deliverservice.(*deliverServiceImpl).newClient.func2()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:230 +0x9c   github.com/hyperledger/fabric/core/deliverservice.(*broadcastClient).try()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/client.go:94 +0x1fe   github.com/hyperledger/fabric/core/deliverservice.(*broadcastClient).Recv()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/client.go:58 +0x7b   github.com/hyperledger/fabric/core/deliverservice/blocksprovider.(*blocksProviderImpl).DeliverBlocks()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/blocksprovider/blocksprovider.go:131 +0xeb   github.com/hyperledger/fabric/core/deliverservice.(*deliverServiceImpl).launchBlockProvider()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient.go:179 +0x26f{code}  ></description> </Issue>
