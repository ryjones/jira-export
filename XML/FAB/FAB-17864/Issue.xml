<Issue id="45030" key="FAB-17864" number="17864" project="10002" reporter="denyeart" assignee="wenjian" creator="denyeart" type="10004" summary="upgrade-dbs command should fail if CouchDB state database cannot be dropped" priority="3" resolution="10000" status="6" created="2020-05-08 12:29:24.0" updated="2020-05-11 17:44:39.0" resolutiondate="2020-05-11 17:44:39.0" votes="0" watches="2" workflowId="58936" archived="N"> <description><! CDATA If `peer node upgrade-dbs` cannot connect to CouchDB to upgrade (drop) the CouchdB state databases, then retries will be exhausted, CouchDB databases will not be dropped, but the other peer databases will be dropped:    {code:java} $ CORE_LEDGER_STATE_STATEDATABASE=CouchDB peer node upgrade-dbs 2020-05-08 08:21:41.898 EDT  kvledger  UpgradeDBs -> INFO 001 Ledger data folder from config =  /var/hyperledger/production/ledgersData  2020-05-08 08:21:41.949 EDT  statecouchdb  DropApplicationDBs -> INFO 002 Dropping CouchDB application databases ... 2020-05-08 08:21:41.950 EDT  statecouchdb  handleRequest -> WARN 003 Retrying couchdb request in 125ms. Attempt:1 Error:Get "http://127.0.0.1:5984/": dial tcp 127.0.0.1:5984: connect: connection refused 2020-05-08 08:21:42.077 EDT  statecouchdb  handleRequest -> WARN 004 Retrying couchdb request in 250ms. Attempt:2 Error:Get "http://127.0.0.1:5984/": dial tcp 127.0.0.1:5984: connect: connection refused 2020-05-08 08:21:42.329 EDT  statecouchdb  handleRequest -> WARN 005 Retrying couchdb request in 500ms. Attempt:3 Error:Get "http://127.0.0.1:5984/": dial tcp 127.0.0.1:5984: connect: connection refused 2020-05-08 08:21:42.831 EDT  statecouchdb  handleRequest -> WARN 006 Retrying couchdb request in 1s. Attempt:4 Error:Get "http://127.0.0.1:5984/": dial tcp 127.0.0.1:5984: connect: connection refused 2020-05-08 08:21:43.836 EDT  kvledger  dropStateLevelDB -> INFO 007 Dropping StateLevelDB at location  /var/hyperledger/production/ledgersData/stateLeveldb  ...if present 2020-05-08 08:21:43.836 EDT  kvledger  dropConfigHistoryDB -> INFO 008 Dropping ConfigHistoryDB at location  /var/hyperledger/production/ledgersData/configHistory  2020-05-08 08:21:43.838 EDT  kvledger  dropBookkeeperDB -> INFO 009 Dropping BookkeeperDB at location  /var/hyperledger/production/ledgersData/bookkeeper  2020-05-08 08:21:43.839 EDT  kvledger  dropHistoryDB -> INFO 00a Dropping HistoryDB at location  /var/hyperledger/production/ledgersData/historyLeveldb  ...if present 2020-05-08 08:21:43.840 EDT  blkstorage  DeleteBlockStoreIndex -> INFO 00b Dropping the index dir  /var/hyperledger/production/ledgersData/chains/index ... if present 2020-05-08 08:21:43.840 EDT  kvledger  upgradeFormat -> INFO 00c Upgrading ledgerProvider database to the new format 2.0{code} This behavior is wrong. The upgrade-dbs command should fail in this case.   ></description> </Issue>
