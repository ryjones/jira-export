<Issue id="46450" key="FAB-18386" number="18386" project="10002" reporter="JIRAUSER21159" assignee="manish-sethi" creator="JIRAUSER21159" type="10004" summary="Chaincode breaks all peers in a network" priority="3" resolution="10000" status="6" created="2020-12-24 17:07:14.0" updated="2021-06-11 10:22:14.0" resolutiondate="2021-01-26 20:13:47.0" votes="0" watches="11" workflowId="60390" security="10000" archived="N"> <description><! CDATA If a chaincode written in node.js puts empty Buffer to a state, peers can't sync newly created block and panic with the following error: {code:java} tion=12.86278mstion=12.86278ms2020-12-24 16:45:59.401 UTC  gossip.privdata  StoreBlock -> INFO 493  defaultchannel  Received block  6  from buffer2020-12-24 16:45:59.401 UTC  committer.txvalidator  Validate -> INFO 494  defaultchannel  Validated block  6  in 0mspanic: Nil value not allowed. Instead call 'Delete' function goroutine 453  running :github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb.(*UpdateBatch).PutValAndMetadata(...) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statedb.go:196github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation.(*publicAndHashUpdates).applyWriteSet(0xc0005ddd00, 0xc00407d560, 0xc002e6ce60, 0xc002f39380, 0xc00330b600, 0x4, 0x4) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation/types.go:100 +0x9c2github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation.(*validator).validateAndPrepareBatch(0xc002f3c360, 0xc00407d520, 0xc00330b701, 0xc0036aa580, 0xc00330b701, 0xc00044d230) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation/validator.go:105 +0x407github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation.(*CommitBatchPreparer).ValidateAndPrepareBatch(0xc002f36ba0, 0xc00407d300, 0x18f1c01, 0x2a, 0xc00330b870, 0x1, 0x1, 0x0, 0x0) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/validation/batch_preparer.go:91 +0x22dgithub.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr.(*LockBasedTxMgr).ValidateAndPrepare(0xc002e12d00, 0xc00407d300, 0x18e7a01, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbased_txmgr.go:196 +0x247github.com/hyperledger/fabric/core/ledger/kvledger.(*kvLedger).CommitLegacy(0xc002b80f30, 0xc00407d300, 0xc002e6cd58, 0x0, 0x0) /go/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger.go:474 +0x1c4github.com/hyperledger/fabric/core/committer.(*LedgerCommitter).CommitLegacy(0xc002fd1f00, 0xc00407d300, 0xc002e6cd58, 0x1, 0xc002e18820) /go/src/github.com/hyperledger/fabric/core/committer/committer_impl.go:62 +0x47github.com/hyperledger/fabric/gossip/privdata.(*coordinator).StoreBlock(0xc002f163c0, 0xc0036aa580, 0x0, 0x0, 0x0, 0xc0030774d0, 0x0) /go/src/github.com/hyperledger/fabric/gossip/privdata/coordinator.go:224 +0xbfagithub.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).commitBlock(0xc000264c60, 0xc0036aa580, 0x0, 0x0, 0x0, 0x3, 0x0) /go/src/github.com/hyperledger/fabric/gossip/state/state.go:786 +0xa2github.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).deliverPayloads(0xc000264c60) /go/src/github.com/hyperledger/fabric/gossip/state/state.go:576 +0x3a6created by github.com/hyperledger/fabric/gossip/state.NewGossipStateProvider /go/src/github.com/hyperledger/fabric/gossip/state/state.go:273 +0x8a8rpc error: code = Unknown desc = Error: No such container: 8907da2462535c6fc8e5c65eb7268fc7d6a306372fd230e48f6464adf85e3f85% {code}  After that peers never recover. Only solution is to setup completely fresh network.  Sample chaincode that reproduces the error can be found here:  https://github.com/CaJIbHuK/hlf-broken-chaincode/tree/master   ></description> </Issue>
