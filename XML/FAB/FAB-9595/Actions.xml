<Action id="43166" issue="29520" author="jyellick" type="comment" body="I believe this config is not under peer, so the variables you are looking for would actually be {{CORE_BCCSP_PKCS11_PIN}} etc." created="2018-04-19 17:14:06.0" updateauthor="jyellick" updated="2018-04-19 17:14:06.0"/>
<Action id="43247" issue="29520" author="rhegde" type="comment" created="2018-04-20 22:24:59.0" updateauthor="rhegde" updated="2018-04-20 22:24:59.0"> <body><! CDATA I am able to use the following 3 flags {code:java} - CORE_PEER_BCCSP_PKCS11_LABEL=... - CORE_PEER_BCCSP_PKCS11_LIBRARY=... - CORE_PEER_BCCSP_PKCS11_PIN=...{code}    However setting - CORE_PEER_BCCSP_DEFAULT=PKCS11 makes PEER unhappy and crashes with the above message. To make peer understand that it is running in PKSC11 - the only option is to update PKCS11 in a core.yaml.  I tried using - CORE_BCCSP_DEFAULT=PKCS11 but that does not work and gives (looks like it is set to SW - which is the default) {code:java} 2018-04-20 22:10:49.362 UTC  main  main -> ERRO 001 Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err KeyMaterial not found in SigningIdentityInfo{code}  ></body> </Action>
<Action id="43622" issue="29520" author="mastersingh24" type="comment" body=" ~rhegde  Can you try setting {{CORE_PEER_BCCSP_SW=}}  (basically set it to nothing)?" created="2018-04-29 08:51:19.0" updateauthor="mastersingh24" updated="2018-04-29 08:51:48.0"/>
<Action id="43628" issue="29520" author="rhegde" type="comment" created="2018-04-29 14:50:11.0" updateauthor="rhegde" updated="2018-04-29 14:50:45.0"> <body><! CDATA  ~mastersingh24  - I get the same error as above.    {code:java} 2018-04-20 22:10:49.362 UTC  main  main -> ERRO 001 Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err KeyMaterial not found in SigningIdentityInfo{code}  ></body> </Action>
<Action id="43680" issue="29520" author="mastersingh24" type="comment" body=" ~rhegde  Does /etc/hyperledger/fabric/msp actually exist?  What are you setting as the value of {{CORE_PEER_MSPCONFIGPATH}}?" created="2018-05-01 09:27:26.0" updateauthor="mastersingh24" updated="2018-05-01 09:27:26.0"/>
<Action id="43683" issue="29520" author="rhegde" type="comment" created="2018-05-01 12:39:47.0" updateauthor="rhegde" updated="2018-05-01 12:39:47.0"> <body><! CDATA Yes  ~mastersingh24  - it does exist.     If I set the PKCS11 using peer yaml file - it works. However using Docker Environment to set PKCS11,  Peer fails to recognize it needs to use PKCS11.  MSP path remains the same in both the scenarios.     ></body> </Action>
<Action id="45436" issue="29520" author="sanchezl" type="comment" created="2018-06-04 01:30:43.0" updateauthor="sanchezl" updated="2018-06-04 01:30:43.0"> <body><! CDATA  ~rhegde , please confirm that the binary in your peer docker image has been compiled with PKCS11 support.  Using a non-PKCS11 peer binary, I get the same error (note the attempt to initialize the {{SW}} factory, which is the hard coded default when the specified default is not valid) :  {code:java} $ docker run --env CORE_PEER_BCCSP_DEFAULT=PKCS11 hyperledger/fabric-peer:x86_64-1.0.4 peer node start 2018-06-04 00:34:34.381 UTC  main  main -> ERRO 001 Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not initialize BCCSP Factories  Failed initializing SW.BCCSP  Could not initialize BCCSP SW  Failed to initialize software key store: An invalid KeyStore path provided. Path cannot be an empty string.   Could not find default `PKCS11` BCCSP   # core-1.0.yaml sets peer.BCCSP.Default: PKCS11 $ docker run --volume $PWD/core-1.0.yaml:/etc/hyperledger/fabric/core.yaml  hyperledger/fabric-peer:x86_64-1.0.4 peer node start 2018-06-04 00:34:44.526 UTC  main  main -> ERRO 001 Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not initialize BCCSP Factories  Failed initializing SW.BCCSP  Could not initialize BCCSP SW  Failed to initialize software key store: An invalid KeyStore path provided. Path cannot be an empty string.   Could not find default `PKCS11` BCCSP {code}    ></body> </Action>
<Action id="45453" issue="29520" author="rhegde" type="comment" body="Yes  ~sanchezl . We use the IBM Blockchain Hyperledger Build which has support for PKCS#11. This should be error in the open source community build also if we can compile this with PKCS#11." created="2018-06-04 12:44:40.0" updateauthor="rhegde" updated="2018-06-04 12:44:40.0"/>
<Action id="45518" issue="29520" author="sanchezl" type="comment" created="2018-06-05 00:29:38.0" updateauthor="sanchezl" updated="2018-06-05 00:30:36.0"> <body><! CDATA  ~rhegde , The environment variables can only override a key that already exists in the {{core.yaml}} file. In this case, it means that none of the {{CORE_PEER_BCCSP_PKCS11_*}} keys can be set via env vars when using the default {{core.yaml}}.   Create an image with the following {{pksc11}} section added under Peer.BCCSP, and you should be able to set the values via the environment variables when starting containers from that image: {code:java} peer: bccsp: sw: // this section is already there pkcs11: // add this section Library: Pin: Label: hash: security: filekeystore: keystore:{code}  ></body> </Action>
<Action id="45526" issue="29520" author="rhegde" type="comment" body="Can we have this change  be made to v1.2 yaml file for orderer + peer so this becomes available as part of release." created="2018-06-05 13:02:56.0" updateauthor="rhegde" updated="2018-06-05 13:02:56.0"/>
<Action id="45797" issue="29520" author="sanchezl" type="comment" body="https://gerrit.hyperledger.org/r/c/22947/" created="2018-06-11 16:32:15.0" updateauthor="sanchezl" updated="2018-06-11 16:32:15.0"/>
<Action id="46095" issue="29520" author="denyeart" type="comment" body=" ~sanchezl  I&apos;ve merged the core.yaml fix.  Is anything needed on orderer side?" created="2018-06-18 12:09:15.0" updateauthor="denyeart" updated="2018-06-18 12:09:15.0"/>
<Action id="50008" issue="29520" author="sykesm" type="comment" body=" ~sanchezl  bump." created="2018-09-06 14:28:08.0" updateauthor="sykesm" updated="2018-09-06 14:28:08.0"/>
<Action id="50627" issue="29520" author="sanchezl" type="comment" body="No corresponding change needed on the orderer." created="2018-09-18 20:56:38.0" updateauthor="sanchezl" updated="2018-09-18 20:56:38.0"/>
<Action id="51797" issue="29520" author="vsudip" type="comment" created="2018-10-05 12:40:32.0" updateauthor="vsudip" updated="2018-10-05 12:41:35.0"> <body><! CDATA Hi,  I am getting the same error while executing e2e_cli with below trace, can someone please review this. {code:java} 2018-10-05 12:31:30.473 UTC  viperutil  EnhancedExactUnmarshalKey -> DEBU 017 map peer.BCCSP:map Default:PKCS11 SW:map FileKeyStore:map KeyStore:  Hash:SHA2 Security:256  PKCS11:map Label:orderer.example.com Pin:***** Hash:SHA2 Security:256 Library:/etc/hyperledger/fabric/dpod/orderer.example.com/libs/64/libCryptoki2.so    2018-10-05 12:31:30.473 UTC  main  InitCmd -> ERRO 018 Cannot run peer because error when setting up MSP of type bccsp from directory /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp: could not initialize BCCSP Factories: Failed initializing BCCSP.: Could not initialize BCCSP SW  Failed to initialize software key store: An invalid KeyStore path provided. Path cannot be an empty string.  Could not find default `PKCS11` BCCSP !!!!!!!!!!!!!!! Ordering Service is not available, Please try again ... !!!!!!!!!!!!!!!! ================== ERROR !!! FAILED to execute End-2-End Scenario ================== {code} Steps followed {code:java} git clone https://gerrit.hyperledger.org/r/fabric cd fabric/examples/e2e_cli cp ../../sampleconfig/core.yaml ../../sampleconfig/orderer.yaml .  Updated the configurations for PKCS11 and execute ./network_setup.sh up{code}  ></body> </Action>
