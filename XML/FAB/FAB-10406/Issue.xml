<Issue id="30665" key="FAB-10406" number="10406" project="10002" reporter="snlan" creator="snlan" type="10004" summary="unit test TestManagerImpl and TestNewChain DATA RACE" priority="4" resolution="10203" status="6" created="2018-05-26 06:20:59.0" updated="2018-10-31 18:00:32.0" resolutiondate="2018-10-31 18:00:31.0" votes="0" watches="3" timeoriginalestimate="43200" timeestimate="43200" workflowId="42942"> <environment><! CDATA root@ubuntu:~# lsb_release -a No LSB modules are available. Distributor ID:    Ubuntu Description:    Ubuntu 18.04 LTS Release:    18.04 Codename:    bionic root@ubuntu:~# go version go version go1.10.2 linux/amd64 root@ubuntu:~# go env GOARCH="amd64" GOBIN="" GOCACHE="/root/.cache/go-build" GOEXE="" GOHOSTARCH="amd64" GOHOSTOS="linux" GOOS="linux" GOPATH="/gopath" GORACE="" GOROOT="/usr/local/go" GOTMPDIR="" GOTOOLDIR="/usr/local/go/pkg/tool/linux_amd64" GCCGO="gccgo" CC="gcc" CXX="g++" CGO_ENABLED="1" CGO_CFLAGS="-g -O2" CGO_CPPFLAGS="" CGO_CXXFLAGS="-g -O2" CGO_FFLAGS="-g -O2" CGO_LDFLAGS="-g -O2" PKG_CONFIG="pkg-config" GOGCCFLAGS="-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build222887490=/tmp/go-build -gno-record-gcc-switches"  ></environment> <description><! CDATA == RUN   TestManagerImpl 2018-05-26 14:28:32.154 CST  orderer/commmon/multichannel  newBlockWriter -> DEBU 059  channel: testchainid  Creating block writer for tip of chain (blockNumber=0, lastConfigBlockNum=0, lastConfigSeq=0) 2018-05-26 14:28:32.155 CST  orderer/commmon/multichannel  newChainSupport -> DEBU 05a  channel: testchainid  Done creating channel support resources 2018-05-26 14:28:32.155 CST  bccsp  GetDefault -> WARN 05b Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.155 CST  orderer/commmon/multichannel  NewRegistrar -> INFO 05c Starting system channel 'testchainid' with genesis block hash 03d033ad0cdd89c9355b569734b68204508d9e829f989fbcca5e1d2ebddeda1a and orderer type solo 2018-05-26 14:28:32.229 CST  bccsp  GetDefault -> WARN 05d Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.229 CST  bccsp  GetDefault -> WARN 05e Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.229 CST  orderer/commmon/multichannel  addLastConfigSignature -> DEBU 05f  channel: testchainid  About to write block, setting its LAST_CONFIG to 0 2018-05-26 14:28:32.230 CST  bccsp  GetDefault -> WARN 060 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. ================== WARNING: DATA RACE Write at 0x00c420151eb8 by goroutine 31:   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).appendBlock()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:170 +0x2ea   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).Append()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:158 +0x18a   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).Append()       <autogenerated>:1 +0x82   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).commitBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:169 +0xf6   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:155 +0x86  Previous read at 0x00c420151eb8 by goroutine 28:   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).Iterator()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:103 +0xd22   github.com/hyperledger/fabric/orderer/common/multichannel.TestManagerImpl()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar_test.go:158 +0x6fa   testing.tRunner()       /usr/local/go/src/testing/testing.go:777 +0x16d  Goroutine 31 (running) created at:   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:153 +0xac   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).WriteBlock()       <autogenerated>:1 +0x83   github.com/hyperledger/fabric/orderer/common/multichannel.(*mockChain).Start.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/util_test.go:95 +0x7ff  Goroutine 28 (running) created at:   testing.(*T).Run()       /usr/local/go/src/testing/testing.go:824 +0x564   testing.runTests.func1()       /usr/local/go/src/testing/testing.go:1063 +0xa4   testing.tRunner()       /usr/local/go/src/testing/testing.go:777 +0x16d   testing.runTests()       /usr/local/go/src/testing/testing.go:1061 +0x4e1   testing.(*M).Run()       /usr/local/go/src/testing/testing.go:978 +0x2cd   main.main()       _testmain.go:64 +0x22a ================== 2018-05-26 14:28:32.230 CST  orderer/commmon/multichannel  commitBlock -> DEBU 061  channel: testchainid  Wrote block 1 --- FAIL: TestManagerImpl (0.08s)     testing.go:730: race detected during execution of test  -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  === RUN   TestNewChain 2018-05-26 14:28:32.233 CST  orderer/commmon/multichannel  newBlockWriter -> DEBU 062  channel: testchainid  Creating block writer for tip of chain (blockNumber=0, lastConfigBlockNum=0, lastConfigSeq=0) 2018-05-26 14:28:32.233 CST  orderer/commmon/multichannel  newChainSupport -> DEBU 063  channel: testchainid  Done creating channel support resources 2018-05-26 14:28:32.234 CST  bccsp  GetDefault -> WARN 064 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.234 CST  orderer/commmon/multichannel  NewRegistrar -> INFO 065 Starting system channel 'testchainid' with genesis block hash 03d033ad0cdd89c9355b569734b68204508d9e829f989fbcca5e1d2ebddeda1a and orderer type solo 2018-05-26 14:28:32.772 CST  bccsp  GetDefault -> WARN 066 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.773 CST  bccsp  GetDefault -> WARN 067 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.775 CST  bccsp  GetDefault -> WARN 068 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.776 CST  orderer/commmon/multichannel  newBlockWriter -> DEBU 069  channel: test-new-chain  Creating block writer for tip of chain (blockNumber=0, lastConfigBlockNum=0, lastConfigSeq=1) 2018-05-26 14:28:32.776 CST  orderer/commmon/multichannel  newChainSupport -> DEBU 06a  channel: test-new-chain  Done creating channel support resources 2018-05-26 14:28:32.776 CST  orderer/commmon/multichannel  newChain -> INFO 06b Created and starting new chain test-new-chain 2018-05-26 14:28:32.777 CST  orderer/commmon/multichannel  addLastConfigSignature -> DEBU 06c  channel: testchainid  About to write block, setting its LAST_CONFIG to 0 2018-05-26 14:28:32.777 CST  bccsp  GetDefault -> WARN 06d Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. ================== WARNING: DATA RACE Write at 0x00c420312058 by goroutine 35:   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).appendBlock()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:170 +0x2ea   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).Append()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:158 +0x18a   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).Append()       <autogenerated>:1 +0x82   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).commitBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:169 +0xf6   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:155 +0x86  Previous read at 0x00c420312058 by goroutine 32:   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).Iterator()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:103 +0xd22   github.com/hyperledger/fabric/orderer/common/multichannel.TestNewChain.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar_test.go:206 +0x13b   github.com/hyperledger/fabric/orderer/common/multichannel.TestNewChain()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar_test.go:222 +0x9b6   testing.tRunner()       /usr/local/go/src/testing/testing.go:777 +0x16d  Goroutine 35 (running) created at:   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:153 +0xac   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteConfigBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:140 +0x528   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).WriteConfigBlock()       <autogenerated>:1 +0x83   github.com/hyperledger/fabric/orderer/common/multichannel.(*mockChain).Start.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/util_test.go:90 +0x4a7  Goroutine 32 (running) created at:   testing.(*T).Run()       /usr/local/go/src/testing/testing.go:824 +0x564   testing.runTests.func1()       /usr/local/go/src/testing/testing.go:1063 +0xa4   testing.tRunner()       /usr/local/go/src/testing/testing.go:777 +0x16d   testing.runTests()       /usr/local/go/src/testing/testing.go:1061 +0x4e1   testing.(*M).Run()       /usr/local/go/src/testing/testing.go:978 +0x2cd   main.main()       _testmain.go:64 +0x22a ================== 2018-05-26 14:28:32.777 CST  orderer/commmon/multichannel  commitBlock -> DEBU 06e  channel: testchainid  Wrote block 1 2018-05-26 14:28:32.814 CST  bccsp  GetDefault -> WARN 06f Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.816 CST  bccsp  GetDefault -> WARN 070 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. 2018-05-26 14:28:32.816 CST  orderer/commmon/multichannel  addLastConfigSignature -> DEBU 071  channel: test-new-chain  About to write block, setting its LAST_CONFIG to 0 2018-05-26 14:28:32.817 CST  bccsp  GetDefault -> WARN 072 Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP. ================== WARNING: DATA RACE Write at 0x00c4203b26d8 by goroutine 36:   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).appendBlock()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:170 +0x2ea   github.com/hyperledger/fabric/common/ledger/blockledger/ram.(*ramLedger).Append()       /gopath/src/github.com/hyperledger/fabric/common/ledger/blockledger/ram/impl.go:158 +0x18a   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).Append()       <autogenerated>:1 +0x82   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).commitBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:169 +0xf6   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:155 +0x86  Previous read at 0x00c4203b26d8 by goroutine 32:    failed to restore the stack   Goroutine 36 (running) created at:   github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteBlock()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:153 +0xac   github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).WriteBlock()       <autogenerated>:1 +0x83   github.com/hyperledger/fabric/orderer/common/multichannel.(*mockChain).Start.func1()       /gopath/src/github.com/hyperledger/fabric/orderer/common/multichannel/util_test.go:95 +0x7ff  Goroutine 32 (running) created at:   testing.(*T).Run()       /usr/local/go/src/testing/testing.go:824 +0x564   testing.runTests.func1()       /usr/local/go/src/testing/testing.go:1063 +0xa4   testing.tRunner()       /usr/local/go/src/testing/testing.go:777 +0x16d   testing.runTests()       /usr/local/go/src/testing/testing.go:1061 +0x4e1   testing.(*M).Run()       /usr/local/go/src/testing/testing.go:978 +0x2cd   main.main()       _testmain.go:64 +0x22a ================== 2018-05-26 14:28:32.817 CST  orderer/commmon/multichannel  commitBlock -> DEBU 073  channel: test-new-chain  Wrote block 1 2018-05-26 14:28:32.818 CST  orderer/commmon/multichannel  newBlockWriter -> DEBU 074  channel: test-new-chain  Creating block writer for tip of chain (blockNumber=1, lastConfigBlockNum=0, lastConfigSeq=1) 2018-05-26 14:28:32.819 CST  orderer/commmon/multichannel  newChainSupport -> DEBU 075  channel: test-new-chain  Done creating channel support resources --- FAIL: TestNewChain (0.59s)     testing.go:730: race detected during execution of test  ></description> </Issue>
