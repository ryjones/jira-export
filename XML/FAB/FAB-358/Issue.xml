<Issue id="12659" key="FAB-358" number="358" project="10002" reporter="harrijk" assignee="sanchezl" creator="harrijk" type="10004" summary="hyperledger/fabric-javaenv Docker image build failures on s390x platform" priority="2" resolution="10000" status="6" created="2016-09-12 18:09:07.0" updated="2018-07-20 14:10:10.0" resolutiondate="2017-04-12 15:23:22.0" votes="0" watches="12" workflowId="36215"> <description><! CDATA I am running on an Ubuntu 16.04 KVM image within a zKVM LPAR on the z Systems platform (s390x) and using Hyperledger Fabric build *03c8bad*.  I have run into two issues when issuing the *make peer* command and both issues are related to the building of the *hyperledger/fabric-javaenv* Docker image.  h3. Issue #1 The *Dockerfile.in* located in fabric/images/javaenv is pulling down an x86 platform Docker image ( openjdk:8 ) from Docker Hub and using it as a base image to build the javaenv Docker image.  As a result, during the execution of step 2 within the javaenv Dockerfile, an *exec format* error occurs when attempting to run the wget command.  {quote}Step 2 : RUN wget https://services.gradle.org/distributions/gradle-2.12-bin.zip -P /tmp --quiet ---> Running in 090e83e1e6f2 rpc error: code = 2 desc = "oci runtime error: exec format error"{quote}  As it is currently coded in the *fabric/images/javaenv/Dockerfile.in* file, the s390x platform cannot execute Docker containers built from Docker images created on non-s390x platforms.  I was able to resolve the issue, by changing the *FROM *statement within the Dockerfile.in file to use *hyperledger/fabric-baseimage* that is built during the make process and add a *RUN* statement to install openjdk-8-jdk, which is pulled from s390x Ubuntu repositories.  NOTE: The numbers  listed in the file below are # (hashtags) and got formatted as numbers. I still need to get up to speed with this editor. :)  The contents of *fabric/images/javaenv/Dockerfile.in* were changed to:  FROM hyperledger/fabric-baseimage # FROM openjdk:8 RUN apt-get install -y openjdk-8-jdk RUN wget https://services.gradle.org/distributions/gradle-2.12-bin.zip -P /tmp --quiet RUN unzip -q /tmp/gradle-2.12-bin.zip -d /opt && rm /tmp/gradle-2.12-bin.zip RUN ln -s /opt/gradle-2.12/bin/gradle /usr/bin ADD javashimsrc.tar.bz2 /root ADD protos.tar.bz2 /root WORKDIR /root # Build java shim after copying proto files from fabric/proto RUN core/chaincode/shim/java/javabuild.sh   h3. Issue #2 After I updated the fabric/images/javaenv/Dockerfile.in file to use the hyperledger/fabric-baseimage instead of the x86 openjdk:8 Docker image, the building of the javaenv Docker image progressed until step 8, where an error occurred while building the Java shim:  {quote}Step 8 : RUN core/chaincode/shim/java/javabuild.sh ---> Running in 3c66c3d93df9  FAILURE: Build failed with an exception.  * Where: Build file '/root/core/chaincode/shim/java/build.gradle' line: 29  * What went wrong: An exception occurred applying plugin request  id: 'java'  > Failed to apply plugin  id 'osdetector'  > Could not create an instance of type com.google.gradle.osdetector.OsDetectorExtension_Decorated.  * Try: Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. The command '/bin/sh -c core/chaincode/shim/java/javabuild.sh' returned a non-zero code: 1 Makefile:217: recipe for target 'build/image/javaenv/.dummy' failed make: ***  build/image/javaenv/.dummy  Error 1{quote}  At this point I suspected that the s390x platform was not supported for this shim build.  To confirm this I performed the following operations:  I commented out the following line from fabric/images/javaenv/Dockerfile.in: {quote}RUN core/chaincode/shim/java/javabuild.sh{quote}  I then ran the make and this allowed for a modified hyperledger/fabric-javaenv image to be built for debugging.  Next I ran a Docker container using the modified hyperledger/fabric-javaenv Docker image. Once inside the javaenv container, I issued the following commands:  {quote}apt-get install -y vim vim /root/core/chaincode/shim/java/javabuild.sh  Change: gradle -q -b ${PARENTDIR}/core/chaincode/shim/java/build.gradle clean  TO: gradle --stacktrace --debug -b ${PARENTDIR}/core/chaincode/shim/java/build.gradle clean  Save the javabuild.sh file  cd /root core/chaincode/shim/java/javabuild.sh {quote} After running the javabuild.sh script the following stacktrace was displayed:  {quote}17:47:11.825  INFO   com.google.gradle.osdetector.OsDetector  ------------------------------------------------------------------------ 17:47:11.826  INFO   com.google.gradle.osdetector.OsDetector  Detecting the operating system and CPU architecture 17:47:11.827  INFO   com.google.gradle.osdetector.OsDetector  ------------------------------------------------------------------------ 17:47:11.828  INFO   com.google.gradle.osdetector.OsDetector  os.detected.name=linux 17:47:11.829  INFO   com.google.gradle.osdetector.OsDetector  os.detected.arch=unknown 17:47:11.829  INFO   com.google.gradle.osdetector.OsDetector  os.detected.classifier=linux-unknown 17:47:11.831  DEBUG   org.gradle.configuration.project.BuildScriptProcessor  Timing: Running the build script took 3.703 secs 17:47:11.874  ERROR   org.gradle.BuildExceptionReporter  17:47:11.875  ERROR   org.gradle.BuildExceptionReporter  FAILURE: Build failed with an exception. 17:47:11.876  ERROR   org.gradle.BuildExceptionReporter  17:47:11.876  ERROR   org.gradle.BuildExceptionReporter  * Where: 17:47:11.877  ERROR   org.gradle.BuildExceptionReporter  Build file '/root/core/chaincode/shim/java/build.gradle' line: 29 17:47:11.877  ERROR   org.gradle.BuildExceptionReporter  17:47:11.878  ERROR   org.gradle.BuildExceptionReporter  * What went wrong: 17:47:11.879  ERROR   org.gradle.BuildExceptionReporter  An exception occurred applying plugin request  id: 'java'  17:47:11.879  ERROR   org.gradle.BuildExceptionReporter  > Failed to apply plugin  id 'osdetector'  17:47:11.880  ERROR   org.gradle.BuildExceptionReporter     > Could not create an instance of type com.google.gradle.osdetector.OsDetectorExtension_Decorated. 17:47:11.881  ERROR   org.gradle.BuildExceptionReporter  17:47:11.881  ERROR   org.gradle.BuildExceptionReporter  * Exception is: 17:47:11.884  ERROR   org.gradle.BuildExceptionReporter  org.gradle.api.plugins.InvalidPluginException: An exception occurred applying plugin request  id: 'java'  17:47:11.884  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugin(DefaultPluginRequestApplicator.java:178) 17:47:11.885  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugins(DefaultPluginRequestApplicator.java:139) 17:47:11.886  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.DefaultScriptPluginFactory$ScriptPluginImpl.apply(DefaultScriptPluginFactory.java:137) 17:47:11.886  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.project.BuildScriptProcessor.execute(BuildScriptProcessor.java:38) 17:47:11.887  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.project.BuildScriptProcessor.execute(BuildScriptProcessor.java:25) 17:47:11.887  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.project.ConfigureActionsProjectEvaluator.evaluate(ConfigureActionsProjectEvaluator.java:34) 17:47:11.888  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.project.LifecycleProjectEvaluator.evaluate(LifecycleProjectEvaluator.java:55) 17:47:11.888  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.project.AbstractProject.evaluate(AbstractProject.java:532) 17:47:11.889  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.project.AbstractProject.evaluate(AbstractProject.java:93) 17:47:11.890  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.execution.TaskPathProjectEvaluator.configureHierarchy(TaskPathProjectEvaluator.java:47) 17:47:11.890  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.configuration.DefaultBuildConfigurer.configure(DefaultBuildConfigurer.java:35) 17:47:11.891  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher$2.run(DefaultGradleLauncher.java:125) 17:47:11.891  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.Factories$1.create(Factories.java:22) 17:47:11.892  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.progress.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:90) 17:47:11.892  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.progress.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:52) 17:47:11.893  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher.doBuildStages(DefaultGradleLauncher.java:122) 17:47:11.893  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher.access$200(DefaultGradleLauncher.java:32) 17:47:11.894  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher$1.create(DefaultGradleLauncher.java:99) 17:47:11.894  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher$1.create(DefaultGradleLauncher.java:93) 17:47:11.894  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.progress.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:90) 17:47:11.895  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.progress.DefaultBuildOperationExecutor.run(DefaultBuildOperationExecutor.java:62) 17:47:11.895  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher.doBuild(DefaultGradleLauncher.java:93) 17:47:11.896  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.initialization.DefaultGradleLauncher.run(DefaultGradleLauncher.java:82) 17:47:11.896  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.InProcessBuildActionExecuter$DefaultBuildController.run(InProcessBuildActionExecuter.java:94) 17:47:11.897  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.tooling.internal.provider.ExecuteBuildActionRunner.run(ExecuteBuildActionRunner.java:28) 17:47:11.898  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.ChainingBuildActionRunner.run(ChainingBuildActionRunner.java:35) 17:47:11.898  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.InProcessBuildActionExecuter.execute(InProcessBuildActionExecuter.java:43) 17:47:11.899  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.InProcessBuildActionExecuter.execute(InProcessBuildActionExecuter.java:28) 17:47:11.899  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.ContinuousBuildActionExecuter.execute(ContinuousBuildActionExecuter.java:75) 17:47:11.900  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.ContinuousBuildActionExecuter.execute(ContinuousBuildActionExecuter.java:45) 17:47:11.900  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.DaemonUsageSuggestingBuildActionExecuter.execute(DaemonUsageSuggestingBuildActionExecuter.java:51) 17:47:11.901  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.exec.DaemonUsageSuggestingBuildActionExecuter.execute(DaemonUsageSuggestingBuildActionExecuter.java:28) 17:47:11.901  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.RunBuildAction.run(RunBuildAction.java:43) 17:47:11.902  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.Actions$RunnableActionAdapter.execute(Actions.java:170) 17:47:11.902  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.CommandLineActionFactory$ParseAndBuildAction.execute(CommandLineActionFactory.java:237) 17:47:11.903  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.CommandLineActionFactory$ParseAndBuildAction.execute(CommandLineActionFactory.java:210) 17:47:11.903  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.JavaRuntimeValidationAction.execute(JavaRuntimeValidationAction.java:35) 17:47:11.904  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.JavaRuntimeValidationAction.execute(JavaRuntimeValidationAction.java:24) 17:47:11.904  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.CommandLineActionFactory$WithLogging.execute(CommandLineActionFactory.java:206) 17:47:11.905  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.CommandLineActionFactory$WithLogging.execute(CommandLineActionFactory.java:169) 17:47:11.905  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.ExceptionReportingAction.execute(ExceptionReportingAction.java:33) 17:47:11.906  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.cli.ExceptionReportingAction.execute(ExceptionReportingAction.java:22) 17:47:11.906  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.Main.doAction(Main.java:33) 17:47:11.907  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.bootstrap.EntryPoint.run(EntryPoint.java:45) 17:47:11.907  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.bootstrap.ProcessBootstrap.runNoExit(ProcessBootstrap.java:54) 17:47:11.908  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.bootstrap.ProcessBootstrap.run(ProcessBootstrap.java:35) 17:47:11.908  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.launcher.GradleMain.main(GradleMain.java:23) 17:47:11.908  ERROR   org.gradle.BuildExceptionReporter  Caused by: org.gradle.api.internal.plugins.PluginApplicationException: Failed to apply plugin  id 'osdetector'  17:47:11.909  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager.doApply(DefaultPluginManager.java:153) 17:47:11.909  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager.apply(DefaultPluginManager.java:112) 17:47:11.910  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultObjectConfigurationAction.applyType(DefaultObjectConfigurationAction.java:112) 17:47:11.910  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultObjectConfigurationAction.access$200(DefaultObjectConfigurationAction.java:35) 17:47:11.911  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultObjectConfigurationAction$3.run(DefaultObjectConfigurationAction.java:79) 17:47:11.912  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultObjectConfigurationAction.execute(DefaultObjectConfigurationAction.java:135) 17:47:11.912  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.project.AbstractPluginAware.apply(AbstractPluginAware.java:46) 17:47:11.913  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.plugins.PluginAware$apply.call(Unknown Source) 17:47:11.913  ERROR   org.gradle.BuildExceptionReporter         at com.google.protobuf.gradle.ProtobufPlugin.doApply(ProtobufPlugin.groovy:104) 17:47:11.914  ERROR   org.gradle.BuildExceptionReporter         at com.google.protobuf.gradle.ProtobufPlugin$_apply_closure1.doCall(ProtobufPlugin.groovy:86) 17:47:11.914  ERROR   org.gradle.BuildExceptionReporter         at com.sun.proxy.$Proxy28.execute(Unknown Source) 17:47:11.914  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager$2.execute(DefaultPluginManager.java:209) 17:47:11.915  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager$2.execute(DefaultPluginManager.java:207) 17:47:11.915  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.listener.ActionBroadcast.execute(ActionBroadcast.java:39) 17:47:11.916  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.DefaultDomainObjectCollection.doAdd(DefaultDomainObjectCollection.java:165) 17:47:11.916  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.DefaultDomainObjectCollection.add(DefaultDomainObjectCollection.java:159) 17:47:11.917  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager$1.run(DefaultPluginManager.java:91) 17:47:11.917  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager.doApply(DefaultPluginManager.java:147) 17:47:11.918  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager.apply(DefaultPluginManager.java:104) 17:47:11.918  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator$6.run(DefaultPluginRequestApplicator.java:141) 17:47:11.919  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.plugin.use.internal.DefaultPluginRequestApplicator.applyPlugin(DefaultPluginRequestApplicator.java:166) 17:47:11.919  ERROR   org.gradle.BuildExceptionReporter         ... 46 more 17:47:11.920  ERROR   org.gradle.BuildExceptionReporter  Caused by: org.gradle.internal.reflect.ObjectInstantiationException: Could not create an instance of type com.google.gradle.osdetector.OsDetectorExtension_Decorated. 17:47:11.920  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.reflect.DirectInstantiator.newInstance(DirectInstantiator.java:51) 17:47:11.921  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.ClassGeneratorBackedInstantiator.newInstance(ClassGeneratorBackedInstantiator.java:36) 17:47:11.921  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultConvention.create(DefaultConvention.java:106) 17:47:11.922  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetectorPlugin.apply(OsDetectorPlugin.groovy:23) 17:47:11.922  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetectorPlugin.apply(OsDetectorPlugin.groovy) 17:47:11.923  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.ImperativeOnlyPluginApplicator.applyImperative(ImperativeOnlyPluginApplicator.java:35) 17:47:11.923  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.RuleBasedPluginApplicator.applyImperative(RuleBasedPluginApplicator.java:43) 17:47:11.924  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.api.internal.plugins.DefaultPluginManager.doApply(DefaultPluginManager.java:137) 17:47:11.924  ERROR   org.gradle.BuildExceptionReporter         ... 66 more 17:47:11.925  ERROR   org.gradle.BuildExceptionReporter  Caused by: java.lang.ExceptionInInitializerError 17:47:11.925  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetectorExtension.<init>(OsDetectorPlugin.groovy:28) 17:47:11.926  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetectorExtension_Decorated.<init>(Unknown Source) 17:47:11.926  ERROR   org.gradle.BuildExceptionReporter         at org.gradle.internal.reflect.DirectInstantiator.newInstance(DirectInstantiator.java:49) 17:47:11.927  ERROR   org.gradle.BuildExceptionReporter         ... 73 more 17:47:11.927  ERROR   org.gradle.BuildExceptionReporter  Caused by: kr.motd.maven.os.DetectionException: unknown os.arch: s390x 17:47:11.928  ERROR   org.gradle.BuildExceptionReporter         at kr.motd.maven.os.Detector.detect(Detector.java:54) 17:47:11.928  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetector$Impl.<init>(OsDetector.java:55) 17:47:11.929  ERROR   org.gradle.BuildExceptionReporter         at com.google.gradle.osdetector.OsDetector.<clinit>(OsDetector.java:27) 17:47:11.929  ERROR   org.gradle.BuildExceptionReporter         ... 76 more 17:47:11.930  ERROR   org.gradle.BuildExceptionReporter  17:47:11.930  LIFECYCLE   org.gradle.BuildResultLogger  17:47:11.931  LIFECYCLE   org.gradle.BuildResultLogger  BUILD FAILED{quote}  As can be seen in the stacktrace above, the s390x platform is not supported when attempting to build the Java shim.   ></description> </Issue>
