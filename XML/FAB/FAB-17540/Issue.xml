<Issue id="44421" key="FAB-17540" number="17540" project="10002" reporter="sykesm" assignee="tsharris" creator="sykesm" type="10004" summary="Data race reported from core/peer TestUpdateRootsFromConfigBlock/MutualTLSOrg1Org2" priority="3" resolution="10000" status="6" created="2020-02-26 11:44:57.0" updated="2020-04-14 14:10:17.0" resolutiondate="2020-04-14 14:10:17.0" votes="0" watches="3" workflowId="58329" archived="N"> <description><! CDATA Data race in the comm layer related to updating certificates from a config block.  {code} --- FAIL: TestUpdateRootsFromConfigBlock (18.80s) --- FAIL: TestUpdateRootsFromConfigBlock/MutualTLSOrg1Org2 (2.18s) pkg_test.go:278: Running test MutualTLSOrg1Org2 ... pkg_test.go:300: listenAddress: 127.0.0.1:33485 pkg_test.go:302: testAddress: localhost:33485 pkg_test.go:191: Channel channel2 MSPIDs: ( Org2MSP SampleOrg ) testing.go:853: race detected during execution of test testing.go:853: race detected during execution of test FAIL coverage: 68.9% of statements FAIL	github.com/hyperledger/fabric/core/peer	39.904s {code}  {code} ================== WARNING: DATA RACE Write at 0x00c001242690 by goroutine 216: github.com/hyperledger/fabric/core/comm.(*GRPCServer).SetClientRootCAs() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/comm/server.go:293 +0x315 github.com/hyperledger/fabric/core/peer.(*Peer).updateTrustedRoots() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/peer.go:113 +0x5c4 github.com/hyperledger/fabric/core/peer.(*Peer).createChannel.func2() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/peer.go:282 +0x79 github.com/hyperledger/fabric/common/channelconfig.(*BundleSource).Update() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/channelconfig/bundlesource.go:46 +0xaf github.com/hyperledger/fabric/core/peer.(*Peer).createChannel() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/channelconfig/bundlesource.go:38 +0xae1 github.com/hyperledger/fabric/core/peer.(*Peer).CreateChannel() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/peer.go:219 +0x28f github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func1() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:187 +0x123 github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func3() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:250 +0x64 github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func5() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:310 +0x87c testing.tRunner() /usr/local/go/src/testing/testing.go:909 +0x199  Previous read at 0x00c001242690 by goroutine 128: crypto/tls.(*Conn).processCertsFromClient() /usr/local/go/src/crypto/tls/handshake_server.go:730 +0x405 crypto/tls.(*serverHandshakeState).doFullHandshake() /usr/local/go/src/crypto/tls/handshake_server.go:514 +0xa23 crypto/tls.(*serverHandshakeState).handshake() /usr/local/go/src/crypto/tls/handshake_server.go:105 +0x68c crypto/tls.(*Conn).serverHandshake() /usr/local/go/src/crypto/tls/handshake_server.go:60 +0x1cd crypto/tls.(*Conn).Handshake() /usr/local/go/src/crypto/tls/conn.go:1364 +0x3cc github.com/hyperledger/fabric/core/comm.(*serverCreds).ServerHandshake() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/comm/creds.go:60 +0x145 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).useTransportAuthenticator() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:517 +0x92 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleRawConn() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:642 +0x157 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).Serve.func3() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:628 +0x4c  Goroutine 216 (running) created at: testing.(*T).Run() /usr/local/go/src/testing/testing.go:960 +0x651 github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:277 +0x330f  Goroutine 128 (finished) created at: github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).Serve() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:627 +0x960 github.com/hyperledger/fabric/core/comm.(*GRPCServer).Start() /home/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/comm/server.go:224 +0x1de {code}  ></description> </Issue>
