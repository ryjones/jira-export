<Issue id="30931" key="FAB-10571" number="10571" project="10002" reporter="hamptonsmith" assignee="chris.elder" creator="hamptonsmith" type="10004" summary="Couch State DB + Top-level field prefixed with underscore crashes endorser" priority="3" resolution="10000" status="6" created="2018-06-07 02:05:33.0" updated="2018-07-20 14:16:55.0" resolutiondate="2018-06-12 12:34:49.0" votes="0" watches="5" workflowId="42422"> <environment><! CDATA Orderer docker image: hyperledger/fabric-orderer:x86_64-1.1.0  Endorser docker image: hyperledger/fabric-peer:x86_64-1.1.0  CouchDB docker image: couchdb:2.1.1  Docker: 18.03.1-ce, build 9ee9f40  docker-compose: 1.21.2, build a133471  Server: Ubuntu 16.04.4 LTS     ></environment> <description><! CDATA This regressed for a previously-working project while upgrading from v1.0 to v1.1:  In CouchDB state db, ledger data values were previously stored under a field named "data", but since upgrading seem to have been promoted to a top level document.  CouchDB disallows top-level fields prefixed by an underscore.  As a result, previously-valid ledgers containing such fields cause the endorser to crash when rebuilding the state db: {code:java} panic: Error during state DB recovery:Couch DB Error:doc_validation,  Status Code:400,  Reason:Bad special document member: _foo  goroutine 1  running : github.com/hyperledger/fabric/core/ledger/kvledger.newKVLedger(0xc42043c9f8, 0x6, 0xc4204525a0, 0x166f820, 0xc42044b3d0, 0x16696e0, 0xc420456580, 0xc4201fd0e0, 0x6c61626f6c67, 0x0, ...)     /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger.go:67 +0x4da github.com/hyperledger/fabric/core/ledger/kvledger.(*Provider).openInternal(0xc4201462c0, 0xc42043c9f8, 0x6, 0xc42044a801, 0x0, 0x0, 0xaba1f5)     /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger_provider.go:152 +0x170 ...<snip>... {code}  ></description> </Issue>
