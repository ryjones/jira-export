<Issue id="46369" key="FAB-18360" number="18360" project="10002" reporter="lmars" creator="lmars" type="10004" summary="Peer connection is unstable after certificate reenroll" priority="3" status="10300" created="2020-12-02 08:24:55.0" updated="2021-06-03 10:35:07.0" votes="2" watches="3" workflowId="60305" archived="N"> <description><! CDATA Peer connection is unstable after peer certificate reenroll.  If I understand correctly, the peer changes the pki-id after reenroll the certificate.  Before: {code} 2020-02-25 19:13:08.103 UTC  gossip.gossip  NewGossipService -> INFO 028 Creating gossip service with self membership of Endpoint: 172.16.13.2:7051, InternalEndpoint: peer:7051, PKI-ID: 0f8f24c0ca4096ddb8922200bb8c5b69ec71bbe21ca0dbb320243d18bee03a28, Metadata:  {code}  After: {code} 2020-11-21 22:27:51.111 UTC  gossip.gossip  NewGossipService -> INFO 030 Creating gossip service with self membership of Endpoint: 172.16.13.2:7051, InternalEndpoint: 172.16.13.2:7051, PKI-ID: 2bfe8770b2cd2b42cf5ba211d102a4ef4b8a9dc6e0dddfbf44ad6205c97dc7d1, Metadata: {code}  But other peers don't forget the old pki-id and this leads to problems: {code} 2020-11-25 17:54:24.267 UTC  gossip.comm  func1 -> WARN 92e7d 172.16.13.2:7051, PKIid:2bfe8770b2cd2b42cf5ba211d102a4ef4b8a9dc6e0dddfbf44ad6205c97dc7d1 isn't responsive: EOF 2020-11-25 17:54:24.413 UTC  gossip.comm  func1 -> WARN 92e7e 172.16.13.2:7051, PKIid:0f8f24c0ca4096ddb8922200bb8c5b69ec71bbe21ca0dbb320243d18bee03a28 isn't responsive: EOF {code}  Sometimes a peer with a new certificate gets completely isolated (because all connections are droped??) {code} 2020-11-23 20:51:34.953 UTC  gossip.discovery  getDeadMembers -> WARN 1b220 Haven't heard from  146 41 71 175 123 191 155 0 15 188 113 74 213 73 183 211 105 142 75 102 113 34 237 169 121 143 66 64 132 137 242 113  for 33.4397331s 2020-11-23 20:51:34.953 UTC  gossip.discovery  getDeadMembers -> WARN 1b221 Haven't heard from  186 97 170 200 31 57 62 54 29 100 131 44 252 157 29 132 181 239 82 74 57 132 3 175 66 26 177 212 96 185 1 163  for 33.2619925s 2020-11-23 20:51:34.953 UTC  gossip.discovery  getDeadMembers -> WARN 1b222 Haven't heard from  221 20 65 5 216 134 55 194 171 4 234 215 28 207 184 250 60 194 145 81 13 186 195 230 37 186 46 153 226 7 135 125  for 38.8349949s 2020-11-23 20:51:34.954 UTC  gossip.discovery  getDeadMembers -> WARN 1b223 Haven't heard from  130 176 95 1 134 199 156 102 84 92 59 133 187 61 230 156 173 192 20 116 114 230 182 185 175 197 57 202 97 233 250 75  for 33.2500996s 2020-11-23 20:51:34.954 UTC  gossip.discovery  getDeadMembers -> WARN 1b224 Haven't heard from  81 178 245 35 135 18 204 222 107 217 30 9 188 27 116 160 132 51 150 144 91 5 46 28 70 199 34 17 254 67 171 36  for 33.1041457s 2020-11-23 20:51:34.954 UTC  gossip.discovery  expireDeadMembers -> WARN 1b225 Entering  922947af7bbf9b000fbc714ad549b7d3698e4b667122eda9798f42408489f271 ba61aac81f393e361d64832cfc9d1d84b5ef524a398403af421ab1d460b901a3 dd144105d88637c2ab04ead71ccfb8fa3cc291510dbac3e625ba2e99e207877d 82b05f0186c79c66545c3b85bb3de69cadc0147472e6b6b9afc539ca61e9fa4b 51b2f5238712ccde6bd91e09bc1b74a0843396905b052e1c46c72211fe43ab24  2020-11-23 20:51:34.954 UTC  gossip.discovery  expireDeadMembers -> WARN 1b226 Closing connection to Endpoint: 172.16.11.3:7051, InternalEndpoint: , PKI-ID: 922947af7bbf9b000fbc714ad549b7d3698e4b667122eda9798f42408489f271, Metadata:  2020-11-23 20:51:34.954 UTC  gossip.discovery  expireDeadMembers -> WARN 1b227 Closing connection to Endpoint: 172.16.18.2:7051, InternalEndpoint: , PKI-ID: ba61aac81f393e361d64832cfc9d1d84b5ef524a398403af421ab1d460b901a3, Metadata:  2020-11-23 20:52:09.014 UTC  gossip.discovery  expireDeadMembers -> WARN 1b228 Closing connection to Endpoint: 172.16.20.2:7051, InternalEndpoint: , PKI-ID: dd144105d88637c2ab04ead71ccfb8fa3cc291510dbac3e625ba2e99e207877d, Metadata:  2020-11-23 20:52:19.904 UTC  gossip.comm  func1 -> WARN 1b229 172.16.12.2:7051, PKIid:82b05f0186c79c66545c3b85bb3de69cadc0147472e6b6b9afc539ca61e9fa4b isn't responsive: EOF 2020-11-23 20:52:29.467 UTC  gossip.discovery  expireDeadMembers -> WARN 1b22a Closing connection to Endpoint: 172.16.12.2:7051, InternalEndpoint: , PKI-ID: 82b05f0186c79c66545c3b85bb3de69cadc0147472e6b6b9afc539ca61e9fa4b, Metadata:  2020-11-23 20:52:29.468 UTC  gossip.discovery  expireDeadMembers -> WARN 1b22b Closing connection to Endpoint: 172.16.14.2:7051, InternalEndpoint: , PKI-ID: 51b2f5238712ccde6bd91e09bc1b74a0843396905b052e1c46c72211fe43ab24, Metadata:  2020-11-23 20:52:29.468 UTC  gossip.discovery  expireDeadMembers -> WARN 1b22c Exiting {code}   This peer also tries to connect to the "old version of it": {code} 2020-11-23 16:59:43.755 UTC  gossip.comm  func1 -> WARN 17b2a 172.16.13.2:7051, PKIid:0f8f24c0ca4096ddb8922200bb8c5b69ec71bbe21ca0dbb320243d18bee03a28 isn't responsive: EOF {code}  Additionaly: this peer has high memory and CPU usage, I think there is some sort of memory link. (is FAB-17289 releated?)   Is there a workaround to normalize this situation?  ></description> </Issue>
