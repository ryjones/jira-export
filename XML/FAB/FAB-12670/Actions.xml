<Action id="52869" issue="35028" author="sambhavdutt" type="comment" created="2018-11-01 04:05:33.0" updateauthor="sambhavdutt" updated="2018-11-01 04:05:33.0"> <body><! CDATA There is another fail in the fabric-daily-s390x unit-tests due to error in the BCCSP package,   {code:java} 23:56:29 Immutable =  false Failed initiliazing BCCSP at  {SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:<nil> DummyKeystore:<nil> Library: Label:ForFabric Pin:98765432 SoftVerify:true Immutable:false} :  Failed initializing PKCS11 library  ForFabric: No PKCS11 library default FAIL	github.com/hyperledger/fabric/bccsp/pkcs11	0.033s 23:56:29 ok  	github.com/hyperledger/fabric/bccsp/signer	(cached)	coverage: 100.0% of statements  23:57:02 ok  	github.com/hyperledger/fabric/bccsp/sw	38.250s	coverage: 89.9% of statements 23:57:02 ?   	github.com/hyperledger/fabric/bccsp/sw/mocks	 no test files  23:57:02 ok  	github.com/hyperledger/fabric/bccsp/utils	(cached)	coverage: 85.5% of statements 23:57:02 Makefile:183: recipe for target 'unit-test' failed 23:57:02 make: ***  unit-test  Error 1 {code}  *Build Logs*  https://jenkins.hyperledger.org/view/Daily/job/fabric-daily-s390x/358/console  https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-daily-s390x/358/  ></body> </Action>
<Action id="52883" issue="35028" author="ashutosh_kumar" type="comment" created="2018-11-01 13:21:06.0" updateauthor="ashutosh_kumar" updated="2018-11-01 13:21:06.0"> <body><! CDATA looks like the softHsm library is not loaded.  ~sambhavdutt  , is there any change recently ?      ></body> </Action>
<Action id="52894" issue="35028" author="rameshthoomu" type="comment" created="2018-11-01 13:58:13.0" updateauthor="rameshthoomu" updated="2018-11-01 13:58:13.0"> <body><! CDATA  ~ashutosh_kumar  It seems this change is causing the problem   https://github.com/hyperledger/fabric/commit/f995aaed7f8b9470ac881be85368a1d243fbd036   Before this change, we used to run unit-tests in a docker container and the softhsm library is available in baseimage.. The above change tries to run tests on native machine..It seems softhsm is not installed on s390x builds.   ~dthom  Could you please install softhsm in all s390x builds. I found installation steps here  https://github.com/hyperledger/fabric/blob/c45fde94b72a0f2fad7db37dff54d08ed4b280a8/images/testenv/install-softhsm2.sh   Could you please work with  ~ashutosh_kumar   ></body> </Action>
<Action id="52922" issue="35028" author="ashutosh_kumar" type="comment" created="2018-11-01 20:26:40.0" updateauthor="ashutosh_kumar" updated="2018-11-01 20:26:40.0"> <body><! CDATA  ~dthom  , any update ?  ~rameshthoomu  , did you try it local ?      ></body> </Action>
<Action id="53025" issue="35028" author="sambhavdutt" type="comment" created="2018-11-05 14:35:03.0" updateauthor="sambhavdutt" updated="2018-11-05 14:35:03.0"> <body><! CDATA The daily unit-tests on the s390x platform, in master branch still fail with the same error,  *fabric commit: 0125e23* {code:java} 22:55:46 Immutable =  false Failed initiliazing BCCSP at  {SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:<nil> DummyKeystore:<nil> Library: Label:ForFabric Pin:98765432 SoftVerify:true Immutable:false} :  Failed initializing PKCS11 library  ForFabric: No PKCS11 library default FAIL	github.com/hyperledger/fabric/bccsp/pkcs11	0.061s 22:55:46 ok  	github.com/hyperledger/fabric/bccsp/signer	(cached)	coverage: 100.0% of statements 22:56:18 ok  	github.com/hyperledger/fabric/bccsp/sw	35.988s	coverage: 89.9% of statements 22:56:18 ?   	github.com/hyperledger/fabric/bccsp/sw/mocks	 no test files  22:56:18 ok  	github.com/hyperledger/fabric/bccsp/utils	(cached)	coverage: 85.5% of statements 22:56:18 Makefile:183: recipe for target 'unit-test' failed 22:56:18 make: ***  unit-test  Error 1 22:56:18 Build step 'Execute shell' marked build as failure {code}  *Build Log*  https://jenkins.hyperledger.org/view/Daily/job/fabric-daily-s390x/362/console  https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-daily-s390x/362/  ></body> </Action>
<Action id="53031" issue="35028" author="ashutosh_kumar" type="comment" body="The problem needs fix , which is to install softhsm in s390 base image." created="2018-11-05 15:36:00.0" updateauthor="ashutosh_kumar" updated="2018-11-05 15:36:00.0"/>
<Action id="53150" issue="35028" author="rameshthoomu" type="comment" created="2018-11-07 14:28:55.0" updateauthor="rameshthoomu" updated="2018-11-07 14:28:55.0"> <body><! CDATA Getting below error while installing softhsm https://github.com/hyperledger/fabric/blob/release-1.3/images/testenv/install-softhsm2.sh {code:java} ading package lists... Done W: Target Packages (main/binary-s390x/Packages) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 W: Target Packages (main/binary-all/Packages) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 W: Target Translations (main/i18n/Translation-en) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 W: GPG error: http://ftp.us.debian.org/debian sid InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY 8B48AD6246925553 NO_PUBKEY 7638D0442B90D010 NO_PUBKEY 04EE7237B7D453EC W: The repository 'http://ftp.us.debian.org/debian sid InRelease' is not signed. N: Data from such a repository can't be authenticated and is therefore potentially dangerous to use. N: See apt-secure(8) manpage for repository creation and user configuration details. W: Target Packages (main/binary-s390x/Packages) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 W: Target Packages (main/binary-all/Packages) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 W: Target Translations (main/i18n/Translation-en) is configured multiple times in /etc/apt/sources.list:57 and /etc/apt/sources.list:58 root@hyperledger-05:~# {code}  ></body> </Action>
<Action id="53221" issue="35028" author="harrijk" type="comment" created="2018-11-08 15:17:59.0" updateauthor="harrijk" updated="2018-11-08 15:17:59.0"> <body><! CDATA I took a quick look at the softhsm2 issue... Since we are now using debian stretch, softhsm2 is available by default and therefore, there is no need to have the following lines inside the  install-softhsm2.sh|http://install-softhsm2.sh/  script:   ARCH=`uname -m` if   $ARCH = "s390x"  ; then   echo "deb http://ftp.us.debian.org/debian sid main" >> /etc/apt/sources.list fi  ></body> </Action>
<Action id="53242" issue="35028" author="harsha544" type="comment" created="2018-11-09 04:40:00.0" updateauthor="harsha544" updated="2018-11-09 04:40:00.0"> <body><! CDATA We run Unit-tests as non-root user, as such whilst initializing token we invariably try access default{color:#de350b} /etc/softhsm/softhsm2.conf{color} which points tokens to be staged under {color:#de350b}/var/lib/softhsm/tokens{color} whose ownership/permission is limited to be used by root and it's associated groups. Changing ownership/permission of {color:#de350b}/var/lib/softhsm/tokens{color} doesn't solve the problem as we cannot access {color:#de350b}/etc/softhsm/softhsm2.conf{color} in first place given the access limitation, we should be doing this instead:-  _cd $HOME_ _mkdir -p $HOME/lib/softhsm/tokens_ _cd $HOME/lib/softhsm/_ _echo "directories.tokendir = $PWD/tokens" > softhsm2.conf_ _export SOFTHSM2_CONF=$HOME/lib/softhsm/softhsm2.conf_  softhsm2-util --init-token --slot 0 --label "ForFabric" --so-pin 1234 --pin 98765432  And if we explicitly test pkcs11 via  go test -cover -count=1 -tags ' pkcs11' github.com/hyperledger/fabric/bccsp/pkcs11  jenkins@blockchain-6:~/go/src/github.com/hyperledger/fabric$ go test -cover -count=1 -tags ' pkcs11' github.com/hyperledger/fabric/bccsp/pkcs11 ok github.com/hyperledger/fabric/bccsp/pkcs11 83.905s coverage: 78.3% of statements jenkins@blockchain-6:~/go/src/github.com/hyperledger/fabric$     or make unit-test should now pass, this workaround works well on x86/s390x/ppc64le as well.     ></body> </Action>
<Action id="53811" issue="35028" author="rameshthoomu" type="comment" body=" ~harsha544 , Could you please push this change to fabric? s390x jobs are failing since many days." created="2018-11-26 17:54:12.0" updateauthor="rameshthoomu" updated="2018-11-26 17:54:12.0"/>
<Action id="54077" issue="35028" author="harsha544" type="comment" body="https://gerrit.hyperledger.org/r/#/c/27759/" created="2018-11-30 14:08:02.0" updateauthor="harsha544" updated="2018-11-30 14:08:02.0"/>
<Action id="54150" issue="35028" author="jonathanlevi" type="comment" created="2018-12-02 04:42:08.0" updateauthor="jonathanlevi" updated="2018-12-02 04:42:08.0"> <body><! CDATA  ~rameshthoomu   ~harsha544  and everybody - thank you very much.   We could not run the unit-tests successfully on Macs and on some of our native platforms (that we deploy without vagrant/VBox).  The error is the same: ?   github.com/hyperledger/fabric/bccsp/mocks  no test files  Immutable =  false Failed initiliazing BCCSP at  \{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:<nil> DummyKeystore:<nil> Library: Label:ForFabric Pin:98765432 SoftVerify:true Immutable:false} :  Failed initializing PKCS11 library  ForFabric: No PKCS11 library default FAIL github.com/hyperledger/fabric/bccsp/pkcs11 0.034s ok   github.com/hyperledger/fabric/bccsp/signer (cached) coverage: 100.0% of statements  Can confirm that I ran the submitted CR and it bypasses the initialization issues.   Thanks again!  ></body> </Action>
<Action id="54279" issue="35028" author="tock" type="comment" body="The change in the Makefile in the recent merge breaks the local build because softhsm2-util is not installed. And to top it off, you allow yourself to mkdir on $HOME. This is very intrusive." created="2018-12-04 15:07:42.0" updateauthor="tock" updated="2018-12-04 15:08:08.0"/>
<Action id="54282" issue="35028" author="harsha544" type="comment" created="2018-12-04 15:26:52.0" updateauthor="harsha544" updated="2018-12-04 15:26:52.0"> <body><! CDATA The local build *never fails*, it's rather UT that fails, the PR introduces changes to fixate issue post testenv target removal from Makefile.  If you go through the suggestions that went in we have updated documentation that suggests Developers to update the environment with softhsm installation.  Any user specific change, as recommended in this change should be specific to a user's $HOME directory and not globally, as such SOFTHSM2_CONF was update to leverage $HOME directory path.  ></body> </Action>
<Action id="54300" issue="35028" author="tock" type="comment" created="2018-12-04 18:01:42.0" updateauthor="tock" updated="2018-12-04 18:01:42.0"> <body><! CDATA Got it. I installed softhsm2 per the instructions and it works.  I still think that this script has no business modifying the users $HOME directory. I think it will be safer to create a directory (.softhsm2 maybe?) next to the .build directory under the hyperledger/fabric folder. you can add that to the .gitignore and point SOFTHSM2_CONF  there.     ></body> </Action>
<Action id="54327" issue="35028" author="sykesm" type="comment" created="2018-12-04 22:39:50.0" updateauthor="sykesm" updated="2018-12-04 22:39:50.0"> <body><! CDATA I've opened https://jira.hyperledger.org/browse/FAB-13164 to revert this change. We also need to revert the corresponding CI change in FABCI-227.  I agree with Yoav that writing to files outside of the build tree is an extremely unfriendly, somewhat arrogant act. These changes have also broken existing, functional local unit tests (which is what devs care about when we "build") on MacOS.  We need a solution that does not modify files outside of the build tree and that works consistently across Linux and Darwin.  ></body> </Action>
<Action id="54329" issue="35028" author="sykesm" type="comment" created="2018-12-04 22:41:19.0" updateauthor="sykesm" updated="2018-12-04 22:41:19.0"> <body><! CDATA  ~JonathanLevi  Setting these environment variables (pointing to the correct library location on Darwin) would allow the tests to run:  {code} # This enables bccsp pkcs11 tests: # softhsm2-util --init-token --label ForFabric --pin 98765432 --slot 0 --so-pin 1234 if   -f /usr/local/Cellar/softhsm/2.5.0/lib/softhsm/libsofthsm2.so  ; then export PKCS11_LIB="/usr/local/Cellar/softhsm/2.5.0/lib/softhsm/libsofthsm2.so" export PKCS11_PIN=98765432 export PKCS11_LABEL="ForFabric" fi {code}  ></body> </Action>
<Action id="54340" issue="35028" author="harsha544" type="comment" created="2018-12-05 02:36:00.0" updateauthor="harsha544" updated="2018-12-05 02:38:17.0"> <body><! CDATA Agreed with Yoav, we can point SOFTHSM in build tree, this PR did sit out for quiet for sometime for reviews, and have incorporated changes based on suggestions/feedback.  It might solve intermittent issues on MAC but this doesn't allow softhsm2 token to be generated for pkcs11 tests on CI/Ubuntu Systems, as mentioned. # This enables bccsp pkcs11 tests: # softhsm2-util --init-token --label ForFabric --pin 98765432 --slot 0 --so-pin 1234if   -f /usr/local/Cellar/softhsm/2.5.0/lib/softhsm/libsofthsm2.so  ; then export PKCS11_LIB="/usr/local/Cellar/softhsm/2.5.0/lib/softhsm/libsofthsm2.so" export PKCS11_PIN=98765432 export PKCS11_LABEL="ForFabric"  fi        Probably having a conditional statement that identifies underlying Linux/Darwin should suffice.     ></body> </Action>
<Action id="54509" issue="35028" author="rameshthoomu" type="comment" body="Re-open this issue as the fix is reverted in fabric and CI config." created="2018-12-07 22:20:59.0" updateauthor="rameshthoomu" updated="2018-12-19 17:02:35.0"/>
<Action id="54747" issue="35028" author="sambhavdutt" type="comment" created="2018-12-13 02:16:25.0" updateauthor="sambhavdutt" updated="2018-12-13 02:16:25.0"> <body><! CDATA I see the unit-test , <s390x>, <release-1.4> branch and the <master> are failing with the same error, *Softhsm* is not installed. This is expected but just want to update the status.  *fabric commit <release-1.4>* c10e00c7cd7d031b654dcb115db3267b5b5dcc39  {code:java} 19:46:09 Immutable =  false Failed initiliazing BCCSP at  {SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:<nil> DummyKeystore:<nil> Library:/usr/lib/s390x-linux-gnu/softhsm/libsofthsm2.so Label:ForFabric Pin:98765432 SoftVerify:true Immutable:false} :  Failed initializing PKCS11 library /usr/lib/s390x-linux-gnu/softhsm/libsofthsm2.so ForFabric: Could not get Slot List  pkcs11: 0x190: CKR_CRYPTOKI_NOT_INITIALIZED  FAIL	github.com/hyperledger/fabric/bccsp/pkcs11	0.040s {code}  *Build Log*  https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-unit-test-daily-release-1.4-s390x/1/  ></body> </Action>
<Action id="54964" issue="35028" author="vijaypunugubati" type="comment" created="2018-12-19 14:29:18.0" updateauthor="vijaypunugubati" updated="2018-12-19 14:31:05.0"> <body><! CDATA *Unit-test fails* consistently on the *release-1.4* branch due to *softhsm* from last 6 days. {code:java} /19:46:52 Immutable =  false Failed initiliazing BCCSP at  {SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:<nil> DummyKeystore:<nil> Library:/usr/lib/s390x-linux-gnu/softhsm/libsofthsm2.so Label:ForFabric Pin:98765432 SoftVerify:true Immutable:false} :  Failed initializing PKCS11 library /usr/lib/s390x-linux-gnu/softhsm/libsofthsm2.so ForFabric: Could not get Slot List  pkcs11: 0x190: CKR_CRYPTOKI_NOT_INITIALIZED  FAIL	github.com/hyperledger/fabric/bccsp/pkcs11	0.037s 19:46:52 ok  	github.com/hyperledger/fabric/bccsp/signer	(cached)	coverage: 100.0% of statements 19:47:27 ok  	github.com/hyperledger/fabric/bccsp/sw	37.842s	coverage: 90.2% of statements 19:47:27 ?   	github.com/hyperledger/fabric/bccsp/sw/mocks	 no test files  19:47:27 ok  	github.com/hyperledger/fabric/bccsp/utils	(cached)	coverage: 85.5% of statements 19:47:27 Makefile:187: recipe for target 'unit-test' failed/ code placeholder {code} Build logs:   https://jenkins.hyperledger.org/view/Daily/job/fabric-unit-test-daily-release-1.4-s390x/4/console      ></body> </Action>
<Action id="54965" issue="35028" author="jonathanlevi" type="comment" created="2018-12-19 14:33:45.0" updateauthor="jonathanlevi" updated="2018-12-19 14:33:45.0"> <body><! CDATA While I know that nobody believes me ;-), as of course, I don't have an s390 laptop version ;-)  But, we have repeatedly observed similar inconaisinco behaviour if that token directory is not in place.  I am tempted to push a CR that may prevent this, or at the very least, do no harm.  While I don't mind thia specific error in general, I am usually very concerned when things are not deterministic.  ></body> </Action>
<Action id="54991" issue="35028" author="jonathanlevi" type="comment" created="2018-12-19 17:22:22.0" updateauthor="jonathanlevi" updated="2018-12-19 17:22:22.0"> <body><! CDATA I have self-assigned this and may need some help with somebody with access to an s390 machine...  Otherwise, please feel free to grab this.     ></body> </Action>
<Action id="55169" issue="35028" author="rameshthoomu" type="comment" body="This has been fixed in s390x job by intiatializing the token. Here is the change https://gerrit.hyperledger.org/r/#/c/28389/2/jjb/fabric/fabric-macros.yaml" created="2018-12-29 00:48:40.0" updateauthor="rameshthoomu" updated="2018-12-29 00:48:40.0"/>
<Action id="55170" issue="35028" author="rameshthoomu" type="comment" body="https://jenkins.hyperledger.org/view/Daily/job/fabric-daily-s390x/" created="2018-12-29 01:59:56.0" updateauthor="rameshthoomu" updated="2018-12-29 01:59:56.0"/>
