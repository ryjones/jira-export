<Issue id="46276" key="FAB-18308" number="18308" project="10002" reporter="JIRAUSER21018" assignee="JIRAUSER21018" creator="JIRAUSER21018" type="10004" summary="Migrate an existing ledger from fabric 1.4.6 to 2.x if there are RSA certificates in any block of a channel to which the orderers belong to." priority="1" resolution="10000" status="6" created="2020-11-02 16:27:24.0" updated="2020-11-21 12:45:32.0" resolutiondate="2020-11-21 12:45:32.0" votes="0" watches="4" workflowId="60190" archived="N"> <description><! CDATA Having an existing ledger with rsa certificates 1.4.x, in order to upgrade to the latest fabric 2.x, the following steps were executed:   Our starting point was: * Single organization * 5 orderers (orderer 0, orderer 1, …. orderer 4) working using Raft consensus mechanism * 1 CA using RSA encryption * 1 system channel which the orderers are using * 1 application channel used, well, by our application * 2 peers that joined the application channel * All fabric components running on fabric 1.4.6 * Ledger type = file on both orderer and peers    This is the procedure we executed to move away from RSA to ECSDA (before upgrading to 2.2): * Had the 5 orderers and 2 peers running * Stopped the CA * Regenerated the CA’s MSP based on ECSDA * Started the CA * updated both system channel and application channel to add this new public certificate of the CA to the org using the MSP of the org’s admin (signed with the previous CA’s MSP). This was done by generating a channel config update transaction based on a delta computed and converted to and from json/protbuf using configtxlator * Regenerated the org’s admin MSP to be based on ECSDA and added his public certificate to the org (signed with the previous CA’s MSP). This was done by generating a channel config update transaction based on a delta computed and converted to and from json/protbuf using configtxlator * Regenerated orderer 0's MSP based on ECSDA * Updated the raft consenter section of the config block (of both system and application channels) to update orderer 0's certificate (orderer 0 is still running). Did that via the config update transaction * Once the new block was distributed, backed up orderer 0, stopped orderer 0, and restarted it using the new MSP * Orderer 0 started with the new MSP and used the latest config block to join the Raft cluster * Repeated these steps for orderers 1-4 * After this we had all orderers communicating over raft using ECSDA MSPs * Then we regenerated both peers MSPs based on ECSDA * Then we backed up one of the peers, stopped it and restarted it using the new MSP * Repeated the process for the other peer * Then, using the new admin’s MSP, we generated a config update transaction to remove the previous CA and admin certificates from both the system and application channels * Then executed some test transactions using the new MSPs and verified that it worked fine * Extracted the latest config block (from both system and application channeles), converted it to JSON and ensured that there were no RSA certificates    Then we attempted to upgrade to fabric 2.2: * we backed up orderer 0 * stopped orderer 0 * upgraded the base image to 2.2 * started it * And it failed when it was validating the existing ledger:    2020-10-28 12:22:25.282 UTC  orderer.common.server  Main -> PANIC Failed validating bootstrap block: initializing channelconfig failed: could not create channel Orderer sub-group config: setting up the MSP manager failed: Failed importing key with opts  &\\{true} : Certificate’s public key type not recognized. Supported keys:  ECDSA  panic: Failed validating bootstrap block: initializing channelconfig failed: could not create channel Orderer sub-group config: setting up the MSP manager failed: Failed importing key with opts  &\\{true} : Certificate’s public key type not recognized. Supported keys:  ECDSA    Then we tried a different approach: * stopped orderer 0 (without any backup) * set up the genesis block to be the current config block * started it (with the ECSDA MSP and an empty production folder) * It used to block correctly and connected to the raft consensus * It started receiving the ledger from both channels * It crashed with the same error    As far as we can determine, there is no way to migrate an existing ledger from fabric 1.4.6 to 2.x if there are RSA certificates in any block of a channel to which the orderers belong to.  ></description> </Issue>
