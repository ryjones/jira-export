<Issue id="37620" key="FAB-14145" number="14145" project="10002" reporter="jlcs" creator="jlcs" type="10004" summary="Endorsement policy n-of fails for n&gt;1 and only for some operations." priority="3" resolution="10203" status="6" created="2019-02-12 12:40:09.0" updated="2019-02-13 09:22:29.0" resolutiondate="2019-02-13 07:56:39.0" votes="0" watches="3" workflowId="49234"> <description><! CDATA Hello, I'm having trouble with the n-of endorsement policy. In particular, I'm using a 3-of policy with 4 deployed peers in the channel. I use a custom manager to communicate with the network through the node SDK.  All versions are for Fabric 1.4.  A particular operation, let's call it Y, over the chaincode (with writes) works fine, but other operations always fail with an ENDORSEMENT_POLICY_FAILURE.  Reading the debug logs in the peer, it appears to validate the signature of the first endorsement, but the other 3 endorsements have invalid signatures. Nonetheless, the same peers successfully sign the Y operation.  Also, I print the following with results being the ProposalResponseObject returned by the SDK:  {{for(let res of results 0 ) { console.log("=====> ", this._channel.verifyProposalResponse(res as ProposalResponse)); } /* Prints: =====> true =====> true =====> true =====> true */}}  If I use a 1-of policy, everything works.  If it weren't because calling the same chaincode with different arguments (the function) works, I would suspect that the signatures are indeed invalid and the SDK fails.   ----------  The DEBUG logs of one of the peers shows (only partial logs for clarity):  * For the successful endorsement:  {{  36m2019-02-12 10:15:15.556 UTC  committer.txvalidator  Validate -> DEBU 13193  0m  rrb  START Block Validation for block  6   36m2019-02-12 10:15:15.556 UTC  protoutils  checkSignatureFromCreator -> DEBU 1319c  0m creator is valid  36m2019-02-12 10:15:15.558 UTC  protoutils  validateEndorserTransaction -> DEBU 131a2  0m validateEndorserTransaction info: signature header is valid   36m2019-02-12 10:15:15.559 UTC  cauthdsl  func2 -> DEBU 131b0  0m 0xc003527480 signed by 0 principal evaluation starts (used  false false false false )    36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131b1  0m 0xc003527480 processing identity 0 with bytes of a997a0  36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131b2  0m 0xc003527480 principal matched by identity 0  36m2019-02-12 10:15:15.560 UTC  msp.identity  Verify -> DEBU 131b4  0m Verify: digest = ...  36m2019-02-12 10:15:15.560 UTC  msp.identity  Verify -> DEBU 131b5  0m Verify: sig = ...  36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131bc  0m 0xc003527480 principal evaluation succeeds for identity 0   36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131be  0m 0xc003527480 signed by 1 principal evaluation starts (used  true false false false )    36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131c0  0m 0xc003527480 skipping identity 0 because it has already been used  36m2019-02-12 10:15:15.560 UTC  cauthdsl  func2 -> DEBU 131c2  0m 0xc003527480 principal matched by identity 1  36m2019-02-12 10:15:15.561 UTC  cauthdsl  func2 -> DEBU 131cc  0m 0xc003527480 principal evaluation succeeds for identity 1   36m2019-02-12 10:15:15.561 UTC  cauthdsl  func2 -> DEBU 131cd  0m 0xc003527480 signed by 2 principal evaluation starts (used  true true false false )   36m2019-02-12 10:15:15.561 UTC  cauthdsl  func2 -> DEBU 131ce  0m 0xc003527480 skipping identity 0 because it has already been used  36m2019-02-12 10:15:15.561 UTC  cauthdsl  func2 -> DEBU 131cf  0m 0xc003527480 skipping identity 1 because it has already been used  36m2019-02-12 10:15:15.561 UTC  cauthdsl  func2 -> DEBU 131d1  0m 0xc003527480 principal matched by identity 2  36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131d4  0m 0xc003527480 principal evaluation succeeds for identity 2   36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131d5  0m 0xc003527480 signed by 3 principal evaluation starts (used  true true true false )   36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131d6  0m 0xc003527480 skipping identity 0 because it has already been used  36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131d7  0m 0xc003527480 skipping identity 1 because it has already been used  36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131d8  0m 0xc003527480 skipping identity 2 because it has already been used  36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131da  0m 0xc003527480 principal matched by identity 3  36m2019-02-12 10:15:15.562 UTC  cauthdsl  func2 -> DEBU 131dd  0m 0xc003527480 principal evaluation succeeds for identity 3   36m2019-02-12 10:15:15.562 UTC  cauthdsl  func1 -> DEBU 131de  0m 0xc003527480 gate 1549966515559216071 evaluation succeeds  36m2019-02-12 10:15:15.563 UTC  vscc  Validate -> DEBU 131df  0m block 6, namespace: *****, tx 0 validation results is: <nil>  }} -----------  * For the failing endorsement:  {{  36m2019-02-12 10:32:12.473 UTC  cauthdsl  func2 -> DEBU 7aa3d  0m 0xc0031a0a40 signed by 0 principal evaluation starts (used  false false false false )   36m2019-02-12 10:32:12.473 UTC  cauthdsl  func2 -> DEBU 7aa3f  0m 0xc0031a0a40 principal matched by identity 0  36m2019-02-12 10:32:12.473 UTC  msp.identity  Verify -> DEBU 7aa40  0m Verify: digest = ...  36m2019-02-12 10:32:12.473 UTC  msp.identity  Verify -> DEBU 7aa41  0m Verify: sig = ...  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa42  0m 0xc0031a0a40 principal evaluation succeeds for identity 0   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa43  0m 0xc0031a0a40 signed by 1 principal evaluation starts (used  true false false false )   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa44  0m 0xc0031a0a40 skipping identity 0 because it has already been used  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa45  0m 0xc0031a0a40 processing identity 1 with bytes of a997a0  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa46  0m 0xc0031a0a40 principal matched by identity 1  36m2019-02-12 10:32:12.474 UTC  msp.identity  Verify -> DEBU 7aa47  0m Verify: digest = ...  36m2019-02-12 10:32:12.474 UTC  msp.identity  Verify -> DEBU 7aa48  0m Verify: sig = ...   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa49  0m 0xc0031a0a40 signature for identity 1 is invalid: The signature is invalid   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4a  0m 0xc0031a0a40 processing identity 2 with bytes of a997a0  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4b  0m 0xc0031a0a40 identity 2 does not satisfy principal: the identity is a member of a different MSP (expected *******MSP, got ***********MSP)  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4c  0m 0xc0031a0a40 processing identity 3 with bytes of a997a0  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4d  0m 0xc0031a0a40 identity 3 does not satisfy principal: the identity is a member of a different MSP (expected *******MSP, got *************MSP)  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4e  0m 0xc0031a0a40 principal evaluation fails   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa4f  0m 0xc0031a0a40 signed by 2 principal evaluation starts (used  true false false false )   36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa50  0m 0xc0031a0a40 skipping identity 0 because it has already been used  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa51  0m 0xc0031a0a40 processing identity 1 with bytes of a997a0  36m2019-02-12 10:32:12.474 UTC  cauthdsl  func2 -> DEBU 7aa52  0m 0xc0031a0a40 identity 1 does not satisfy principal: the identity is a member of a different MSP (expected ***********MSP, got *******MSP)  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa53  0m 0xc0031a0a40 processing identity 2 with bytes of a997a0  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa54  0m 0xc0031a0a40 principal matched by identity 2  36m2019-02-12 10:32:12.475 UTC  msp.identity  Verify -> DEBU 7aa55  0m Verify: digest = ...  36m2019-02-12 10:32:12.475 UTC  msp.identity  Verify -> DEBU 7aa56  0m Verify: sig = ...   36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa57  0m 0xc0031a0a40 signature for identity 2 is invalid: The signature is invalid   36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa58  0m 0xc0031a0a40 processing identity 3 with bytes of a997a0  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa59  0m 0xc0031a0a40 identity 3 does not satisfy principal: the identity is a member of a different MSP (expected ***********MSP, got *************MSP)  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5a  0m 0xc0031a0a40 principal evaluation fails   36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5b  0m 0xc0031a0a40 signed by 3 principal evaluation starts (used  true false false false )   36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5c  0m 0xc0031a0a40 skipping identity 0 because it has already been used  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5d  0m 0xc0031a0a40 processing identity 1 with bytes of a997a0  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5e  0m 0xc0031a0a40 identity 1 does not satisfy principal: the identity is a member of a different MSP (expected *************MSP, got *******MSP)  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa5f  0m 0xc0031a0a40 processing identity 2 with bytes of a997a0  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa60  0m 0xc0031a0a40 identity 2 does not satisfy principal: the identity is a member of a different MSP (expected *************MSP, got ***********MSP)  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa61  0m 0xc0031a0a40 processing identity 3 with bytes of a997a0  36m2019-02-12 10:32:12.475 UTC  cauthdsl  func2 -> DEBU 7aa62  0m 0xc0031a0a40 principal matched by identity 3  36m2019-02-12 10:32:12.475 UTC  msp.identity  Verify -> DEBU 7aa63  0m Verify: digest = ...  36m2019-02-12 10:32:12.475 UTC  msp.identity  Verify -> DEBU 7aa64  0m Verify: sig = ...   36m2019-02-12 10:32:12.476 UTC  cauthdsl  func2 -> DEBU 7aa65  0m 0xc0031a0a40 signature for identity 3 is invalid: The signature is invalid   36m2019-02-12 10:32:12.476 UTC  cauthdsl  func2 -> DEBU 7aa66  0m 0xc0031a0a40 principal evaluation fails   36m2019-02-12 10:32:12.476 UTC  cauthdsl  func1 -> DEBU 7aa67  0m 0xc0031a0a40 gate 1549967532473433662 evaluation fails  31m2019-02-12 10:32:12.476 UTC  vscc  Validate -> ERRO 7aa68  0m VSCC error: stateBasedValidator.Validate failed, err validation of endorsement policy for chaincode **** in tx 7:0 failed: signature set did not satisfy policy  }}   ----------    Anywhere else I could look for debugging info? Thanks  ></description> </Issue>
