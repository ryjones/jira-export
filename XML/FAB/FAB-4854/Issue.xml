<Issue id="18280" key="FAB-4854" number="4854" project="10002" reporter="c0rwin" assignee="c0rwin" creator="c0rwin" type="10004" summary="Intermitently failing test -- TestMsgStoreExpiration" priority="3" resolution="10000" status="6" created="2017-06-18 16:15:30.0" updated="2018-07-20 14:13:30.0" resolutiondate="2017-06-19 01:30:38.0" votes="0" watches="1" workflowId="39184" security="10001"> <description><! CDATA From time to time {{TestMsgStoreExpiration}} appears to fail in CI due to timeout reached while waiting for peers to stabilize on membership view:  {code} 10:37:19 unit-tests_1  | 2017-06-18 10:37:04.171 UTC  gossip/discovery#localhost:2613  expireDeadMembers -> WARN 4e8 Closing connection to Endpoint: localhost:2614, InternalEndpoint: localhost:2614, PKI-ID:  108 111 99 97 108 104 111 115 116 58 50 54 49 52 , Metadata:    10:37:19 unit-tests_1  | 2017-06-18 10:37:04.172 UTC  gossip/discovery#localhost:2613  expireDeadMembers -> WARN 4e9 Closing connection to Endpoint: localhost:2615, InternalEndpoint: localhost:2615, PKI-ID:  108 111 99 97 108 104 111 115 116 58 50 54 49 53 , Metadata:    10:37:19 unit-tests_1  | 2017-06-18 10:37:04.172 UTC  gossip/discovery#localhost:2613  expireDeadMembers -> WARN 4ea Exiting 10:37:19 unit-tests_1  | --- FAIL: TestMsgStoreExpiration (37.80s) 10:37:19 unit-tests_1  | 	assertions.go:225:   	Error Trace:	discovery_test.go:1177 10:37:19 unit-tests_1  | 		 			discovery_test.go:1165 10:37:19 unit-tests_1  | 		 			discovery_test.go:1217 10:37:19 unit-tests_1  | 		 			discovery_test.go:848 10:37:19 unit-tests_1  | 		 	Error:		Timeout expired! 10:37:19 unit-tests_1  | 		 10:37:19 unit-tests_1  | 	assertions.go:225:   	Error Trace:	discovery_test.go:1177 10:37:19 unit-tests_1  | 		 			discovery_test.go:1165 10:37:19 unit-tests_1  | 		 			discovery_test.go:1217 10:37:19 unit-tests_1  | 		 			discovery_test.go:890 10:37:19 unit-tests_1  | 		 	Error:		Timeout expired! 10:37:19 unit-tests_1  | 		 10:37:19 unit-tests_1  | FAIL 10:37:19 unit-tests_1  | coverage: 83.9% of statements 10:37:19 unit-tests_1  | FAIL	github.com/hyperledger/fabric/gossip/discovery	38.252s 10:37:19 unit-tests_1  | error: exit status 1 10:37:19 unit-tests_1  | panic: EOF 10:37:19 unit-tests_1  |  10:37:19 unit-tests_1  | goroutine 1  running : 10:37:19 unit-tests_1  | panic(0x4daca0, 0xc420064020) 10:37:19 unit-tests_1  | 	/opt/go/src/runtime/panic.go:500 +0x1a1 10:37:19 unit-tests_1  | main.main() 10:37:19 unit-tests_1  | 	/opt/gotools/obj/gopath/src/github.com/AlekSi/gocov-xml/gocov-xml.go:60 +0x15fd 10:37:19 unittest_unit-tests_1 exited with code 2 10:37:19 Stopping couchdb ...  {code}  https://jenkins.hyperledger.org/job/fabric-verify-x86_64/13569/console  Here is related code from the test:  {code} 	assertMembership(t, instances, nodeNum-1)  	waitUntilOrFailBlocking(t, instances nodeNum-1 .Stop) 	waitUntilOrFailBlocking(t, instances nodeNum-2 .Stop)  	assertMembership(t, instances :len(instances)-2 , nodeNum-3) {code}  And {{assertMembership}} function which implemented following way:  {code} func assertMembership(t *testing.T, instances   *gossipInstance, expectedNum int) { 	fullMembership := func() bool { 		for _, inst := range instances { 			if len(inst.GetMembership()) != expectedNum { 				return false 			} 		} 		return true 	} 	waitUntilOrFail(t, fullMembership) } {code}   ></description> </Issue>
