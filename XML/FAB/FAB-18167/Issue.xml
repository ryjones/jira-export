<Issue id="45832" key="FAB-18167" number="18167" project="10002" reporter="wlahti" assignee="wlahti" creator="wlahti" type="10004" summary="Raft active nodes flakey when switching follower to member " priority="3" resolution="10204" status="6" created="2020-08-15 19:17:47.0" updated="2020-08-17 17:02:11.0" resolutiondate="2020-08-17 17:02:11.0" votes="0" watches="1" workflowId="59738" archived="N"> <description><! CDATA At times, the active nodes reported by Raft are temporarily unstable. I've noticed this while working on an integration test where I add an OSN as a follower, wait for it to catch up, and then add it to the consenters set.   When the active nodes are incorrectly reported, I see the following (note the Check logs - one halfway down and one at the end):  {code:java} STEP: ensuring orderer3 transitions from follower to member  e  OrdererOrg.orderer1  2020-08-15 14:01:09.596 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 073 Sending msg of 28 bytes to 2 on channel participation-trophy took 11.708µs  e  OrdererOrg.orderer1  2020-08-15 14:01:09.596 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 074 Sending msg of 28 bytes to 3 on channel participation-trophy took 8.215µs  e  OrdererOrg.orderer1  2020-08-15 14:01:09.596 EDT  orderer.consensus.etcdraft  logSendFailure -> ERRO 075 Failed to send StepRequest to 3, because: aborted channel=participation-trophy node=1  e  OrdererOrg.orderer1  2020-08-15 14:01:09.596 EDT  orderer.consensus.etcdraft  stepLeader -> DEBU 076 1 failed to send message to 3 because it is unreachable  next = 8, match = 0, state = ProgressStateProbe, waiting = false, pendingSnapshot = 0  channel=participation-trophy node=1  e  OrdererOrg.orderer2  2020-08-15 14:01:09.597 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 053 Sending msg of 28 bytes to 1 on channel participation-trophy took 9.881µs  e  OrdererOrg.orderer1  2020-08-15 14:01:10.098 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 077 Sending msg of 28 bytes to 2 on channel participation-trophy took 15.206µs  e  OrdererOrg.orderer1  2020-08-15 14:01:10.098 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 078 Sending msg of 28 bytes to 3 on channel participation-trophy took 63.591µs  e  OrdererOrg.orderer1  2020-08-15 14:01:10.098 EDT  orderer.consensus.etcdraft  send -> INFO 079 Successfully sent StepRequest to 3 after failed attempt(s) channel=participation-trophy node=1  e  OrdererOrg.orderer2  2020-08-15 14:01:10.098 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 054 Sending msg of 28 bytes to 1 on channel participation-trophy took 9.88µs  e  OrdererOrg.orderer3  2020-08-15 14:01:10.098 EDT  comm.grpc.server  1 -> INFO 039 streaming call completed grpc.service=orderer.Cluster grpc.method=Step grpc.peer_address=127.0.0.1:59031 grpc.peer_subject="CN=orderer1.example.com,L=San Francisco,ST=California,C=US" error="channel participation-trophy doesn't exist" grpc.code=Unknown grpc.call_duration=159.114µs  e  OrdererOrg.orderer1  2020-08-15 14:01:10.599 EDT  orderer.consensus.etcdraft  Check -> DEBU 07a Current active nodes in cluster are:  1 2 3  channel=participation-trophy node=1  e  OrdererOrg.orderer1  2020-08-15 14:01:10.599 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 07b Sending msg of 28 bytes to 2 on channel participation-trophy took 10.953µs  e  OrdererOrg.orderer1  2020-08-15 14:01:10.599 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 07c Sending msg of 28 bytes to 3 on channel participation-trophy took 8.432µs  e  OrdererOrg.orderer2  2020-08-15 14:01:10.599 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 055 Sending msg of 28 bytes to 1 on channel participation-trophy took 5.733µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.100 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 07d Sending msg of 28 bytes to 2 on channel participation-trophy took 10.589µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.100 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 07e Sending msg of 28 bytes to 3 on channel participation-trophy took 7.993µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.100 EDT  orderer.consensus.etcdraft  logSendFailure -> ERRO 07f Failed to send StepRequest to 3, because: aborted channel=participation-trophy node=1  e  OrdererOrg.orderer1  2020-08-15 14:01:11.100 EDT  orderer.consensus.etcdraft  stepLeader -> DEBU 080 1 failed to send message to 3 because it is unreachable  next = 8, match = 0, state = ProgressStateProbe, waiting = false, pendingSnapshot = 0  channel=participation-trophy node=1  e  OrdererOrg.orderer2  2020-08-15 14:01:11.101 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 056 Sending msg of 28 bytes to 1 on channel participation-trophy took 6.485µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.600 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 081 Sending msg of 28 bytes to 2 on channel participation-trophy took 8.306µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.600 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 082 Sending msg of 28 bytes to 3 on channel participation-trophy took 72.071µs  e  OrdererOrg.orderer1  2020-08-15 14:01:11.600 EDT  orderer.consensus.etcdraft  send -> INFO 083 Successfully sent StepRequest to 3 after failed attempt(s) channel=participation-trophy node=1  e  OrdererOrg.orderer2  2020-08-15 14:01:11.600 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 057 Sending msg of 28 bytes to 1 on channel participation-trophy took 8.624µs  e  OrdererOrg.orderer3  2020-08-15 14:01:11.601 EDT  comm.grpc.server  1 -> INFO 03a streaming call completed grpc.service=orderer.Cluster grpc.method=Step grpc.peer_address=127.0.0.1:59031 grpc.peer_subject="CN=orderer1.example.com,L=San Francisco,ST=California,C=US" error="channel participation-trophy doesn't exist" grpc.code=Unknown grpc.call_duration=113.964µs  e  OrdererOrg.orderer1  2020-08-15 14:01:12.097 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 084 Sending msg of 28 bytes to 2 on channel participation-trophy took 9.963µs  e  OrdererOrg.orderer1  2020-08-15 14:01:12.098 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 085 Sending msg of 28 bytes to 3 on channel participation-trophy took 88.04µs  e  OrdererOrg.orderer2  2020-08-15 14:01:12.098 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 058 Sending msg of 28 bytes to 1 on channel participation-trophy took 8.869µs  e  OrdererOrg.orderer1  2020-08-15 14:01:12.602 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 086 Sending msg of 28 bytes to 2 on channel participation-trophy took 25.483µs  e  OrdererOrg.orderer1  2020-08-15 14:01:12.602 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 087 Sending msg of 28 bytes to 3 on channel participation-trophy took 22.558µs  e  OrdererOrg.orderer1  2020-08-15 14:01:12.602 EDT  orderer.consensus.etcdraft  logSendFailure -> ERRO 088 Failed to send StepRequest to 3, because: aborted channel=participation-trophy node=1  e  OrdererOrg.orderer1  2020-08-15 14:01:12.602 EDT  orderer.consensus.etcdraft  stepLeader -> DEBU 089 1 failed to send message to 3 because it is unreachable  next = 8, match = 0, state = ProgressStateProbe, waiting = false, pendingSnapshot = 0  channel=participation-trophy node=1  e  OrdererOrg.orderer2  2020-08-15 14:01:12.602 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 059 Sending msg of 28 bytes to 1 on channel participation-trophy took 13.823µs  e  OrdererOrg.orderer1  2020-08-15 14:01:13.100 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 08a Sending msg of 28 bytes to 3 on channel participation-trophy took 107.128µs  e  OrdererOrg.orderer1  2020-08-15 14:01:13.100 EDT  orderer.consensus.etcdraft  send -> INFO 08b Successfully sent StepRequest to 3 after failed attempt(s) channel=participation-trophy node=1  e  OrdererOrg.orderer1  2020-08-15 14:01:13.100 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 08c Sending msg of 28 bytes to 2 on channel participation-trophy took 7.153µs  e  OrdererOrg.orderer3  2020-08-15 14:01:13.100 EDT  comm.grpc.server  1 -> INFO 03b streaming call completed grpc.service=orderer.Cluster grpc.method=Step grpc.peer_address=127.0.0.1:59031 grpc.peer_subject="CN=orderer1.example.com,L=San Francisco,ST=California,C=US" error="channel participation-trophy doesn't exist" grpc.code=Unknown grpc.call_duration=166.345µs  e  OrdererOrg.orderer2  2020-08-15 14:01:13.100 EDT  orderer.consensus.etcdraft  consensusSent -> DEBU 05a Sending msg of 28 bytes to 1 on channel participation-trophy took 19.855µs  e  OrdererOrg.orderer3  2020-08-15 14:01:13.578 EDT  orderer.common.cluster.puller  fetchLastBlockSeq -> INFO 03c 127.0.0.1:26000 is at block sequence of 3 channel=participation-trophy  e  OrdererOrg.orderer1  2020-08-15 14:01:13.578 EDT  comm.grpc.server  1 -> INFO 08d streaming call completed grpc.service=orderer.AtomicBroadcast grpc.method=Deliver grpc.peer_address=127.0.0.1:59324 grpc.peer_subject="CN=orderer3.example.com,L=San Francisco,ST=California,C=US" error="context finished before block retrieved: context canceled" grpc.code=Unknown grpc.call_duration=1.097729ms  e  OrdererOrg.orderer2  2020-08-15 14:01:13.579 EDT  comm.grpc.server  1 -> INFO 05b streaming call completed grpc.service=orderer.AtomicBroadcast grpc.method=Deliver grpc.peer_address=127.0.0.1:59323 grpc.peer_subject="CN=orderer3.example.com,L=San Francisco,ST=California,C=US" error="context finished before block retrieved: context canceled" grpc.code=Unknown grpc.call_duration=1.108355ms  e  OrdererOrg.orderer3  2020-08-15 14:01:13.579 EDT  orderer.common.cluster.puller  fetchLastBlockSeq -> INFO 03d 127.0.0.1:26004 is at block sequence of 3 channel=participation-trophy  e  OrdererOrg.orderer3  2020-08-15 14:01:13.579 EDT  orderer.common.cluster.puller  connectToSomeEndpoint -> INFO 03e Connected to 127.0.0.1:26004 with last block seq of 3 channel=participation-trophy  e  OrdererOrg.orderer3  2020-08-15 14:01:13.579 EDT  orderer.common.cluster.puller  obtainStream -> INFO 03f Sending request for block  3  to 127.0.0.1:26004 channel=participation-trophy  e  OrdererOrg.orderer3  2020-08-15 14:01:13.580 EDT  orderer.common.cluster.puller  pullBlocks -> INFO 040 Got block  3  of size 23 KB from 127.0.0.1:26004 channel=participation-trophy  e  OrdererOrg.orderer1  2020-08-15 14:01:13.597 EDT  orderer.consensus.etcdraft  Check -> DEBU 08e Current active nodes in cluster are:  1 2  channel=participation-trophy node=1 {code} You can see the leader initially reports the active nodes as  1 2 3  and then follows it up by reporting the active nodes of  1 2 .      This causes problems when attempting to determine when a newly added consenter is truly active. Subsequent attempts to, for example, remove a consenter result in an incorrect failure: {code:java}  e  OrdererOrg.orderer2  2020-08-15 15:15:10.135 EDT  orderer.common.broadcast  ProcessMessage -> WARN 066  channel: participation-trophy  Rejecting broadcast of config message from 127.0.0.1:63134 because of error: error applying config update to existing channel 'participation-trophy': consensus metadata update for channel config update is invalid: 2 out of 3 nodes are alive, configuration will result in quorum loss {code}  ></description> </Issue>
