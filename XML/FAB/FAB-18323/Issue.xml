<Issue id="46298" key="FAB-18323" number="18323" project="10002" reporter="magpie73" assignee="wenjian" creator="magpie73" type="10004" summary="Orderer node cannot start with BCCSP FileKeystore.KeyStorePath config" priority="3" resolution="10000" status="6" created="2020-11-08 03:18:56.0" updated="2020-12-07 13:44:55.0" resolutiondate="2020-12-07 13:44:55.0" votes="0" watches="2" workflowId="60212" archived="N"> <description><! CDATA *1. Condition* Use SW BCCCSP Set BCCSP FileKeystore.KeyStorePath as docker environment( ORDERER_GENERAL_BCCSP_SW_FILEKEYSTORE_KEYSTORE )  *2. Symptom* Orderer node cannot start up with error. {code:java} General.BCCSP.SwOpts.Ephemeral = true General.BCCSP.SwOpts.FileKeystore.KeyStorePath = "/var/hyperledger/orderer/msp/keystore" General.BCCSP.SwOpts.DummyKeystore = General.BCCSP.SwOpts.InmemKeystore = ... 2020-11-08 01:42:20.617 UTC  orderer.common.server  loadLocalMSP -> PANI 004 Failed to setup local msp with config: KeyMaterial not found in SigningIdentityInfo panic: Failed to setup local msp with config: KeyMaterial not found in SigningIdentityInfo goroutine 1  running : go.uber.org/zap/zapcore.(*CheckedEntry).Write(0xc0000c4fd0, 0x0, 0x0, 0x0) /go/src/github.com/hyperledger/fabric/vendor/go.uber.org/zap/zapcore/entry.go:230 +0x545 go.uber.org/zap.(*SugaredLogger).log(0xc00018a210, 0xc000124004, 0x102a92b, 0x29, 0xc0001c1460, 0x1, 0x1, 0x0, 0x0, 0x0) /go/src/github.com/hyperledger/fabric/vendor/go.uber.org/zap/sugar.go:234 +0x100 go.uber.org/zap.(*SugaredLogger).Panicf(...) /go/src/github.com/hyperledger/fabric/vendor/go.uber.org/zap/sugar.go:159 github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Panicf(...) /go/src/github.com/hyperledger/fabric/common/flogging/zap.go:74 github.com/hyperledger/fabric/orderer/common/server.loadLocalMSP(0xc0000c0d80, 0xc00047dea0, 0x0) /go/src/github.com/hyperledger/fabric/orderer/common/server/main.go:690 +0x314 github.com/hyperledger/fabric/orderer/common/server.Main() /go/src/github.com/hyperledger/fabric/orderer/common/server/main.go:91 +0x252 main.main() /go/src/github.com/hyperledger/fabric/cmd/orderer/main.go:15 +0x20 {code}    *3. Reason*  The msp.SetupBCCSPKeystoreConfig function only override the KeyStorePath if it was left empty, then set 'bccspConfig.SwOpts.Ephemeral' as false.  If KeyStorePath is passed as docker environment, the 'bccspConfig.SwOpts.Ephemeral' remain as default - true.  Then bccsp/factory/SWFactory *return DummyKeyStore* because it is marked as 'Ephemeral'.  (There's no way that can set 'bccspConfig.SwOpts.Ephemeral' via YAML config or environment.)     *4. Solution* The msp.SetupBCCSPKeystoreConfig function should always set set 'bccspConfig.SwOpts.Ephemeral' as false - or allow set 'bccspConfig.SwOpts.Ephemeral' via YAML config or environment.     + Peer should fail to start like orderer.     But peer has one more bug(FAB-18324) - cannot read docker environment about FileKeystore.KeyStorePath( CORE_PEER_BCCSP_SW_FILEKEYSTORE_KEYSTORE ).     So peer always consider that FileKeystore.KeyStorePath is emprty, and bypass the bug above.  I think 2 bugs should be fixed at the same time.  ></description> </Issue>
