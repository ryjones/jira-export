<Issue id="17898" key="FAB-4627" number="4627" project="10002" reporter="suryalnvs" assignee="kchristidis" creator="suryalnvs" type="10004" summary="Deliver clients drop grpc connection with orderers when restarted the kafka broker" environment="vagrant, ubuntu16.04" priority="5" resolution="10000" status="6" created="2017-06-14 14:30:20.0" updated="2018-07-20 14:13:19.0" resolutiondate="2017-06-14 21:53:40.0" votes="0" watches="3" workflowId="39006" security="10001"> <description><! CDATA When tried to restart the kafka brokers sequentially, deliver clients drop the grpc connection with orderers.  *Fabric commit:* 076ef432fd3657b5448b07ef07df6df644a82d46, *Date:* Tue Jun 13 20:42:21 2017 +0000.  *Network Configuration:* 3 orderers, 4 kafka brokers, 3 zookeepers, 2 orgs with 2 peers in each.  *Steps:* The test case is to restart the kafka brokers sequentially while sending in the traffic using broadcast client and receiving through deliver client with OTE. *Step 1:* Run the testcase ORD94 in OTE         {color:#14892c}go test -run ORD94 -timeout 45m{color} This will launch the network with the configuration mentioned above, starts the deliver clients first and each client will be connected to each orderer, starts broadcast clients for each orderer and starts sending the traffic to the orderers. Then a separate thread will be used to restart the kafka broker one after the other with 2 minutes time gap between them. During this restart process, when a kafka broker is taken down, to which the orderers are connected to, the deliver clients grpc connection are being dropped with SERVICE_UNAVAILABLE. All deliver clients encountered this error and dropped grpc connections at same time, when we stopped one particular kafka broker (not the first one) - so we suspect the orderers were all connected to that one.  Attached the logs for the reference.  *Expected:* Taking down one kafka broker out of 4, should not affect the orderer connections as relication factor is set to 3, minimum ISR is set to 2.  *This worked as expected with the beta commit level: no grpc connections were dropped.*  ></description> </Issue>
