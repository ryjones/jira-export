<Issue id="31216" key="FAB-10747" number="10747" project="10002" reporter="divyank" assignee="denyeart" creator="divyank" type="10004" summary="Uncommitted private data is periodically lost causing peers to slowly commit blocks" priority="2" resolution="10000" status="6" created="2018-06-20 14:33:05.0" updated="2018-07-20 14:17:00.0" resolutiondate="2018-06-28 22:08:01.0" votes="0" watches="9" workflowId="42497"> <description><! CDATA While running load tests with simple transactions that write some test data to private data, we noticed that every 1000 blocks, all the peers on the network almost stop committing blocks (they commit one block per minute) for a few minutes:    !block height graph.png|width=580,height=170!  On inspecting the logs, we found that *all* of the peers are timing out on the `pullRetryThreshold`(60s) at commit: {code:java} Could not fetch all missing collection private write sets from remote peers. Will commit block with missing private write sets: txID: 4caabb384d2972e8de4808b285e9916842ea4a34b5c69a108c52f8785ea431f3, seq: 1, namespace: mycc1, collection: mycollection1, hash: 22bed93ec2efe5acd7b1bbf9ba949ab50133105844487c1db17b53fcb19362af txID: a4c09a826e59bbffde1d348d4835f7817754885df778e3c59cbab2f0d7ca9c48, seq: 3, namespace: mycc2, collection: mycollection2, hash: 0e16dff4d881f3347b4782534e72e510971ed0f7caafd156bce0c1261ef86abf txID: 6ba3934a06190d3cabb01569ae11c7d523364fecc254495763f9d4606af05bf7, seq: 5, namespace: mycc1, collection: mycollection1, hash: 80915690dc7186731dc0229eb6a97bb3ff97f91c10bb48238416a9c9dbc17804 txID: 6ba3934a06190d3cabb01569ae11c7d523364fecc254495763f9d4606af05bf7, seq: 5, namespace: mycc2, collection: mycollection2, hash: 0c65c5caec1c1f8a37cf058573ae80f88e081b7de0369ecaf9a8e88314c12291 txID: 10cecdac580507afabfbd928bc2c34ea37d989ed140e59de693ad63ee72ecfcd, seq: 0, namespace: mycc2, collection: mycollection2, hash: b15aa23849e650bc473e8f8cd257106d9ba1f8cb1756fedead1a33c1d9daef00 {code} This happens for a few consecutive blocks (or many, depending on the load) and then the peers recover, committing blocks at a normal rate. During this period (5 to 30 minutes, depending on the load) the entire system comes to a halt as the none of the peers are able to commit transactions.  We suspect that this issue is related to the `transientstoreMaxBlockRetention` configuration which is set to 1000. The purge could be wiping out private data from transactions that were in-flight (endorsed, but not committed) from the transient store leading to the pull timeout at commit time.  *Environment information:*  Fabric master branch commit 25342999b62eb522e8bf303e18a54ec3013e58a7  Four orgs with two peers each, three channels (one with all orgs, two with two orgs each)  The tests were run on a networked cloud environment and the issue is consistently reproducible.  Private data collection config:        mycollection1: any org, requiredPeerCount=3, and maxPeerCount=7 mycollection2: any org, requiredPeerCount=3, and maxPeerCount=7  ></description> </Issue>
