<Issue id="18131" key="FAB-4819" number="4819" project="10002" reporter="shimos" assignee="shimos" creator="shimos" type="10004" summary="Vendoring bugs in chaincode packaging" priority="3" resolution="10000" status="6" created="2017-06-16 00:39:44.0" updated="2018-07-20 14:13:30.0" resolutiondate="2017-06-19 23:17:59.0" votes="0" watches="5" workflowId="39169" security="10001"> <environment><! CDATA fabric commit 859fd8a653fca1109f04f7d1e807b73ca0d0f9d2   ></environment> <description><! CDATA In vendoring during packaging a chaincode for deployment, I think I found two bugs: -	To locate system packages, the GOROOT environment variable is used. Since it might be not set when go is installed in its standard location, it fails in finding system packages -	To find packages imported from the chaincode, “go list” command is invoked. But its parsing result contains an empty string which is interpreted in turn as the package in CWD.  {noformat} /opt/gopath/src/github.com/hyperledger/fabric/bddtests$ peer chaincode package -n example02 -c '{"Args":  "init", "a", "100", "b", "200" }' -p 'github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02' -v test --logging-level debug tmp/outf 2017-06-15 16:27:59.980 PDT  msp  getMspConfig -> INFO 001 intermediate certs folder not found at  /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts: no such file or directory  2017-06-15 16:27:59.980 PDT  msp  getMspConfig -> INFO 002 crls folder not found at  /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/crls: no such file or directory  2017-06-15 16:28:00.006 PDT  msp  GetLocalMSP -> DEBU 003 Returning existing local MSP 2017-06-15 16:28:00.006 PDT  msp  GetDefaultSigningIdentity -> DEBU 004 Obtaining default signing identity 2017-06-15 16:28:00.006 PDT  chaincodeCmd  checkChaincodeCmdParams -> INFO 005 Using default escc 2017-06-15 16:28:00.006 PDT  chaincodeCmd  checkChaincodeCmdParams -> INFO 006 Using default vscc 2017-06-15 16:28:00.006 PDT  golang-platform  getCodeFromFS -> DEBU 007 getCodeFromFS github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 2017-06-15 16:28:00.159 PDT  golang-platform  func1 -> DEBU 008 Discarding GOROOT package fmt 2017-06-15 16:28:00.159 PDT  golang-platform  func1 -> DEBU 009 Discarding provided package github.com/hyperledger/fabric/core/chaincode/shim 2017-06-15 16:28:00.159 PDT  golang-platform  func1 -> DEBU 00a Discarding provided package github.com/hyperledger/fabric/protos/peer 2017-06-15 16:28:00.159 PDT  golang-platform  func1 -> DEBU 00b Discarding GOROOT package strconv 2017-06-15 16:28:00.159 PDT  golang-platform  func1 -> DEBU 00c Discarding GOROOT package 2017-06-15 16:28:00.159 PDT  golang-platform  GetDeploymentPayload -> DEBU 00d done 2017-06-15 16:28:00.160 PDT  chaincodeCmd  chaincodePackage -> DEBU 00e Packaged chaincode into deployment spec of size <2544>, with args =  tmp/outf  2017-06-15 16:28:00.161 PDT  main  main -> INFO 00f Exiting..... {noformat}  The line “00c Discarding GOROOT package” shows that empty string is included in imported packages.  {noformat} /opt/gopath/src/github.com/hyperledger/fabric/bddtests$ GOROOT= peer chaincode package -n example02 -c '{"Args":  "init", "a", "100", "b", "200" }' -p 'github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02' -v test --logging-level debug tmp/outf 2017-06-15 16:27:48.156 PDT  msp  getMspConfig -> INFO 001 intermediate certs folder not found at  /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts : no such file or directory  2017-06-15 16:27:48.156 PDT  msp  getMspConfig -> INFO 002 crls folder not found at  /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/intermediatecerts . Skipping.:  stat /opt/go/src/github.com/hyperledger/fabric/sampleconfig/msp/crls: no such file or directory   2017-06-15 16:27:48.178 PDT  msp  GetLocalMSP -> DEBU 003 Returning existing local MSP 2017-06-15 16:27:48.178 PDT  msp  GetDefaultSigningIdentity -> DEBU 004 Obtaining default signing identity 2017-06-15 16:27:48.178 PDT  chaincodeCmd  checkChaincodeCmdParams -> INFO 005 Using default escc 2017-06-15 16:27:48.178 PDT  chaincodeCmd  checkChaincodeCmdParams -> INFO 006 Using default vscc 2017-06-15 16:27:48.178 PDT  golang-platform  getCodeFromFS -> DEBU 007 getCodeFromFS github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 2017-06-15 16:27:48.333 PDT  golang-platform  func1 -> DEBU 008 Accepting import: fmt 2017-06-15 16:27:48.333 PDT  golang-platform  func1 -> DEBU 009 Discarding provided package github.com/hyperledger/fabric/core/chaincode/shim 2017-06-15 16:27:48.333 PDT  golang-platform  func1 -> DEBU 00a Discarding provided package github.com/hyperledger/fabric/protos/peer 2017-06-15 16:27:48.333 PDT  golang-platform  func1 -> DEBU 00b Accepting import: strconv 2017-06-15 16:27:48.333 PDT  golang-platform  func1 -> DEBU 00c Accepting import: 2017-06-15 16:27:48.593 PDT  golang-platform  GetDeploymentPayload -> DEBU 00d processing dep: compress/flate 2017-06-15 16:27:48.593 PDT  golang-platform  GetDeploymentPayload -> DEBU 00e checking: /opt/go/src/compress/flate exists: false (snip) 2017-06-15 16:27:48.622 PDT  golang-platform  GetDeploymentPayload -> DEBU 0b0 processing dep: github.com/hyperledger/fabric/bccsp/utils 2017-06-15 16:27:48.622 PDT  golang-platform  GetDeploymentPayload -> DEBU 0b1 checking: /opt/go/src/github.com/hyperledger/fabric/bccsp/utils exists: true 2017-06-15 16:27:48.622 PDT  golang-platform  GetDeploymentPayload -> DEBU 0b2 processing dep: github.com/hyperledger/fabric/protos/msp 2017-06-15 16:27:48.622 PDT  golang-platform  GetDeploymentPayload -> DEBU 0b3 checking: /opt/go/src/github.com/hyperledger/fabric/protos/msp exists: true (snip) 2017-06-15 16:27:49.063 PDT  chaincodeCmd  chaincodePackage -> DEBU 39b Packaged chaincode into deployment spec of size <830302>, with args =  tmp/depo  2017-06-15 16:27:49.064 PDT  main  main -> INFO 39c Exiting..... {noformat}  Without GOROOT, it fails to locate system packages, accepting “fmt” and “strconv” as external imports. Also, as dependencies from “” (empty string, i.e. the CWD, bddtests), many fabric packages are also vendored, resulting in a big deployment package.   As a result, behave tests (bddtest) seems to fail when GOROOT is not set during instantiating a chaincode because the vendored packages lack “shim” : {noformat} ...(snip)… And user "configAdminPeerOrg0" using cert alias "config-admin-cert" sends proposal "instantiateProposal1" to endorsers with timeout of "90" seconds with proposal responses "instantiateProposalResponses" # steps/endorser_impl.py:109 29.466s | Endorser | | peer0    | | peer2    | Traceback (most recent call last): File "/home/ubuntu/Envs/behave_venv/local/lib/python2.7/site-packages/behave/model.py", line 1456, in run match.run(runner.context) File "/home/ubuntu/Envs/behave_venv/local/lib/python2.7/site-packages/behave/model.py", line 1903, in run self.func(context, *args, **kwargs) File "steps/endorser_impl.py", line 124, in step_impl resultsDict =  dict(zip(endorsers,  respFuture.result() for respFuture in proposalResponseFutures )) File "/home/ubuntu/Envs/behave_venv/local/lib/python2.7/site-packages/grpc/_channel.py", line 294, in result raise self _Rendezvous: <_Rendezvous of RPC that terminated with (StatusCode.UNKNOWN, Error starting container: Failed to generate platform-specific docker build: Error returned from build: 2 "# github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:45: cannot use shim.Error("Incorrect number of arguments. Expecting 4") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.co m/hyperledger/fabric/examples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:52: cannot use shim.Error("Expecting integer value for asset holding") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com /hyperledger/fabric/examples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:57: cannot use shim.Error("Expecting integer value for asset holding") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com /hyperledger/fabric/examples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:64: cannot use shim.Error(err.Error()) (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com/hyperledger/fabric/examples/cha incode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:69: cannot use shim.Error(err.Error()) (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com/hyperledger/fabric/examples/cha incode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:72: cannot use shim.Success(nil) (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com/hyperledger/fabric/examples/chaincode /go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:89: cannot use shim.Error("Invalid invoke function name. Expecting "invoke" "delete" "query"") (type "github.com/hyperledger/fabric/protos/peer".Respo nse) as type "github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:100: cannot use shim.Error("Incorrect number of arguments. Expecting 3") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.c om/hyperledger/fabric/examples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:110: cannot use shim.Error("Failed to get state") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com/hyperledger/fabric/e xamples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:113: cannot use shim.Error("Entity not found") (type "github.com/hyperledger/fabric/protos/peer".Response) as type "github.com/hyperledger/fabric/exam ples/chaincode/go/chaincode_example02/vendor/github.com/hyperledger/fabric/protos/peer".Response in return argument chaincode/input/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/chaincode_example02.go:113: too many errors {noformat}   ></description> </Issue>
