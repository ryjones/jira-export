<Issue id="39259" key="FAB-15151" number="15151" project="10002" reporter="sykesm" assignee="guoger" creator="sykesm" type="10004" summary="Data race encountered in etcdraft unit tests" priority="3" resolution="10000" status="6" created="2019-04-11 18:17:10.0" updated="2019-04-22 01:26:17.0" resolutiondate="2019-04-22 01:26:17.0" votes="0" watches="2" workflowId="52136"> <description><! CDATA {code} ================== WARNING: DATA RACE Write at 0x00c0004ebe58 by goroutine 79: github.com/hyperledger/fabric/orderer/consensus/etcdraft_test.(*network).elect() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/chain_test.go:3915 +0xa47 github.com/hyperledger/fabric/orderer/consensus/etcdraft_test.glob..func1.4.4.5() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/chain_test.go:1660 +0x136 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes.(*runner).runSync() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes/runner.go:110 +0xbd github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes.(*runner).run() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes/runner.go:64 +0x107 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes.(*SetupNode).Run() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/leafnodes/setup_nodes.go:15 +0x87 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/spec.(*Spec).runSample() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/spec/spec.go:181 +0x2a8 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/spec.(*Spec).Run() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/spec/spec.go:138 +0x142 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner.(*SpecRunner).runSpec() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner/spec_runner.go:198 +0x172 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner.(*SpecRunner).runSpecs() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner/spec_runner.go:168 +0x217 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner.(*SpecRunner).Run() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/specrunner/spec_runner.go:64 +0x101 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/suite.(*Suite).Run() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/internal/suite/suite.go:62 +0x6a2 github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo.RunSpecsWithCustomReporters() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/ginkgo_dsl.go:220 +0x33a github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo.RunSpecs() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/onsi/ginkgo/ginkgo_dsl.go:201 +0x99 github.com/hyperledger/fabric/orderer/consensus/etcdraft_test.TestEtcdraft() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/etcdraft_suite_test.go:20 +0x120 testing.tRunner() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:865 +0x163  Previous read at 0x00c0004ebe58 by goroutine 83: github.com/hyperledger/fabric/orderer/consensus/etcdraft_test.(*network).addChain.func5() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/chain_test.go:3727 +0xa1 github.com/hyperledger/fabric/orderer/consensus/etcdraft/mocks.(*FakeBlockPuller).HeightsByEndpoints() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/mocks/mock_blockpuller.go:74 +0x314 github.com/hyperledger/fabric/orderer/common/cluster.latestHeightAndEndpoint() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/cluster/replication.go:493 +0x59 github.com/hyperledger/fabric/orderer/common/cluster.PullLastConfigBlock() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/cluster/replication.go:464 +0x49 github.com/hyperledger/fabric/orderer/consensus/etcdraft.(*evictionSuspector).confirmSuspicion() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/util.go:613 +0x226 github.com/hyperledger/fabric/orderer/consensus/etcdraft.(*evictionSuspector).confirmSuspicion-fm() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/util.go:603 +0x4b github.com/hyperledger/fabric/orderer/consensus/etcdraft.(*PeriodicCheck).conditionFulfilled() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/util.go:572 +0x164 github.com/hyperledger/fabric/orderer/consensus/etcdraft.(*PeriodicCheck).check() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/util.go:552 +0x98 github.com/hyperledger/fabric/orderer/consensus/etcdraft.(*PeriodicCheck).check-fm() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/etcdraft/util.go:550 +0x41  Goroutine 79 (running) created at: testing.(*T).Run() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:916 +0x65a testing.runTests.func1() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:1157 +0xa8 testing.tRunner() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:865 +0x163 testing.runTests() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:1155 +0x523 testing.(*M).Run() /usr/local/Cellar/go/1.12.3/libexec/src/testing/testing.go:1072 +0x2eb main.main() _testmain.go:130 +0x334  Goroutine 83 (finished) created at: time.goFunc() /usr/local/Cellar/go/1.12.3/libexec/src/time/sleep.go:169 +0x51 ================== ... --- FAIL: TestEtcdraft (47.26s) testing.go:809: race detected during execution of test {code}  This is on current master - f18b91a3c475b43b199144302c806a7b13fd89a4  ></description> </Issue>
