<Issue id="35306" key="FAB-12836" number="12836" project="10002" reporter="david_dornseifer" assignee="manish-sethi" creator="david_dornseifer" type="10004" summary="Fabric Peer Panics with CouchDB Error due to key with empty string" priority="1" resolution="10000" status="6" created="2018-11-13 08:48:06.0" updated="2019-07-15 11:29:54.0" resolutiondate="2019-01-28 22:42:19.0" votes="0" watches="3" workflowId="46752" security="10000"> <description><! CDATA We have seen several peers panic with CouchDB errors:  A block is being added to a channel the peer is subscribed to then a panic happens:  {code} 11:20:53:  kvledger  CommitWithPvtData -> INFO 371fa Channel  test : Committed block  107  with 2 transaction(s)     11:20:53: panic: Error during commit to txmgr:Couch DB Error:illegal_docid, Status Code:400, Reason:Document id must not be empty   11:20:53:  goroutine 53726  running :   github.com/hyperledger/fabric/core/ledger/kvledger.(*kvLedger).CommitWithPvtData(0xc425162e10, 0xc42629a1e0, 0x0, 0x0) /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger.go:273 +0x870   github.com/hyperledger/fabric/core/committer.(*LedgerCommitter).CommitWithPvtData(0xc424c66d00, 0xc42629a1e0, 0xc42265dd40, 0xdf8475800)   /opt/gopath/src/github.com/hyperledger/fabric/core/committer/committer_impl.go:105 +0x6b   github.com/hyperledger/fabric/gossip/privdata.(*coordinator).StoreBlock(0xc425b29860, 0xc424c9bbe0, 0x0, 0x0, 0x0, 0xc42265de78, 0x7329db)   /opt/gopath/src/github.com/hyperledger/fabric/gossip/privdata/coordinator.go:236 +0xc3b   github.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).commitBlock(0xc42539ff00, 0xc424c9bbe0, 0x0, 0x0, 0x0, 0x0, 0x0)   /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:771 +0x6c   github.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).deliverPayloads(0xc42539ff00)   /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:558 +0x3c5   created by github.com/hyperledger/fabric/gossip/state.NewGossipStateProvider   /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:239 +0x681 ```  The peer reboots, loads the ledgers (chains) and gets stuck in a `restart` loop due to the error below:      ``` 11:23:28: panic: Error during state DB recovery:Couch DB Error:illegal_docid, Status Code:400, Reason:Document id must not be empty   11:23:28:  goroutine 1  running :   github.com/hyperledger/fabric/core/ledger/kvledger.newKVLedger(0xc4214b7380, 0x37, 0xc4238d70b0, 0x1153a20, 0xc4248be5f0, 0x114b6c0, 0xc421c43460, 0x114b680, 0xc4200b6220, 0xc421c43480, ...)   /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger.go:77 +0x779   github.com/hyperledger/fabric/core/ledger/kvledger.(*Provider).openInternal(0xc420530310, 0xc4214b7380, 0x37, 0xc420f96101, 0x0, 0x0, 0xc400000008)   /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger_provider.go:158 +0x1c6   github.com/hyperledger/fabric/core/ledger/kvledger.(*Provider).Open(0xc420530310, 0xc4214b7380, 0x37, 0x37, 0x19a20c0, 0x0, 0x237fac23fe)   /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/kvledger/kv_ledger_provider.go:134 +0x130    github.com/hyperledger/fabric/core/ledger/ledgermgmt.OpenLedger(0xc4214b7380, 0x37, 0x0, 0x0, 0x0, 0x0)   /opt/gopath/src/github.com/hyperledger/fabric/core/ledger/ledgermgmt/ledger_mgmt.go:111 +0x1b4   github.com/hyperledger/fabric/core/peer.Initialize(0xc4203a9170, 0x114a500, 0xc42000e148, 0x114cea0, 0xc4200b94a0, 0x1134720, 0xc4205b3110)   /opt/gopath/src/github.com/hyperledger/fabric/core/peer/peer.go:210 +0x218   github.com/hyperledger/fabric/peer/node.serve(0x19a09e8, 0x0, 0x0, 0x0, 0x0)   /opt/gopath/src/github.com/hyperledger/fabric/peer/node/start.go:356 +0x1712   github.com/hyperledger/fabric/peer/node.glob..func1(0x1891cc0, 0x19a09e8, 0x0, 0x0, 0x0, 0x0)   /opt/gopath/src/github.com/hyperledger/fabric/peer/node/start.go:111 +0x9c   github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).execute(0x1891cc0, 0x19a09e8, 0x0, 0x0, 0x1891cc0, 0x19a09e8)   /opt/gopath/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:698 +0x46d   github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0x1892320, 0x197c7b0, 0xf, 0x2)   /opt/gopath/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:783 +0x2e4   github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).Execute(0x1892320, 0x2, 0xffffffffffffffff)   /opt/gopath/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:736 +0x2b   main.main()   /opt/gopath/src/github.com/hyperledger/fabric/peer/main.go:97 +0x5bf {code}     ></description> </Issue>
