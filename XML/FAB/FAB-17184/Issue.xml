<Issue id="43533" key="FAB-17184" number="17184" project="10002" reporter="denyeart" assignee="caod" creator="denyeart" type="10004" summary="Peer cannot find private data, but should skip pulling private data due to invalid transaction" priority="3" resolution="10000" status="6" created="2019-12-03 19:22:34.0" updated="2020-01-08 17:55:55.0" resolutiondate="2020-01-08 17:55:55.0" votes="0" watches="2" workflowId="57277"> <description><! CDATA *Scenario:* Chaincode writes to _implicit_org_Org1MSP. Invoke chaincode on Org2 peer.  Note Org1 peer has setting: skipPullingInvalidTransactionsDuringCommit: true  *Expected behavior:*  Org2 attempts to endorse a transaction with implicit collection _implicit_org_Org1MSP.  The private data should disseminate to Org1, however the transaction will be marked as invalid due to endorsement policy failure.  *Actual behavior:*  Org1 peer appears to get the private data at endorsement time:  {code:java} 2019-12-03 14:01:31.998 EST  transientstore  Persist -> DEBU 050 Persisting private data to transient store for txid  697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013  at block height  45  {code}  Issue 1: Org1 peer can't find private data in transient store  {code:java} 2019-12-03 14:01:34.060 EST  gossip.privdata  populateFromTransientStore -> WARN 05c The PvtRwset of PvtSimulationResultsWithConfig for txID  697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013  is nil. Skipping. channel=mychannel {code}  The reason Org1 peer can't find the private data is because there is not yet any dissemination configuration for implicit collections... this is proposed to be added in FAB-17303.  Issue 2: Peer should skip pulling private data for invalid transactions, but it attempts to pull anyways.  *Full Org1 peer log at commit time:*  {code:java} 2019-12-03 14:01:34.056 EST  gossip.privdata  StoreBlock -> INFO 051  mychannel  Received block  45  from buffer 2019-12-03 14:01:34.056 EST  gossip.privdata  StoreBlock -> DEBU 052  mychannel  Validating block  45  2019-12-03 14:01:34.059 EST  vscc  Validate -> ERRO 053 VSCC error: stateBasedValidator.Validate failed, err validation of endorsement policy for collection _implicit_org_Org1MSP chaincode marblesp in tx 45:0 failed: signature set did not satisfy policy 2019-12-03 14:01:34.059 EST  committer.txvalidator  validateTx -> ERRO 054 Dispatch for transaction txId = 697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013 returned error: validation of endorsement policy for collection _implicit_org_Org1MSP chaincode marblesp in tx 45:0 failed: signature set did not satisfy policy 2019-12-03 14:01:34.059 EST  committer.txvalidator  Validate -> INFO 055  mychannel  Validated block  45  in 2ms 2019-12-03 14:01:34.060 EST  gossip.privdata  endorsersFromEligibleOrgs -> DEBU 056 Org2MSP isn't among the collection's orgs:  Org1MSP  for namespace marblesp ,collection _implicit_org_Org1MSP 2019-12-03 14:01:34.060 EST  gossip.privdata  populateFromCache -> DEBU 057 Attempting to retrieve 2 private write sets from cache. channel=mychannel 2019-12-03 14:01:34.060 EST  gossip.privdata  RetrievePvtdata -> DEBU 058 Could not find all collection private write sets in cache for block  45  channel=mychannel 2019-12-03 14:01:34.060 EST  gossip.privdata  RetrievePvtdata -> DEBU 059 Fetching 2 collection private write sets from transient store channel=mychannel 2019-12-03 14:01:34.060 EST  gossip.privdata  populateFromTransientStore -> DEBU 05a Attempting to retrieve 2 private write sets from transient store. channel=mychannel 2019-12-03 14:01:34.060 EST  transientstore  GetTxPvtRWSetByTxid -> DEBU 05b Getting private data from transient store for transaction 697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013 2019-12-03 14:01:34.060 EST  gossip.privdata  populateFromTransientStore -> WARN 05c The PvtRwset of PvtSimulationResultsWithConfig for txID  697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013  is nil. Skipping. channel=mychannel 2019-12-03 14:01:34.060 EST  transientstore  GetTxPvtRWSetByTxid -> DEBU 05d Getting private data from transient store for transaction 697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013 2019-12-03 14:01:34.061 EST  gossip.privdata  RetrievePvtdata -> DEBU 05e Could not find all collection private write sets in local peer transient store for block  45  channel=mychannel 2019-12-03 14:01:34.061 EST  gossip.privdata  RetrievePvtdata -> DEBU 05f Fetching 1 collection private write sets from remote peers for a maximum duration of 10s channel=mychannel 2019-12-03 14:01:34.061 EST  gossip.privdata  populateFromRemotePeers -> DEBU 060 Attempting to retrieve 1 private write sets from remote peers. channel=mychannel 2019-12-03 14:01:34.061 EST  gossip.privdata  populateFromRemotePeers -> DEBU 061 Skipping invalid key  {697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013 0 marblesp _implicit_org_Org1MSP feea17dd8c6aa05fc7017040814624bc5c9ee311ece8cb7df8fb428f53e859b2}  because peer is configured to skip pulling rwsets of invalid transactions. channel=mychannel 2019-12-03 14:01:34.061 EST  gossip.privdata  fetchPrivateData -> DEBU 062 Total members in channel:  Endpoint: 127.0.0.1:7055, InternalEndpoint: , PKI-ID: dbbf31fb5385654e28cb34140b74287187fb33f91a8cc605ddc315b2aa60183d, Metadata:   2019-12-03 14:01:34.061 EST  gossip.privdata  fetchPrivateData -> DEBU 063 Total members that fit some digest:    2019-12-03 14:01:34.061 EST  gossip.privdata  fetchPrivateData -> WARN 064 Do not know any peer in the channel( mychannel ) that matches the policies , aborting 2019-12-03 14:01:34.061 EST  gossip.privdata  populateFromRemotePeers -> WARN 065 Failed fetching private data from remote peers for dig2src: map   , err: Empty membership channel=mychannel ... 2019-12-03 14:01:43.083 EST  gossip.privdata  populateFromRemotePeers -> DEBU 096 Attempting to retrieve 1 private write sets from remote peers. channel=mychannel 2019-12-03 14:01:43.083 EST  gossip.privdata  populateFromRemotePeers -> DEBU 097 Skipping invalid key  {697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013 0 marblesp _implicit_org_Org1MSP feea17dd8c6aa05fc7017040814624bc5c9ee311ece8cb7df8fb428f53e859b2}  because peer is configured to skip pulling rwsets of invalid transactions. channel=mychannel 2019-12-03 14:01:43.084 EST  gossip.privdata  fetchPrivateData -> DEBU 098 Total members in channel:  Endpoint: 127.0.0.1:7055, InternalEndpoint: , PKI-ID: dbbf31fb5385654e28cb34140b74287187fb33f91a8cc605ddc315b2aa60183d, Metadata:   2019-12-03 14:01:43.084 EST  gossip.privdata  fetchPrivateData -> DEBU 099 Total members that fit some digest:    2019-12-03 14:01:43.084 EST  gossip.privdata  fetchPrivateData -> WARN 09a Do not know any peer in the channel( mychannel ) that matches the policies , aborting 2019-12-03 14:01:43.084 EST  gossip.privdata  populateFromRemotePeers -> WARN 09b Failed fetching private data from remote peers for dig2src: map   , err: Empty membership channel=mychannel 2019-12-03 14:01:44.088 EST  gossip.privdata  RetrievePvtdata -> DEBU 09c Could not fetch all missing collection private write sets from remote peers for block  45  channel=mychannel 2019-12-03 14:01:44.088 EST  gossip.privdata  prepareBlockPvtdata -> WARN 09d Could not fetch all missing eligible collection private write sets for block  45 . Will commit block with missing private write sets: txID: 697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013, seq: 0, namespace: marblesp, collection: _implicit_org_Org1MSP, hash: feea17dd8c6aa05fc7017040814624bc5c9ee311ece8cb7df8fb428f53e859b2   channel=mychannel 2019-12-03 14:01:44.088 EST  kvledger  CommitLegacy -> DEBU 09e  mychannel  Validating state for block  45  2019-12-03 14:01:44.088 EST  valimpl  preprocessProtoBlock -> WARN 09f Channel  mychannel : Block  45  Transaction index  0  TxId  697d5471b1ce014251967dd6818ffa151dd719bb97ee8a8a54527f4200f20013  marked as invalid by committer. Reason code  ENDORSEMENT_POLICY_FAILURE  2019-12-03 14:01:44.089 EST  kvledger  CommitLegacy -> DEBU 0a0  mychannel  Adding CommitHash to the block  45  2019-12-03 14:01:44.089 EST  kvledger  CommitLegacy -> DEBU 0a1  mychannel  Committing block  45  to storage 2019-12-03 14:01:44.089 EST  ledgerstorage  CommitWithPvtData -> DEBU 0a2 Writing block  45  to pvt block store 2019-12-03 14:01:44.126 EST  kvledger  CommitLegacy -> DEBU 0a3  mychannel  Committing block  45  transactions to state database 2019-12-03 14:01:44.136 EST  kvledger  CommitLegacy -> DEBU 0a4  mychannel  Committing block  45  transactions to history database 2019-12-03 14:01:44.147 EST  kvledger  CommitLegacy -> INFO 0a5  mychannel  Committed block  45  with 1 transaction(s) in 58ms (state_validation=0ms block_and_pvtdata_commit=37ms state_commit=10ms) commitHash= bbeee83194e5dd8d4c45973e361a203c43071f876d72fd2e553e0fb20de6e708  {code}   ></description> </Issue>
