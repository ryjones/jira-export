<Issue id="14194" key="FAB-1765" number="1765" project="10002" reporter="jyellick" assignee="jyellick" creator="jyellick" type="10004" summary="Orderer crash on empty chain creators and new chain proposal" priority="3" resolution="10000" status="6" created="2017-01-19 21:12:41.0" updated="2018-07-20 14:11:17.0" resolutiondate="2017-01-31 19:27:39.0" votes="0" watches="1" workflowId="37116"> <description><! CDATA When the orderer is initialized with an empty slice for ChainCreationPolicyNames, no chain is initialized as the system chain.  This does not cause a panic, and leads to a nil pointer dereference when a new chain proposal tries to reference the system chain.  This is a byproduct of the fact that empty slices marshal to nil under protobuf, so the sharedconfig code was setting the ChainCreationPolicyNames to nil rather than an empty slice.  The system chain was detected by looking for a non-nil ChainCreationPolicyNames.  Resulting trace looked like:  {code} 2017-01-19 19:16:38.594 UTC  ordererledger/ramledger  appendBlock -> DEBU 001 Sending signal that block 18446744073709551615 has a successor 2017-01-19 19:16:38.594 UTC  ordererledger/ramledger  Iterator -> DEBU 002 Attempting to return block 0 2017-01-19 19:16:38.594 UTC  ordererledger/ramledger  Iterator -> DEBU 003 Attempting to return block 0 2017-01-19 19:16:38.594 UTC  common/configtx  beginHandlers -> DEBU 004 Beginning new configuration for chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.594 UTC  common/policies  GetPolicy -> DEBU 005 Returning dummy reject all policy because NewConfigurationItemPolicy could not be found 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 006 Proposed configuration item of type Policy and key %!t(string=chainCreatePolicy1) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 007 Proposing configuration item of type Policy for key chainCreatePolicy1 on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.594 UTC  common/policies  ProposeConfig -> DEBU 008 Proposed new policy chainCreatePolicy1 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 009 Proposed configuration item of type Orderer and key %!t(string=ChainCreators) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00a Proposing configuration item of type Orderer for key ChainCreators on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00b Proposed configuration item of type MSP and key %!t(string=peerOrg0) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00c Proposing configuration item of type MSP for key peerOrg0 on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00d Proposed configuration item of type MSP and key %!t(string=peerOrg1) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00e Proposing configuration item of type MSP for key peerOrg1 on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 00f Proposed configuration item of type MSP and key %!t(string=peerOrg2) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.594 UTC  common/configtx  processConfig -> DEBU 010 Proposing configuration item of type MSP for key peerOrg2 on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 011 Proposed configuration item of type Orderer and key %!t(string=BatchSize) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 012 Proposing configuration item of type Orderer for key BatchSize on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 013 Proposed configuration item of type Orderer and key %!t(string=ConsensusType) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 014 Proposing configuration item of type Orderer for key ConsensusType on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 015 Proposed configuration item of type Policy and key %!t(string=AcceptAllPolicy) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 016 Proposing configuration item of type Policy for key AcceptAllPolicy on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/policies  ProposeConfig -> DEBU 017 Proposed new policy AcceptAllPolicy 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 018 Proposed configuration item of type Orderer and key %!t(string=IngressPolicy) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 019 Proposing configuration item of type Orderer for key IngressPolicy on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 01a Proposed configuration item of type Orderer and key %!t(string=EgressPolicy) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 01b Proposing configuration item of type Orderer for key EgressPolicy on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 01c Proposed configuration item of type Policy and key %!t(string=DefaultModificationPolicy) on chain cb749a08de7b11e6bec308002790a540 has been modified 2017-01-19 19:16:38.595 UTC  common/configtx  processConfig -> DEBU 01d Proposing configuration item of type Policy for key DefaultModificationPolicy on chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  common/policies  ProposeConfig -> DEBU 01e Proposed new policy DefaultModificationPolicy 2017-01-19 19:16:38.595 UTC  common/configtx  commitHandlers -> DEBU 01f Committing configuration for chain cb749a08de7b11e6bec308002790a540 2017-01-19 19:16:38.595 UTC  orderer/common/sharedconfig  CommitConfig -> DEBU 020 Adopting new orderer shared config: &{consensusType:solo batchSize:0xc420212810 batchTimeout:0 chainCreationPolicies:   kafkaBrokers:   ingressPolicyNames:   egressPolicyNames:  } 2017-01-19 19:16:38.595 UTC  orderer/multichain  NewManagerImpl -> DEBU 021 Starting chain: 6362373439613038646537623131653662656333303830303237393061353430 2017-01-19 19:16:38.595 UTC  orderer/main  NewServer -> INFO 022 Starting orderer 2017-01-19 19:16:38.596 UTC  orderer/main  main -> INFO 023 Beginning to serve requests 2017-01-19 19:16:41.271 UTC  orderer/main  Broadcast -> DEBU 024 Starting new Broadcast handler 2017-01-19 19:16:41.272 UTC  orderer/common/broadcast  Handle -> DEBU 025 Proposing new chain panic: runtime error: invalid memory address or nil pointer dereference  signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x5415b8  goroutine 23  running : panic(0x9a1360, 0xc42000c050) /opt/go/src/runtime/panic.go:500 +0x1a1 github.com/hyperledger/fabric/orderer/multichain.(*systemChain).authorize(0x0, 0xc420236280, 0x654) /opt/gopath/src/github.com/hyperledger/fabric/orderer/multichain/systemchain.go:175 +0x1c8 github.com/hyperledger/fabric/orderer/multichain.(*systemChain).authorizeAndInspect(0x0, 0xc42020ee70, 0x0) /opt/gopath/src/github.com/hyperledger/fabric/orderer/multichain/systemchain.go:239 +0x2a9 github.com/hyperledger/fabric/orderer/multichain.(*systemChain).proposeChain(0x0, 0xc42020ee70, 0x5) /opt/gopath/src/github.com/hyperledger/fabric/orderer/multichain/systemchain.go:108 +0x4d github.com/hyperledger/fabric/orderer/multichain.(*multiLedger).ProposeChain(0xc4201e79e0, 0xc42020ee70, 0xc420213a10) /opt/gopath/src/github.com/hyperledger/fabric/orderer/multichain/manager.go:152 +0x39 main.(*broadcastSupport).ProposeChain(0xc420213690, 0xc42020ee70, 0x13) <autogenerated>:1 +0x53 github.com/hyperledger/fabric/orderer/common/broadcast.(*handlerImpl).Handle(0xc4202136a0, 0xefc0c0, 0xc420213930, 0x0, 0x0) /opt/gopath/src/github.com/hyperledger/fabric/orderer/common/broadcast/broadcast.go:95 +0x1d8 main.(*server).Broadcast(0xc4201f1e80, 0xefc0c0, 0xc420213930, 0xc42001d4a8, 0xc42001d4d0) /opt/gopath/src/github.com/hyperledger/fabric/orderer/server.go:61 +0x8b github.com/hyperledger/fabric/protos/orderer._AtomicBroadcast_Broadcast_Handler(0x9a4560, 0xc4201f1e80, 0xefaa40, 0xc420217d80, 0xc42020ee40, 0x0) /opt/gopath/src/github.com/hyperledger/fabric/protos/orderer/ab.pb.go:525 +0xbb github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processStreamingRPC(0xc4201be360, 0xefb940, 0xc420234000, 0xc4201de960, 0xc42020e9c0, 0xee5400, 0xc42020ee10, 0x0, 0x0) /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:657 +0x6f3 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream(0xc4201be360, 0xefb940, 0xc420234000, 0xc4201de960, 0xc42020ee10) /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:741 +0xc33 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1(0xc4202137b0, 0xc4201be360, 0xefb940, 0xc420234000, 0xc4201de960) /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:402 +0xab created by github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1 /opt/gopath/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:403 +0xa3 {code}  ></description> </Issue>
