<Issue id="27797" key="FAB-8336" number="8336" project="10002" reporter="adnanchoudhury" assignee="chris.elder" creator="adnanchoudhury" type="10004" summary="CouchDB indexing: The peer log misleadingly indicates that N indexes were created when in reality it may be different" priority="3" resolution="10000" status="6" created="2018-02-16 15:17:31.0" updated="2018-07-20 14:15:45.0" resolutiondate="2018-02-27 19:21:45.0" votes="0" watches="3" workflowId="41267"> <description><! CDATA If the provided index definitions have more than one (lets say N) index with same DesignDoc and indexName but with potentially different indexes, the log will contain N messages like `created CouchDB index in the channel...` but in reality only 1 index will be created in CouchDB. Fabric goes through each file in alphabetic order, creating and (quietly) replacing the index created in last round with the same DDoc and indexName, so only the last index remains in CouchDB.  +*How to reproduce:*+ if there are two indexes in the index folder:  Â  {code:java} adnans-mbp:indexes adnanc$ cat indexOwner.json  {"index":{"fields":  "docType", "owner", "color" }, "ddoc": "indexOwnerDoc", "type": "json", "name": "indexOwner"} adnans-mbp:indexes adnanc$ cat indexOwnerOriginal.json  {"index":{"fields": "docType","owner" },"ddoc":"indexOwnerDoc", "name":"indexOwner","type":"json"} {code} The Peer log contains: {code:java}  36m2018-02-16 14:52:03.951 UTC  couchdb  CreateIndex -> DEBU 52f 0m Entering CreateIndex() indexdefinition={"index":{"fields":  "docType", "owner", "color" }, "ddoc": "indexOwnerDoc", "type": "json", "name": "indexOwner"}  36m2018-02-16 14:52:03.951 UTC  couchdb  handleRequest -> DEBU 530 0m Entering handleRequest() method=POST url=http://couchdb01:5984/mychannel1_mycc1/_index  36m2018-02-16 14:52:03.958 UTC  couchdb  handleRequest -> DEBU 531 0m HTTP Request: POST /mychannel1_mycc1/_index HTTP/1.1 | Host: couchdb01:5984 | User-Agent: Go-http-client/1.1 | Content-Length: 115 | Accept: application/json | Content-Type: application/json | Accept-Encoding: gzip | |   36m2018-02-16 14:52:04.137 UTC  couchdb  handleRequest -> DEBU 532 0m Exiting handleRequest() 2018-02-16 14:52:04.137 UTC  couchdb  CreateIndex -> INFO 533 0m Created CouchDB index in state database mychannel1_mycc1  36m2018-02-16 14:52:04.137 UTC  statecouchdb  HandleChaincodeDeploy -> DEBU 534 0m Reading artifact from file: META-INF/statedb/couchdb/indexes/indexOwnerOriginal.json  36m2018-02-16 14:52:04.137 UTC  statecouchdb  HandleChaincodeDeploy -> DEBU 535 0m Creating index from file file: indexOwnerOriginal.json  36m2018-02-16 14:52:04.137 UTC  couchdb  CreateIndex -> DEBU 536 0m Entering CreateIndex() indexdefinition={"index":{"fields": "docType","owner" },"ddoc":"indexOwnerDoc", "name":"indexOwner","type":"json"}  36m2018-02-16 14:52:04.137 UTC  couchdb  handleRequest -> DEBU 537 0m Entering handleRequest() method=POST url=http://couchdb01:5984/mychannel1_mycc1/_index  36m2018-02-16 14:52:04.141 UTC  couchdb  handleRequest -> DEBU 538 0m HTTP Request: POST /mychannel1_mycc1/_index HTTP/1.1 | Host: couchdb01:5984 | User-Agent: Go-http-client/1.1 | Content-Length: 99 | Accept: application/json | Content-Type: application/json | Accept-Encoding: gzip | |   36m2018-02-16 14:52:04.151 UTC  couchdb  handleRequest -> DEBU 539 0m Exiting handleRequest() 2018-02-16 14:52:04.151 UTC  couchdb  CreateIndex -> INFO 53a 0m Created CouchDB index in state database mychannel1_mycc1 {code} Â   Result: Only 1 index gets created even though two index files were there and log mentions index was created for both {code:java} adnans-mbp:/ adnanc$ curl -k -X GET http://localhost:5984/mychannel1_mycc1/_index  {"total_rows":2,"indexes": {"ddoc":null,"name":"_all_docs","type":"special","def":{"fields": {"_id":"asc"} }},{"ddoc":"_design/indexOwnerDoc","name":"indexOwner","type":"json","def":{"fields": {"docType":"asc"},{"owner":"asc"} ,"partial_filter_selector":{}}} } {code}     Â   ></description> </Issue>
