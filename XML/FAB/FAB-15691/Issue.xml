<Issue id="40527" key="FAB-15691" number="15691" project="10002" reporter="sykesm" assignee="mrosen52" creator="sykesm" type="10004" summary="Data race detected in TestWithStaticDeliverClientLeader" priority="4" resolution="10002" status="6" created="2019-06-11 17:21:15.0" updated="2019-06-11 17:30:17.0" resolutiondate="2019-06-11 17:30:17.0" votes="0" watches="2" workflowId="53476"> <description><! CDATA Running locally  {code} go test -race -v -run TestWithStaticDeliverClientLeader {code}  results in the following race on current master.  {code} ================== WARNING: DATA RACE Write at 0x00c0000c4740 by goroutine 153: sync.(*WaitGroup).Wait() /usr/local/Cellar/go/1.12.5/libexec/src/internal/race/race.go:41 +0xef github.com/hyperledger/fabric/gossip/comm.(*connection).close() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/conn.go:243 +0x1c7 github.com/hyperledger/fabric/gossip/comm.(*connectionStore).onConnected() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/conn.go:165 +0x70b github.com/hyperledger/fabric/gossip/comm.(*commImpl).GossipStream() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:557 +0x494 github.com/hyperledger/fabric/protos/gossip._Gossip_GossipStream_Handler() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/protos/gossip/message.pb.go:2466 +0xcd github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processStreamingRPC() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1176 +0x1669 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1256 +0x12e5 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:691 +0xac  Previous read at 0x00c0000c4740 by goroutine 95: sync.(*WaitGroup).Add() /usr/local/Cellar/go/1.12.5/libexec/src/internal/race/race.go:37 +0x169 github.com/hyperledger/fabric/gossip/comm.(*connection).serviceConnection() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/conn.go:293 +0xf4  Goroutine 153 (running) created at: github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:689 +0xb8 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).operateHeaders() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:421 +0x1622 github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport.(*http2Server).HandleStreams() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/internal/transport/http2_server.go:461 +0x37a github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:687 +0x170 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleRawConn.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:649 +0x50  Goroutine 95 (finished) created at: github.com/hyperledger/fabric/gossip/comm.(*connectionStore).getConnection() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/conn.go:124 +0x878 github.com/hyperledger/fabric/gossip/comm.(*commImpl).sendToEndpoint() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:231 +0x2ce github.com/hyperledger/fabric/gossip/comm.(*commImpl).Send.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:218 +0x51 ================== {code}  ></description> </Issue>
