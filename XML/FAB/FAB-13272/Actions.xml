<Action id="54790" issue="36145" author="denyeart" type="comment" created="2018-12-14 00:04:08.0" updateauthor="denyeart" updated="2018-12-14 00:04:08.0"> <body><! CDATA Thank you for the deep test.  But I think this is correct. Look closely at the Warning message:  "Missing key because was purged *or will soon be purged*, continue block commit without".     The skipping of "soon to be purged" private data is required because in a high volume environment the catching up peer may request the private data at the same time other peers are purging the private data. This race condition would cause the catching up peer to pause. So there is a config option to skip soon to be purged private data, default is 10 blocks:   https://github.com/hyperledger/fabric/blob/release-1.4/sampleconfig/core.yaml#L183-L188   Make sense?  ></body> </Action>
<Action id="54791" issue="36145" author="yuki-kon" type="comment" created="2018-12-14 00:55:39.0" updateauthor="yuki-kon" updated="2018-12-14 00:55:39.0"> <body><! CDATA Hello,  ~denyeart . Thank you for your quick review and feedback. After setting "CORE_PEER_GOSSIP_PVTDATA_BTLPULLMARGIN=1" to make the pulling margin short, a new peer can fetch and get private data in the latest block which are not "soon to be purged". I will close the JIRA. Sorry for making an unnecessary bug report.  Here are the log messages. - Log messages of reconciliation at a new peer. {noformat} 2018-12-14 00:40:38.785 UTC  gossip.privdata  StoreBlock -> INFO 036  mychannel  Received block  6  from buffer 2018-12-14 00:40:38.793 UTC  gossip.privdata  fetchFromPeers -> WARN 038 Missing key because was purged or will soon be purged, continue block commit without  {txID:e2987a9b82e2cc6ad8fefb3e1db617b6a759e8e57cc0faeecfec1d2cb887d1e1 seqInBlock:0 namespace:marblesp collection:collectionMarblePrivateDetails hash:5df64b386e1af066177edf6f6ddf321a19726a1792a74a14b68270c02b6248cd}  in private rwset 2018-12-14 00:40:38.793 UTC  gossip.privdata  StoreBlock -> INFO 039  mychannel  Fetched all missing collection private write sets from remote peers for block  6  (4ms) 2018-12-14 00:40:38.806 UTC  kvledger  CommitWithPvtData -> INFO 03a  mychannel  Committed block  6  with 1 transaction(s) in 12ms (state_validation=0ms block_commit=6ms state_commit=4ms) (snip) 2018-12-14 00:40:38.865 UTC  gossip.privdata  StoreBlock -> INFO 04a  mychannel  Received block  10  from buffer 2018-12-14 00:40:38.872 UTC  gossip.privdata  StoreBlock -> INFO 04c  mychannel  Fetched all missing collection private write sets from remote peers for block  10  (5ms) 2018-12-14 00:40:38.886 UTC  kvledger  CommitWithPvtData -> INFO 04d  mychannel  Committed block  10  with 1 transaction(s) in 14ms (state_validation=0ms block_commit=7ms state_commit=5ms)  {noformat} - Log messages of query at a new peer. {noformat} root@d64ac35ce98d:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n marblesp -c '{"Args": "readMarblePrivateDetails","marble1" }' Error: endorsement failure during query. response: status:500 message:"{\"Error\":\"Marble private details does not exist: marble1\"}" root@d64ac35ce98d:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n marblesp -c '{"Args": "readMarblePrivateDetails","marble2" }' Error: endorsement failure during query. response: status:500 message:"{\"Error\":\"Failed to get private details for marble2: GET_STATE failed: transaction ID: ee5283c4a0b4bbc3bbdb52b17651e856e1defb183f9b15f830c50d754916f0bd: private data matching public hash version is not available. Public hash version = &version.Height{BlockNum:0x7, TxNum:0x0}, Private data version = (*version.Height)(nil)\"}" (snip) root@d64ac35ce98d:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n marblesp -c '{"Args": "readMarblePrivateDetails","marble5" }' {"docType":"marblePrivateDetails","name":"marble5","price":99} {noformat}  ></body> </Action>
<Action id="54792" issue="36145" author="yuki-kon" type="comment" body="A new peer couldn&apos;t read missing private data because it is &quot;soon to be purged&quot;. This is expected by private data reconciliation. This is not a bug." created="2018-12-14 00:59:35.0" updateauthor="yuki-kon" updated="2018-12-14 00:59:35.0"/>
