<Issue id="35578" key="FAB-12987" number="12987" project="10002" reporter="denyeart" assignee="manish-sethi" creator="denyeart" type="10004" summary="Upgrade from v1.2 to v1.3 fails for leveldb state database" priority="2" resolution="10000" status="6" created="2018-11-25 16:30:11.0" updated="2019-07-15 11:29:57.0" resolutiondate="2018-11-28 03:50:13.0" votes="0" watches="1" workflowId="47049"> <description><! CDATA Upon startup of v1.3 peer after upgrade, receive error:  2018-11-25 11:22:06.331 EST  peer  Initialize -> WARN 023 Failed to load chain myc(proto: msgs.VersionedValueProto: illegal tag 0 (wire type 0))  This makes a prior release channel in the peer unusable after upgrade.  Related change in v1.3: https://gerrit.hyperledger.org/r/#/c/21763/  Failing at this line: https://github.com/hyperledger/fabric/blob/release-1.3/core/ledger/kvledger/txmgmt/statedb/stateleveldb/value_encoding.go#L37  It is failing if the latest channel config came from the genesis block (block 0). In that case the EncodedValue for  resourcesconfigtx.CHANNEL_CONFIG_KEY starts with 0x0 (representing block 0). 0x0 happens to be the indicator character for the 'new' versioned value format in v1.3. Peer therefore tries to decode the 'old v1.2' value using the 'new v1.3' proto and throws error proto: msgs.VersionedValueProto: illegal tag 0 (wire type 0).  If the latest channel config came from a later block (as in the byfn case, due to config updates for anchor peer), then things work fine.  Note also that we should wrap error messages to make errors easier to troubleshoot.  For users hitting this error, you can resolve it by stopping peer and deleting directory /var/hyperledger/production/ledgersData/stateLeveldb. Upon peer restart it will rebuild leveldb state database with correct format.  ></description> </Issue>
