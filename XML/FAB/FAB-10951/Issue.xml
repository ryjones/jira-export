<Issue id="31506" key="FAB-10951" number="10951" project="10002" reporter="sykesm" assignee="sykesm" creator="sykesm" type="10003" summary="Data race when running TestUpdateRootsFromConfigBlock" priority="4" resolution="10000" status="6" created="2018-06-29 19:29:29.0" updated="2018-07-20 14:17:05.0" resolutiondate="2018-07-02 20:35:11.0" votes="0" watches="1" workflowId="42574"> <description><! CDATA Another race related to viper (doesn't support concurrency) and gossip (constantly retrieves config data from the map). {code:java} ================== WARNING: DATA RACE Write at 0x00c4200cbfb0 by goroutine 154:   runtime.mapassign_faststr()       /usr/local/Cellar/go/1.10.3/libexec/src/runtime/hashmap_fast.go:694 +0x0   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:772 +0xc6   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.Set()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:768 +0x72   github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func1()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:170 +0x90   github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func3()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:267 +0x5a   github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock.func5()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:326 +0x846   testing.tRunner()       /usr/local/Cellar/go/1.10.3/libexec/src/testing/testing.go:777 +0x16d  Previous read at 0x00c4200cbfb0 by goroutine 39:   runtime.mapaccess2_faststr()       /usr/local/Cellar/go/1.10.3/libexec/src/runtime/hashmap_fast.go:261 +0x0   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).find()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:628 +0x16a   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).Get()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:404 +0x106   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.(*Viper).GetDuration()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:481 +0x4c   github.com/hyperledger/fabric/vendor/github.com/spf13/viper.GetDuration()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/spf13/viper/viper.go:479 +0x5e   github.com/hyperledger/fabric/gossip/util.GetDurationOrDefault()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/util/misc.go:177 +0x87   github.com/hyperledger/fabric/gossip/gossip/algo.(*PullEngine).processIncomingDigests()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/gossip/algo/pull.go:216 +0x729   github.com/hyperledger/fabric/gossip/gossip/algo.(*PullEngine).initiatePull.func1()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/gossip/gossip/algo/pull.go:189 +0x41  Goroutine 154 (running) created at:   testing.(*T).Run()       /usr/local/Cellar/go/1.10.3/libexec/src/testing/testing.go:824 +0x564   github.com/hyperledger/fabric/core/peer_test.TestUpdateRootsFromConfigBlock()       /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/core/peer/pkg_test.go:298 +0x2952   testing.tRunner()       /usr/local/Cellar/go/1.10.3/libexec/src/testing/testing.go:777 +0x16d  Goroutine 39 (finished) created at:   time.goFunc()       /usr/local/Cellar/go/1.10.3/libexec/src/time/sleep.go:172 +0x51 =================={code}    ></description> </Issue>
