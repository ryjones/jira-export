<Issue id="37172" key="FAB-13910" number="13910" project="10002" reporter="kchristidis" creator="kchristidis" type="10004" summary="Data race in TestMetadata (package: core/cclifecycle)" priority="3" resolution="10002" status="6" created="2019-01-27 22:11:55.0" updated="2019-03-19 10:57:46.0" resolutiondate="2019-01-27 22:23:36.0" votes="0" watches="2" workflowId="48750"> <description><! CDATA As seen in: https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/8260/console  {code} ================== WARNING: DATA RACE Write at 0x000001d3e110 by goroutine 25: github.com/hyperledger/fabric/core/cclifecycle_test.newLogRecorder() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/lifecycle_test.go:464 +0x99 github.com/hyperledger/fabric/core/cclifecycle_test.TestMetadata() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/lifecycle_test.go:344 +0x53 testing.tRunner() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:827 +0x162  Previous read at 0x000001d3e110 by goroutine 24: github.com/hyperledger/fabric/core/cclifecycle.(*Lifecycle).fireChangeListeners() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/lifecycle.go:188 +0x2a4 github.com/hyperledger/fabric/core/cclifecycle.(*Subscription).processPendingUpdate() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/subscription.go:57 +0x6e5 github.com/hyperledger/fabric/core/cclifecycle.(*Subscription).ChaincodeDeployDone.func1() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/subscription.go:79 +0x131  Goroutine 25 (running) created at: testing.(*T).Run() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:878 +0x650 testing.runTests.func1() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:1119 +0xa8 testing.tRunner() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:827 +0x162 testing.runTests() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:1117 +0x4ee testing.(*M).Run() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:1034 +0x2ee main.main() _testmain.go:112 +0x332  Goroutine 24 (finished) created at: github.com/hyperledger/fabric/core/cclifecycle.(*Subscription).ChaincodeDeployDone() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/subscription.go:68 +0x7d github.com/hyperledger/fabric/core/cclifecycle_test.TestMultipleUpdates() /w/workspace/fabric-verify-unit-tests-x86_64/gopath/src/github.com/hyperledger/fabric/core/cclifecycle/lifecycle_test.go:320 +0x1399 testing.tRunner() /opt/go/go1.11.1.linux.amd64/src/testing/testing.go:827 +0x162 ================== --- FAIL: TestMetadata (0.01s) <autogenerated>:1:    Metadata -> WARN 0021 Requested Metadata for non-existent channel mychannel <autogenerated>:1:    queryChaincodeDefinitions -> DEBU 0022 Chaincode {cc1 1.0  42 } 's version is 1.0 and Id is  42  <autogenerated>:1:    DeployedChaincodes -> DEBU 0023 Returning  {cc1 1.0  1 2 3 4 5   42    }  <autogenerated>:1:    fireChangeListeners -> DEBU 0024 Listeners for channel mychannel invoked <autogenerated>:1:    Metadata -> DEBU 0025 Returning metadata for channel mychannel , chaincode cc1 : {cc1 1.0  1 2 3 4 5   42    } <autogenerated>:1:    Metadata -> ERRO 0026 Failed obtaining new query for channel mychannel : failed obtaining query executor <autogenerated>:1:    DeployedChaincodes -> ERRO 0027 Failed querying lscc namespace: GetState failed <autogenerated>:1:    Metadata -> ERRO 0028 Failed querying LSCC for channel mychannel : GetState failed <autogenerated>:1:    DeployedChaincodes -> INFO 0029 Chaincode cc2 isn't instantiated <autogenerated>:1:    DeployedChaincodes -> DEBU 002a Returning    <autogenerated>:1:    Metadata -> INFO 002b Chaincode cc2 isn't defined in channel mychannel <autogenerated>:1:    DeployedChaincodes -> DEBU 002c Returning  {cc2 1.0     42    }  <autogenerated>:1:    DeployedChaincodes -> DEBU 002d Retrieved collection config for cc1 from cc1~collection <autogenerated>:1:    DeployedChaincodes -> DEBU 002e Returning  {cc1 1.0  1 2 3 4 5   42   10 10 10 }  <autogenerated>:1:    DeployedChaincodes -> ERRO 002f Failed querying lscc namespace for cc1~collection: foo <autogenerated>:1:    Metadata -> ERRO 0030 Failed querying LSCC for channel mychannel : foo testing.go:771: race detected during execution of test 2019-01-23 12:23:39.789 UTC  discovery.lifecycle  DeployedChaincodes -> ERRO 031 Failed querying lscc namespace: failed querying ledger 2019-01-23 12:23:39.790 UTC  discovery.lifecycle  DeployedChaincodes -> ERRO 032 Failed extracting chaincode info about cc1 from LSCC returned payload. Error: failed unmarshaling lscc read value into ChaincodeData: proto: ccprovider.ChaincodeData: illegal tag 0 (wire type 0) 2019-01-23 12:23:39.791 UTC  discovery.lifecycle  DeployedChaincodes -> ERRO 033 Chaincode cc1 is listed in LSCC as cc2 2019-01-23 12:23:39.791 UTC  discovery.lifecycle  DeployedChaincodes -> INFO 034 Chaincode cc1 isn't instantiated FAIL coverage: 99.3% of statements FAIL	github.com/hyperledger/fabric/core/cclifecycle	0.449s {code}  ></description> </Issue>
