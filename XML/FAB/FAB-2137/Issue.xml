<Issue id="14640" key="FAB-2137" number="2137" project="10002" reporter="scottz" assignee="suryalnvs" creator="scottz" type="10004" summary="orderer service batching broken using new BATCHTIMEOUT" priority="3" resolution="10000" status="6" created="2017-02-08 23:40:29.0" updated="2018-07-20 14:11:33.0" resolutiondate="2017-06-01 18:01:00.0" votes="0" watches="4" workflowId="37364"> <description><! CDATA SIMPLE batching works with default values, but NOT when setting some environment variables to non-default values. This bug is for problems seen when changing the BatchTimeout.  Simple batching works ok when using default values: solo orderer default channel = testchainid default batchtimeout = 10s Broadcast/Send 4 TX or 14 TX After 10 secs, the 4 transactions are batched and delivered as expected, and the total number of blocks = 2.  Refer to FAB-2001 for problems when change the channel ID. For this bug, we kept the default testchainid. HOWEVER, for this bug: Run same test, using ORDERER_GENESIS_BATCHTIMEOUT=20s Instead of seeing the same result after waiting 20 secs for the 2nd batch, we see a random number of batches (typically between 5 .. 13) Consumer recvd a block, o 0 c 0 blkNum 1 numtrans 2 Consumer recvd a block, o 0 c 0 blkNum 2 numtrans 5 Consumer recvd a block, o 0 c 0 blkNum 3 numtrans 1 Consumer recvd a block, o 0 c 0 blkNum 4 numtrans 1 Consumer recvd a block, o 0 c 0 blkNum 5 numtrans 1 Consumer recvd a block, o 0 c 0 blkNum 6 numtrans 2 Send Duration (seconds):    0 Consumer recvd a block, o 0 c 0 blkNum 7 numtrans 2 Recovery Duration (secs):   2 waitSecs for last batch:    2 Error: Unexpected Block count 7 (expected 2) Total deliveries received TX             14  Total deliveries received Blocks         7   Same goes for Kafka (works with default timeout, but not if we change it): Run same test, using ORDERER_GENESIS_BATCHTIMEOUT=20s and OTE_TXS=14 ORDERER_GENESIS_ORDERERTYPE=kafka OTE_KAFKABROKERS=3 and we see incorrect batches data like this: Consumer recvd a block, o 0 c 0 blkNum 1 numtrans 1 Consumer recvd a block, o 0 c 0 blkNum 2 numtrans 2 Consumer recvd a block, o 0 c 0 blkNum 3 numtrans 5 Consumer recvd a block, o 0 c 0 blkNum 4 numtrans 2 Consumer recvd a block, o 0 c 0 blkNum 5 numtrans 2 Consumer recvd a block, o 0 c 0 blkNum 6 numtrans 2 Error: Unexpected Block count 6 (expected 2) Total deliveries received TX on each ordr            14  Total deliveries received Blocks on each ordr         6    ></description> </Issue>
