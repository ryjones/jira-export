<Issue id="15769" key="FAB-3182" number="3182" project="10002" reporter="yacovm" assignee="yacovm" creator="yacovm" type="10004" summary="CI failure in delivery service - goroutines didn&apos;t finish" priority="3" resolution="10000" status="6" created="2017-04-16 09:48:18.0" updated="2019-03-19 11:13:13.0" resolutiondate="2017-04-18 18:44:29.0" votes="0" watches="1" workflowId="38005"> <description><! CDATA I think that the goroutine check needs to be poll-based, it seems that it's too brittle as I saw a CI failure:  https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9618/console  09:43:12 unit-tests_1  | 2017-04-16 09:42:45.470 UTC  deliveryClient  connect -> ERRO 02e Failed obtaining connection: Failed connecting 09:43:12 unit-tests_1  | stream error: code = 1 desc = "context canceled" 09:43:12 unit-tests_1  | 2017-04-16 09:42:47.473 UTC  deliveryClient  connect -> ERRO 02f Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 09:43:12 unit-tests_1  | 2017-04-16 09:42:48.473 UTC  deliveryClient  connect -> ERRO 030 Connection to  localhost:5611 established but was unable to create gRPC stream: Failed creating ABC 09:43:12 unit-tests_1  | --- FAIL: TestProductionUsage (1.00s) 09:43:12 unit-tests_1  | 	assertions.go:219:   	Error Trace:	deliveryclient_test.go:353 09:43:12 unit-tests_1  | 		 			client_test.go:599 09:43:12 unit-tests_1  | 		 	Error:		Not equal: 4 (expected) 09:43:12 unit-tests_1  | 			        != 3 (actual) 09:43:12 unit-tests_1  | 		 	Messages:	Some goroutine(s) didn't finish: goroutine 78  running : 09:43:12 unit-tests_1  | 		github.com/hyperledger/fabric/core/deliverservice.getStackTrace(0x3, 0xc420350000) 09:43:12 unit-tests_1  | 			/opt/gopath/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:359 +0x79 09:43:12 unit-tests_1  | 		github.com/hyperledger/fabric/core/deliverservice.ensureNoGoroutineLeak.func1() 09:43:12 unit-tests_1  | 			/opt/gopath/src/github.com/hyperledger/fabric/core/deliverservice/deliveryclient_test.go:353 +0x86 09:43:12 unit-tests_1  | 		github.com/hyperledger/fabric/core/deliverservice.TestProductionUsage(0xc4202ac540) 09:43:12 unit-tests_1  | 			/opt/gopath/src/github.com/hyperledger/fabric/core/deliverservice/client_test.go:599 +0x49b 09:43:12 unit-tests_1  | 		testing.tRunner(0xc4202ac540, 0xa10b18) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:610 +0x81 09:43:12 unit-tests_1  | 		created by testing.(*T).Run 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:646 +0x2ec 09:43:12 unit-tests_1  | 		 09:43:12 unit-tests_1  | 		goroutine 1  chan receive : 09:43:12 unit-tests_1  | 		testing.(*T).Run(0xc4202a1200, 0x9cd8ed, 0x13, 0xa10b18, 0xc420173c01) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:647 +0x316 09:43:12 unit-tests_1  | 		testing.RunTests.func1(0xc4202a1200) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:793 +0x6d 09:43:12 unit-tests_1  | 		testing.tRunner(0xc4202a1200, 0xc420173d78) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:610 +0x81 09:43:12 unit-tests_1  | 		testing.RunTests(0xa11c40, 0xe5ff20, 0x12, 0x12, 0x412e8e) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:799 +0x2f5 09:43:12 unit-tests_1  | 		testing.(*M).Run(0xc420173ed8, 0x9e2f76) 09:43:12 unit-tests_1  | 			/opt/go/src/testing/testing.go:743 +0x85 09:43:12 unit-tests_1  | 		main.main() 09:43:12 unit-tests_1  | 			github.com/hyperledger/fabric/core/deliverservice/_test/_testmain.go:138 +0x1bd 09:43:12 unit-tests_1  | 		 09:43:12 unit-tests_1  | 		goroutine 17  syscall, locked to thread : 09:43:12 unit-tests_1  | 		runtime.goexit() 09:43:12 unit-tests_1  | 			/opt/go/src/runtime/asm_amd64.s:2086 +0x1 09:43:12 unit-tests_1  | 		 09:43:12 unit-tests_1  | 		 09:43:12 unit-tests_1  | 2017-04-16 09:42:50.477 UTC  deliveryClient  StartDeliverForChannel -> ERRO 031 Delivery service - block provider already exists for TEST_CHAINID found, can't start delivery 09:43:12 unit-tests_1  | 2017-04-16 09:42:50.478 UTC  deliveryClient  StopDeliverForChannel -> ERRO 032 Delivery service - no block provider for TEST_CHAINID2 found, can't stop delivery 09:43:12 unit-tests_1  | 2017-04-16 09:42:50.998 UTC  deliveryClient  StartDeliverForChannel -> ERRO 033 Delivery service is stopping cannot join a new channel TEST_CHAINID 09:43:12 unit-tests_1  | 2017-04-16 09:42:50.998 UTC  deliveryClient  StopDeliverForChannel -> ERRO 034 Delivery service is stopping, cannot stop delivery for channel TEST_CHAINID 09:43:12 unit-tests_1  | 2017-04-16 09:42:56.314 UTC  blocksProvider  DeliverBlocks -> WARN 035 Receive error: Client is closing 09:43:12 unit-tests_1  | 2017-04-16 09:43:06.320 UTC  ConnProducer  NewConnection -> ERRO 036 Failed connecting to localhost:5612 , error: grpc: timed out when dialing 09:43:12 unit-tests_1  | 2017-04-16 09:43:06.322 UTC  blocksProvider  DeliverBlocks -> WARN 037 Receive error: Client is closing 09:43:12 unit-tests_1  | 2017-04-16 09:43:08.325 UTC  blocksProvider  DeliverBlocks -> WARN 038 Receive error: Client is closing 09:43:12 unit-tests_1  | FAIL  ></description> </Issue>
