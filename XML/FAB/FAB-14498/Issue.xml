<Issue id="38222" key="FAB-14498" number="14498" project="10002" reporter="hagarm" assignee="hagarm" creator="hagarm" type="10003" summary="Address data race in gossip/gossip" priority="3" resolution="10000" status="6" created="2019-03-05 15:36:05.0" updated="2019-03-17 07:19:31.0" resolutiondate="2019-03-17 07:19:31.0" votes="0" watches="2" workflowId="49844"> <description><! CDATA ================== WARNING: DATA RACE Read at 0x00c00330aa90 by goroutine 1759: github.com/hyperledger/fabric/gossip/gossip.TestConfidentiality.func4() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:435 +0x55  Previous write at 0x00c00330aa90 by goroutine 123: github.com/hyperledger/fabric/gossip/gossip.TestConfidentiality() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:427 +0x1b6d testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Goroutine 1759 (running) created at: github.com/hyperledger/fabric/gossip/gossip.TestConfidentiality() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:432 +0x1ecb testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Goroutine 123 (running) created at: testing.(*T).Run() /usr/local/go/src/testing/testing.go:878 +0x659 testing.runTests.func1() /usr/local/go/src/testing/testing.go:1119 +0xa8 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162 testing.runTests() /usr/local/go/src/testing/testing.go:1117 +0x4ee testing.(*M).Run() /usr/local/go/src/testing/testing.go:1034 +0x2ee main.main() _testmain.go:152 +0x332 ==================     ================== WARNING: DATA RACE Read at 0x00c004389a70 by goroutine 3176: github.com/hyperledger/fabric/gossip/protoext.(*SignedGossipMessage).String() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/protoext/signing.go:159 +0x19e4 fmt.(*pp).handleMethods() /usr/local/go/src/fmt/print.go:603 +0x404 fmt.(*pp).printArg() /usr/local/go/src/fmt/print.go:686 +0x255 fmt.(*pp).doPrintln() /usr/local/go/src/fmt/print.go:1146 +0xbd fmt.Sprintln() /usr/local/go/src/fmt/print.go:271 +0x5f github.com/hyperledger/fabric/common/flogging.formatArgs() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/common/flogging/zap.go:105 +0x50 github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Debug() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/common/flogging/zap.go:61 +0x50 github.com/hyperledger/fabric/gossip/comm.(*commImpl).sendToEndpoint() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:227 +0x1e2 github.com/hyperledger/fabric/gossip/comm.(*commImpl).Send.func1() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:218 +0x51  Previous write at 0x00c004389a70 by goroutine 833: github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendAndFilterSecrets() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:533 +0x32b github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).gossipBatch() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:519 +0x13a5 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendGossipBatch() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:425 +0x1a8 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendGossipBatch-fm() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:118 +0x5f github.com/hyperledger/fabric/gossip/gossip.(*batchingEmitterImpl).emit() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/batcher.go:81 +0x2ab github.com/hyperledger/fabric/gossip/gossip.(*batchingEmitterImpl).periodicEmit() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/batcher.go:64 +0xc0  Goroutine 3176 (running) created at: github.com/hyperledger/fabric/gossip/comm.(*commImpl).Send() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/comm/comm_impl.go:217 +0x244 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendAndFilterSecrets() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:536 +0x2bc github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).gossipBatch() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:519 +0x13a5 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendGossipBatch() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:425 +0x1a8 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).sendGossipBatch-fm() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:118 +0x5f github.com/hyperledger/fabric/gossip/gossip.(*batchingEmitterImpl).emit() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/batcher.go:81 +0x2ab github.com/hyperledger/fabric/gossip/gossip.(*batchingEmitterImpl).periodicEmit() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/batcher.go:64 +0xc0  Goroutine 833 (running) created at: github.com/hyperledger/fabric/gossip/gossip.newBatchingEmitter() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/batcher.go:54 +0x2ad github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:116 +0xea8 github.com/hyperledger/fabric/gossip/gossip.newGossipInstanceWithGRPCWithExternalEndpoint() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:136 +0x85a github.com/hyperledger/fabric/gossip/gossip.TestMultipleOrgEndpointLeakage() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:212 +0xc60 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162 ==================     WARNING: DATA RACE Read at 0x00c0001c8930 by goroutine 1020: runtime.mapaccess2_faststr() /usr/local/go/src/runtime/map_faststr.go:101 +0x0 github.com/hyperledger/fabric/gossip/gossip.(*naiveCryptoService).Expiration() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:142 +0xa3 github.com/hyperledger/fabric/gossip/identity.(*identityMapperImpl).Put() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/identity/identity.go:113 +0xcf github.com/hyperledger/fabric/gossip/gossip.(*discoverySecurityAdapter).ValidateAliveMsg() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:998 +0x3d0 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMsgFromComm() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:350 +0x7c7 github.com/hyperledger/fabric/gossip/discovery.(*gossipDiscoveryImpl).handleMessages() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:304 +0x162  Previous write at 0x00c0001c8930 by goroutine 131: runtime.mapassign_faststr() /usr/local/go/src/runtime/map_faststr.go:190 +0x0 github.com/hyperledger/fabric/gossip/gossip.TestIdentityExpiration() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:1440 +0x484 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Goroutine 1020 (running) created at: github.com/hyperledger/fabric/gossip/discovery.NewDiscoveryService() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/discovery/discovery_impl.go:120 +0x856 github.com/hyperledger/fabric/gossip/gossip.NewGossipService() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:129 +0x120c github.com/hyperledger/fabric/gossip/gossip.newGossipInstanceWithGrpcMcsMetrics() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:269 +0x8ec github.com/hyperledger/fabric/gossip/gossip.TestDataLeakage.func1() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:1093 +0x3af  Goroutine 131 (running) created at: testing.(*T).Run() /usr/local/go/src/testing/testing.go:878 +0x659 testing.runTests.func1() /usr/local/go/src/testing/testing.go:1119 +0xa8 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162 testing.runTests() /usr/local/go/src/testing/testing.go:1117 +0x4ee testing.(*M).Run() /usr/local/go/src/testing/testing.go:1034 +0x2ee main.main() _testmain.go:152 +0x332 ==================        WARNING: DATA RACE Write at 0x00c0003df090 by goroutine 92: runtime.closechan() /usr/local/go/src/runtime/chan.go:327 +0x0 github.com/hyperledger/fabric/gossip/gossip.(*discoveryAdapter).close() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:882 +0x7e github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).Stop() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:749 +0x185 github.com/hyperledger/fabric/gossip/gossip.(*gossipGRPC).Stop() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_test.go:351 +0x4b github.com/hyperledger/fabric/gossip/gossip.TestMultipleOrgEndpointLeakage() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/orgs_test.go:269 +0x14d1 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Previous read at 0x00c0003df090 by goroutine 1096: runtime.chansend() /usr/local/go/src/runtime/chan.go:140 +0x0 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).forwardDiscoveryMsg() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:400 +0xe5 github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).handleMessage() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:387 +0x106e github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).acceptMessages() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:318 +0x1b0  Goroutine 92 (running) created at: testing.(*T).Run() /usr/local/go/src/testing/testing.go:878 +0x659 testing.runTests.func1() /usr/local/go/src/testing/testing.go:1119 +0xa8 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162 testing.runTests() /usr/local/go/src/testing/testing.go:1117 +0x4ee testing.(*M).Run() /usr/local/go/src/testing/testing.go:1034 +0x2ee main.main() _testmain.go:152 +0x332  Goroutine 1096 (running) created at: github.com/hyperledger/fabric/gossip/gossip.(*gossipServiceImpl).start() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/gossip_impl.go:304 +0x105 ==================     ================== WARNING: DATA RACE Read at 0x00c0004b0030 by goroutine 114: github.com/hyperledger/fabric/common/flogging.(*FabricLogger).Info() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/common/flogging/zap.go:70 +0x74 github.com/hyperledger/fabric/gossip/gossip/channel.(*gossipChannel).reportMembershipChanges() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel.go:295 +0x98 github.com/hyperledger/fabric/gossip/gossip/channel.(*gossipChannel).reportMembershipChanges-fm() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel.go:283 +0x5f github.com/hyperledger/fabric/gossip/gossip/channel.(*membershipTracker).checkIfPeersChanged() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel.go:1045 +0xb0c github.com/hyperledger/fabric/gossip/gossip/channel.(*membershipTracker).trackMembershipChanges() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel.go:1074 +0x24a  Previous write at 0x00c0004b0030 by goroutine 41: github.com/hyperledger/fabric/common/flogging.(*FabricLogger).WithOptions() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/common/flogging/zap.go:102 +0x2c5 github.com/hyperledger/fabric/gossip/gossip/channel.TestMembershiptrackerStopWhenGCStops() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel_test.go:2220 +0x16a2 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Goroutine 114 (running) created at: github.com/hyperledger/fabric/gossip/gossip/channel.NewGossipChannel() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel.go:290 +0x12bd github.com/hyperledger/fabric/gossip/gossip/channel.TestMembershiptrackerStopWhenGCStops() /Users/hagarmei/golang/src/github.com/hyperledger/fabric/gossip/gossip/channel/channel_test.go:2209 +0xe74 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162  Goroutine 41 (running) created at: testing.(*T).Run() /usr/local/go/src/testing/testing.go:878 +0x659 testing.runTests.func1() /usr/local/go/src/testing/testing.go:1119 +0xa8 testing.tRunner() /usr/local/go/src/testing/testing.go:827 +0x162 testing.runTests() /usr/local/go/src/testing/testing.go:1117 +0x4ee testing.(*M).Run() /usr/local/go/src/testing/testing.go:1034 +0x2ee main.main() _testmain.go:140 +0x332 ==================  ></description> </Issue>
