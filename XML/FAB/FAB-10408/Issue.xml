<Issue id="30667" key="FAB-10408" number="10408" project="10002" reporter="denyeart" assignee="c0rwin" creator="denyeart" type="10004" summary="Private data pull delays for 1 second before pulling" priority="3" resolution="10000" status="6" created="2018-05-26 11:36:26.0" updated="2018-07-20 14:16:50.0" resolutiondate="2018-05-27 12:59:43.0" votes="0" watches="3" workflowId="42346"> <description><! CDATA At commit time if peer doesn't have private data for a transaction in local transient store, peer will attempt to pull private data from another peer in the network.  There appears to be an unnecessary 1 second delay between the time the peer detects that it needs to pull, and the time that it actually pulls.  This is demonstrated in the below trace from the org2 pulling peer, using the sample chaincode and config found in FAB-10231 (org2 has access to one collection but not the other). {code:java} 2018-05-26 11:16:41.344 UTC  gossip/privdata  StoreBlock -> INFO a1c Received block  3  2018-05-26 11:16:41.344 UTC  gossip/privdata  StoreBlock -> DEBU a1d Validating block  3  2018-05-26 11:16:41.349 UTC  stateleveldb  GetState -> DEBU a3c GetState(). ns=lscc, key=marblesp~collection 2018-05-26 11:16:41.350 UTC  gossip/privdata  isEligible -> DEBU a3e Skipping namespace marblesp collection collectionMarblePrivateDetails because we're not eligible for the private data 2018-05-26 11:16:41.350 UTC  gossip/privdata  inspectTransaction -> DEBU a3f Peer is not eligible for collection, channel  mychannel , chaincode  marblesp , collection name  collectionMarblePrivateDetails , txID  4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260  the policy is  &privdata.SimpleCollection{name:"collectionMarblePrivateDetails", accessPolicy:(*cauthdsl.policy)(0xc422f78a00), memberOrgs:  string{"Org1MSP"}, conf:common.StaticCollectionConfig{Name:"collectionMarblePrivateDetails", MemberOrgsPolicy:(*common.CollectionPolicyConfig)(0xc422afbb30), RequiredPeerCount:0, MaximumPeerCount:0, BlockToLive:0x3}} . Skipping. 2018-05-26 11:16:41.350 UTC  stateleveldb  GetState -> DEBU a41 GetState(). ns=lscc, key=marblesp~collection 2018-05-26 11:16:41.350 UTC  gossip/privdata  listMissingPrivateData -> DEBU a43 Retrieving private write sets for 1 transactions from transient store 2018-05-26 11:16:41.350 UTC  transientstore  GetTxPvtRWSetByTxid -> DEBU a44 Getting private data from transient store for transaction 4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260 2018-05-26 11:16:41.351 UTC  gossip/privdata  StoreBlock -> DEBU a46 Could not find all collection private write sets in local peer transient store. 2018-05-26 11:16:41.351 UTC  gossip/privdata  StoreBlock -> DEBU a47 Fetching 1 collection private write sets from remote peers for a maximum duration of 1m0s 2018-05-26 11:16:41.351 UTC  gossip/privdata  func1 -> DEBU a48 Fetching {4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260 0 marblesp collectionMarbles 6c6c363ba4824671dbb0f7ed703367a7c6d04733bb0e7b5c5ad4aa60bbbcac70} from peers 2018-05-26 11:16:41.351 UTC  stateleveldb  GetState -> DEBU a4a GetState(). ns=lscc, key=marblesp~collection{code} 1 second gap in debug... {code:java} 2018-05-26 11:16:42.352 UTC  gossip/privdata  fetch -> DEBU a8d Total members in channel:  {peer0.org1.example.com:7051     229 244 44 51 127 183 98 146 95 185 26 198 234 23 94 76 87 2 58 150 246 3 184 227 39 250 88 93 132 119 99 72   ledger_height:3 chaincodes:<name:"marblesp" version:"1.0" >  payload:"\030\005zo\022\024\010\200\322\363\223\342\263\213\231\025\020\300\256\256\303\223\264\213\231\025\032 \345\364,3\177\267b\222_\271\032\306\352\027^LW\002:\226\366\003\270\343'\372X \204wcH\" $=i\306\226\200\020\r$\260\215F\000nb\334z\236\205\206\364\277\340u\363*$M0\231\021:*\023\010\003\032\017\n\010marblesp\022\0031.0" signature:"0E\002!\000\304\004\323\274\234\2766\224?.\246\1775\030\233q\321\330\317\202\343\024\344\023-4wL\322\267\200r\002 Mi\013\273/\316P\275\355U\357G!\361\027\332\203\251\256\343}\235;\333\200 8\034\275Ku)" }  2018-05-26 11:16:42.352 UTC  gossip/privdata  fetch -> DEBU a8e Total members that fit some digest:  {peer0.org1.example.com:7051     229 244 44 51 127 183 98 146 95 185 26 198 234 23 94 76 87 2 58 150 246 3 184 227 39 250 88 93 132 119 99 72   ledger_height:3 chaincodes:<name:"marblesp" version:"1.0" >  payload:"\030\005zo\022\024\010\200\322\363\223\342\263\213\231\025\020\300\256\256\303\223\264\213\231\025\032 \345\364,3\177\267b\222_\271\032\306\352\027^LW\002:\226\366\003\270\343'\372X \204wcH\" $=i\306\226\200\020\r$\260\215F\000nb\334z\236\205\206\364\277\340u\363*$M0\231\021:*\023\010\003\032\017\n\010marblesp\022\0031.0" signature:"0E\002!\000\304\004\323\274\234\2766\224?.\246\1775\030\233q\321\330\317\202\343\024\344\023-4wL\322\267\200r\002 Mi\013\273/\316P\275\355U\357G!\361\027\332\203\251\256\343}\235;\333\200 8\034\275Ku)" }  2018-05-26 11:16:42.353 UTC  gossip/privdata  assignDigestsToPeers -> DEBU a8f Matching  {peer0.org1.example.com:7051     229 244 44 51 127 183 98 146 95 185 26 198 234 23 94 76 87 2 58 150 246 3 184 227 39 250 88 93 132 119 99 72   ledger_height:3 chaincodes:<name:"marblesp" version:"1.0" >  payload:"\030\005zo\022\024\010\200\322\363\223\342\263\213\231\025\020\300\256\256\303\223\264\213\231\025\032 \345\364,3\177\267b\222_\271\032\306\352\027^LW\002:\226\366\003\270\343'\372X \204wcH\" $=i\306\226\200\020\r$\260\215F\000nb\334z\236\205\206\364\277\340u\363*$M0\231\021:*\023\010\003\032\017\n\010marblesp\022\0031.0" signature:"0E\002!\000\304\004\323\274\234\2766\224?.\246\1775\030\233q\321\330\317\202\343\024\344\023-4wL\322\267\200r\002 Mi\013\273/\316P\275\355U\357G!\361\027\332\203\251\256\343}\235;\333\200 8\034\275Ku)" }  to {collectionMarbles:  4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260 } 2018-05-26 11:16:42.353 UTC  gossip/privdata  fetch -> DEBU a90 Matched 1 digests to 1 peer(s) 2018-05-26 11:16:42.353 UTC  gossip/privdata  scatterRequests -> DEBU a91 Sending peer0.org1.example.com:7051 request  tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3   2018-05-26 11:16:42.353 UTC  gossip/comm  Send -> DEBU a92 Entering, sending GossipMessage: nonce:6783268945934398498 channel:"mychannel" tag:CHAN_ONLY privateReq:<digests:<tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3 > > , Envelope: 125 bytes, Signature: 0 bytes to  1 peers 2018-05-26 11:16:42.354 UTC  gossip/comm  sendToEndpoint -> DEBU a93 Entering, Sending to peer0.org1.example.com:7051 , msg: GossipMessage: nonce:6783268945934398498 channel:"mychannel" tag:CHAN_ONLY privateReq:<digests:<tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3 > > , Envelope: 125 bytes, Signature: 0 bytes 2018-05-26 11:16:42.357 UTC  gossip/comm  func1 -> DEBU a95 Got message: GossipMessage: Channel: mychannel, nonce: 6783268945934398498, tag: CHAN_ONLY  tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3  with 1 elements , Envelope: 252 bytes, Signature: 0 bytes 2018-05-26 11:16:42.357 UTC  gossip/privdata  handleResponse -> DEBU a96 Got elements:<digest:<tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3 > payload:"\032\036\n\031\000color~name\000blue\000marble1\000\032\001\000\032W\n\007marble1\032L{\"docType\":\"marble\",\"name\":\"marble1\",\"color\":\"blue\",\"size\":35,\"owner\":\"tom\"}" >  from 172.18.0.2:7051 2018-05-26 11:16:42.358 UTC  gossip/privdata  fetch -> DEBU a97 Got empty response for tx_id:"4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260" namespace:"marblesp" collection:"collectionMarbles" block_seq:3  2018-05-26 11:16:42.358 UTC  transientstore  Persist -> DEBU a98 Persisting private data to transient store for txid = 4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260 2018-05-26 11:16:42.361 UTC  gossip/privdata  fetchFromPeers -> DEBU a99 Fetched {4293a3832d6d4ea8eede55951bfb85d7328eda89d5657642af81540a1a989260 0 marblesp collectionMarbles 6c6c363ba4824671dbb0f7ed703367a7c6d04733bb0e7b5c5ad4aa60bbbcac70} 2018-05-26 11:16:43.362 UTC  gossip/privdata  StoreBlock -> DEBU ad6 Fetched all missing collection private write sets from remote peers 2018-05-26 11:16:43.362 UTC  gossip/privdata  StoreBlock -> DEBU ad7 Added 1 namespace private write sets for block  3 , tran  0 {code}  ></description> </Issue>
