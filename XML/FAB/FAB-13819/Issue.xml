<Issue id="37041" key="FAB-13819" number="13819" project="10002" reporter="sykesm" assignee="sykesm" creator="sykesm" type="10004" summary="Investigate high memory utilization during chaincode tests" priority="4" resolution="10000" status="6" created="2019-01-22 14:39:50.0" updated="2019-01-25 16:31:01.0" resolutiondate="2019-01-25 16:31:01.0" votes="0" watches="1" workflowId="48610"> <description><! CDATA When running unit-tests inside the vagrant VM, we consistently run out of memory during the chaincode tests. Investigate where the memory consumption is coming from and any possible resolution.  {code} 2019-01-21 21:03:17.949 UTC  common.tools.configtxgen.localconfig  completeInitialization -> INFO 001 orderer type: solo 2019-01-21 21:03:17.949 UTC  common.tools.configtxgen.localconfig  Load -> INFO 002 Loaded configuration: /home/vagrant/go/src/github.com/hyperledger/fabric/sampleconfig/configtx.yaml 2019-01-21 21:03:17.956 UTC  chaincodeCmd  validatePeerConnectionParameters -> WARN 003 received more TLS root cert files (2) than peer addresses (1) 2019-01-21 21:03:17.971 UTC  chaincodeCmd  validatePeerConnectionParameters -> WARN 004 received more TLS root cert files (1) than peer addresses (0) 2019-01-21 21:03:17.985 UTC  chaincodeCmd  ClientWait -> INFO 005 txid  txid0  committed with status (VALID) at peer0 2019-01-21 21:03:17.988 UTC  chaincodeCmd  ClientWait -> INFO 006 txid  txid0  committed with status (VALID) at peer1 2019-01-21 21:03:17.988 UTC  chaincodeCmd  ClientWait -> INFO 007 txid  txid0  committed with status (VALID) at peer0 2019-01-21 21:03:17.990 UTC  chaincodeCmd  ClientWait -> INFO 008 txid  txid0  committed with status (VALID) at peer0 2019-01-21 21:03:17.990 UTC  chaincodeCmd  ClientWait -> INFO 009 txid  txid0  committed with status (VALID) at peer1 Error: must supply value for chaincode name, path and version parameters 2019-01-21 21:03:18.023 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 00a Using default escc 2019-01-21 21:03:18.023 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 00b Using default vscc Error: error getting chaincode deployment spec for badexample02: path to chaincode does not exist: /home/vagrant/go/src/github.com/hyperledger/fabric/examples/chaincode/go/bad_example02 2019-01-21 21:03:18.144 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 00c Using escc escc 2019-01-21 21:03:18.144 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 00d Using vscc vscc 2019-01-21 21:03:18.151 UTC  chaincodeCmd  submitInstallProposal -> INFO 00e Installed remotely: response:<status:200 > endorsement:<>  Error: could not unmarshal chaincode package to CDS or SignedCDS 2019-01-21 21:03:18.164 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 00f Using escc escc 2019-01-21 21:03:18.164 UTC  chaincodeCmd  checkChaincodeCmdParams -> INFO 010 Using vscc vscc fatal error: runtime: out of memory  runtime stack: runtime.throw(0x1a3d20f, 0x16) 	/opt/go/src/runtime/panic.go:608 +0x72 runtime.sysMap(0xc05c000000, 0x10000000, 0x31445f8) 	/opt/go/src/runtime/mem_linux.go:156 +0xc7 runtime.(*mheap).sysAlloc(0x27a5a60, 0x10000000, 0x97493c, 0x7fc5e05bfd28) 	/opt/go/src/runtime/malloc.go:619 +0x1c1 runtime.(*mheap).grow(0x27a5a60, 0x62b5, 0x0) 	/opt/go/src/runtime/mheap.go:920 +0x42 runtime.(*mheap).allocSpanLocked(0x27a5a60, 0x62b5, 0x3144608, 0x98585b) 	/opt/go/src/runtime/mheap.go:848 +0x337 runtime.(*mheap).alloc_m(0x27a5a60, 0x62b5, 0x970100, 0xc00005c840) 	/opt/go/src/runtime/mheap.go:692 +0x119 runtime.(*mheap).alloc.func1() 	/opt/go/src/runtime/mheap.go:759 +0x4c runtime.(*mheap).alloc(0x27a5a60, 0x62b5, 0x10100, 0xc000046000) 	/opt/go/src/runtime/mheap.go:758 +0x8a runtime.largeAlloc(0xc56a000, 0x100000001, 0xc000000f00) 	/opt/go/src/runtime/malloc.go:1019 +0x97 runtime.mallocgc.func1() 	/opt/go/src/runtime/malloc.go:914 +0x46 runtime.systemstack(0x7fffae661520) 	/opt/go/src/runtime/asm_amd64.s:351 +0x66 runtime.mstart() 	/opt/go/src/runtime/proc.go:1229  goroutine 64  running : runtime.systemstack_switch() 	/opt/go/src/runtime/asm_amd64.s:311 fp=0xc000069c10 sp=0xc000069c08 pc=0x9adb40 runtime.mallocgc(0xc56a000, 0x180bea0, 0x16c0801, 0x9965e0) 	/opt/go/src/runtime/malloc.go:913 +0x8b1 fp=0xc000069cb0 sp=0xc000069c10 pc=0x95c8c1 runtime.growslice(0x180bea0, 0xc03dc46000, 0x694955, 0x694955, 0x694956, 0x31407d8, 0x0, 0x996662) 	/opt/go/src/runtime/slice.go:204 +0x1aa fp=0xc000069d28 sp=0xc000069cb0 pc=0x99678a github.com/hyperledger/fabric/peer/chaincode/mock.(*Deliver).recordInvocation(0xc000234000, 0x1a28bf3, 0x4, 0x31407d8, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/mock/deliver.go:204 +0x33f fp=0xc000069de0 sp=0xc000069d28 pc=0x16c08ff github.com/hyperledger/fabric/peer/chaincode/mock.(*Deliver).Recv(0xc000234000, 0xc000000001, 0xe40337, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/mock/deliver.go:100 +0x203 fp=0xc000069e88 sp=0xc000069de0 pc=0x16bf5e3 github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).ClientWait(0xc0002ff8c0, 0xc00023c660) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:656 +0x339 fp=0xc000069fd0 sp=0xc000069e88 pc=0x16e65d9 runtime.goexit() 	/opt/go/src/runtime/asm_amd64.s:1333 +0x1 fp=0xc000069fd8 sp=0xc000069fd0 pc=0x9afc21 created by github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).Wait 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:632 +0x16b  goroutine 1  chan receive, 1 minutes : testing.(*T).Run(0xc0000c2900, 0x1a36fd7, 0x11, 0x1a7e7d8, 0xc0004fdb01) 	/opt/go/src/testing/testing.go:879 +0x692 testing.runTests.func1(0xc0000c2900) 	/opt/go/src/testing/testing.go:1119 +0xa9 testing.tRunner(0xc0000c2900, 0xc0004fdca8) 	/opt/go/src/testing/testing.go:827 +0x163 testing.runTests(0xc000553d20, 0x26ad840, 0x30, 0x30, 0xc0003e9e00) 	/opt/go/src/testing/testing.go:1117 +0x4ef testing.(*M).Run(0xc000166380, 0x0) 	/opt/go/src/testing/testing.go:1034 +0x2ef github.com/hyperledger/fabric/peer/chaincode.TestMain(0xc000166380) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/package_test.go:42 +0x50 main.main() 	_testmain.go:200 +0x32f  goroutine 7  syscall, 1 minutes : os/signal.signal_recv(0x9afc21) 	/opt/go/src/runtime/sigqueue.go:139 +0x9c os/signal.loop() 	/opt/go/src/os/signal/signal_unix.go:23 +0x30 created by os/signal.init.0 	/opt/go/src/os/signal/signal_unix.go:29 +0x4f  goroutine 72  runnable : compress/flate.(*compressor).findMatch(0xc006b4e000, 0xfe24, 0xbabc, 0x3, 0x1dc, 0xb, 0x307, 0x201) 	/opt/go/src/compress/flate/deflate.go:233 +0x606 compress/flate.(*compressor).deflate(0xc006b4e000) 	/opt/go/src/compress/flate/deflate.go:443 +0x1792 compress/flate.(*compressor).write(0xc006b4e000, 0xc011219800, 0x1000, 0x800, 0xc011219000, 0x1000, 0x1000) 	/opt/go/src/compress/flate/deflate.go:551 +0xb7 compress/flate.(*Writer).Write(0xc006b4e000, 0xc011219000, 0x1000, 0x1000, 0x1000, 0xc05f061d42, 0xa05c88) 	/opt/go/src/compress/flate/deflate.go:709 +0x5d compress/gzip.(*Writer).Write(0xc00001a4d0, 0xc011219000, 0x1000, 0x1000, 0xc00fd33de8, 0xc011219000, 0x1000) 	/opt/go/src/compress/gzip/gzip.go:196 +0x1fd archive/tar.(*regFileWriter).Write(0xc000524d20, 0xc011219000, 0x1000, 0x1000, 0x1000, 0x0, 0x0) 	/opt/go/src/archive/tar/writer.go:497 +0x199 archive/tar.(*Writer).Write(0xc00008c700, 0xc011219000, 0x1000, 0x1000, 0x64, 0x0, 0x0) 	/opt/go/src/archive/tar/writer.go:435 +0xa9 bufio.(*Reader).writeBuf(0xc0005066c0, 0x1bb1ac0, 0xc00008c700, 0x1000, 0x0, 0x0) 	/opt/go/src/bufio/bufio.go:510 +0xfc bufio.(*Reader).WriteTo(0xc0005066c0, 0x1bb1ac0, 0xc00008c700, 0x7fc5dc57ba38, 0xc0005066c0, 0xc0074a9c01) 	/opt/go/src/bufio/bufio.go:491 +0x236 io.copyBuffer(0x1bb1ac0, 0xc00008c700, 0x1bb1b60, 0xc0005066c0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0) 	/opt/go/src/io/io.go:384 +0x46b io.Copy(0x1bb1ac0, 0xc00008c700, 0x1bb1b60, 0xc0005066c0, 0xc00f8ad260, 0x0, 0x0) 	/opt/go/src/io/io.go:364 +0x75 github.com/hyperledger/fabric/core/container/util.WriteStreamToPackage(0x1bb1b60, 0xc0005066c0, 0xc0074a9c70, 0x67, 0xc0074a9c81, 0x56, 0xc00008c700, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/core/container/util/writer.go:204 +0x6ce github.com/hyperledger/fabric/core/container/util.WriteFileToPackage(0xc0074a9c70, 0x67, 0xc0074a9c81, 0x56, 0xc00008c700, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/core/container/util/writer.go:175 +0x3ec github.com/hyperledger/fabric/core/chaincode/platforms/golang.(*Platform).GetDeploymentPayload(0x31407d8, 0x1a68f75, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/core/chaincode/platforms/golang/platform.go:462 +0x1644 github.com/hyperledger/fabric/core/chaincode/platforms.(*Registry).GetDeploymentPayload(0xc0003963e0, 0x1a2aa90, 0x6, 0x1a68f75, 0x41, 0x1a2aa90, 0x6, 0x1a68f75, 0x41, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/core/chaincode/platforms/platforms.go:103 +0xed github.com/hyperledger/fabric/core/container.GetChaincodePackageBytes(0xc0003963e0, 0xc000210680, 0x1, 0xc000039220, 0x18, 0xe, 0xc000210680) 	/home/vagrant/go/src/github.com/hyperledger/fabric/core/container/controller.go:191 +0x17d github.com/hyperledger/fabric/peer/chaincode.getChaincodeDeploymentSpec(0xc000210680, 0xc000000001, 0x2, 0x0, 0x1a32200) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:57 +0x251 github.com/hyperledger/fabric/peer/chaincode.genChaincodeDeploymentSpec(0xc00018b680, 0x1a2efea, 0x9, 0x1a33c1f, 0xe, 0x98, 0x18aab60, 0x6) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install.go:330 +0x10f github.com/hyperledger/fabric/peer/chaincode.(*Installer).getLegacyChaincodePackageMessage(0xc0000b74a0, 0x1, 0x5, 0x0, 0xc0000b74a0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install.go:273 +0x364 github.com/hyperledger/fabric/peer/chaincode.(*Installer).installLegacy(0xc0000b74a0, 0xc000000001, 0x5) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install.go:167 +0x69 github.com/hyperledger/fabric/peer/chaincode.(*Installer).installChaincode(0xc0000b74a0, 0xc000416de0, 0x0, 0x6, 0x103a4bf, 0x9b1572) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install.go:118 +0x166 github.com/hyperledger/fabric/peer/chaincode.installCmd.func1(0xc00018b680, 0xc000416de0, 0x0, 0x6, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install.go:84 +0x107 github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).execute(0xc00018b680, 0xc000416d80, 0x6, 0x6, 0xc00018b680, 0xc000416d80) 	/home/vagrant/go/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:762 +0x4f6 github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0xc00018b680, 0x95cba8, 0x60, 0x186ae40) 	/home/vagrant/go/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:852 +0x433 github.com/hyperledger/fabric/vendor/github.com/spf13/cobra.(*Command).Execute(0xc00018b680, 0x60, 0xc0000391a0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/vendor/github.com/spf13/cobra/command.go:800 +0x39 github.com/hyperledger/fabric/peer/chaincode.installLegacyEx02(0xc000187100, 0x0, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install_test.go:161 +0x238 github.com/hyperledger/fabric/peer/chaincode.TestInstallLegacy(0xc000187100) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/install_test.go:169 +0x3d testing.tRunner(0xc000187100, 0x1a7e7d8) 	/opt/go/src/testing/testing.go:827 +0x163 created by testing.(*T).Run 	/opt/go/src/testing/testing.go:878 +0x65a  goroutine 63  runnable : github.com/hyperledger/fabric/peer/chaincode/mock.(*Deliver).Recv(0xc00059ed80, 0xc000000001, 0xe54f3e, 0x0) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/mock/deliver.go:96 +0x3f6 github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).ClientWait(0xc0002ff8c0, 0xc00023c630) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:656 +0x339 created by github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).Wait 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:632 +0x16b  goroutine 65  semacquire, 1 minutes : sync.runtime_Semacquire(0xc0002ff978) 	/opt/go/src/runtime/sema.go:56 +0x39 sync.(*WaitGroup).Wait(0xc0002ff970) 	/opt/go/src/sync/waitgroup.go:130 +0xb5 github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).WaitForWG(0xc0002ff8c0, 0xc00008b860) 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:686 +0x59 created by github.com/hyperledger/fabric/peer/chaincode.(*deliverGroup).Wait 	/home/vagrant/go/src/github.com/hyperledger/fabric/peer/chaincode/common.go:635 +0x1f7 FAIL	github.com/hyperledger/fabric/peer/chaincode	70.927s {code}  ></description> </Issue>
