<Action id="67845" issue="44278" author="yacovm" type="comment" created="2020-02-06 21:27:08.0" updateauthor="yacovm" updated="2020-02-06 21:27:08.0"> <body><! CDATA  ~ptippett  can you attach the logs and not just a snippet?  Are you sure you migrated *all* the channels to etcdraft ?   ></body> </Action>
<Action id="67846" issue="44278" author="ptippett" type="comment" created="2020-02-06 21:35:38.0" updateauthor="ptippett" updated="2020-02-06 21:35:38.0"> <body><! CDATA  ~yacovm  Yep.  The original orderers (3 of them) were running fine and every channel was set to RAFT consensus.  Also after RAFT migration we turn off kafka/zookeeper, so they would have been failing/throwing errors if not all channels were raft.        ></body> </Action>
<Action id="67848" issue="44278" author="yacovm" type="comment" created="2020-02-06 22:21:17.0" updateauthor="yacovm" updated="2020-02-06 22:21:17.0"> <body><! CDATA i reproduced this locally in an integration test... I think this happens because when orderers onboard a cluster, they always commit the genesis block, even if they do not participate in that channel. This is done to be able to track this channel in the future, when they will be added to it. However, the genesis block is a Kafka one...   ></body> </Action>
<Action id="67850" issue="44278" author="ptippett" type="comment" created="2020-02-06 22:40:06.0" updateauthor="ptippett" updated="2020-02-06 22:40:06.0"> <body><! CDATA  ~yacovm  Nice.  Thanks for investigating.  I don't have any earlier logs.  Likely you don't need them since you reproduced.  The other thing I forgot to mention is that this channel in particular did not have any peers or blocks other than the genesis block. The lack of peers is actually why it didn't get added to the list of channels that we added the new orderer node to because the code that pulls the channel list was relying on the peers to find the channels.  I don't think this matters in this issue, but figured I'd mention it.  ></body> </Action>
<Action id="67853" issue="44278" author="yacovm" type="comment" created="2020-02-06 23:24:21.0" updateauthor="yacovm" updated="2020-02-07 00:01:52.0"> <body><! CDATA I am not sure I was clear: There is a bigger problem here. If you take a migrated kafka cluster and try to add more orderers to it later on, it won't work... the nodes will say: "hey I'm not part of this channel" when they onboard, so they will never replicate the block that migrated the channels,  and later on they will try to start a Kafka chain and will never try to check if they are added later on, even if they won't crash.  Playing my own advocate - Raft onboarding was implemented before migration so we could never test this scenario back in the day, however, it is a real shame that no one tested this until now... I'm actually done in writing a fix that solves both your crash and the replication problem later on.   Will post a PR shortly after I'll finish up the integration test.  ></body> </Action>
<Action id="67854" issue="44278" author="yacovm" type="comment" body="https://github.com/hyperledger/fabric/pull/642 - for release-1.4 (v1.4.5)" created="2020-02-06 23:44:48.0" updateauthor="denyeart" updated="2020-02-10 19:59:11.0"/>
<Action id="67855" issue="44278" author="ptippett" type="comment" created="2020-02-07 02:50:53.0" updateauthor="ptippett" updated="2020-02-07 02:50:53.0"> <body><! CDATA  ~yacovm  Thanks for the fix. If it helps, I can confirm that using the current code, I can migrate channels from kafka to Raft based consensus and, assuming I add individual ordering nodes to the consenter set for every channel, things work fine.  If I replay what you wrote above, I think what you are saying is if you only fixed the orderer crash in this bug, I still could never add that orderer node to the "missing" raft channel once it first comes up as kafka.  So once we get in this state, we're stuck.  Yep, that's bad.  ></body> </Action>
<Action id="67860" issue="44278" author="denyeart" type="comment" created="2020-02-07 14:28:38.0" updateauthor="denyeart" updated="2020-02-07 14:28:38.0"> <body><! CDATA Thanks  ~yacovm .  I assume a cherry pick to release-2.0 for v2.0.1 and master would make sense. Updated FixVersion accordingly.  ></body> </Action>
<Action id="67865" issue="44278" author="yacovm" type="comment" created="2020-02-07 17:53:14.0" updateauthor="yacovm" updated="2020-02-07 18:04:55.0"> <body><! CDATA  https://github.com/hyperledger/fabric/pull/644  - for master.   https://github.com/hyperledger/fabric/pull/645  - for v2.0   ~denyeart  ,  ~ptippett  keep in mind that we probably have a similar problem when migrating from Solo to Raft.  I'll leave it as an optional home exercise for now ;) , if anyone wants to have a go at it, he/she is welcome.  ></body> </Action>
<Action id="67892" issue="44278" author="denyeart" type="comment" body=" ~jyellick  or  ~guoger  - Could you review the release-1.4 PR first so that we can get it into v1.4.5?   https://github.com/hyperledger/fabric/pull/642 " created="2020-02-10 19:59:58.0" updateauthor="denyeart" updated="2020-02-10 19:59:58.0"/>
