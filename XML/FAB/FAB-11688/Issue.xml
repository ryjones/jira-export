<Issue id="33132" key="FAB-11688" number="11688" project="10002" reporter="sykesm" assignee="sykesm" creator="sykesm" type="10004" summary="Data race related to multichannel/registrar" priority="4" resolution="10000" status="6" created="2018-08-22 15:16:35.0" updated="2018-08-26 12:11:02.0" resolutiondate="2018-08-26 12:11:02.0" votes="0" watches="1" workflowId="44342"> <description><! CDATA {code} ================== WARNING: DATA RACE Write at 0x00c4201d2e70 by goroutine 29: github.com/hyperledger/fabric/orderer/common/multichannel.(*Registrar).newChain() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar.go:286 +0x453 github.com/hyperledger/fabric/orderer/common/multichannel.(*BlockWriter).WriteConfigBlock() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/multichannel/blockwriter.go:118 +0x47a github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).WriteConfigBlock() <autogenerated>:1 +0x83 github.com/hyperledger/fabric/orderer/consensus/solo.(*chain).main() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/solo/consensus.go:160 +0x57b  Previous read at 0x00c4201d2e70 by goroutine 37: github.com/hyperledger/fabric/orderer/common/server.deliverSupport.GetChain() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar.go:224 +0x54 github.com/hyperledger/fabric/common/deliver.(*Handler).deliverBlocks() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/deliver/deliver.go:186 +0x74a github.com/hyperledger/fabric/common/deliver.(*Handler).Handle() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/deliver/deliver.go:153 +0x3b8 github.com/hyperledger/fabric/orderer/common/server.(*server).Deliver() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/server.go:182 +0x3af github.com/hyperledger/fabric/orderer/common/performance.(*BenchmarkServer).CreateDeliverClient.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/performance/server.go:174 +0x68  Goroutine 29 (running) created at: github.com/hyperledger/fabric/orderer/consensus/solo.(*chain).Start() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/consensus/solo/consensus.go:67 +0x4c github.com/hyperledger/fabric/orderer/common/multichannel.(*ChainSupport).start() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/multichannel/chainsupport.go:87 +0x53 github.com/hyperledger/fabric/orderer/common/multichannel.NewRegistrar() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/multichannel/registrar.go:188 +0x13de github.com/hyperledger/fabric/orderer/common/server.initializeMultichannelRegistrar() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/main.go:258 +0x2fb github.com/hyperledger/fabric/common/viperutil.unmarshalJSON() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/viperutil/config_util.go:79 +0x10c github.com/hyperledger/fabric/common/viperutil.getKeysRecursively() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/viperutil/config_util.go:52 +0x383 github.com/hyperledger/fabric/common/viperutil.getKeysRecursively() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/viperutil/config_util.go:51 +0x2cd github.com/hyperledger/fabric/common/viperutil.getKeysRecursively() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/viperutil/config_util.go:48 +0xb93 github.com/hyperledger/fabric/common/viperutil.EnhancedExactUnmarshal() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/viperutil/config_util.go:294 +0xe4 github.com/hyperledger/fabric/common/tools/configtxgen/localconfig.Load() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/tools/configtxgen/localconfig/config.go:278 +0x83c github.com/hyperledger/fabric/orderer/common/server.initializeBootstrapChannel() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/main.go:199 +0x663 github.com/hyperledger/fabric/orderer/common/server.initializeMultichannelRegistrar() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/main.go:249 +0xe0 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:585 +0x239 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).checkAndCleanFiles() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db_util.go:52 +0x2e6 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.openDB() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:129 +0xa4c fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:585 +0x239 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.(*DB).recoverJournal() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:475 +0xd9 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.openDB() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:124 +0xa28 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.Open() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:196 +0x186 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 fmt.(*ss).doScanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:1193 +0x345 fmt.Fscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:143 +0xf5 fmt.Sscanf() /usr/local/Cellar/go/1.10.3/libexec/src/fmt/scan.go:114 +0xbb github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.fsParseName() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:571 +0x16c github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage.(*fileStorage).List() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/storage/file_storage.go:386 +0x2b0 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.(*session).recover.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/session.go:113 +0xc3 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.(*session).recover() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/session.go:121 +0x1860 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.Open() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:182 +0xc8 github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb.OpenFile() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/vendor/github.com/syndtr/goleveldb/leveldb/db.go:218 +0x9f github.com/hyperledger/fabric/common/ledger/util/leveldbhelper.(*DB).Open() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/ledger/util/leveldbhelper/leveldb_helper.go:78 +0x1e1 github.com/hyperledger/fabric/common/ledger/util/leveldbhelper.NewProvider() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/ledger/util/leveldbhelper/leveldb_provider.go:40 +0x211 github.com/hyperledger/fabric/common/ledger/blkstorage/fsblkstorage.NewProvider() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/ledger/blkstorage/fsblkstorage/fs_blockstore_provider.go:34 +0xa0 github.com/hyperledger/fabric/common/ledger/blockledger/file.New() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/common/ledger/blockledger/file/factory.go:71 +0x143 github.com/hyperledger/fabric/orderer/common/server.createLedgerFactory() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/util.go:32 +0x5cf github.com/hyperledger/fabric/orderer/common/server.initializeMultichannelRegistrar() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/main.go:246 +0x6b github.com/hyperledger/fabric/orderer/common/server.Start() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/server/main.go:96 +0x3de  Goroutine 37 (finished) created at: github.com/hyperledger/fabric/orderer/common/performance.(*BenchmarkServer).CreateDeliverClient() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/performance/server.go:173 +0x195 github.com/hyperledger/fabric/orderer/common/performance.WaitForChannels.func1() /Users/sykesm/workspace/fabric/src/github.com/hyperledger/fabric/orderer/common/performance/utils.go:119 +0x116 ================== {code}  ></description> </Issue>
