<Issue id="45047" key="FAB-17876" number="17876" project="10002" reporter="ritel126" creator="ritel126" type="10004" summary="An authentication handshake failed need help!" priority="2" resolution="10203" status="6" created="2020-05-12 07:00:03.0" updated="2020-12-26 10:21:10.0" resolutiondate="2020-12-26 10:21:10.0" votes="0" watches="2" workflowId="58955" archived="N"> <description><! CDATA I want to create a msp by fabric-ca. But when I set tls enabled, the Orderers handshake with each others failed. Here is the script of creating orderers!     {color:#0747a6}fabric-ca-client enroll -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6} {color}{color:#0747a6}fabric-ca-client affiliation list -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client affiliation remove --force org1 -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client affiliation remove --force org2 -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client affiliation add com -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client affiliation add com.h3c -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6} {color}{color:#0747a6}fabric-ca-client register --id.name  Admin@h3c.com|mailto:Admin@h3c.com  --id.type client --id.affiliation "com.h3c" --id.attrs '"hf.Registrar.Roles=client,orderer,peer,user","hf.Registrar.DelegateRoles=client,orderer,peer,user",hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert' --id.secret=123456 --csr.cn=h3c.com --csr.hosts= 'h3c.com'  -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client enroll -d --enrollment.profile tls -u http:// Admin@h3c.com|mailto:Admin@h3c.com : 123456@0.0.0.0|mailto:123456@0.0.0.0 :7056 --csr.cn=h3c.com --csr.hosts= 'h3c.com'  -M ./crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tlstmp --home ./fabric-ca-client{color}  {color:#0747a6} {color}  {color:#0747a6}mkdir  ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tls/{color}  {color:#0747a6}cp ./server_2/ca-chain.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tls/ca.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tlstmp/signcerts/cert.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tls/client.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tlstmp/keystore/*_sk ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tls/client.key{color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tlstmp/tlscacerts ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/msp{color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/users/ Admin@h3c.com|mailto:Admin@h3c.com /tlstmp/tlsintermediatecerts ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/msp{color}  {color:#0747a6}fabric-ca-client register --id.name or1-gm-orderer --id.type orderer --id.affiliation "com.h3c" --id.attrs '"role=orderer",ecert=true' --id.secret=123456 --csr.cn=or1-gm-orderer --csr.hosts= 'or1-gm-orderer'  -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client enroll -d --enrollment.profile tls -u http://or1-gm-orderer: 123456@0.0.0.0|mailto:123456@0.0.0.0 :7056 --csr.cn=or1-gm-orderer --csr.hosts= 'or1-gm-orderer'  -M ./crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tlstmp --home ./fabric-ca-client{color}  {color:#0747a6}mkdir        ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tls/{color}  {color:#0747a6}cp ./server_2/ca-chain.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tls/ca.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tlstmp/signcerts/cert.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tls/server.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tlstmp/keystore/*_sk ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tls/server.key{color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tlstmp/tlscacerts ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/msp{color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/tlstmp/tlsintermediatecerts  ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or1.h3c.com/msp{color}  {color:#0747a6}fabric-ca-client register --id.name or2-gm-orderer --id.type orderer --id.affiliation "com.h3c" --id.attrs '"role=orderer",ecert=true' --id.secret=123456 --csr.cn=or2-gm-orderer --csr.hosts= 'or2-gm-orderer'  -M ./crypto-config/ordererOrganizations/h3c.com/tlstmp -u http://admin: adminpw@0.0.0.0|mailto:adminpw@0.0.0.0 :7056 --home ./fabric-ca-client{color}  {color:#0747a6}fabric-ca-client enroll -d --enrollment.profile tls -u http://or2-gm-orderer: 123456@0.0.0.0|mailto:123456@0.0.0.0 :7056 --csr.cn=or2-gm-orderer --csr.hosts= 'or2-gm-orderer'  -M ./crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tlstmp --home ./fabric-ca-client{color}  {color:#0747a6}mkdir ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tls/{color}  {color:#0747a6}cp ./server_2/ca-chain.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tls/ca.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tlstmp/signcerts/cert.pem ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tls/server.crt{color}  {color:#0747a6}cp ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tlstmp/keystore/*_sk ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tls/server.key{color}  {color:#0747a6} {color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tlstmp/tlscacerts ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/msp{color}  {color:#0747a6}cp -r ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/tlstmp/tlsintermediatecerts  ./fabric-ca-client/crypto-config/ordererOrganizations/h3c.com/orderers/or2.h3c.com/msp{color}  {color:#0747a6} {color}  {color:#0747a6} {color}The error info look like this :     2020-05-12 11:19:02.169 CST  grpc  switchBalancer -> DEBU 360 ClientConn switching balancer to "pick_first"  2020-05-12 11:19:02.169 CST  grpc  HandleSubConnStateChange -> DEBU 361 pickfirstBalancer: HandleSubConnStateChange: 0xc000223010, CONNECTING  {color:#FF0000}2020-05-12 11:19:02.173 CST  grpc  createTransport -> DEBU 362 grpc: addrConn.createTransport failed to connect to \{or1-gm-orderer:30000 0  <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...{color}  2020-05-12 11:19:02.173 CST  grpc  HandleSubConnStateChange -> DEBU 363 pickfirstBalancer: HandleSubConnStateChange: 0xc00050f320, TRANSIENT_FAILURE  2020-05-12 11:19:02.173 CST  core.comm  ServerHandshake -> ERRO 364 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress=172.20.1.1:49108  2020-05-12 11:19:02.173 CST  grpc  handleRawConn -> DEBU 365 grpc: Server.Serve failed to complete security handshake from "172.20.1.1:49108": remote error: tls: bad certificate  2020-05-12 11:19:02.174 CST  grpc  createTransport -> DEBU 366 grpc: addrConn.createTransport failed to connect to \{or2-gm-orderer:30001 0  <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...  2020-05-12 11:19:02.175 CST  grpc  HandleSubConnStateChange -> DEBU 367 pickfirstBalancer: HandleSubConnStateChange: 0xc000223010, TRANSIENT_FAILURE  2020-05-12 11:19:02.934 CST  core.comm  ServerHandshake -> ERRO 368 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress=172.20.0.0:38260  2020-05-12 11:19:02.939 CST  grpc  handleRawConn -> DEBU 369 grpc: Server.Serve failed to complete security handshake from "172.20.0.0:38260": remote error: tls: bad certificate  2020-05-12 11:19:03.169 CST  grpc  HandleSubConnStateChange -> DEBU 36a pickfirstBalancer: HandleSubConnStateChange: 0xc00050f320, CONNECTING  2020-05-12 11:19:03.170 CST  grpc  HandleSubConnStateChange -> DEBU 36b pickfirstBalancer: HandleSubConnStateChange: 0xc000223010, CONNECTING  2020-05-12 11:19:03.172 CST  grpc  createTransport -> DEBU 36c grpc: addrConn.createTransport failed to connect to \{or1-gm-orderer:30000 0  <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...  2020-05-12 11:19:03.172 CST  core.comm  ServerHandshake -> ERRO 36d TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress=172.20.1.1:49118  2020-05-12 11:19:03.172 CST  grpc  HandleSubConnStateChange -> DEBU 36e pickfirstBalancer: HandleSubConnStateChange: 0xc00050f320, TRANSIENT_FAILURE  2020-05-12 11:19:03.172 CST  grpc  handleRawConn -> DEBU 36f grpc: Server.Serve failed to complete security handshake from "172.20.1.1:49118": remote error: tls: bad certificate  2020-05-12 11:19:03.174 CST  grpc  createTransport -> DEBU 370 grpc: addrConn.createTransport failed to connect to \{or2-gm-orderer:30001 0  <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...  2020-05-12 11:19:03.174 CST  grpc  HandleSubConnStateChange -> DEBU 371 pickfirstBalancer: HandleSubConnStateChange: 0xc000223010, TRANSIENT_FAILURE  2020-05-12 11:19:04.489 CST  grpc  HandleSubConnStateChange -> DEBU 372 pickfirstBalancer: HandleSubConnStateChange: 0xc00050f320, CONNECTING  2020-05-12 11:19:04.492 CST  core.comm  ServerHandshake -> ERRO 373 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress=172.20.1.1:49130  2020-05-12 11:19:04.492 CST  grpc  createTransport -> DEBU 374 grpc: addrConn.createTransport failed to connect to \{or1-gm-orderer:30000 0  <nil>}. Err :connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority". Reconnecting...  2020-05-12 11:19:04.492 CST  grpc  handleRawConn -> DEBU 375 grpc: Server.Serve failed to complete security handshake from "172.20.1.1:49130": remote error: tls: bad certificate  2020-05-12 11:19:04.492 CST  grpc  HandleSubConnStateChange -> DEBU 376 pickfirstBalancer: HandleSubConnStateChange: 0xc00050f320, TRANSIENT_FAILURE  2020-05-12 11:19:04.732 CST  grpc  HandleSubConnStateChange -> DEBU 377 pickfirstBalancer: HandleSubConnStateChange: 0x     I have changed the orderer's port from 7050 to 30000, and when I use the cryptogen tools to create msp , it can work normally , But when I changed to the fabric-ca , It always get errors. Can anyone tell me how to fix it?     ></description> </Issue>
