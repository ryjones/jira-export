<Issue id="31045" key="FAB-10630" number="10630" project="10002" reporter="scottz" assignee="scottz" creator="scottz" type="10004" summary="OTE tests, rare failure - orderers not ready yet" priority="3" resolution="10000" status="6" created="2018-06-13 19:41:18.0" updated="2019-03-19 11:13:45.0" resolutiondate="2018-07-01 15:43:30.0" votes="0" watches="1" workflowId="42445"> <description><! CDATA Relevant logs seen: {quote}Creating Channels 1  2018-06-08 12:48:17.338 UTC  channelCmd  InitCmdFactory -> INFO 001#x1B 0m Endorser and orderer connections initialized *Error: got unexpected status: SERVICE_UNAVAILABLE -- will not enqueue, consenter for this channel hasn't started yet*  ========== OTE testname=FAB-7074 TX=15000 Channels=1 Orderers=3 ordererType=kafka kafka-brokers=5 oteSpy=OFF producersPerCh=1 payloadSizeKB=10 2018-06-08 12:48:56.677 UTC  localconfig  completeInitialization -> INFO 001#x1B 0m Kafka.Version unset, setting to 0.10.2.0 OTE_MASTERSPY=<ignored> masterSpy=OFF OTE_SPY_ORDERER=<ignored> spyOrd=0 CONFIGTX_ORDERER_BATCHSIZE_MAXMESSAGECOUNT= batchSize=10 CONFIGTX_ORDERER_BATCHTIMEOUT= batchTimeout=2 CORE_LOGGING_LEVEL= CORE_LEDGER_STATE_STATEDATABASE= Using 1 new channelIDs, e.g. testchan321 Started client Consumer-o0-c0 to recv delivered batches srvr=orderer0.example.com:7050 chID=testorgschannel1 Got DeliverResponse_Status: &\{NOT_FOUND} Started client Consumer-o1-c0 to recv delivered batches srvr=orderer1.example.com:7050 chID=testorgschannel1 Got DeliverResponse_Status: &\{NOT_FOUND} Started client Consumer-o2-c0 to recv delivered batches srvr=orderer2.example.com:7050 chID=testorgschannel1 Got DeliverResponse_Status: &\{NOT_FOUND} Finished creating all CONSUMERS clients Finished creating all 3 PRODUCERs at 2018-06-08 12:49:06.691862679 +0000 UTC m=+10.053133900 Starting Producer to send 5000 TXs to ord 0  ch 0  srvr=orderer0.example.com:7050 chID=testorgschannel1, 2018-06-08 12:49:09.696784231 +0000 UTC m=+13.058055556 Starting Producer to send 5000 TXs to ord 1  ch 0  srvr=orderer1.example.com:7050 chID=testorgschannel1, 2018-06-08 12:49:09.69763104 +0000 UTC m=+13.058902354 Starting Producer to send 5000 TXs to ord 2  ch 0  srvr=orderer2.example.com:7050 chID=testorgschannel1, 2018-06-08 12:49:09.698831768 +0000 UTC m=+13.060103053 Producer-o0-c0 failed to broadcast TX 0 (ACK=0 NACK=1), 2018-06-08 12:49:11.699883356 +0000 UTC m=+15.061154628, err: Got unexpected status: SERVICE_UNAVAILABLE Producer-o1-c0 failed to broadcast TX 0 (ACK=0 NACK=1), 2018-06-08 12:49:11.700169302 +0000 UTC m=+15.061440589, err: Got unexpected status: SERVICE_UNAVAILABLE Producer-o2-c0 failed to broadcast TX 0 (ACK=0 NACK=1), 2018-06-08 12:49:11.701080086 +0000 UTC m=+15.062351337, err: Got unexpected status: SERVICE_UNAVAILABLE {quote} Problem Description:  Tests in CI jobs fail occasionally. In this particular daily test run, FAB-7074 failed but 23 other tests succeeded. Most test runs do NOT reveal a failure like this. It is rare, and seems to be a race condition. We use NetworkLauncher to bring up a network using docker-compose, and then immediately a bash script to create channels, and then execute the test. In the logs above, you can see the script echo out the "Creating Channels" message and the number of channels to be created, and then the error log that can be printed by the orderer. From that point, the OTE test continues, and you can see the logs from the test that indicate failures to connect to the orderer from the 3 orderer consumers and the 3 orderer producers.  We could discuss with design team, because the error message does not say *what* it will not enqueue; more information might be helpful.     Nevertheless, based on the likelihood that the orderer is simply not fully running yet by the time we create the channels and run the test, my suggestions are:  1. To increase the delay before creating channels after launching the network, we could increase the sleep time by editing this line in OTE/ote-compose.yml : {quote}command: sh -c 'sleep 30 && ./script.sh' {quote} 2. Try increasing the delay after creating channels before proceeding with test  (creating consumers and producers that connect to the orderer); to do this, edit this line in OTE/script.sh to increase the sleep time: {quote}sleep 30 go test -run $TESTCASE -timeout=90m {quote}  ></description> </Issue>
