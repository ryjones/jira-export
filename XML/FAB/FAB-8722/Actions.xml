<Action id="41370" issue="28300" author="denyeart" type="comment" created="2018-03-08 15:59:50.0" updateauthor="denyeart" updated="2018-03-08 15:59:50.0"> <body><! CDATA I attempted to reproduce:  {noformat} ./byfn.sh -m up -s couchdb docker logs couchdb0 {noformat}  Here's what I see coming out of couchdb:  {code:java}  info  2018-03-08T15:54:11.446649Z nonode@nohost <0.7.0> -------- Application couch_log started on node nonode@nohost  info  2018-03-08T15:54:11.464606Z nonode@nohost <0.7.0> -------- Application folsom started on node nonode@nohost  info  2018-03-08T15:54:11.557156Z nonode@nohost <0.7.0> -------- Application couch_stats started on node nonode@nohost  info  2018-03-08T15:54:11.558611Z nonode@nohost <0.7.0> -------- Application khash started on node nonode@nohost  info  2018-03-08T15:54:11.585281Z nonode@nohost <0.7.0> -------- Application couch_event started on node nonode@nohost  info  2018-03-08T15:54:11.601483Z nonode@nohost <0.7.0> -------- Application ibrowse started on node nonode@nohost  info  2018-03-08T15:54:11.621243Z nonode@nohost <0.7.0> -------- Application ioq started on node nonode@nohost  info  2018-03-08T15:54:11.621401Z nonode@nohost <0.7.0> -------- Application mochiweb started on node nonode@nohost  info  2018-03-08T15:54:11.663924Z nonode@nohost <0.195.0> -------- Apache CouchDB 2.1.1 is starting.   info  2018-03-08T15:54:11.664111Z nonode@nohost <0.196.0> -------- Starting couch_sup  notice  2018-03-08T15:54:11.865533Z nonode@nohost <0.83.0> -------- config:  couchdb  uuid set to b0f9d9a384e4e5d8a1589efb6aa392c9 for reason nil  info  2018-03-08T15:54:11.978964Z nonode@nohost <0.201.0> -------- open_result error {not_found,no_db_file} for _users  info  2018-03-08T15:54:12.172161Z nonode@nohost <0.195.0> -------- Apache CouchDB has started. Time to relax.   info  2018-03-08T15:54:12.172378Z nonode@nohost <0.195.0> -------- Apache CouchDB has started on http://127.0.0.1:5986/  info  2018-03-08T15:54:12.178951Z nonode@nohost <0.7.0> -------- Application couch started on node nonode@nohost  info  2018-03-08T15:54:12.179390Z nonode@nohost <0.7.0> -------- Application ets_lru started on node nonode@nohost  info  2018-03-08T15:54:12.247877Z nonode@nohost <0.7.0> -------- Application rexi started on node nonode@nohost  info  2018-03-08T15:54:12.297653Z nonode@nohost <0.201.0> -------- open_result error {not_found,no_db_file} for _nodes  warning  2018-03-08T15:54:12.297794Z nonode@nohost <0.269.0> -------- creating missing database: _nodes  info  2018-03-08T15:54:12.437017Z nonode@nohost <0.201.0> -------- open_result error {not_found,no_db_file} for _dbs  warning  2018-03-08T15:54:12.437077Z nonode@nohost <0.282.0> -------- creating missing database: _dbs  warning  2018-03-08T15:54:12.437119Z nonode@nohost <0.281.0> -------- creating missing database: _dbs  info  2018-03-08T15:54:12.533762Z nonode@nohost <0.7.0> -------- Application mem3 started on node nonode@nohost  info  2018-03-08T15:54:12.534123Z nonode@nohost <0.7.0> -------- Application fabric started on node nonode@nohost  info  2018-03-08T15:54:12.591668Z nonode@nohost <0.7.0> -------- Application chttpd started on node nonode@nohost  notice  2018-03-08T15:54:12.617438Z nonode@nohost <0.318.0> -------- chttpd_auth_cache changes listener died database_does_not_exist at mem3_shards:load_shards_from_db/6(line:403) <= mem3_shards:load_shards_from_disk/1(line:378) <= mem3_shards:load_shards_from_disk/2(line:407) <= mem3_shards:for_docid/3(line:91) <= fabric_doc_open:go/3(line:38) <= chttpd_auth_cache:ensure_auth_ddoc_exists/2(line:187) <= chttpd_auth_cache:listen_for_changes/1(line:134)  error  2018-03-08T15:54:12.617508Z nonode@nohost emulator -------- Error in process <0.319.0> with exit value: {database_does_not_exist, {mem3_shards,load_shards_from_db,"_users", {file,"src/mem3_shards.erl"},{line,403} },{mem3_shards,load_shards_from_disk,1, {file,"src/mem3_shards.erl"},{line,378} },{mem3_shards,load_shards_from_disk,2, {file,"src/mem3_shards.erl"},{line,407} },{mem3_shards,for_docid,3, {file,"src/mem3_shards.erl"},{line,91} },{fabric_doc_open,go,3, {file,"src/fabric_doc_open.erl"},{line,38} },{chttpd_auth_cache,ensure_auth_ddoc_exists,2, {file,"src/chttpd_auth_cache.erl"},{line,187} },{chttpd_auth_cache,listen_for_changes,1, {file,"src/chttpd_auth_cache.erl"},{line,134} } }   info  2018-03-08T15:54:12.621338Z nonode@nohost <0.7.0> -------- Application couch_index started on node nonode@nohost  info  2018-03-08T15:54:12.621398Z nonode@nohost <0.7.0> -------- Application couch_mrview started on node nonode@nohost  info  2018-03-08T15:54:12.621474Z nonode@nohost <0.7.0> -------- Application couch_plugins started on node nonode@nohost  notice  2018-03-08T15:54:12.712837Z nonode@nohost <0.83.0> -------- config:  features  scheduler set to true for reason nil  info  2018-03-08T15:54:12.770848Z nonode@nohost <0.201.0> -------- open_result error {not_found,no_db_file} for _replicator  notice  2018-03-08T15:54:12.880830Z nonode@nohost <0.335.0> -------- creating replicator ddoc <<"_replicator">>  info  2018-03-08T15:54:12.908466Z nonode@nohost <0.7.0> -------- Application couch_replicator started on node nonode@nohost  info  2018-03-08T15:54:12.939000Z nonode@nohost <0.7.0> -------- Application couch_peruser started on node nonode@nohost  notice  2018-03-08T15:54:12.956259Z nonode@nohost <0.302.0> 682da737da couchdb0:5984 172.19.0.10 undefined GET / 200 ok 236  notice  2018-03-08T15:54:12.970178Z nonode@nohost <0.302.0> 9601219ecf couchdb0:5984 172.19.0.10 undefined GET /_users 404 ok 14  info  2018-03-08T15:54:12.976500Z nonode@nohost <0.7.0> -------- Application ddoc_cache started on node nonode@nohost  info  2018-03-08T15:54:13.046053Z nonode@nohost <0.7.0> -------- Application global_changes started on node nonode@nohost  info  2018-03-08T15:54:13.046189Z nonode@nohost <0.7.0> -------- Application jiffy started on node nonode@nohost  notice  2018-03-08T15:54:13.272981Z nonode@nohost <0.302.0> 9c1578cc8c couchdb0:5984 172.19.0.10 undefined PUT /_users 201 ok 302  notice  2018-03-08T15:54:13.275300Z nonode@nohost <0.302.0> 72cea8e6f9 couchdb0:5984 172.19.0.10 undefined GET /_replicator 404 ok 1  info  2018-03-08T15:54:13.466077Z nonode@nohost <0.7.0> -------- Application mango started on node nonode@nohost  notice  2018-03-08T15:54:13.525338Z nonode@nohost <0.302.0> 901159b3e3 couchdb0:5984 172.19.0.10 undefined PUT /_replicator 201 ok 245  notice  2018-03-08T15:54:13.527463Z nonode@nohost <0.302.0> f9de942488 couchdb0:5984 172.19.0.10 undefined GET /_global_changes 404 ok 1  info  2018-03-08T15:54:13.722971Z nonode@nohost <0.7.0> -------- Application setup started on node nonode@nohost  info  2018-03-08T15:54:13.723139Z nonode@nohost <0.7.0> -------- Application snappy started on node nonode@nohost  notice  2018-03-08T15:54:13.723971Z nonode@nohost <0.302.0> 0f4bb79924 couchdb0:5984 172.19.0.10 undefined PUT /_global_changes 201 ok 196  notice  2018-03-08T15:54:15.260012Z nonode@nohost <0.302.0> 29a554098a couchdb0:5984 172.19.0.10 undefined GET /mychannel_ 404 ok 2  notice  2018-03-08T15:54:15.381715Z nonode@nohost <0.302.0> 7a03d8205d couchdb0:5984 172.19.0.10 undefined PUT /mychannel_ 201 ok 121  notice  2018-03-08T15:54:15.508671Z nonode@nohost <0.302.0> 082015a127 couchdb0:5984 172.19.0.10 undefined GET /mychannel_ 200 ok 18  notice  2018-03-08T15:54:15.534554Z nonode@nohost <0.302.0> b237356e6a couchdb0:5984 172.19.0.10 undefined POST /mychannel_/_all_docs?include_docs=true 200 ok 25  notice  2018-03-08T15:54:15.550028Z nonode@nohost <0.302.0> 4df2cb5042 couchdb0:5984 172.19.0.10 undefined POST /mychannel_/_bulk_docs 201 ok 14  notice  2018-03-08T15:54:15.551001Z nonode@nohost <0.302.0> 4bb1960bec couchdb0:5984 172.19.0.10 undefined POST /mychannel_/_ensure_full_commit 201 ok 1  notice  2018-03-08T15:54:15.552558Z nonode@nohost <0.302.0> 748fed91a7 couchdb0:5984 172.19.0.10 undefined GET /mychannel_/statedb_savepoint?attachments=true 404 ok 1  notice  2018-03-08T15:54:15.554499Z nonode@nohost <0.302.0> 8f2b0db784 couchdb0:5984 172.19.0.10 undefined PUT /mychannel_/statedb_savepoint 201 ok 2  notice  2018-03-08T15:54:15.611058Z nonode@nohost <0.302.0> a3aa95d740 couchdb0:5984 172.19.0.10 undefined GET /mychannel_/resourcesconfigtx.CHANNEL_CONFIG_KEY?attachments=true 200 ok 8  notice  2018-03-08T15:54:15.621935Z nonode@nohost <0.533.0> dcdd01d82a couchdb0:5984 172.19.0.10 undefined GET /mychannel_/_index/ 200 ok 70  notice  2018-03-08T15:54:17.645564Z nonode@nohost <0.339.0> -------- couch_replicator_clustering : cluster stable  notice  2018-03-08T15:54:17.654792Z nonode@nohost <0.356.0> -------- Started replicator db changes listener <0.746.0>  notice  2018-03-08T15:54:17.742097Z nonode@nohost <0.746.0> -------- creating replicator ddoc <<"shards/80000000-9fffffff/_replicator.1520524453">>  notice  2018-03-08T15:54:27.247843Z nonode@nohost <0.262.0> -------- rexi_buffer : cluster stable  notice  2018-03-08T15:54:27.248104Z nonode@nohost <0.259.0> -------- rexi_server : cluster stable {code}   ></body> </Action>
<Action id="41371" issue="28300" author="denyeart" type="comment" created="2018-03-08 16:02:40.0" updateauthor="denyeart" updated="2018-03-08 16:09:42.0"> <body><! CDATA Analysis of couchdb log from above:  couchdb starts at 2018-03-08T15:54:11. couchdb cant find _users system database and reports error at 2018-03-08T15:54:12. peer starts and creates _users system database at 2018-03-08T15:54:13. _users system database created, no more errors.  The same behavior existed between alpha and rc1. The thing that changed is couchdb logs are now directed to stderr so that they show up in `docker logs`.  ></body> </Action>
<Action id="41374" issue="28300" author="aatkddny" type="comment" created="2018-03-08 16:18:13.0" updateauthor="aatkddny" updated="2018-03-08 16:18:30.0"> <body><! CDATA I just went back and double checked - the problem is when you start from a new instance (as in remove all the files previously created) in your /opt/couchdb/data directory.  The biggest problem is that the errors don't stop. So your logs end up flooded.   The fixes outlined here -  http://docs.couchdb.org/en/2.1.1/install/setup.html?highlight=users  - stop the errors coming out although you do see this after the _users call, which is quite alarming     {code:java}    |  error  2018-03-08T16:04:03.485861Z nonode@nohost <0.208.0> -------- CRASH REPORT Process couch_index_server (<0.208.0>) with 0 neighbors exited with reason: {'EXIT',{{'EXIT',{database_does_not_exist, {mem3_shards,load_shards_from_db,"_replicator", {file,"src/mem3_shards.erl"},{line,403} },{mem3_shards,load_shards_from_disk,1, {file,"src/mem3_shards.erl"},{line,378} },{mem3_shards,for_db,2, {file,"src/mem3_shards.erl"},{line,54} },{mem3_shards,local,1, {file,"src/mem3_shards.erl"},{line,156} },{couch_index_server,handle_db_event,3, {file,"src/couch_index_server.erl"},{line,281} },{couch_event_listener_mfa,handle_event,3, {file,"src/couch_event_..."},... },... }},...}} at couch_event_listener:do_event/3(line:150) at gen_server:terminate/7(line:826) <= proc_lib:init_p_do_apply/3(line:240); initial_call: {couch_index_server,init, 'Argument__1' }, ancestors:  couch_secondary_services,couch_sup,<0.195.0> , messages:   , links:  <0.204.0> , dictionary:   , trap_exit: true, status: running, heap_size: 2586, stack_size: 27, reductions: 5636 {code} Of course these commands only work if you are in party mode - you need to add the user/password you set up in the script for non-trivial implementations.      ></body> </Action>
<Action id="41377" issue="28300" author="denyeart" type="comment" created="2018-03-08 16:45:33.0" updateauthor="denyeart" updated="2018-03-08 16:45:33.0"> <body><! CDATA Spamming the logs every 5 seconds until the system databases are created is a open couchdb issue: https://issues.apache.org/jira/browse/COUCHDB-3163  As a workaround, let's use this work item to investigate if the system databases can be pre-created in the fabric-couchdb images.  ></body> </Action>
<Action id="41582" issue="28300" author="chris.elder" type="comment" body="https://gerrit.hyperledger.org/r/#/c/19151/" created="2018-03-14 10:43:07.0" updateauthor="chris.elder" updated="2018-03-14 10:43:07.0"/>
<Action id="44791" issue="28300" author="kchristidis" type="comment" body=" ~chris.elder : I see that the CR has been abandoned. What is the plan of attack here?" created="2018-05-21 19:16:07.0" updateauthor="kchristidis" updated="2018-05-21 19:16:07.0"/>
<Action id="45534" issue="28300" author="chris.elder" type="comment" created="2018-06-05 16:06:42.0" updateauthor="chris.elder" updated="2018-06-05 16:06:42.0"> <body><! CDATA Added a new changeset for the changes.  https://gerrit.hyperledger.org/r/#/c/21467/  ></body> </Action>
<Action id="46079" issue="28300" author="denyeart" type="comment" created="2018-06-18 11:46:37.0" updateauthor="denyeart" updated="2019-02-27 19:36:53.0"> <body><! CDATA On further thought, I don't think the system database can be pre-created in the image. Typically users will mount a directory on the host system to the CouchDB /data volume. Therefore we cannot pre-create databases within the images /data volume.  The peer will continue to create the system databases upon first peer start.  ></body> </Action>
<Action id="57663" issue="28300" author="denyeart" type="comment" created="2019-02-27 19:35:54.0" updateauthor="denyeart" updated="2019-02-27 19:35:54.0"> <body><! CDATA I've created a CouchDB issue to resolve the issue from CouchDB side:  https://github.com/apache/couchdb/issues/1949  ></body> </Action>
