<Action id="42093" issue="28808" author="yacovm" type="comment" body="can you link the corresponding jenkins builds ?" created="2018-03-23 20:29:08.0" updateauthor="yacovm" updated="2018-03-23 20:29:08.0"/>
<Action id="42097" issue="28808" author="sykesm" type="comment" body="No. These happen with local builds across three machines - all macOS with 4 cores and SMT. When I run into it on jenkins I will point to it here. (I think it&apos;s just a matter of time.)" created="2018-03-23 20:43:16.0" updateauthor="sykesm" updated="2018-03-23 20:43:16.0"/>
<Action id="42098" issue="28808" author="yacovm" type="comment" created="2018-03-23 21:31:36.0" updateauthor="yacovm" updated="2018-03-23 21:31:36.0"> <body><! CDATA Can you try this patch and tell if that fixes it?  {code} diff --git a/core/deliverservice/client_test.go b/core/deliverservice/client_test.go index b1d7857..59f41e6 100644 --- a/core/deliverservice/client_test.go +++ b/core/deliverservice/client_test.go @@ -28,6 +28,8 @@ import (  var connNumber = 0  +var wg sync.WaitGroup + func newConnection() *grpc.ClientConn { 	// The balancer is in order to check connection leaks. 	// When grpc.ClientConn.Close() is called, it calls the balancer's Close() @@ -40,6 +42,7 @@ type balancer struct { }  func (*balancer) Start(target string, config grpc.BalancerConfig) error { +	wg.Add(1) 	connNumber++ 	return nil } @@ -58,6 +61,7 @@ func (*balancer) Notify() <-chan   grpc.Address {  func (*balancer) Close() error { 	connNumber-- +	wg.Done() 	return nil }  @@ -225,9 +229,12 @@ func testOrderingServiceStreamFailure(t *testing.T, bdc blocksDelivererConsumer) }  func TestOrderingServiceSetupFailure(t *testing.T) { -	testOrderingServiceSetupFailure(t, blockDelivererConsumerWithRecv) -	testOrderingServiceSetupFailure(t, blockDelivererConsumerWithSend) -	assert.Equal(t, 0, connNumber) +	for i := 0; i < 10000; i++ { +		testOrderingServiceSetupFailure(t, blockDelivererConsumerWithRecv) +		testOrderingServiceSetupFailure(t, blockDelivererConsumerWithSend) +		wg.Wait() +		assert.Equal(t, 0, connNumber) +	} }  func testOrderingServiceSetupFailure(t *testing.T, bdc blocksDelivererConsumer) {  {code}  ></body> </Action>
<Action id="42099" issue="28808" author="yacovm" type="comment" created="2018-03-23 21:33:21.0" updateauthor="yacovm" updated="2018-03-23 21:34:06.0"> <body><! CDATA As for the TestNewConnection - it's not mine... ;)   core/comm/client_test.go ?   ></body> </Action>
<Action id="42114" issue="28808" author="sykesm" type="comment" body="Applied it and will run with it for a bit. I&apos;ll let you know if I hit the issue again. tx." created="2018-03-25 00:44:18.0" updateauthor="sykesm" updated="2018-03-25 00:44:18.0"/>
<Action id="42121" issue="28808" author="sykesm" type="comment" created="2018-03-25 16:14:12.0" updateauthor="sykesm" updated="2018-03-25 16:14:12.0"> <body><! CDATA I've run {{make unit-tests}} a few times now and this issue hasn't popped up. (Lots of others have, but not this one.)  I think using the WaitGroup probably takes care of this flake. I'll open a separate issue for the comm flake.  ></body> </Action>
<Action id="42122" issue="28808" author="yacovm" type="comment" body="OK, do you want me to push a fix or do you want to do it? " created="2018-03-25 17:54:54.0" updateauthor="yacovm" updated="2018-03-25 17:54:54.0"/>
<Action id="42308" issue="28808" author="sykesm" type="comment" body="https://jenkins.hyperledger.org/job/fabric-verify-x86_64/21962/consoleFull" created="2018-03-29 13:12:07.0" updateauthor="sykesm" updated="2018-03-29 13:12:07.0"/>
<Action id="42310" issue="28808" author="yacovm" type="comment" created="2018-03-29 13:21:35.0" updateauthor="yacovm" updated="2018-03-29 13:21:35.0"> <body><! CDATA Well but this has nothing to do with the TestOrderingServiceSetupFailure test, it's the other one (the comm). And I was also able to reproduce that comm test failure locally, however I tried to fix it and wasn't able to do that, but it was very late at night so i ended up giving up.   ></body> </Action>
<Action id="43059" issue="28808" author="yacovm" type="comment" created="2018-04-17 14:52:22.0" updateauthor="yacovm" updated="2018-04-17 14:52:22.0"> <body><! CDATA  ~sykesm  -   {quote} OK, do you want me to push a fix or do you want to do it? {quote}  Â   ></body> </Action>
<Action id="43148" issue="28808" author="sykesm" type="comment" created="2018-04-19 12:59:29.0" updateauthor="sykesm" updated="2018-04-19 12:59:29.0"> <body><! CDATA If you don't mind pushing the fix, that would be helpful. I've go my hands full with a few threads of work running in parallel with different folks.  Thanks.  ></body> </Action>
<Action id="43175" issue="28808" author="yacovm" type="comment" body="https://gerrit.hyperledger.org/r/#/c/20805/" created="2018-04-19 20:32:19.0" updateauthor="yacovm" updated="2018-04-19 20:32:19.0"/>
