<Issue id="13496" key="FAB-1163" number="1163" project="10002" reporter="stylix" assignee="muralisr" creator="stylix" type="10004" summary="Query timeout crash a chaincode  v0.6 " priority="2" resolution="10000" status="6" created="2016-11-21 01:50:29.0" updated="2019-03-05 03:04:25.0" resolutiondate="2017-05-10 13:16:22.0" votes="2" watches="7" workflowId="36734"> <description><! CDATA *Issue* With some heavy process, e.g. query with a very time consuming function, I found that when the query time is over 30 seconds, the chaincode will got crashed  *Chaincode *log ------------------------------------------------------------------------------ 09:01:43.342  shim  DEBU :  eecae41e Sending RANGE_QUERY_STATE 09:01:46.983  shim  DEBU :  eecae41e Received message RESPONSE from shim 09:01:46.983  shim  DEBU :  eecae41e Handling ChaincodeMessage of type: RESPONSE(state:ready) 09:01:46.983  shim  DEBU :  eecae41e before send 09:01:46.983  shim  DEBU :  eecae41e after send 09:01:46.983  shim  DEBU :  eecae41e Received RESPONSE, communicated (state:ready) 09:01:46.983  shim  DEBU :  eecae41e Received RESPONSE. Successfully got range Removed: 368 09:01:46.984  shim  DEBU :  eecae41e Sending RANGE_QUERY_STATE 2016/11/18 09:01:47 transport: http2Client.notifyError got notified that the client transport was broken EOF. 09:01:47.027  shim  ERRO : Received error from server: rpc error: code = 13 desc = transport is closing, ending chaincode stream Error starting AML chaincode: rpc error: code = 13 desc = transport is closing ------------------------------------------------------------------------------    However, on the *validator peer,* itâ€™s still there, but shown some segmentation fault. ------------------------------------------------------------------------------ NFO 0a5 Successfully queried chaincode:    08:59:53.631  rest  ProcessChaincode -> INFO 0a6 REST successfully query chaincode: {"jsonrpc":"2.0","result":{"status":"OK","message":"  "},"id":0} 09:01:13.693  rest  ProcessChaincode -> INFO 0a7 REST processing chaincode request... 09:01:13.693  rest  processChaincodeInvokeOrQuery -> INFO 0a8 REST query chaincode... 09:01:13.693  devops  invokeOrQuery -> INFO 0a9 Transaction ID: eecae41e-05fc-4175-aedb-0a2aa96db4ac 09:01:43.694  rest  processChaincodeInvokeOrQuery -> ERRO 0aa Error when querying chaincode: Error:Failed to execute transaction or query(Timeout expired while executing transaction) 09:01:43.694  rest  ProcessChaincode -> INFO 0ab REST successfully query chaincode: {"jsonrpc":"2.0","error":{"code":-32003,"message":"Query failure","data":"Error when querying chaincode: Error:Failed to execute transaction or query(Timeout expired while executing transaction)"},"id":0} panic: runtime error: invalid memory address or nil pointer dereference panic: runtime error: invalid memory address or nil pointer dereference  signal SIGSEGV: segmentation violation code=0x1 addr=0x30 pc=0x6f21be   goroutine 1481284  running : panic(0xb82c00, 0xc4200160b0) /usr/local/go/src/runtime/panic.go:500 +0x1a1 github.com/hyperledger/fabric/core/chaincode.(*Handler).handleRangeQueryState.func1.1(0xc420268b80, 0xc428d7d040, 0xc4202e2e48) /go/src/github.com/hyperledger/fabric/core/chaincode/handler.go:689 +0x4e panic(0xb82c00, 0xc4200160b0) /usr/local/go/src/runtime/panic.go:458 +0x243 github.com/hyperledger/fabric/core/chaincode.(*Handler).putRangeQueryIterator(0xc420268b80, 0x0, 0xc4257eb830, 0x24, 0x11da2a0, 0xc42015a1c0) /go/src/github.com/hyperledger/fabric/core/chaincode/handler.go:149 +0x8f github.com/hyperledger/fabric/core/chaincode.(*Handler).handleRangeQueryState.func1(0xc420268b80, 0xc428d7d040) /go/src/github.com/hyperledger/fabric/core/chaincode/handler.go:727 +0x2de created by github.com/hyperledger/fabric/core/chaincode.(*Handler).handleRangeQueryState /go/src/github.com/hyperledger/fabric/core/chaincode/handler.go:774 +0x49 ------------------------------------------------------------------------------    And here is what the *other validator peers* keep talking about ------------------------------------------------------------------------------ 09:13:12.002  peer  ensureConnected -> WARN 171 Touch service indicates dropped connections, attempting to reconnect... 2016/11/18 09:13:13 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: dial tcp 11.44.0.7:7051: getsockopt: connection refused"; Reconnecting to {"11.44.0.7:7051" <nil>} 2016/11/18 09:13:14 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: dial tcp 11.44.0.7:7051: getsockopt: connection refused"; Reconnecting to {"11.44.0.7:7051" <nil>} 09:13:15.003  peer  chatWithPeer -> ERRO 172 Error creating connection to peer address 11.44.0.7:7051: grpc: timed out when dialing 2016/11/18 09:13:15 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: dial tcp 11.44.0.7:7051: getsockopt: connection refused"; Reconnecting to {"11.44.0.7:7051" <nil>} ------------------------------------------------------------------------------   *To reproduce it* Run a query more than 30 secs on v0.6 branch  ></description> </Issue>
