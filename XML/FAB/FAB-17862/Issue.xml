<Issue id="45028" key="FAB-17862" number="17862" project="10002" reporter="denyeart" assignee="wenjian" creator="denyeart" type="10003" summary="Allow upgrade-dbs to drop all dbs when running second times" priority="3" resolution="10000" status="6" created="2020-05-08 12:08:33.0" updated="2020-05-13 15:01:50.0" resolutiondate="2020-05-13 15:01:50.0" votes="0" watches="2" workflowId="58938" archived="N"> <description><! CDATA After upgrading to v2.0 with CouchDB, you can upgrade-dbs as follows: {code:java} peer node upgrade-dbs {code}    This will drop/upgrade local peer databases to v2.0. If CouchDB was down, or you forgot to pass the CouchDB variable CORE_LEDGER_STATE_STATEDATABASE, it will not drop the CouchDB databases as part of upgrade-dbs.  Starting peer next time will therefore give an error:   {code:java} 2020-05-08 07:58:08.814 EDT  kvledger  func1 -> ERRO 048 Please execute the 'peer node upgrade-dbs' command to upgrade the database format: unexpected format. db info =  CouchDB for state database , data format =   , expected format =  2.0  panic: Error in instantiating ledger provider: unexpected format. db info =  CouchDB for state database , data format =   , expected format =  2.0 {code}      The error says to run upgrade-dbs again since CouchDB database is still in old format.  If you run upgrade-dbs again, this time passing CouchDB as state database, you will get a message that saying upgrade-dbs has nothing to do:   {code:java} CORE_LEDGER_STATE_STATEDATABASE=CouchDB peer node upgrade-dbs 2020-05-08 07:59:09.077 EDT  kvledger  UpgradeDBs -> INFO 001 Ledger data folder from config =  /var/hyperledger/production/ledgersData  2020-05-08 07:59:09.116 EDT  kvledger  checkUpgradeEligibility -> INFO 002 Ledger data format is current, nothing to upgrade.{code}      It should be possible to run upgrade-dbs multiple times, so that any databases missed the first time, can be dropped/upgraded the second time.  ></description> </Issue>
