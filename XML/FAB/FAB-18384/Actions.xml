<Action id="70988" issue="46440" author="yacovm" type="comment" created="2020-12-19 12:28:18.0" updateauthor="yacovm" updated="2020-12-19 12:35:31.0"> <body><! CDATA Look at  this|https://hyperledger-fabric.readthedocs.io/en/latest/raft_configuration.html#local-configuration  document. Start your orderers with *TLSHandshakeTimeShift* configured to be some time (in hours) in the past, like *TLSHandshakeTimeShift=96h* for 4 days. Also enable *General.Authentication.NoExpirationChecks* as noted  here|https://hyperledger-fabric.readthedocs.io/en/latest/raft_configuration.html#certificate-expiration-related-authentication .  And when you send your transaction from  peer CLI|https://hyperledger-fabric.readthedocs.io/en/latest/commands/peerchannel.html  you need to use *--tlsHandshakeTimeShift*.    ~joe-alewine   ~pandrejko   ~denyeart  we might want to document these things in a consolidated manner (new record under the operations guides?) under some title such as "recovering expired certificates" so it'll be easy for users to locate.  ></body> </Action>
<Action id="70989" issue="46440" author="adarshajha" type="comment" created="2020-12-19 13:02:43.0" updateauthor="adarshajha" updated="2020-12-19 13:02:43.0"> <body><! CDATA  ~yacovm  thanks for replying . I am facing this issue in production environment. Can you please tell where to add this TLSHandshakeTimeShift param ?  I'm using hyperledger fabric 1.4 version using raft ordering service. I unable to find it in the document above.  ></body> </Action>
<Action id="70990" issue="46440" author="adarshajha" type="comment" body=" ~yacovm  I&apos;ve passed it and after restarting the orderer . i am seeing in logs an error :-  Failed to initialize msp signing certs expired. " created="2020-12-19 15:04:01.0" updateauthor="adarshajha" updated="2020-12-19 15:04:01.0"/>
<Action id="70991" issue="46440" author="yacovm" type="comment" body="Oh the orderer&apos;s signing cert expired too? Or is it the peer CLI signing certs?" created="2020-12-19 16:16:51.0" updateauthor="yacovm" updated="2020-12-19 16:16:51.0"/>
<Action id="70992" issue="46440" author="yacovm" type="comment" created="2020-12-19 16:17:24.0" updateauthor="yacovm" updated="2020-12-19 16:17:24.0"> <body><! CDATA If it is the admin's signing certs you can just issue a new admin from the CA. If it's the orderer's signing cert, you can issue new ones and replace them.  ></body> </Action>
<Action id="70993" issue="46440" author="adarshajha" type="comment" created="2020-12-19 16:37:16.0" updateauthor="adarshajha" updated="2020-12-19 16:37:16.0"> <body><! CDATA  ~yacovm  I have added it in my orderer.yaml and restarted the node but my container got exited and giving me error   {code:java} 2020-12-19 16:09:38.664 UTC  orderer.common.server  initializeLocalMsp -> FATA 001 Failed to initialize local MSP: signing identity expired 28h58m38.664163036s ago  {code}    ></body> </Action>
<Action id="70994" issue="46440" author="yacovm" type="comment" body="Just replace it with a fresh one and you&apos;ll be fine" created="2020-12-19 16:45:35.0" updateauthor="yacovm" updated="2020-12-19 16:45:35.0"/>
<Action id="70998" issue="46440" author="adarshajha" type="comment" created="2020-12-21 08:30:30.0" updateauthor="adarshajha" updated="2020-12-21 08:30:30.0"> <body><! CDATA  ~yacovm  I have created new orderer signing certs for all my orderers and i have also inclused  TLSHandshakeTimeShift and General.Authentication.NoExpirationChecks . All my orderer containers are up now but they are giving me consenter error.    {code:java} I do not belong to channel system-channel or am forbidden pulling it (not in the channel), skipping chain retrieval {code}   ></body> </Action>
<Action id="71000" issue="46440" author="yacovm" type="comment" body="You were supposed to replace the enrollment certificates of the orderers, not the TLS certificates of the orderers" created="2020-12-21 09:28:51.0" updateauthor="yacovm" updated="2020-12-21 09:28:51.0"/>
<Action id="71001" issue="46440" author="adarshajha" type="comment" body="can i put back the old TLS certs again and just replace the new enrollment certs ? will it work ?" created="2020-12-21 11:45:07.0" updateauthor="adarshajha" updated="2020-12-21 11:45:07.0"/>
<Action id="71002" issue="46440" author="yacovm" type="comment" body="That&apos;s what I said. You need to replace enrollment certificates and put back the old TLS certs and use the time shift configuration to make the TLS handshake think it traveled back in time. " created="2020-12-21 12:04:13.0" updateauthor="yacovm" updated="2020-12-21 12:04:13.0"/>
<Action id="71010" issue="46440" author="adarshajha" type="comment" created="2020-12-25 14:31:55.0" updateauthor="adarshajha" updated="2020-12-25 17:17:28.0"> <body><! CDATA I have tried adding new enrollment certificates of the orderers and also added TLSHandshakeTimeshift and General.Authentication.NoExpirationChecks but I am getting this error in my orderer logs :-   I'm using hyperledger-fabric 1.4.2 version.  {code:java} 2020-12-24 18:17:22.479 UTC  core.comm  ServerHandshake -> ERRO 7d4 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress=1**.*0.0.*:****  {code}   ></body> </Action>
<Action id="71020" issue="46440" author="adarshajha" type="comment" created="2020-12-27 12:20:39.0" updateauthor="adarshajha" updated="2020-12-27 12:24:19.0"> <body><! CDATA  ~yacovm  I upgraded my binaries from 1.4.2 to 1.4.9 version and now it worked. My orderers went up and achieved raft consensus but whenever i up my peer containers then they aren't able to communicate with orderers. They are giving this error :-   {code:java} 2020-12-27 11:56:18.822 UTC  core.comm  ServerHandshake -> ERRO 262 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress {code} =  ></body> </Action>
<Action id="71022" issue="46440" author="yacovm" type="comment" body="Make non-expired certificates for your admins and orderers and then issue config updates to replace them according to the documentation guides." created="2020-12-27 14:08:31.0" updateauthor="yacovm" updated="2020-12-27 14:08:31.0"/>
<Action id="71023" issue="46440" author="adarshajha" type="comment" created="2020-12-27 14:31:53.0" updateauthor="adarshajha" updated="2020-12-27 15:12:48.0"> <body><! CDATA I have replaced peer nodes with new certs (both msp and tls certs) and now I'm trying to fetch config using peer node by passing flags with orderer ca certs. I can see logs in orderer with TLS handshake failed with error remote error:   {code:java} tls: bad certificate server=Orderer remoteaddress  {code}  with the corresponding peer node's IP and peer return this log :  {code:java}  Error: failed to create deliver client: orderer client failed to connect to orderer1.example.com:7050: failed to create new connection: context deadline exceeded  {code}    ></body> </Action>
<Action id="71050" issue="46440" author="adarshajha" type="comment" created="2021-01-06 08:01:39.0" updateauthor="adarshajha" updated="2021-01-06 08:01:39.0"> <body><! CDATA  ~yacovm  Thanks for your support . I added this       {code:java} - ORDERER_GENERAL_TLS_TLSHANDSHAKETIMESHIFT=1240h {code} in my docker-base.yaml file and upgraded my binaries to 1.4.9 and my orderers are able to communicate with each other.    Now Do I have to update my orderer config to the channel for new binaries ? to be able to work with 1.4.9 or i can move ahead ?  ></body> </Action>
<Action id="71051" issue="46440" author="yacovm" type="comment" body="The configuration file is baked into the docker image, so you only need to keep in mind the environment variables. Since you see it works, then it works." created="2021-01-06 09:07:40.0" updateauthor="yacovm" updated="2021-01-06 09:07:40.0"/>
<Action id="71053" issue="46440" author="adarshajha" type="comment" created="2021-01-06 13:40:20.0" updateauthor="adarshajha" updated="2021-01-06 13:40:20.0"> <body><! CDATA  ~yacovm  my orderers are up but now i am tryint to fetch the config from orderer cli but I am getting this error : -   {code:java} 2021-01-06 13:30:48.123 UTC  core.comm  ServerHandshake -> ERRO 53a4 TLS handshake failed with error remote error: tls: bad certificate server=Orderer remoteaddress {code}  Am i moving in the right direction ?    ></body> </Action>
<Action id="71056" issue="46440" author="yacovm" type="comment" created="2021-01-06 14:36:43.0" updateauthor="yacovm" updated="2021-01-06 14:36:43.0"> <body><! CDATA You might want to use the time shift option here as well or to change the clock of your laptop.  You can also fetch it from a peer  ></body> </Action>
<Action id="71065" issue="46440" author="adarshajha" type="comment" body="@Yacov how to add timeshift option in cli? Just like i set it as a env variable in yaml file? Like export ORDERER_GENERAL_TLS_TLSHANDSHAKETIMESHIFT=700H ? " created="2021-01-06 18:03:22.0" updateauthor="adarshajha" updated="2021-01-06 18:03:22.0"/>
<Action id="71067" issue="46440" author="yacovm" type="comment" body="https://hyperledger-fabric.readthedocs.io/en/latest/commands/peerchannel.html" created="2021-01-06 18:25:42.0" updateauthor="yacovm" updated="2021-01-06 18:25:42.0"/>
<Action id="71073" issue="46440" author="adarshajha" type="comment" created="2021-01-07 12:15:15.0" updateauthor="adarshajha" updated="2021-01-08 09:43:38.0"> <body><! CDATA  ~yacovm  thanks for sharing the link. It helped a lot and i was able to fetch the config using --tlshandshaketimeshift but Now after modifying the system channel config file when I'm am trying to update it using:  {code:java} peer channel update -f certs_update_in_envelope.pb -c $CHANNEL_NAME -o $ORDERER_CONTAINER:7050 --tls --cafile $ORDERER_CA --tlsHandshakeTimeShift 1240h {code}  I'm getting this error:  {code:java} Error: got unexpected status: BAD_REQUEST -- error applying config update to existing channel 'system-channel': error authorizing update: error validating DeltaSet: policy for  Value   /Channel/Consortiums/SampleConsortium/org3MSP/MSP not satisfied: signature set did not satisfy policy {code}  Can you please help me with this    ></body> </Action>
<Action id="71088" issue="46440" author="yacovm" type="comment" body="You need to sign it with several organizations, not just a single one." created="2021-01-08 09:48:23.0" updateauthor="yacovm" updated="2021-01-08 09:48:23.0"/>
<Action id="71089" issue="46440" author="adarshajha" type="comment" created="2021-01-08 10:24:21.0" updateauthor="adarshajha" updated="2021-01-08 10:57:03.0"> <body><! CDATA  ~yacovm  do I have to sign this with the newly generated certs or with the older ones?  I have tried with both and wasn't able to update with either. When I have tried with new ones it reproduced the same error and while updating with the older certs I got this errror:   {code:java} 2021-01-08 08:32:51.979 UTC  main  InitCmd -> ERRO 001 Cannot run peer because error when setting up MSP of type bccsp from directory /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/org3.com/users/Admin@org3.com/msp: signing identity expired 501h22m51.979380795s ago  {code}   ></body> </Action>
<Action id="71090" issue="46440" author="yacovm" type="comment" created="2021-01-08 11:15:50.0" updateauthor="yacovm" updated="2021-01-08 11:15:50.0"> <body><! CDATA You need with the older ones, obviously. Otherwise anyone could kidnap your entire network without authorization, right?     You can try to reverse the date in your machine from with you run the peer CLI. I know it's far from optimal but that's what we have right now.  ></body> </Action>
<Action id="71091" issue="46440" author="adarshajha" type="comment" created="2021-01-08 13:36:31.0" updateauthor="adarshajha" updated="2021-01-08 13:38:22.0"> <body><! CDATA  ~yacovm  Thanks for sharing this info. I tried reversing the date in my machine and was able to successfully sign the config but when i try to update it . I am getting this error :-    {code:java} error: got unexpected status: BAD_REQUEST -- error applying config update to existing channel 'libra-system-channel': initializing channelconfig failed: could not create channel Orderer sub-group config: setting up the MSP manager failed: CA Certificate is not valid, (SN: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx): could not obtain certification chain: the supplied identity is not valid: x509: certificate has expired or is not yet valid {code}    ></body> </Action>
<Action id="71092" issue="46440" author="yacovm" type="comment" body=" ~jyellick  any ideas? Why is it rejected after broadcast expiration filter? I thought we don&apos;t have expiration checks in the orderer except from the expiration filter which is not this case" created="2021-01-08 13:58:33.0" updateauthor="yacovm" updated="2021-01-08 13:58:33.0"/>
<Action id="71104" issue="46440" author="adarshajha" type="comment" body=" ~yacovm  Do i have to generate new tls certs for the orderer before doing the config update  ?" created="2021-01-09 11:16:22.0" updateauthor="adarshajha" updated="2021-01-09 11:16:22.0"/>
<Action id="71183" issue="46440" author="adarshajha" type="comment" created="2021-01-11 10:26:04.0" updateauthor="adarshajha" updated="2021-01-11 10:26:04.0"> <body><! CDATA  ~yacovm  I'm at the final step of updating the config and I'm getting this error .  Do i have to update orderer certs one by one ?    {code:java} Error: got unexpected status: SERVICE_UNAVAILABLE -- update of more than one consenter at a time is not supported, requested changes: add 6 node(s), remove 6 node(s)  {code}   ></body> </Action>
<Action id="71184" issue="46440" author="yacovm" type="comment" body="Yes you can only add/remove one at a time" created="2021-01-11 11:02:39.0" updateauthor="yacovm" updated="2021-01-11 11:02:39.0"/>
<Action id="71199" issue="46440" author="adarshajha" type="comment" created="2021-01-12 07:40:12.0" updateauthor="adarshajha" updated="2021-01-12 07:40:12.0"> <body><! CDATA  ~yacovm  I tried updating one orderer at a time. I was able to successfully update two orderers but when i tried updating the third orderer then after updation when i restarted that orderer my raft lost its consensus as in my case i have 6 orderers . i checked the logs and saw that the newly updated orderers were not able to communicate with orderer4 , 5 and 6 . So my question is do i have to restart my orderer peers after upation of all certs one by one  ?    ></body> </Action>
<Action id="71200" issue="46440" author="yacovm" type="comment" body="No, you don&apos;t need to restart them." created="2021-01-12 08:07:58.0" updateauthor="yacovm" updated="2021-01-12 08:07:58.0"/>
<Action id="71201" issue="46440" author="adarshajha" type="comment" created="2021-01-12 08:57:32.0" updateauthor="adarshajha" updated="2021-01-12 08:57:32.0"> <body><! CDATA  ~yacovm  so , Should i update them one by one after I have update all orderer certs ( newly generated ) in the config.  Do i have to follow any particular order to restart all of my orderers ? like from orderer6 to orderer1 or orderer1 to orderer6 ?   ></body> </Action>
<Action id="71202" issue="46440" author="yacovm" type="comment" created="2021-01-12 09:05:23.0" updateauthor="yacovm" updated="2021-01-12 09:05:23.0"> <body><! CDATA Do config update for orderer 1 Restart it with the new certificate  Do config update of orderer2 Restart it with the new certificate ... ...  Do config update of orderer6 Restart it with the new certificate  ></body> </Action>
<Action id="71204" issue="46440" author="adarshajha" type="comment" created="2021-01-12 11:49:16.0" updateauthor="adarshajha" updated="2021-01-12 11:49:16.0"> <body><! CDATA We did the same thing but then we lost consensus between orderers, so just want to enquire if we have to first update config with all org's msp admin and tls certs or not.  In total we have to change three org MSP certs:  admins  tls root certs  Then the tls certs for consenters for 6 orderers.  Can you please guide the sequence.  ></body> </Action>
<Action id="71304" issue="46440" author="adarshajha" type="comment" body=" ~yacovm  i have tried it many times now and was able to successfully update on all the 4 channels i have but the moment i restart my orderer it gets out of consensus and is never able to get back in consensus. Please suggest something as it&apos;s been a month now for me and it&apos;s my production network. what should i do ? i feel like i am completely stuck now . " created="2021-01-25 07:01:01.0" updateauthor="adarshajha" updated="2021-01-25 07:01:01.0"/>
<Action id="71305" issue="46440" author="yacovm" type="comment" body="Perhaps send an email to the mailing list. JIRA is not an ideal platform to get technical assistance " created="2021-01-25 08:12:23.0" updateauthor="yacovm" updated="2021-01-25 08:12:23.0"/>
<Action id="71355" issue="46440" author="adarshajha" type="comment" created="2021-02-08 11:40:42.0" updateauthor="adarshajha" updated="2021-02-08 11:41:23.0"> <body><! CDATA  ~yacovm  Thanks for your help. I was able to rotate my expired certs for orderers by reducing the size to two orderers and also added a new orderer with new certs and also rotated my peers certs.  My network is running now with the new certs  but when i try to invoke the chaincode. I get this error :-   {code:java}  Error: 2 UNKNOWN: identity expired  ERROR  Query - Error: 2 UNKNOWN: identity expired {code}     ></body> </Action>
<Action id="71357" issue="46440" author="yacovm" type="comment" body="You&apos;re invoking with an expired certificate " created="2021-02-08 11:57:06.0" updateauthor="yacovm" updated="2021-02-08 11:57:06.0"/>
<Action id="71371" issue="46440" author="adarshajha" type="comment" created="2021-02-09 11:46:50.0" updateauthor="adarshajha" updated="2021-02-09 11:46:50.0"> <body><! CDATA Thanks , i was able to invoke the transaction and the chaincode also went up. seems like everything is working fine now but when i try to instantiate a newly installed chaincode , I am getting this error :-  {code:java} Error: could not assemble transaction, err proposal response was not successful, error code 500, msg instantiation policy violation: signature set did not satisfy policy {code} Am i missing something ? I think this would be the last piece of puzzle.   ></body> </Action>
<Action id="71393" issue="46440" author="adarshajha" type="comment" created="2021-02-15 08:23:11.0" updateauthor="adarshajha" updated="2021-02-15 08:23:11.0"> <body><! CDATA Hey i solved this, actually there was a problem with my chaincode that's why it wasn't able to instantiate. Finally i was able to recover my network  with expired admin and tls certs.  Thanks  ~yacovm  for your help.  It took me 40 days to solve this. I tried so many things and learnt so many things too.   ></body> </Action>
<Action id="71394" issue="46440" author="yacovm" type="comment" body="Glad you solved it" created="2021-02-15 08:26:09.0" updateauthor="yacovm" updated="2021-02-15 08:26:09.0"/>
