<Issue id="46574" key="FAB-18424" number="18424" project="10002" reporter="sykesm" assignee="manish-sethi" creator="sykesm" type="10004" summary="Discovery service integration tests failures" priority="2" resolution="10000" status="6" created="2021-02-15 17:22:06.0" updated="2021-02-18 22:03:13.0" resolutiondate="2021-02-18 22:03:13.0" votes="0" watches="3" workflowId="60518" archived="N"> <description><! CDATA The discovery service tests fail when a snapshot request is issued before "update anchor peers" is completed.  {code} • Failure  72.576 seconds  DiscoveryService /Users/sykesm/fabric/integration/discovery/discovery_test.go:35 discovers network configuration, endorsers, and peer membership  It  /Users/sykesm/fabric/integration/discovery/discovery_test.go:154  Timed out after 60.004s. Expected <string>: Successfully got pending snapshot requests:  1   to contain substring <string>: Successfully got pending snapshot requests:      /Users/sykesm/fabric/integration/discovery/discovery_test.go:776 ------------------------------   Summarizing 1 Failure:   Fail  DiscoveryService  It  discovers network configuration, endorsers, and peer membership /Users/sykesm/fabric/integration/discovery/discovery_test.go:776 {code}  This failure is related to this line in the test: {code} 		By("verifying snapshot completed on org1Peer0") 		verifyNoPendingSnapshotRequest(network, org1Peer0, "testchannel") {code}  Some of the logs {code} STEP: generating a snapshot at current block number on org1Peer0 ...  o  peer-channel-info  Blockchain info: {"height":2,"currentBlockHash":"7FuHgrJ1JGQDOlDJ6frNhfWjCYBB3SDZKSCTscf7q3k=","previousBlockHash":"erqByEwRm6VLp902tVgydTBRHgsDZhISnCxqtkUQg1U="} ...  d  peer-snapshot-submit  starting peer snapshot submitrequest --channelID testchannel --blockNumber 0 --peerAddress 127.0.0.1:21005 --tlsRootCertFile /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/ca-certs.pem ...  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02de DEBU  committer.txvalidator  validateTx ->  testchannel  validateTx completes for block 0x14003248200 env 0x14003230910 txn 0  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02df DEBU  committer.txvalidator  Validate -> got result for idx 0, code 0  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e0 INFO  committer.txvalidator  Validate ->  testchannel  Validated block  2  in 3ms  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e1 DEBU  kvledger  processSnapshotMgmtEvents -> Event received channelID=testchannel type=commitStart blockNumber=2 snapshotInProgress=false  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e2 DEBU  kvledger  commit ->  testchannel  Validating state for block  2   e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e3 DEBU  lockbasedtxmgr  ValidateAndPrepare -> Waiting for purge mgr to finish the background job of computing expirying keys for the block  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e4 DEBU  lockbasedtxmgr  ValidateAndPrepare -> lock acquired on oldBlockCommit for validating read set version against the committed version  e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e5 DEBU  lockbasedtxmgr  ValidateAndPrepare -> Validating new block with num trans =  1   e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e6 DEBU  validation  ValidateAndPrepareBatch -> ValidateAndPrepareBatch() for block number =  2   e  Org1.peer0  2021-02-15 10:45:46.531 EST 02e7 DEBU  validation  ValidateAndPrepareBatch -> preprocessing ProtoBlock...  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02e8 DEBU  validation  preprocessProtoBlock -> txType=CONFIG  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02e9 DEBU  validation  processNonEndorserTx -> Performing custom processing for transaction  txid= ,  txType=CONFIG   e  Org1.peer0  2021-02-15 10:45:46.532 EST 02ea DEBU  validation  processNonEndorserTx -> Processor for custom tx processing:&peer.ConfigTxProcessor{}  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02eb DEBU  lockbasedtxmgr  NewTxSimulator -> constructing new tx simulator  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02ec DEBU  lockbasedtxmgr  newQueryExecutor -> constructing new query executor txid =     e  Org1.peer0  2021-02-15 10:45:46.532 EST 02ed DEBU  lockbasedtxmgr  newTxSimulator -> constructing new tx simulator txid =     e  Org1.peer0  2021-02-15 10:45:46.532 EST 02ee DEBU  peer  GenerateSimulationResults -> Processing CONFIG  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02ef DEBU  lockbasedtxmgr  GetTxSimulationResults -> Simulation completed, getting simulation results  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f0 DEBU  lockbasedtxmgr  Done -> Done with transaction simulation / query execution     e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f1 DEBU  validation  validateAndPrepareBatch -> Block  2  Transaction index  0  TxId    marked as valid by state validator. ContainsPostOrderWrites  true   e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f2 DEBU  validation  applyWriteSet -> txops=validation.txOps{validation.compositeKey{ns:"", coll:"", key:"CHANNEL_CONFIG_ENV_BYTES"}:(*validation.keyOps)(0x1400346e980)}  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f3 DEBU  validation  ValidateAndPrepareBatch -> validating rwset...  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f4 DEBU  validation  ValidateAndPrepareBatch -> postprocessing ProtoBlock...  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f5 DEBU  validation  ValidateAndPrepareBatch -> ValidateAndPrepareBatch() complete  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f6 DEBU  kvledger  commit ->  testchannel  Adding CommitHash to the block  2   e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f7 DEBU  kvledger  commit ->  testchannel  Committing pvtdata and block  2  to storage  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f8 DEBU  kvledger  commitToPvtAndBlockStore -> Writing block  2  to pvt data store  e  Org1.peer0  2021-02-15 10:45:46.532 EST 02f9 DEBU  pvtdatastorage  Commit -> Committing private data for block  2  ...  e  Org1.peer0  2021-02-15 10:45:46.561 EST 0311 DEBU  pvtdatastorage  Commit -> Committed private data for block  2   e  peer-snapshot-submit  2021-02-15 10:45:46.563 EST 0005 DEBU  comm.tls  ClientHandshake -> Client TLS handshake completed in 793.458µs remoteaddress=127.0.0.1:21005  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0312 DEBU  core.comm  ServerHandshake -> Server TLS handshake completed in 848.75µs server=PeerServer remoteaddress=127.0.0.1:65205  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0313 DEBU  kvledger  processSnapshotMgmtEvents -> Event received channelID=testchannel type=requestAdd blockNumber=0 snapshotInProgress=false  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0314 INFO  kvledger  processSnapshotMgmtEvents -> Converting the snapshot generation request from block number 0 to the latest committed block number channelID=testchannel convertedRequestBlockNumber=1  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0315 INFO  kvledger  add -> Adding new request for snapshot channelID=testchannel blockNumber=1  e  Org1.peer0  2021-02-15 10:45:46.598 EST 0316 DEBU  blkstorage  indexBlock -> Indexing block  blockNum=2, blockHash=  byte{0xf3, 0xd7, 0x8, 0x73, 0x40, 0x17, 0x1a, 0x1d, 0x52, 0x3b, 0xde, 0xc1, 0xc7, 0x93, 0x39, 0xd9, 0x9c, 0xd5, 0x35, 0xb1, 0x86, 0x21, 0x2a, 0x69, 0xaa, 0xf, 0x56, 0xe8, 0x74, 0xa5, 0x70, 0x54} txOffsets=  e  Org1.peer0  txId=c3911b16bbac888a554abe7e2fa6167f38f1aca45fd06959f0e34c775dc26be2 locPointer=offset=71, bytesLength=23741  e  Org1.peer0     e  Org1.peer0  2021-02-15 10:45:46.598 EST 0317 DEBU  blkstorage  indexBlock -> Adding txLoc  fileSuffixNum=0, offset=48641, bytesLength=23741  for tx ID:  c3911b16bbac888a554abe7e2fa6167f38f1aca45fd06959f0e34c775dc26be2  to txid-index  e  Org1.peer0  2021-02-15 10:45:46.598 EST 0318 DEBU  blkstorage  indexBlock -> Adding txLoc  fileSuffixNum=0, offset=48641, bytesLength=23741  for tx number: 0  ID:  c3911b16bbac888a554abe7e2fa6167f38f1aca45fd06959f0e34c775dc26be2  to blockNumTranNum index  e  Org1.peer0  2021-02-15 10:45:46.614 EST 0319 INFO  kvledger  add -> Added new request for snapshot channelID=testchannel blockNumber=1 nextsnapshotblockNumber=1 ...  o  peer-snapshot-submit  Snapshot request submitted successfully STEP: verifying snapshot completed on org1Peer0  d  peer-snapshot-submit  starting peer snapshot listpending --channelID testchannel --peerAddress 127.0.0.1:21005 --tlsRootCertFile /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/ca-certs.pem ...  o  peer-snapshot-submit  Successfully got pending snapshot requests:  1  ...  e  Org1.peer0  2021-02-15 10:45:46.720 EST 032e DEBU  history  Commit -> Channel  testchannel : Updates committed to history database for blockNo  2   e  Org1.peer0  2021-02-15 10:45:46.720 EST 032f INFO  kvledger  commit ->  testchannel  Committed block  2  with 1 transaction(s) in 188ms (state_validation=0ms block_and_pvtdata_commit=117ms state_commit=35ms) commitHash= 5f88b61407b149a48413433f4670c46531e5c4a8febdc339a9536ff8716a559e   e  Org1.peer0  2021-02-15 10:45:46.720 EST 0330 DEBU  kvledger  processSnapshotMgmtEvents -> Event received channelID=testchannel type=commitDone blockNumber=2 snapshotInProgress=false ...  d  peer-snapshot-submit  starting peer snapshot listpending --channelID testchannel --peerAddress 127.0.0.1:21005 --tlsRootCertFile /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/ca-certs.pem  e  peer-snapshot-submit  2021-02-15 10:45:56.758 EST 0001 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:45:56.759 EST 0002 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:45:56.772 EST 0003 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:45:56.774 EST 0004 DEBU  bccsp_sw  openKeyStore -> KeyStore opened at  /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore ...done  e  peer-snapshot-submit  2021-02-15 10:45:56.778 EST 0005 DEBU  comm.tls  ClientHandshake -> Client TLS handshake completed in 1.575167ms remoteaddress=127.0.0.1:21005  e  Org1.peer0  2021-02-15 10:45:56.778 EST 035e DEBU  core.comm  ServerHandshake -> Server TLS handshake completed in 1.638875ms server=PeerServer remoteaddress=127.0.0.1:65211  e  Org1.peer0  2021-02-15 10:45:56.778 EST 035f DEBU  leveldbhelper  GetIterator -> Getting iterator for range    byte{0x74, 0x65, 0x73, 0x74, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x32, 0x0}  -    byte{0x74, 0x65, 0x73, 0x74, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x32, 0x1}   e  Org1.peer0  2021-02-15 10:45:56.778 EST 0360 INFO  comm.grpc.server  1 -> unary call completed grpc.service=protos.Snapshot grpc.method=QueryPendings grpc.peer_address=127.0.0.1:65211 grpc.code=OK grpc.call_duration=272.917µs  o  peer-snapshot-submit  Successfully got pending snapshot requests:  1  ...  d  peer-snapshot-submit  starting peer snapshot listpending --channelID testchannel --peerAddress 127.0.0.1:21005 --tlsRootCertFile /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/ca-certs.pem  e  peer-snapshot-submit  2021-02-15 10:46:06.839 EST 0001 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:46:06.840 EST 0002 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:46:06.854 EST 0003 DEBU  bccsp  GetDefault -> Before using BCCSP, please call InitFactories(). Falling back to bootBCCSP.  e  peer-snapshot-submit  2021-02-15 10:46:06.855 EST 0004 DEBU  bccsp_sw  openKeyStore -> KeyStore opened at  /var/folders/gp/t_36h6md65j0gw522mbvy7180000gn/T/e2e-sd285796601/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/keystore ...done  e  peer-snapshot-submit  2021-02-15 10:46:06.859 EST 0005 DEBU  comm.tls  ClientHandshake -> Client TLS handshake completed in 1.419083ms remoteaddress=127.0.0.1:21005  e  Org1.peer0  2021-02-15 10:46:06.859 EST 037e DEBU  core.comm  ServerHandshake -> Server TLS handshake completed in 1.474041ms server=PeerServer remoteaddress=127.0.0.1:65215  e  Org1.peer0  2021-02-15 10:46:06.860 EST 037f DEBU  leveldbhelper  GetIterator -> Getting iterator for range    byte{0x74, 0x65, 0x73, 0x74, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x32, 0x0}  -    byte{0x74, 0x65, 0x73, 0x74, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x2f, 0x32, 0x1}   e  Org1.peer0  2021-02-15 10:46:06.860 EST 0380 INFO  comm.grpc.server  1 -> unary call completed grpc.service=protos.Snapshot grpc.method=QueryPendings grpc.peer_address=127.0.0.1:65215 grpc.code=OK grpc.call_duration=294.625µs  o  peer-snapshot-submit  Successfully got pending snapshot requests:  1  {code}  ></description> </Issue>
