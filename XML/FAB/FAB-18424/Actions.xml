<Action id="71400" issue="46574" author="sykesm" type="comment" created="2021-02-15 17:33:07.0" updateauthor="sykesm" updated="2021-02-15 17:33:07.0"> <body><! CDATA It appears that the snapshot was requested for {{blockNumber=1}} while block 2 was being processed. {code}  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0314 INFO  kvledger  processSnapshotMgmtEvents -> Converting the snapshot generation request from block number 0 to the latest committed block number channelID=testchannel convertedRequestBlockNumber=1  e  Org1.peer0  2021-02-15 10:45:46.563 EST 0315 INFO  kvledger  add -> Adding new request for snapshot channelID=testchannel blockNumber=1 ...  e  Org1.peer0  2021-02-15 10:45:46.614 EST 0319 INFO  kvledger  add -> Added new request for snapshot channelID=testchannel blockNumber=1 nextsnapshotblockNumber=1 ...  e  Org1.peer0  2021-02-15 10:45:46.720 EST 0330 DEBU  kvledger  processSnapshotMgmtEvents -> Event received channelID=testchannel type=commitDone blockNumber=2 snapshotInProgress=false {code}  The last log record comes from this line in {{snapshot_mgmt.go}}: {code} logger.Infow("Added new request for snapshot", "channelID", k.ledgerID, "blockNumber", blockNumber, "next snapshot blockNumber", k.smallestRequestBlockNum) {code}  I don't know the code but it looks like the go routine below is never initiated because the {{smallestRequestBlockNum}} does not equal {{lastCommittedBlockNumber}} when block 2 processing completes. {code} 		case commitDone: 			lastCommittedBlockNumber = e.blockNumber 			committerStatus = idle 			if lastCommittedBlockNumber != l.snapshotMgr.snapshotRequestBookkeeper.smallestRequestBlockNum { 				continue 			} 			snapshotInProgress = true 			go func() { 				logger.Infow("Generating snapshot", "channelID", l.ledgerID, "lastCommittedBlockNumber", lastCommittedBlockNumber) 				if err := l.generateSnapshot(); err != nil { 					logger.Errorw("Failed to generate snapshot", "channelID", l.ledgerID, "lastCommittedBlockNumber", lastCommittedBlockNumber, "error", err) 				} else { 					logger.Infow("Generated snapshot", "channelID", l.ledgerID, "lastCommittedBlockNumber", lastCommittedBlockNumber) 				} 				events <- &event{snapshotDone, lastCommittedBlockNumber} 			}() {code}  ></body> </Action>
<Action id="71401" issue="46574" author="sykesm" type="comment" body="Initially this looked like a test flake but I think it&apos;s actually an issue in the production code." created="2021-02-15 17:33:41.0" updateauthor="sykesm" updated="2021-02-15 17:33:41.0"/>
<Action id="71403" issue="46574" author="btl5037" type="comment" body="Hit this twice today, no need to provide my logs, they look just like yours" created="2021-02-17 17:20:33.0" updateauthor="btl5037" updated="2021-02-17 17:20:33.0"/>
<Action id="71404" issue="46574" author="manish-sethi" type="comment" body="Thanks  ~sykesm  for sharing the logs. I verified - this is a trivial to fix bug in the production code.  This line|https://github.com/hyperledger/fabric/blob/ecaf6970efdf2e5fde72f7c8ec903d7b3827de8a/core/ledger/kvledger/snapshot_mgmt.go#L153  should be like &quot;leastAcceptableBlockNum += 1&quot;. I am surprised that this never hit before and now suddenly started hitting." created="2021-02-17 22:45:13.0" updateauthor="manish-sethi" updated="2021-02-17 22:46:05.0"/>
<Action id="71405" issue="46574" author="sykesm" type="comment" created="2021-02-17 23:26:34.0" updateauthor="sykesm" updated="2021-02-17 23:34:05.0"> <body><! CDATA It looks like it's one of the untested paths through the code.  !image-2021-02-17-18-25-59-505.png!  With the exception of logging and returning errors, almost every other path is covered so it's simply an unfortunate escape.  Good to see it's an easy fix.  ></body> </Action>
<Action id="71406" issue="46574" author="manish-sethi" type="comment" created="2021-02-18 05:45:57.0" updateauthor="manish-sethi" updated="2021-02-18 21:20:07.0"> <body><! CDATA  https://github.com/hyperledger/fabric/pull/2413  - master   https://github.com/hyperledger/fabric/pull/2418  - release-2.3  ></body> </Action>
