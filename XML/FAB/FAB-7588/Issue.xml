<Issue id="26340" key="FAB-7588" number="7588" project="10002" reporter="rickr" assignee="wlahti" creator="rickr" type="10004" summary="Eventing services completes for transaction but query still shows old value." priority="1" resolution="10000" status="6" created="2018-01-03 16:43:09.0" updated="2018-07-20 14:15:20.0" resolutiondate="2018-01-09 19:35:41.0" votes="0" watches="3" workflowId="40871"> <environment><! CDATA commit f6bb64bea60d6d3498e2be0f053e474ad9731df1 Author: David Enyeart <enyeart@us.ibm.com> Date:   Wed Dec 27 11:27:13 2017 -0500       FAB-7563  Add pvt data capability to configtx.yaml          FAB-6859 introduced V1_1_PVTDATA_EXPERIMENTAL     capability.  This work item adds it to the sample configtx.yaml     so that users know how to configure it.          Change-Id: I14e1fc49caa9193543340cbd885c7988db260ac8     Signed-off-by: David Enyeart <enyeart@us.ibm.com>  ></environment> <description><! CDATA I'm running the SDK a balance transfer example. This issue is not happening locally but when on the build machine it happens quite regularly.    https://gerrit.hyperledger.org/r/#/c/16117/   https://jenkins.hyperledger.org/job/fabric-sdk-java-verify-x86_64/1450/   In this case the txid in question is cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19  We do a query for b value on two peers: 2018-01-03 15:59:33,725 pool-17-thread-1 TRACE CryptoPrimitives:301 - verify :  diagnostic_2018-01-03T15-59-33_724P8429_37_256.bin Query payload of b from peer peer0.org1.example.com returned 325 Query payload of b from peer peer1.org1.example.com returned 325  we send a move of 50 (the CC in this case will double the move value) so we would expect b to have 425   2018-01-03 15:59:34,951 pool-17-thread-1 TRACE CryptoPrimitives:301 - verify :  diagnostic_2018-01-03T15-59-34_951P8429_37_264.bin Successful transaction proposal response Txid: cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19 from peer peer0.org1.example.com Successful transaction proposal response Txid: cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19 from peer peer1.org1.example.com Received 2 transaction proposal responses. Successful+verified: 2 . Failed: 0 Successfully received transaction proposal responses. Sending chaincode transaction(move a,b,50) to orderer.  2018-01-03 15:59:34,998 pool-17-thread-1 DEBUG Channel:2496 - Channel foo successful sent to Orderer transaction id: cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19  now we wait to see on both peers from the peer eventing service that the transaction is done and good.  2018-01-03 15:59:37,393 pool-14-thread-1 DEBUG Channel:3422 - Channel foo seen transaction event cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19 for peer peer1.org1.example.com  2018-01-03 15:59:37,395 pool-14-thread-1 DEBUG Channel:3422 - Channel foo seen transaction event cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19 for peer peer0.org1.example.com   clear the future the tx has been done ok.   2018-01-03 15:59:37,395 pool-14-thread-1 DEBUG Channel:3503 - Completing future for channel foo and transaction id: cf1812994e03d95c20425b882ae9848937a10c50b3f3b57a5afce23433973f19 Now query chaincode on channel foo for the value of b expecting to see: 425    Now query chaincode on channel foo for the value of b expecting to see: 425 2018-01-03 15:59:37,399 pool-17-thread-1 DEBUG ProtoUtils:80 - ChannelHeader: type: ENDORSER_TRANSACTION, version: 1, Txid: 9ca9668f54ee48f98fc64810e58c2ed17af76408971d708044cad93bddb94d76, channelId: foo, epoch 0 2018-01-03 15:59:37,399 pool-17-thread-1 DEBUG ProposalBuilder:196 - ChaincodeInvocationSpec type: GOLANG, chaincode name: example_cc_go, chaincode path: github.com/example_cc, chaincode version: 11 args("invoke", "query", "b") 2018-01-03 15:59:37,399 pool-17-thread-1 DEBUG ProtoUtils:201 - SignatureHeader: nonce: 15c3a589c8a6ebd486dceb8006d3554166d510b1ae997ca2, User:user1, MSPID: Org1MSP, idBytes: 050912538b9d067217eaa5abfbf7f6617d9a6e06e64d6fde57828ff99dc25fa9 2018-01-03 15:59:37,401 pool-17-thread-1 DEBUG Channel:2268 - Channel foo send proposal to peer peer0.org1.example.com at url grpcs://localhost:7051 2018-01-03 15:59:37,401 pool-17-thread-1 TRACE Channel:2272 - Sending to channel foo, peer: peer0.org1.example.com, proposal: protobuf_2018-01-03T15-59-37_401P8429_37_268.proto 2018-01-03 15:59:37,402 pool-17-thread-1 DEBUG Peer:190 - peer.sendProposalAsync name: peer0.org1.example.com, url: grpcs://localhost:7051 2018-01-03 15:59:37,407 pool-17-thread-1 DEBUG Channel:2268 - Channel foo send proposal to peer peer1.org1.example.com at url grpcs://localhost:7056 2018-01-03 15:59:37,408 pool-17-thread-1 TRACE Channel:2272 - Sending to channel foo, peer: peer1.org1.example.com, proposal: protobuf_2018-01-03T15-59-37_408P8429_37_269.proto 2018-01-03 15:59:37,408 pool-17-thread-1 DEBUG Peer:190 - peer.sendProposalAsync name: peer1.org1.example.com, url: grpcs://localhost:7056 2018-01-03 15:59:39,344 pool-17-thread-1 DEBUG Channel:2300 - Channel foo got back from peer peer0.org1.example.com status: 200, message: OK 2018-01-03 15:59:39,346 pool-17-thread-1 TRACE Channel:2303 - Got back from channel foo, peer: peer0.org1.example.com, proposal response: protobuf_2018-01-03T15-59-39_346P8429_37_270.proto 2018-01-03 15:59:39,347 pool-17-thread-1 TRACE ProposalResponse:122 - payload TransactionBuilderbytes:  diagnostic_2018-01-03T15-59-39_347P8429_37_271.bin 2018-01-03 15:59:39,347 pool-17-thread-1 TRACE CryptoPrimitives:301 - verify :  diagnostic_2018-01-03T15-59-39_347P8429_37_272.bin 2018-01-03 15:59:40,327 pool-17-thread-1 DEBUG Channel:2300 - Channel foo got back from peer peer1.org1.example.com status: 200, message: OK 2018-01-03 15:59:40,328 pool-17-thread-1 TRACE Channel:2303 - Got back from channel foo, peer: peer1.org1.example.com, proposal response: protobuf_2018-01-03T15-59-40_328P8429_37_273.proto 2018-01-03 15:59:40,328 pool-17-thread-1 TRACE ProposalResponse:122 - payload TransactionBuilderbytes:  diagnostic_2018-01-03T15-59-40_328P8429_37_274.bin 2018-01-03 15:59:40,328 pool-17-thread-1 TRACE CryptoPrimitives:301 - verify :  diagnostic_2018-01-03T15-59-40_328P8429_37_275.bin Query payload of b from peer peer0.org1.example.com returned 325 org.junit.ComparisonFailure: Failed compare on channel foo chaincode id ChaincodeID(example_cc_go:github.com/example_cc:11) expected value:'425', but got:'325' expected:< 4 25> but was:< 3 25>     at org.junit.Assert.assertEquals(Assert.java:115)     at org.hyperledger.fabric.sdkintegration.End2endAndBackAgainIT.queryChaincodeForExpectedValue(End2endAndBackAgainIT.java:801)     at org.hyperledger.fabric.sdkintegration.End2endAndBackAgainIT.lambda$runChannel$2(End2endAndBackAgainIT.java:456)     at java.util.concurrent.CompletableFuture.uniApply(CompletableFuture.java:602)  ></description> </Issue>
