<Issue id="44191" key="FAB-17458" number="17458" project="10002" reporter="denyeart" assignee="wenjian" creator="denyeart" type="10004" summary="Rolling upgrade - Peer at V1_4_2 capability adds v2.0 lifecycle Sequence in readset" priority="2" resolution="10000" status="6" created="2020-01-30 16:10:09.0" updated="2020-02-06 14:56:23.0" resolutiondate="2020-02-06 14:56:23.0" votes="0" watches="2" workflowId="58092" archived="N"> <description><! CDATA Peer running at V1_4_2 capability should not consider v2.0 _lifecycle at endorsement or validation time. However there are two reads of _lifecycle Sequence in each endorsement:  2020-01-30 11:06:20.969 EST  statecouchdb  GetState -> DEBU 14c GetState(). ns=_lifecycle, key=namespaces/fields/marbles/Sequence goroutine 206  running : runtime/debug.Stack(0x0, 0x0, 0x0) 	/usr/local/go/src/runtime/debug/stack.go:24 +0x9d runtime/debug.PrintStack() 	/usr/local/go/src/runtime/debug/stack.go:16 +0x22 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.(*VersionedDB).GetState(0xc000155340, 0x4f87b50, 0xa, 0xc0000d8ed0, 0x22, 0xff, 0xbf84dd9f39c4a688, 0x15ae13e08) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go:371 +0x12e github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr.(*queryHelper).getState(0xc003204120, 0x4f87b50, 0xa, 0xc0000d8ed0, 0x22, 0x4070c3c, 0x5b2d640, 0xc000460d80, 0x3, 0xc0031e2b70, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr/helper.go:55 +0x8c github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr.(*lockBasedQueryExecutor).GetState(0xc003208060, 0x4f87b50, 0xa, 0xc0000d8ed0, 0x22, 0x0, 0x0, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr/lockbased_query_executer.go:28 +0x66 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*SimpleQueryExecutorShim).GetState(0xc0031f17c0, 0xc0000d8ed0, 0x22, 0x4, 0x4, 0xc0000d8ed0, 0x22, 0xe) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/ledger_shim.go:121 +0x5d github.com/hyperledger/fabric/core/chaincode/lifecycle.(*Serializer).DeserializeField(0xc0000daa38, 0x4f8808c, 0xa, 0xc0023c6f40, 0x7, 0x4f85648, 0x8, 0x515e000, 0xc0031f17c0, 0x20, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/serializer.go:380 +0x19f github.com/hyperledger/fabric/core/chaincode/lifecycle.(*Serializer).DeserializeFieldAsInt64(0xc0000daa38, 0x4f8808c, 0xa, 0xc0023c6f40, 0x7, 0x4f85648, 0x8, 0x515e000, 0xc0031f17c0, 0x5a66060, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/serializer.go:437 +0xa8 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*ChaincodeEndorsementInfoSource).CachedChaincodeInfo(0xc0022daea0, 0xc0023c6f00, 0x9, 0xc0023c6f40, 0x7, 0xa600af0, 0xc003208060, 0x48e5870, 0xc0031e2f70, 0x400ca15, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/endorsment_info.go:65 +0x114 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*ChaincodeEndorsementInfoSource).ChaincodeEndorsementInfo(0xc0022daea0, 0xc0023c6f00, 0x9, 0xc0023c6f40, 0x7, 0xa600af0, 0xc003208060, 0x400ca15, 0x4e9e820, 0x4f5ca20) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/endorsment_info.go:112 +0x1ed github.com/hyperledger/fabric/core/endorser.(*SupportImpl).ChaincodeEndorsementInfo(0xc0022cb5e0, 0xc0023c6f00, 0x9, 0xc0023c6f40, 0x7, 0xa600a60, 0xc003208060, 0x0, 0x0, 0xc0031e3110) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/support.go:131 +0xbf github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposalSuccessfullyOrError(0xc002303f20, 0xc0031ea500, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:386 +0x202 github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposal(0xc002303f20, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:335 +0x380 github.com/hyperledger/fabric/core/handlers/auth/filter.(*expirationCheckFilter).ProcessProposal(0xc0023088a0, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0x4db9d00, 0x0, 0x6e38270) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/expiration.go:61 +0x8f github.com/hyperledger/fabric/core/handlers/auth/filter.(*filter).ProcessProposal(0xc002308840, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0xc002308840, 0x20, 0xfe) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/filter.go:32 +0x51 github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler.func1(0x518dfa0, 0xc0023c5200, 0x4ec6be0, 0xc002275450, 0x0, 0xc0023eedfe, 0x518dfa0, 0xc0023c5200) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:107 +0x86 github.com/hyperledger/fabric/common/grpclogging.UnaryServerInterceptor.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed00, 0x40cf366, 0x5e32fefc, 0x39ac5bc8, 0x4c476bb51fb5e) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpclogging/server.go:92 +0x286 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0x516fd60, 0x5b7fa78, 0x4e40940, 0xbb51eb0b) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63 github.com/hyperledger/fabric/common/grpcmetrics.UnaryServerInterceptor.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed20, 0x45c2bca, 0x4e67a40, 0xc0023eed40, 0xc0023eece0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpcmetrics/interceptor.go:31 +0x1c9 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0003db600, 0xc0023eec60, 0xc0031d5a10, 0x400f378) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed00, 0xc0003e4a80, 0x41eca68, 0x4e9a3e0, 0xc0023c5050) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:34 +0xd5 github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler(0x4db9d00, 0xc002308840, 0x518dfa0, 0xc0023c5050, 0xc0023c1740, 0xc0001c9140, 0x518dfa0, 0xc0023c5050, 0xc0002df200, 0x45c) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:109 +0x14b github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processUnaryRPC(0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600, 0xc002503440, 0x5b2b0c0, 0xc0004b5540, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:995 +0x460 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream(0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600, 0xc0004b5540) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1275 +0xd97 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1(0xc0023c67f0, 0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:710 +0xbb created by github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:708 +0xa1  2020-01-30 11:06:20.999 EST  statecouchdb  GetState -> DEBU 162 GetState(). ns=_lifecycle, key=namespaces/fields/marbles/Sequence goroutine 206  running : runtime/debug.Stack(0x0, 0x0, 0x0) 	/usr/local/go/src/runtime/debug/stack.go:24 +0x9d runtime/debug.PrintStack() 	/usr/local/go/src/runtime/debug/stack.go:16 +0x22 github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb.(*VersionedDB).GetState(0xc000155340, 0x4f87b50, 0xa, 0xc0000d9170, 0x22, 0x8, 0xc0031e2598, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go:371 +0x12e github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr.(*queryHelper).getState(0xc003204120, 0x4f87b50, 0xa, 0xc0000d9170, 0x22, 0x4070c3c, 0x5b2d640, 0xc000460d80, 0x3, 0xc0031e2690, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr/helper.go:55 +0x8c github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr.(*lockBasedQueryExecutor).GetState(0xc003208060, 0x4f87b50, 0xa, 0xc0000d9170, 0x22, 0x0, 0x0, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/txmgr/lockbasedtxmgr/lockbased_query_executer.go:28 +0x66 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*SimpleQueryExecutorShim).GetState(0xc00389c160, 0xc0000d9170, 0x22, 0x4, 0x4, 0xc0000d9170, 0x22, 0x5b62c00) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/ledger_shim.go:121 +0x5d github.com/hyperledger/fabric/core/chaincode/lifecycle.(*Serializer).DeserializeField(0xc0000daa38, 0x4f8808c, 0xa, 0xc0023c6f40, 0x7, 0x4f85648, 0x8, 0x515e000, 0xc00389c160, 0x20, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/serializer.go:380 +0x19f github.com/hyperledger/fabric/core/chaincode/lifecycle.(*Serializer).DeserializeFieldAsInt64(0xc0000daa38, 0x4f8808c, 0xa, 0xc0023c6f40, 0x7, 0x4f85648, 0x8, 0x515e000, 0xc00389c160, 0x20, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/serializer.go:437 +0xa8 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*ChaincodeEndorsementInfoSource).CachedChaincodeInfo(0xc0022daea0, 0xc0023c6f00, 0x9, 0xc0023c6f40, 0x7, 0xa600af0, 0xc003208060, 0x0, 0xc0031e2a90, 0x400ca15, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/endorsment_info.go:65 +0x114 github.com/hyperledger/fabric/core/chaincode/lifecycle.(*ChaincodeEndorsementInfoSource).ChaincodeEndorsementInfo(0xc0022daea0, 0xc0023c6f00, 0x9, 0xc0023c6f40, 0x7, 0xa600af0, 0xc003208060, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/lifecycle/endorsment_info.go:112 +0x1ed github.com/hyperledger/fabric/core/chaincode.(*ChaincodeSupport).CheckInvocation(0xc00024a840, 0xc0031ee200, 0xc0023c6f40, 0x7, 0xc0031ea0f0, 0x30, 0xc003208930, 0xc000099800, 0x68ae460, 0xc000099800) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:211 +0x238 github.com/hyperledger/fabric/core/chaincode.(*ChaincodeSupport).Invoke(0xc00024a840, 0xc0031ee200, 0xc0023c6f40, 0x7, 0xc0031ea0f0, 0x5b7fa78, 0xc0002bebd0, 0xc0031ea0f0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:192 +0x63 github.com/hyperledger/fabric/core/chaincode.(*ChaincodeSupport).Execute(0xc00024a840, 0xc0031ee200, 0xc0023c6f40, 0x7, 0xc0031ea0f0, 0xc0031ea0f0, 0x0, 0x0, 0x515e480) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:155 +0x5d github.com/hyperledger/fabric/core/endorser.(*SupportImpl).Execute(0xc0022cb5e0, 0xc0031ee200, 0xc0023c6f40, 0x7, 0xc0031ea0f0, 0xc0031e2dc0, 0x43e1136, 0x4defb80, 0xc000138698) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/support.go:126 +0x15a github.com/hyperledger/fabric/core/endorser.(*Endorser).callChaincode(0xc002303f20, 0xc0031ee200, 0xc0031ea0f0, 0xc0023c6f40, 0x7, 0x0, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:119 +0x1a2 github.com/hyperledger/fabric/core/endorser.(*Endorser).SimulateProposal(0xc002303f20, 0xc0031ee200, 0xc0023c6f40, 0x7, 0xc0031ea0f0, 0x0, 0x0, 0x0, 0x0, 0x0, ...) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:182 +0xd8 github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposalSuccessfullyOrError(0xc002303f20, 0xc0031ea500, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:392 +0x433 github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposal(0xc002303f20, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0x0, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/endorser/endorser.go:335 +0x380 github.com/hyperledger/fabric/core/handlers/auth/filter.(*expirationCheckFilter).ProcessProposal(0xc0023088a0, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0x4db9d00, 0x0, 0x6e38270) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/expiration.go:61 +0x8f github.com/hyperledger/fabric/core/handlers/auth/filter.(*filter).ProcessProposal(0xc002308840, 0x518dfa0, 0xc0023c5200, 0xc002275450, 0xc002308840, 0x20, 0xfe) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/core/handlers/auth/filter/filter.go:32 +0x51 github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler.func1(0x518dfa0, 0xc0023c5200, 0x4ec6be0, 0xc002275450, 0x0, 0xc0023eedfe, 0x518dfa0, 0xc0023c5200) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:107 +0x86 github.com/hyperledger/fabric/common/grpclogging.UnaryServerInterceptor.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed00, 0x40cf366, 0x5e32fefc, 0x39ac5bc8, 0x4c476bb51fb5e) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpclogging/server.go:92 +0x286 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0x516fd60, 0x5b7fa78, 0x4e40940, 0xbb51eb0b) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63 github.com/hyperledger/fabric/common/grpcmetrics.UnaryServerInterceptor.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed20, 0x45c2bca, 0x4e67a40, 0xc0023eed40, 0xc0023eece0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/common/grpcmetrics/interceptor.go:31 +0x1c9 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0003db600, 0xc0023eec60, 0xc0031d5a10, 0x400f378) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 +0x63 github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1(0x518dfa0, 0xc0023c5050, 0x4ec6be0, 0xc002275450, 0xc0023eece0, 0xc0023eed00, 0xc0003e4a80, 0x41eca68, 0x4e9a3e0, 0xc0023c5050) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:34 +0xd5 github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler(0x4db9d00, 0xc002308840, 0x518dfa0, 0xc0023c5050, 0xc0023c1740, 0xc0001c9140, 0x518dfa0, 0xc0023c5050, 0xc0002df200, 0x45c) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:109 +0x14b github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).processUnaryRPC(0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600, 0xc002503440, 0x5b2b0c0, 0xc0004b5540, 0x0, 0x0) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:995 +0x460 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).handleStream(0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600, 0xc0004b5540) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1275 +0xd97 github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1(0xc0023c67f0, 0xc0001d2b00, 0x519cf40, 0xc00230ed80, 0xc0003db600) 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:710 +0xbb created by github.com/hyperledger/fabric/vendor/google.golang.org/grpc.(*Server).serveStreams.func1 	/Users/denyeart/work/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:708 +0xa1   ></description> </Issue>
