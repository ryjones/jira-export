<Issue id="37168" key="FAB-13907" number="13907" project="10002" reporter="denyeart" assignee="manish-sethi" creator="denyeart" type="10004" summary="Calling DelState() twice results in an unexpected warning when using CouchDB" priority="4" status="10000" created="2019-01-26 11:14:32.0" updated="2020-11-16 20:54:12.0" votes="0" watches="2" workflowId="48746"> <description><! CDATA Calling DelState() for the same key in two different transactions results in an unexpected warning message: {code:java} 2019-01-26 06:04:38.636 EST  statecouchdb  commitUpdates -> WARN 866 CouchDB batch document delete encountered an problem. Retrying delete for document ID:marble1{code} The reason is that upon commit a bulk update is attempted to create/update/delete documents from CouchDB. The second Delete will fail due to non-existing document. The situation should be detected and a more indicative warning message should be provided instead of the current warning message.  Also the retry of the individual delete should be skipped. {code:java} 2019-01-26 06:04:38.623 EST  lockbasedtxmgr  Commit -> DEBU 851 Committing updates to state database 2019-01-26 06:04:38.623 EST  pvtstatepurgemgmt  buildExpirySchedule -> DEBU 852 Building the expiry schedules based on the update batch 2019-01-26 06:04:38.623 EST  lockbasedtxmgr  Commit -> DEBU 853 Write lock acquired for committing updates to state database 2019-01-26 06:04:38.624 EST  statecouchdb  executeBatches -> DEBU 854 Executing batches =  %!s(*statecouchdb.nsCommittersBuilder=&{map marble1:0xc00151ca40  0xc00024f880 map     })  2019-01-26 06:04:38.624 EST  statecouchdb  addRevisionsForMissingKeys -> DEBU 855 Pulling revisions for the  1  keys for namsespace  myc_marbles  that were not part of the readset 2019-01-26 06:04:38.624 EST  statecouchdb  executeBatches -> DEBU 856 Executing batches =  subNsMetadataRetriever:ns=, num keys=1  2019-01-26 06:04:38.624 EST  couchdb  BatchRetrieveDocumentMetadata -> DEBU 857  myc_marbles  Entering BatchRetrieveDocumentMetadata() keys= marble1  2019-01-26 06:04:38.624 EST  couchdb  handleRequest -> DEBU 858 Entering handleRequest() method=POST url=http://127.0.0.1:5984 dbName=myc_marbles 2019-01-26 06:04:38.624 EST  couchdb  handleRequest -> DEBU 859 Request URL: http://127.0.0.1:5984/myc_marbles/_all_docs?include_docs=true 2019-01-26 06:04:38.624 EST  couchdb  handleRequest -> DEBU 85a HTTP Request: POST /myc_marbles/_all_docs?include_docs=true HTTP/1.1 | Host: 127.0.0.1:5984 | User-Agent: Go-http-client/1.1 | Content-Length: 20 | Accept: application/json | Content-Type: application/json | Accept-Encoding: gzip | |  2019-01-26 06:04:38.630 EST  couchdb  handleRequest -> DEBU 85b Exiting handleRequest() 2019-01-26 06:04:38.630 EST  couchdb  BatchRetrieveDocumentMetadata -> DEBU 85c  myc_marbles  HTTP Response: HTTP/1.1 200 OK | Transfer-Encoding: chunked | Cache-Control: must-revalidate | Content-Type: application/json | Date: Sat, 26 Jan 2019 11:04:38 GMT | Server: CouchDB/2.2.0 (Erlang OTP/18) | X-Couch-Request-Id: 277be0c981 | X-Couchdb-Body-Time: 0 | |  2019-01-26 06:04:38.630 EST  couchdb  BatchRetrieveDocumentMetadata -> DEBU 85d  myc_marbles  Exiting BatchRetrieveDocumentMetadata() 2019-01-26 06:04:38.630 EST  statecouchdb  executeBatches -> DEBU 85e Executing batches =  %!s(*statecouchdb.subNsCommitter=&{0xc00024f880 map marble1:0xc001231e00 })  2019-01-26 06:04:38.630 EST  couchdb  BatchUpdateDocuments -> DEBU 85f  myc_marbles  Entering BatchUpdateDocuments() document ids= marble1  2019-01-26 06:04:38.631 EST  couchdb  handleRequest -> DEBU 860 Entering handleRequest() method=POST url=http://127.0.0.1:5984 dbName=myc_marbles 2019-01-26 06:04:38.631 EST  couchdb  handleRequest -> DEBU 861 Request URL: http://127.0.0.1:5984/myc_marbles/_bulk_docs 2019-01-26 06:04:38.631 EST  couchdb  handleRequest -> DEBU 862 HTTP Request: POST /myc_marbles/_bulk_docs HTTP/1.1 | Host: 127.0.0.1:5984 | User-Agent: Go-http-client/1.1 | Content-Length: 72 | Accept: application/json | Content-Type: application/json | Accept-Encoding: gzip | |  2019-01-26 06:04:38.636 EST  couchdb  handleRequest -> DEBU 863 Exiting handleRequest() 2019-01-26 06:04:38.636 EST  couchdb  BatchUpdateDocuments -> DEBU 864  myc_marbles  HTTP Response: HTTP/1.1 201 Created | Content-Length: 75 | Cache-Control: must-revalidate | Content-Type: application/json | Date: Sat, 26 Jan 2019 11:04:38 GMT | Server: CouchDB/2.2.0 (Erlang OTP/18) | X-Couch-Request-Id: 5b19ecb032 | X-Couchdb-Body-Time: 0 | |  2019-01-26 06:04:38.636 EST  couchdb  BatchUpdateDocuments -> DEBU 865  myc_marbles  Exiting BatchUpdateDocuments() _bulk_docs response=  {"id":"marble1","error":"conflict","reason":"Document update conflict."}    2019-01-26 06:04:38.636 EST  statecouchdb  commitUpdates -> WARN 866 CouchDB batch document delete encountered an problem. Retrying delete for document ID:marble1 2019-01-26 06:04:38.636 EST  couchdb  DeleteDoc -> DEBU 867  myc_marbles  Entering DeleteDoc() id=marble1 2019-01-26 06:04:38.636 EST  couchdb  ReadDoc -> DEBU 868  myc_marbles  Entering ReadDoc() id= marble1  2019-01-26 06:04:38.636 EST  couchdb  handleRequest -> DEBU 869 Entering handleRequest() method=GET url=http://127.0.0.1:5984 dbName=myc_marbles 2019-01-26 06:04:38.636 EST  couchdb  handleRequest -> DEBU 86a Request URL: http://127.0.0.1:5984/myc_marbles/marble1?attachments=true 2019-01-26 06:04:38.636 EST  couchdb  handleRequest -> DEBU 86b HTTP Request: GET /myc_marbles/marble1?attachments=true HTTP/1.1 | Host: 127.0.0.1:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Accept-Encoding: gzip | |  2019-01-26 06:04:38.640 EST  couchdb  handleRequest -> DEBU 86c Error handling CouchDB request. Error:not_found, Status Code:404, Reason:deleted 2019-01-26 06:04:38.640 EST  couchdb  ReadDoc -> DEBU 86d  myc_marbles  Document not found (404), returning nil value instead of 404 error 2019-01-26 06:04:38.640 EST  couchdb  handleRequest -> DEBU 86e Entering handleRequest() method=DELETE url=http://127.0.0.1:5984 dbName=myc_marbles 2019-01-26 06:04:38.640 EST  couchdb  handleRequest -> DEBU 86f Request URL: http://127.0.0.1:5984/myc_marbles/marble1 2019-01-26 06:04:38.640 EST  couchdb  handleRequest -> DEBU 870 HTTP Request: DELETE /myc_marbles/marble1 HTTP/1.1 | Host: 127.0.0.1:5984 | User-Agent: Go-http-client/1.1 | Content-Type: application/json | Accept-Encoding: gzip | |  2019-01-26 06:04:38.643 EST  couchdb  handleRequest -> DEBU 871 Error handling CouchDB request. Error:not_found, Status Code:404, Reason:deleted 2019-01-26 06:04:38.643 EST  couchdb  DeleteDoc -> DEBU 872  myc_marbles  Document not found (404), returning nil value instead of 404 error{code}  ></description> </Issue>
