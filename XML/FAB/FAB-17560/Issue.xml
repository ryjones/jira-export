<Issue id="44464" key="FAB-17560" number="17560" project="10002" reporter="skarim" creator="skarim" type="10004" summary="Global var for error and sync.Once" priority="3" resolution="10001" status="6" created="2020-02-28 15:47:05.0" updated="2020-03-02 18:24:42.0" resolutiondate="2020-03-02 18:24:42.0" votes="0" watches="3" workflowId="58372" archived="N"> <description><! CDATA There are a couple of implementations details in BCCSP that makes it difficult to call down into BCCSP with varying configuration.  *First Issue:*  The first issue is the use of sync.Once, see: See:  https://github.com/hyperledger/fabric/blob/v1.4.6/bccsp/factory/pkcs11.go#L39   What this means is that if BCCSP is initialized with bad config (wrong label or pin) when using PKCS11, it has entered into a bad state from which it cannot recover. All subsequent requests, will fail even if the configuration has been corrected and is being passed down to BCCSP.  *Second Issue:*  I used bad HSM config the first time, now I want to switch to using a non-hsm configuration. This use case will not work if the BCCSP library has already encountered an error, unfortunately BCCSP when it gets an error stores that error in a global variable which once sets remains sets. Here:  https://github.com/hyperledger/fabric/blob/master/bccsp/factory/factory.go#L43 * |https://github.com/hyperledger/fabric/blob/master/bccsp/factory/factory.go#L43 *  Even though you might be using a valid configuration after using a bad one, BCCSP will always continue to return that previously hit error and initialization will always fail.  ></description> </Issue>
