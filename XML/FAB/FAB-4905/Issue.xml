<Issue id="18512" key="FAB-4905" number="4905" project="10002" reporter="thirdstage" assignee="mastersingh24" creator="thirdstage" type="10004" summary="Fabric 1.0.0-beta CouchDB docker container image can&apos;t be loaded with host mounted volume." priority="3" resolution="10000" status="6" created="2017-06-21 09:18:48.0" updated="2018-07-20 14:13:32.0" resolutiondate="2017-09-30 09:35:20.0" votes="0" watches="3" workflowId="39215" security="10001"> <description><! CDATA h3. +Problem+  The dockerfile for Fabric CouchDB in 1.0.0-beta ( https://github.com/hyperledger/fabric/blob/v1.0.0-beta/images/couchdb/Dockerfile.in)  has degradation which can cause the container can't be loaded successfully with host directory volume mapping.  Although the following Docker run command would load the container successfully, {quote}docker run -itd \ --name couch1 \ -p 5984:5984 \ hyperledger/fabric-couchdb:x86_64-1.0.0-beta {quote} The next command which has host mounted volume( {{-v ~/docker/opt/couchdb/couch1/data:/opt/couchdb/data}} ) would fail. {quote}docker run -itd \ --name couch1 \ -p 5984:5984 \ -v ~/docker/opt/couchdb/couch1/data:/opt/couchdb/data \ hyperledger/fabric-couchdb:x86_64-1.0.0-beta {quote} With host mounted volume, you can find the following error message via docker logs {quote} os_mon  cpu supervisor port (cpu_sup): Error writing to Erlang {quote}   h3. +Cause+  This is because the {{/opt/couchdb/data}} directory is set to owned by {{root}} user and {{root}} group when created on host mounted volume.  Although the dockerfile ( https://github.com/hyperledger/fabric/blob/v1.0.0-beta/images/couchdb/Dockerfile.in)  contains {{chown -R couchdb:couchdb /opt/couchdb/}} commands before {{VOLUME}} instruction, the {{chown}} command has no effect when the volume is created as an host mounted volume.  From 1.0.0-alpha2, the Fabric CouchDB dockerfile changes the current user to {{couchdb}} ( {{USER couchdb}} instruction in dockerfile) before starting the CouchDB. So the data directory ({{/opt/couchdb/data}} )  on host mounted volume whose owner is set to {{root:root}} is can't be accessed CouchDB instance. h3. +Recommended Solution+  1.0.0-alpha has no problem with host mounted volume on {{/opt/couchdb/data}} where the container is executed as a {{root}} until the entry-point and the entry-point  ({{/docker-entrypoint.sh}} :  https://github.com/hyperledger/fabric/blob/v1.0.0-alpha/images/couchdb/docker-entrypoint.sh)  contains the command to change the owner of {{/opt/couchdb/data}} directory to {{couchdb}} ( {{chown -R couchdb:couchdb /opt/couchdb}} ) before launch the CouchDB.  So, I think it would be better to restore the {{Dockerfile.in}} and {{docker-entrypoint.sh}} file of 1.0.0-alpha.            ></description> </Issue>
