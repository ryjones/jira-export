<Issue id="22807" key="FAB-6738" number="6738" project="10002" reporter="davidkel" assignee="chris.elder" creator="davidkel" type="10004" summary="GetState using CouchDB is frequently failing to return any data." priority="1" resolution="10000" status="6" created="2017-10-24 09:40:47.0" updated="2018-07-20 14:14:45.0" resolutiondate="2017-10-27 22:28:04.0" votes="0" watches="4" workflowId="40343"> <description><! CDATA For a while composer has created composite keys in a specific format and this has worked fine. Since the introduction of a change to the GetState protocol, GetState has not been returning information. Looking in the peer logs I see GetState calls which work {code}  36m2017-10-24 06:30:27.599 UTC  chaincode  func1 -> DEBU d82 0m  9f29b84b  getting state for chaincode systest-accesscontrols, key ï¿½$syscollectionsï¿½$sysregistriesï¿½, channel composerchannel  36m2017-10-24 06:30:27.599 UTC  statecouchdb  GetState -> DEBU d83 0m GetState(). ns=systest-accesscontrols, key=ï¿½$syscollectionsï¿½$sysregistriesï¿½  36m2017-10-24 06:30:27.599 UTC  couchdb  ReadDoc -> DEBU d84 0m Entering ReadDoc()  id= systest-accesscontrolsï¿½ï¿½$syscollectionsï¿½$sysregistriesï¿½   36m2017-10-24 06:30:27.599 UTC  couchdb  handleRequest -> DEBU d85 0m Entering handleRequest()  method=GET  url=http://couchdb.org1.example.com:5984/composerchannel/systest-accesscontrols%00%00$syscollections%00$sysregistries%00?attachments=true  36m2017-10-24 06:30:27.600 UTC  couchdb  handleRequest -> DEBU d86 0m HTTP Request: GET /composerchannel/systest-accesscontrols%00%00$syscollections%00$sysregistries%00?attachments=true HTTP/1.1 | Host: couchdb.org1.example.com:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Accept-Encoding: gzip |  |   36m2017-10-24 06:30:27.601 UTC  couchdb  handleRequest -> DEBU d87 0m Exiting handleRequest()  36m2017-10-24 06:30:27.601 UTC  couchdb  ReadDoc -> DEBU d88 0m Exiting ReadDoc()  36m2017-10-24 06:30:27.601 UTC  chaincode  func1 -> DEBU d89 0m  9f29b84b Got state. Sending RESPONSE  36m2017-10-24 06:30:27.601 UTC  chaincode  1 -> DEBU d8a 0m  9f29b84b handleGetState serial send RESPONSE {code} And this key generates the correct url to query couchdb.  However we have many examples where an incorrect url is being generated. For example {code}  36m2017-10-24 06:30:27.585 UTC  chaincode  func1 -> DEBU d75 0m  9f29b84b  getting state for chaincode systest-accesscontrols, key ï¿½$sysregistriesï¿½Asset:org.hyperledger.composer.system.Identityï¿½, channel composerchannel  36m2017-10-24 06:30:27.585 UTC  statecouchdb  GetState -> DEBU d76 0m GetState(). ns=systest-accesscontrols, key=ï¿½$sysregistriesï¿½Asset:org.hyperledger.composer.system.Identityï¿½  36m2017-10-24 06:30:27.585 UTC  couchdb  ReadDoc -> DEBU d77 0m Entering ReadDoc()  id= systest-accesscontrolsï¿½ï¿½$sysregistriesï¿½Asset:org.hyperledger.composer.system.Identityï¿½   36m2017-10-24 06:30:27.585 UTC  couchdb  handleRequest -> DEBU d78 0m Entering handleRequest()  method=GET  url=http://couchdb.org1.example.com:5984/composerchannel/.%2Fsystest-accesscontrols%00%00$sysregistries%00Asset:org.hyperledger.composer.system.Identity%00?attachments=true  36m2017-10-24 06:30:27.585 UTC  couchdb  handleRequest -> DEBU d79 0m HTTP Request: GET /composerchannel/.%2Fsystest-accesscontrols%00%00$sysregistries%00Asset:org.hyperledger.composer.system.Identity%00?attachments=true HTTP/1.1 | Host: couchdb.org1.example.com:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Accept-Encoding: gzip |  |   36m2017-10-24 06:30:27.587 UTC  couchdb  handleRequest -> DEBU d7a 0m Couch DB Error:not_found,  Status Code:404,  Reason:missing  36m2017-10-24 06:30:27.587 UTC  couchdb  ReadDoc -> DEBU d7b 0m Document not found (404), returning nil value instead of 404 error  36m2017-10-24 06:30:27.587 UTC  chaincode  func1 -> DEBU d7c 0m  9f29b84b No state associated with key:  ?ï¿½$sysregistriesï¿½Asset:org.hyperledger.composer.system.Identityï¿½. Sending RESPONSE with an empty payload  36m2017-10-24 06:30:27.587 UTC  chaincode  1 -> DEBU d7d 0m  9f29b84b handleGetState serial send RESPONSE {code} the peer is incorrectly adding '.%2F' to the front of the url which makes the url incorrect for the data it wants to query and returns nothing. There doesn't appear to be a problem with PutState as I can see the data is created in CouchDB This is a blocker for hyperledger composer.  ></description> </Issue>
