<Action id="23183" issue="16060" author="adnanchoudhury" type="comment" created="2017-04-28 22:10:11.0" updateauthor="adnanchoudhury" updated="2017-04-28 22:10:11.0"> <body><! CDATA Notes: 1) The error is observed if the number of chains exceed 200, and changing the number of parallel transactions allowed  (from 1 to 1000) does not effect the occurrence of the error. 2)  It does not look like an HTTP issue as putting timer between each PUT operation does not effect the occurrence of the error. 3) setting the `max_dbs_open` config parameter to a high value (1000) did not effect the occurrence  of the error.  ></body> </Action>
<Action id="23218" issue="16060" author="denyeart" type="comment" created="2017-05-01 13:12:05.0" updateauthor="denyeart" updated="2017-05-01 13:12:05.0"> <body><! CDATA  ~AdnanChoudhury  You're saying that if you have 1 channel (or even a few), you cannot introduce the error?  Only if there is massive parallel writes to couchdb (as implied by 200+ channels) do you see the error?  ></body> </Action>
<Action id="23225" issue="16060" author="adnanchoudhury" type="comment" created="2017-05-01 14:30:25.0" updateauthor="adnanchoudhury" updated="2017-05-01 14:56:50.0"> <body><! CDATA  ~denyeart  yes to first part, the error is *not* there if the number of channels (i.e. number of chains) are 100 or 150, and its there when the number is 200 or more. As far as the parallel write goes, its a bit more complicated, ----The parallel writes in the tests can either be via multiple chains, or via multiple clients working on the same chain. I see this error only when high number of chains but *not* on low number of chains, even if the multiple parallel client write number is high.   Edit: log to passing and failing scenarioo attached.   ^output_1-parallel_vary-numchain_3.txt     ></body> </Action>
<Action id="23236" issue="16060" author="denyeart" type="comment" created="2017-05-01 18:59:53.0" updateauthor="denyeart" updated="2017-05-01 19:01:00.0"> <body><! CDATA  ~AdnanChoudhury  Perhaps looking at the couchdb stats would help identify if something is crossing a threshold around 200 parallel chains. To see couchdb stats you can go into the couchdb container and get the _stats API response: docker exec -it couchdb /bin/bash curl -X GET http://127.0.0.1:5986/_stats  Note that _stats is only available at the 'internal admin' port 5986 which is not exposed outside the container.  ></body> </Action>
<Action id="23237" issue="16060" author="adnanchoudhury" type="comment" body="Thanks  ~denyeart  , let me check." created="2017-05-01 19:12:50.0" updateauthor="adnanchoudhury" updated="2017-05-01 19:12:50.0"/>
<Action id="23357" issue="16060" author="adnanchoudhury" type="comment" created="2017-05-03 18:43:17.0" updateauthor="adnanchoudhury" updated="2017-05-03 18:47:06.0"> <body><! CDATA This error was due to the "max number of open files" in the host being the bottleneck. The Couch container resides on the host, and databases created on the container creates file operations on the host, and if the number of databases are high, the number of open files in the host become high and hits the limit. Once it hits the limit, the Couch starts spewing read and write errors.  Increasing the max number of open files is straightforward in Ubuntu and linux variants via "ulimit -n \{desired_value\}". In a Mac, its little more involved. This bug was encountered in a Mac OS Sierra, and simply running "ulimit ...." did not work. To increase the max open file limit, (details here: https://unix.stackexchange.com/questions/108174/how-to-persist-ulimit-settings-in-osx-mavericks) a file needs to be created named `/Library/LaunchDaemons/limit.maxfiles.plist` with root ownership that has the following text:   {code:java} <?xml version="1.0" encoding="UTF-8"?>   <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"   "http://www.apple.com/DTDs/PropertyList-1.0.dtd"> <plist version="1.0">   <dict> <key>Label</key> <string>limit.maxfiles</string> <key>ProgramArguments</key> <array> <string>launchctl</string> <string>limit</string> <string>maxfiles</string> <string>524288</string> <string>524288</string> </array> <key>RunAtLoad</key> <true/> <key>ServiceIPC</key> <false/> </dict> </plist>   {code} And then restart the machine. The tests run as expected after that.  ></body> </Action>
<Action id="23436" issue="16060" author="denyeart" type="comment" created="2017-05-06 09:55:11.0" updateauthor="denyeart" updated="2017-05-06 09:55:11.0"> <body><! CDATA Let's keep this bug open until it is resolved by documentation updates.  ~nickgaski  I'm assigning this one to you.  We will need to document that ulimit needs to be set to a high value when there are many channels in the network and CouchDB used as state database.  This is because there is a CouchDB database per channel which consumes many files on the OS (on the host OS even if CouchDB is in docker). I wasn't sure where this fits best in current documentation.  Seems we need a setup area.   ~AdnanChoudhury  As a reference point, in your trial with 200 channels, what was the original value for number of files, and what setting resolved it?  ></body> </Action>
<Action id="23617" issue="16060" author="adnanchoudhury" type="comment" body=" ~nickgaski   ~denyeart  the default maxfiles was 256, changed it to 524288 and it worked for me." created="2017-05-09 19:55:12.0" updateauthor="adnanchoudhury" updated="2017-05-09 19:55:12.0"/>
<Action id="24982" issue="16060" author="scottz" type="comment" created="2017-06-01 18:22:19.0" updateauthor="scottz" updated="2017-06-01 18:22:19.0"> <body><! CDATA 1. Since this is now a doc issue, should we change component to fabric-doc?  2. I question whether Nick should be handling this. Is this change really required in the read-the-docs section for basic setup, for ALL fabric developers/testers to use? Or do we need to modify a readme.md somewhere in the tests folders, so dev/testers can see this info when setting up and running the tests? These tests are not part of the unit tests; they are run as part of the daily test suite - or can be run manually.  ></body> </Action>
<Action id="24985" issue="16060" author="adnanchoudhury" type="comment" body="To partially response to question 2 by  ~scottz , after a discussion (between  ~nickgaski ,  ~denyeart , me) on what should be the right place for this info, it was decided that a &quot;Troubleshooting&quot; or similar section would be an appropriate place. Some discussion can e seen here ( https://gerrit.hyperledger.org/r/#/c/9249/)  This issue can be faced by any user of Fabric, and not just a user of the tests, so this should not be confined in test docs only. " created="2017-06-01 18:31:52.0" updateauthor="adnanchoudhury" updated="2017-06-01 18:32:35.0"/>
<Action id="25330" issue="16060" author="markparz" type="comment" body="I agree with  ~scottz  that at min there needs to be a link from the config to how to config the different platforms, as this will be a pervasive issue." created="2017-06-05 13:41:07.0" updateauthor="markparz" updated="2017-06-05 13:41:07.0"/>
<Action id="26480" issue="16060" author="markparz" type="comment" body=" ~nickgaski  you have a merge conflict on this and I know you are doing some updates as well. Can you add this in the troubleshooting guide at the same time: https://jira.hyperledger.org/browse/FAB-4594" created="2017-06-15 21:00:29.0" updateauthor="markparz" updated="2017-06-15 21:00:29.0"/>
<Action id="26633" issue="16060" author="nickgaski" type="comment" created="2017-06-16 22:13:38.0" updateauthor="nickgaski" updated="2017-06-16 22:13:38.0"> <body><! CDATA addressed here -  https://gerrit.hyperledger.org/r/#/c/10719/  .      I feel we should continue adding to this doc, as it will help us aggregate many config issues, which can then be ported to a more standard setup/config type doc  ></body> </Action>
