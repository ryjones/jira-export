<Issue id="27934" key="FAB-8458" number="8458" project="10002" reporter="aleksandar.likic" creator="aleksandar.likic" type="10004" summary="Peer out of memory, trying to allocate 842GB" priority="3" resolution="10203" status="6" created="2018-02-22 22:07:59.0" updated="2018-12-01 11:36:59.0" resolutiondate="2018-12-01 11:36:59.0" votes="0" watches="4" workflowId="43052"> <description><! CDATA Last night one of our peers ran out of memory. At one point, we observed that the peer went unresponsive (not available for client transaction requests). In logs we found that the peer has just restarted. Apparently, the peer was waiting for chaincodes to initialize. User CC logs were not present, which to us looked like the CCs failed initialization. We redeployed Fabric to get the system running again.     Peer Log:  runtime: out of memory: cannot allocate 842394632192-byte block (314507264 in use)  fatal error: out of memory     runtime stack:  runtime.throw(0x13ee5cc, 0xd)          /opt/go/src/runtime/panic.go:605 +0x95  runtime.largeAlloc(0xc422a148bb, 0x9f0100, 0x1ffffffffffffff)          /opt/go/src/runtime/malloc.go:829 +0x114  runtime.mallocgc.func1()          /opt/go/src/runtime/malloc.go:722 +0x46  runtime.systemstack(0xc420023900)          /opt/go/src/runtime/asm_amd64.s:344 +0x79  runtime.mstart()          /opt/go/src/runtime/proc.go:1135     goroutine 1710  running :  runtime.systemstack_switch()          /opt/go/src/runtime/asm_amd64.s:298 fp=0xc425b82e00 sp=0xc425b82df8 pc=0x9ff8d0  runtime.mallocgc(0xc422a148bb, 0x0, 0x1300000, 0x1)          /opt/go/src/runtime/malloc.go:721 +0x7ae fp=0xc425b82ea8 sp=0xc425b82e00 pc=0x9b5a4e  runtime.rawstring(0xc422a148bb, 0x0, 0x0, 0x0, 0x0, 0x0)          /opt/go/src/runtime/string.go:245 +0x6a fp=0xc425b82ed8 sp=0xc425b82ea8 pc=0x9ed23a  runtime.rawstringtmp(0x0, 0xc422a148bb, 0xc425b82f60, 0x9b663d, 0xc42233de28, 0xc427224980, 0xc4227387c0)          /opt/go/src/runtime/string.go:115 +0x6f fp=0xc425b82f18 sp=0xc425b82ed8 pc=0x9ecc2f  runtime.concatstrings(0x0, 0xc425b82ff8, 0x2, 0x2, 0x1b4d620, 0xc426003e60)          /opt/go/src/runtime/string.go:46 +0x10a fp=0xc425b82fb0 sp=0xc425b82f18 pc=0x9ec75a  runtime.concatstring2(0x0, 0xc422a148a0, 0xc422a148b0, 0x13ed01c, 0xb, 0xc425b83040, 0xc427224980)          /opt/go/src/runtime/string.go:55 +0x47 fp=0xc425b82ff0 sp=0xc425b82fb0 pc=0x9ec957  github.com/hyperledger/fabric/core/common/privdata.BuildCollectionKVSKey(...)          /opt/gopath/src/github.com/hyperledger/fabric/core/common/privdata/collection.go:106  github.com/hyperledger/fabric/core/peer.(*collectionSupport).GetCollectionKVSKey(0xc4218ca080, 0xc422a3aff0, 0xf, 0xc422a14870, 0xc422a14880, 0xc422a148c0, 0xc422a148d0, 0xc422a148a0, 0xc422a148b0, 0xc42211b8c0, ...)          /opt/gopath/src/github.com/hyperledger/fabric/core/peer/peer.go:749 +0x59 fp=0xc425b83038 sp=0xc425b82ff0 pc=0x111a689  github.com/hyperledger/fabric/core/common/privdata.(*simpleCollectionStore).retrieveCollectionConfigPackage(0xc4218ca090, 0xc422a3aff0, 0xf, 0xc422a14870, 0xc422a14880, 0xc422a148c0, 0xc422a148d0, 0xc422a148a0, 0xc422a148b0, 0x0, ...)          /opt/gopath/src/github.com/hyperledger/fabric/core/common/privdata/store.go:58 +0x2c6 fp=0xc425b83258 sp=0xc425b83038 pc=0x10237f6  github.com/hyperledger/fabric/core/common/privdata.(*simpleCollectionStore).retrieveCollectionConfig(0xc4218ca090, 0xc422a3aff0, 0xf, 0xc422a14870, 0xc422a14880, 0xc422a148c0, 0xc422a148d0, 0xc422a148a0, 0xc422a148b0, 0x138b620, ...)          /opt/gopath/src/github.com/hyperledger/fabric/core/common/privdata/store.go:76 +0x60 fp=0xc425b83328 sp=0xc425b83258 pc=0x1023ce0  github.com/hyperledger/fabric/core/common/privdata.(*simpleCollectionStore).retrieveSimpleCollection(0xc4218ca090, 0xc422a3aff0, 0xf, 0xc422a14870, 0xc422a14880, 0xc422a148c0, 0xc422a148d0, 0xc422a148a0, 0xc422a148b0, 0xc425b83668, ...)          /opt/gopath/src/github.com/hyperledger/fabric/core/common/privdata/store.go:97 +0x60 fp=0xc425b83420 sp=0xc425b83328 pc=0x1023fa0  github.com/hyperledger/fabric/core/common/privdata.(*simpleCollectionStore).RetrieveCollectionAccessPolicy(0xc4218ca090, 0xc422a3aff0, 0xf, 0xc422a14870, 0xc422a14880, 0xc422a148c0, 0xc422a148d0, 0xc422a148a0, 0xc422a148b0, 0x9b5695, ...)          /opt/gopath/src/github.com/hyperledger/fabric/core/common/privdata/store.go:114 +0x48 fp=0xc425b83490 sp=0xc425b83420 pc=0x1024348  github.com/hyperledger/fabric/gossip/privdata.(*puller).computeFilters(0xc423004300, 0xc423fbce10, 0xc42734df1b, 0x5, 0xc42734df20)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/privdata/pull.go:375 +0x1d5 fp=0xc425b836b8 sp=0xc425b83490 pc=0x10f6b25  github.com/hyperledger/fabric/gossip/privdata.(*puller).fetch(0xc423004300, 0xc423fbce10, 0xc423fbce10, 0x0, 0xc423fbce10, 0xd900000000000003, 0xc420021300)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/privdata/pull.go:208 +0x50 fp=0xc425b83808 sp=0xc425b836b8 pc=0x10f3e40  github.com/hyperledger/fabric/gossip/privdata.(*coordinator).fetchFromPeers(0xc422eb3900, 0xcc, 0xc422494d20, 0xc427604c30)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/privdata/coordinator.go:259 +0xe8 fp=0xc425b83af0 sp=0xc425b83808 pc=0x10e75a8  github.com/hyperledger/fabric/gossip/privdata.(*coordinator).StoreBlock(0xc422eb3900, 0xc42b6d7dc0, 0x0, 0x0, 0x0, 0x9b65a6, 0xc4230e3e08)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/privdata/coordinator.go:189 +0x648 fp=0xc425b83dc8 sp=0xc425b83af0 pc=0x10e63b8  github.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).commitBlock(0xc4218f5a80, 0xc42b6d7dc0, 0x0, 0x0, 0x0, 0x0, 0x0)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:781 +0x7d fp=0xc425b83e70 sp=0xc425b83dc8 pc=0x1105e5d  github.com/hyperledger/fabric/gossip/state.(*GossipStateProviderImpl).deliverPayloads(0xc4218f5a80)          /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:561 +0x411 fp=0xc425b83fd8 sp=0xc425b83e70 pc=0x1103a11  runtime.goexit()          /opt/go/src/runtime/asm_amd64.s:2337 +0x1 fp=0xc425b83fe0 sp=0xc425b83fd8 pc=0xa02501  created by github.com/hyperledger/fabric/gossip/state.NewGossipStateProvider          /opt/gopath/src/github.com/hyperledger/fabric/gossip/state/state.go:253 +0x6d3     ></description> </Issue>
