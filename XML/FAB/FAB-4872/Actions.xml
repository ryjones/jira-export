<Action id="26835" issue="18342" author="denyeart" type="comment" created="2017-06-20 11:35:08.0" updateauthor="denyeart" updated="2017-06-20 11:35:08.0"> <body><! CDATA  ~chris.elder  max_dbs_open default value of 8000 (1000 databases) has been added to local.ini in FAB-4243.  Could you summarize the final FAB-4243 recommendations into the Description of this item, so that they can be documented?  e.g. the Linux and Mac recommended settings for ephemeral ports, as well as a mention of ulimit and max_dbs_open.  So that doc authors can simply look at Description here, rather than parse through all the details in FAB-4243 comments.  ></body> </Action>
<Action id="26849" issue="18342" author="chris.elder" type="comment" created="2017-06-20 14:18:23.0" updateauthor="chris.elder" updated="2017-06-20 14:18:23.0"> <body><! CDATA Settings for large numbers of channels:  1. The ulimit for open files needs to be adequate for handling the large number of open files.  ulimit -n 40000  2. The max_dbs_open setting in the CouchDB refers to the maximum number of open shards. In the default settings, each database (channel) will have 8 shards. For a concurrency of 1000 channels, the minimum setting of max_dbs_open would be 8000. max_dbs_open = number of channels * shards per database (q)   couchdb  max_dbs_open = 8000   Settings for high concurrency:  1. High concurrency requires a port of each CouchDB connection. For high concurrency, the number of ephemeral ports can be exhausted causing failed connections to CouchDB.  Linux:  Review the range of ephemeral ports:  sysctl net.ipv4.ip_local_port_range  Review the FIN-WAIT-2 timeout:  sysctl net.ipv4.tcp_fin_timeout   a. Increase the number of ephemeral ports to increase the number of possible socket connections:  sudo sysctl -w net.ipv4.ip_local_port_range="20000 60999"  b. Reduce the timeout for sockets to remain in the FIN-WAIT-2 state before timing out to 5 seconds.  sudo sysctl -w net.ipv4.tcp_fin_timeout="5"   MacOS:  Review the range of ephemeral ports:  sysctl net.inet.ip.portrange.first net.inet.ip.portrange.last  Review the maximum segment lifetime.  sysctl net.inet.tcp.msl  sysctl net.inet.tcp.msl  a. Increase the number of ephemeral ports to increase the number of possible socket connections:  sudo sysctl -w net.inet.ip.portrange.first=20000  sudo sysctl -w net.inet.ip.portrange.last=65535   b. Reduce the maximum segment lifetime (in milliseconds)  sudo sysctl -w net.inet.tcp.msl=5000  ></body> </Action>
<Action id="33228" issue="18342" author="markparz" type="comment" created="2017-10-26 16:07:20.0" updateauthor="markparz" updated="2017-10-26 16:08:17.0"> <body><! CDATA updated ledger doc...  https://gerrit.hyperledger.org/r/c/14891/       ~chris.elder   ~denyeart  if you can take a look I added an additional note based off this defect and the other one that this branched from.  ></body> </Action>
<Action id="33381" issue="18342" author="markparz" type="comment" created="2017-10-30 18:45:49.0" updateauthor="markparz" updated="2017-10-30 19:06:00.0"> <body><! CDATA Based on conversation with  ~denyeart  ... here is my proposed update for S.O. at least for a stop gap until we create a real "tuning guide":     Issue: CouchDB error:  2017-05-30 14:24:07.695 EDT  couchdb  handleRequest -> DEBU 2c45 HTTP Request: GET /chain_0008/testChaincode%00key_000000222?attachments=true HTTP/1.1 | Host: 127.0.0.1:5984 | User-Agent: Go-http-client/1.1 | Accept: multipart/related | Accept-Encoding: gzip |  |  2017-05-30 14:24:07.695 EDT  couchdb  ReadDoc -> DEBU 2c41 couchDBReturn=<nil> panic: Error:Get  http://127.0.0.1:5984/chain_0006/testChaincode%00key_000000269?attachments=true:  EOF  Answer:  This is likely an issue with concurrency and not enough resources available. You will need to increase the maximum number of open files descriptors. This can be done with :  First verify you have enough system resource allocated to the shell:  ulimit -a  When running at a high volume you probably would want something like 40000. To increase the ulimit use the following command:  ulimit -n 40000  Now for the CouchDB specific settings. CouchDB uses Least Recently Used (LRU) cache to manage open databases, and closes databases as needed. The current default setting is 8000, which should handle a fairly significant currency load. Deployments with large numbers of channels and high concurrency may need to increase this setting. Specify the number of database shards that can be open concurrently. Beware too high of a setting can impact your local resources since this is utilizing more memory resources.  To increase the maximum number of open shards in CouchDB edit fabric/images/couchdb/local.ini change  max_open_dbs=8000  This default setting is set so each database(channel) will have 8 shards. Meaning, for concurrency of 1000 channels the minimum setting of max_dbs_open would be 8000 (our current default). max_dbs_open=number of channels * shards per database.  After these setting changes you will then build your image.     ></body> </Action>
