<Action id="43810" issue="28919" author="anikitindsr" type="comment" created="2018-05-04 10:36:09.0" updateauthor="anikitindsr" updated="2018-05-04 10:36:09.0"> <body><! CDATA Reasons: - need to create migration script from leveldb to rocksdb storage while indy-node upgrading  Changes: - created migrations script  Versions: indy-node: 1.3.399-master indy-plenum: 1.2.347-master  Risks: - This migrations needs to recreating rocksdb storage from leveldb. Therefore, if upgrade procedure will failed, than storages can be restored only from backup.   ></body> </Action>
<Action id="43978" issue="28919" author="vladimirwork" type="comment" created="2018-05-07 10:07:33.0" updateauthor="vladimirwork" updated="2018-05-14 15:31:48.0"> <body><! CDATA PoA:  Build Info:  indy-node 1.3.395 indy-plenum 1.2.342 / indy-node=1.3.375 indy-plenum=1.2.317 python3-indy-crypto=0.4.0 python3-base58=0.2.4 / python3-base58=0.2.4 libindy-crypto=0.1.6 python3-indy-crypto=0.1.6 indy-plenum=1.2.180 indy-node=1.2.223   Preconditions: Pool ledger should be filled with  0 (genesis only) / 100 / 10k  txns before upgrade.  Cases: 1. Upgrade to current master all nodes with force=False. 2. Upgrade to current master all nodes with force=True simultaneously. 3. Upgrade to current master without one node with force=True. 4. Manual upgrade of single node (from Step 3).  Expected Results: Upgrade should finish successfully (there should be no errors/stacktraces in logs/node service status). Pool should write new txns and read txns that were added *before and after* upgrade. Check /usr/local/lib/python3.5/dist-packages/plenum/config.py for the next entries:  {noformat} domainStateStorage = KeyValueStorageType.Rocksdb poolStateStorage = KeyValueStorageType.Rocksdb configStateStorage = KeyValueStorageType.Rocksdb reqIdToTxnStorage = KeyValueStorageType.Rocksdb {noformat}    ></body> </Action>
<Action id="44035" issue="28919" author="vladimirwork" type="comment" created="2018-05-08 08:06:55.0" updateauthor="vladimirwork" updated="2018-05-08 08:06:55.0"> <body><! CDATA Build Info: indy-node 1.3.395 indy-plenum 1.2.342  Steps to Reproduce: 1. Install pool. 2. Upgrade pool from 395 to 404 version. 3. Check journalctl.   Actual Results: There are no migrations applied during upgrade:  ^journal.txt    {noformat} | _create_backup | Creating backup for 1.3.395 | migrate | Migrating from 1.3.395 to 1.3.404 on Ubuntu | migrate | Found migration scripts:  '1_0_96_to_1_0_97', '1_1_150_to_1_1_151', '1_2_188_to_1_2_189', '1_2_233_to_1_2_234', '1_2_273_to_1_2_274', 'disabled_1_0_97_to_1_0_96', 'helper_1_0_96_to_1_0_97'  | migrate | No migrations can be applied to the current code. | _remove_old_backups | Removing old backups | _call_restart_node_script | Restarting indy {noformat}  Expected Results: Migration script from leveldb to rocksdb should be applied.  ></body> </Action>
<Action id="44157" issue="28919" author="anikitindsr" type="comment" created="2018-05-10 07:21:24.0" updateauthor="anikitindsr" updated="2018-05-10 07:21:24.0"> <body><! CDATA Versions: indy-node: 1.3.406  ></body> </Action>
<Action id="44165" issue="28919" author="vladimirwork" type="comment" created="2018-05-10 09:33:46.0" updateauthor="vladimirwork" updated="2018-05-10 09:33:46.0"> <body><! CDATA Build Info: indy-node 1.3.395 indy-plenum 1.2.342  Steps to Reproduce: 1. Install pool. 2. Upgrade pool from 395 to 406 version. 3. Check journalctl.  Actual Results: There are errors during migration applying:  {noformat} May 10 09:21:46 da0258d2f24a env 67 : 2018-05-10 09:21:46,820 | INFO     | migration_tool.py    (  52) | migrate | Migrating from 1.3.395 to 1.3.406 on Ubuntu May 10 09:21:46 da0258d2f24a env 67 : 2018-05-10 09:21:46,827 | DEBUG    | migration_tool.py    (  54) | migrate | Found migration scripts:  '1_0_96_to_1_0_97', '1_1_150_to_1_1_151', '1_2_188_to_1_2_189', May 10 09:21:46 da0258d2f24a env 67 : 2018-05-10 09:21:46,829 | INFO     | migration_tool.py    (  61) | migrate | Following migrations will be applied:  '1_3_396_to_1_3_397'  May 10 09:21:46 da0258d2f24a env 67 : 2018-05-10 09:21:46,831 | INFO     | migration_tool.py    (  63) | migrate | Applying migration 1_3_396_to_1_3_397 May 10 09:21:46 da0258d2f24a env 67 : 2018-05-10 09:21:46,831 | INFO     | migration_tool.py    (  35) | _call_migration_script | script path /usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3 May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,120 | INFO     | 1_3_396_to_1_3_397.py ( 149) | migrate_all | Starting migration of storages from LevelDB to RocksDB... May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,186 | ERROR    | 1_3_396_to_1_3_397.py (  96) | migrate_storage | None May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,186 | ERROR    | 1_3_396_to_1_3_397.py (  97) | migrate_storage | Could not put key/value to RocksDB storage 'pool_transactions' May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,187 | ERROR    | 1_3_396_to_1_3_397.py ( 112) | migrate_storages | Could not migrate pool_transactions, DB path: /var/lib/indy/sandbox/data/Node1/ May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,187 | ERROR    | 1_3_396_to_1_3_397.py ( 154) | migrate_all | Storages migration from LevelDB to RocksDB failed! May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,188 | INFO     | 1_3_396_to_1_3_397.py ( 196) | <module> | Migration from LevelDB to RocksDB failed! May 10 09:21:48 da0258d2f24a env 67 : Traceback (most recent call last): May 10 09:21:48 da0258d2f24a env 67 :   File "/usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_396_to_1_3_397.py", line 94, in migrate_storage May 10 09:21:48 da0258d2f24a env 67 :     rocksdb_storage.put(key, val) May 10 09:21:48 da0258d2f24a env 67 :   File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb.py", line 52, in put May 10 09:21:48 da0258d2f24a env 67 :     self._db.put(key, value) May 10 09:21:48 da0258d2f24a env 67 :   File "rocksdb/_rocksdb.pyx", line 1467, in rocksdb._rocksdb.DB.put May 10 09:21:48 da0258d2f24a env 67 :   File "rocksdb/_rocksdb.pyx", line 103, in rocksdb._rocksdb.bytes_to_slice May 10 09:21:48 da0258d2f24a env 67 : TypeError: expected bytes, bytearray found May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,380 | ERROR    | migration_tool.py    (  44) | _call_migration_script | Migration failed: script returned 1 May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,380 | DEBUG    | node_control_tool.py ( 178) | _restore_from_backup | Restoring from backup for 1.3.395 May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,381 | WARNING  | node_control_tool.py ( 185) | _restore_from_backup | Copying last_version failed due to  Errno 2  No such file or directory: '/va May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,381 | WARNING  | node_control_tool.py ( 185) | _restore_from_backup | Copying next_version failed due to  Errno 2  No such file or directory: '/va May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,381 | WARNING  | node_control_tool.py ( 185) | _restore_from_backup | Copying upgrade_log failed due to  Errno 2  No such file or directory: '/var May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,381 | WARNING  | node_control_tool.py ( 185) | _restore_from_backup | Copying last_version_file failed due to  Errno 2  No such file or directory: May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,381 | WARNING  | node_control_tool.py ( 185) | _restore_from_backup | Copying restart_log failed due to  Errno 2  No such file or directory: '/var May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,521 | WARNING  | node_control_tool.py ( 194) | _restore_from_backup | Copying last_version failed due to  Errno 2  No such file or directory: '/tm May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,536 | WARNING  | node_control_tool.py ( 194) | _restore_from_backup | Copying next_version failed due to  Errno 2  No such file or directory: '/tm May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,537 | WARNING  | node_control_tool.py ( 194) | _restore_from_backup | Copying upgrade_log failed due to  Errno 2  No such file or directory: '/tmp May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,537 | WARNING  | node_control_tool.py ( 194) | _restore_from_backup | Copying last_version_file failed due to  Errno 2  No such file or directory: May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,537 | WARNING  | node_control_tool.py ( 194) | _restore_from_backup | Copying restart_log failed due to  Errno 2  No such file or directory: '/tmp May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,537 | ERROR    | node_control_tool.py ( 271) | _declare_upgrade_failed | Upgrade from 1.3.395 to 1.3.406 failed: Migration failed: script returned May 10 09:21:48 da0258d2f24a env 67 : 2018-05-10 09:21:48,538 | ERROR    | node_control_tool.py ( 238) | _upgrade | Trying to rollback to the previous version Migration failed: script returned 1 {noformat}  Pool upgrade failed due to this errors.  Expected Results: Upgrade and migration from leveldb to rocksdb should be performed successfully.  ></body> </Action>
<Action id="44191" issue="28919" author="anikitindsr" type="comment" created="2018-05-10 15:02:57.0" updateauthor="anikitindsr" updated="2018-05-10 15:02:57.0"> <body><! CDATA Version: 1.3.410  ></body> </Action>
<Action id="44416" issue="28919" author="vladimirwork" type="comment" created="2018-05-15 11:19:57.0" updateauthor="vladimirwork" updated="2018-05-15 11:19:57.0"> <body><! CDATA Build Info: indy-node 1.3.410  Actual Results: All cases from PoA passed except upgrade from indy-node=1.2.223 (upgrade and migration works but pool has lost working capacity after it, INDY-1330 was reported).  ></body> </Action>
