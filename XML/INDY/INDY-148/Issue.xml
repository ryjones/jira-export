<Issue id="17472" key="INDY-148" number="148" project="10303" reporter="dsurnin" creator="dsurnin" type="10004" summary="Node crashed during the startup catchup if run with ledger file deleted" priority="3" resolution="10200" status="10001" created="2017-06-05 10:09:12.0" updated="2019-03-29 20:33:42.0" resolutiondate="2019-03-29 20:33:42.0" votes="0" watches="2" workflowId="17476"> <description><! CDATA install client and node in one machine from rc repo;  run 4 nodes locally as described https://github.com/sovrin-foundation/sovrin-node/blob/master/docs/Sovrin_Running_Locally.md;  run load_test.py to generate transactions;  on running node1 delete ledger file   ~/.sovrin/data/nodes/Node1/transactions_sandbox/1  stop and rerun node1;  have crash log like this {code:java} 2017-06-05 12:51:14,849 | DEBUG | ledger_manager.py ( 416) | processCatchupRep | Node1 found 104 transactions in the catchup from Node2 2017-06-05 12:51:14,849 | DEBUG | ledger_manager.py ( 433) | processCatchupRep | Node1 merging all received catchups 2017-06-05 12:51:14,849 | DEBUG | ledger_manager.py ( 439) | processCatchupRep | Node1 merged catchups, there are 207 of them now, from 105 to 311 2017-06-05 12:51:14,849 | DEBUG | ledger_manager.py ( 447) | processCatchupRep | Node1 processed 0 catchup replies with sequence numbers    2017-06-05 12:51:14,854 | TRACE | zstack.py ( 611) | _receiveFromListener | Node1 got 1 messages through listener 2017-06-05 12:51:14,858 | DEBUG | node.py (1190) | validateNodeMsg | Node1 received node message from Node4: CATCHUP_REP(ledgerId=1, txns={'29': {'txnTime': None, 'signature': '4iGGY5rCMBsUcCR1Uu1XypMqrZKk92B2B9BebGFEuwJhA3pXYAAogUySCUjVtC1KTw7UuPjgQYmKisJvvpjyZMFK', 'reqId': 1496413055063127, 'hash': None, 'verkey': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'enc': None, 'identifier': 'FYmoFw55GeQH7SRFa37dkx1d2dZ3zUF8ckg7wmL7ofN4', 'alias': None, 'type': '1', 'ref': None, 'raw': None, 'data': None, 'role': '101', 'dest': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'signature_type': None},... 2017-06-05 12:51:14,865 | INFO | node.py (1149) | handleOneNodeMsg | Node1 msg validated ({'ledgerId': 1, 'txns': {'29': {'txnTime': None, 'signature': '4iGGY5rCMBsUcCR1Uu1XypMqrZKk92B2B9BebGFEuwJhA3pXYAAogUySCUjVtC1KTw7UuPjgQYmKisJvvpjyZMFK', 'reqId': 1496413055063127, 'hash': None, 'verkey': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'enc': None, 'identifier': 'FYmoFw55GeQH7SRFa37dkx1d2dZ3zUF8ckg7wmL7ofN4', 'alias': None, 'type': '1', 'ref': None, 'raw': None, 'data': None, 'role': '101', 'dest': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'signature_type': None},... 2017-06-05 12:51:14,866 | DEBUG | node.py (1216) | postToNodeInBox | Node1 appending to nodeInbox CATCHUP_REP(ledgerId=1, txns={'29': {'txnTime': None, 'signature': '4iGGY5rCMBsUcCR1Uu1XypMqrZKk92B2B9BebGFEuwJhA3pXYAAogUySCUjVtC1KTw7UuPjgQYmKisJvvpjyZMFK', 'reqId': 1496413055063127, 'hash': None, 'verkey': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'enc': None, 'identifier': 'FYmoFw55GeQH7SRFa37dkx1d2dZ3zUF8ckg7wmL7ofN4', 'alias': None, 'type': '1', 'ref': None, 'raw': None, 'data': None, 'role': '101', 'dest': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'signature_type': None},... 2017-06-05 12:51:14,867 | DEBUG | ledger_manager.py ( 411) | processCatchupRep | Node1 received catchup reply from Node4: CATCHUP_REP(ledgerId=1, txns={'29': {'txnTime': None, 'signature': '4iGGY5rCMBsUcCR1Uu1XypMqrZKk92B2B9BebGFEuwJhA3pXYAAogUySCUjVtC1KTw7UuPjgQYmKisJvvpjyZMFK', 'reqId': 1496413055063127, 'hash': None, 'verkey': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'enc': None, 'identifier': 'FYmoFw55GeQH7SRFa37dkx1d2dZ3zUF8ckg7wmL7ofN4', 'alias': None, 'type': '1', 'ref': None, 'raw': None, 'data': None, 'role': '101', 'dest': '2Rxwpp75WXypqkuwbzhBvEXKTzwUG6Q6w1eJhUSuXnrz', 'signature_type': None},... 2017-06-05 12:51:14,925 | DEBUG | ledger_manager.py ( 416) | processCatchupRep | Node1 found 104 transactions in the catchup from Node4 2017-06-05 12:51:14,925 | DEBUG | ledger_manager.py ( 433) | processCatchupRep | Node1 merging all received catchups 2017-06-05 12:51:14,926 | DEBUG | ledger_manager.py ( 439) | processCatchupRep | Node1 merged catchups, there are 311 of them now, from 1 to 311 2017-06-05 12:51:14,935 | DEBUG | ledger_manager.py ( 543) | hasValidCatchupReplies | Node1 verifying proof for 104, 311, b'z{\x86\xc8u\x08ZU\x02\x81\xbf\xad\x90Uj@\x07m2uI\xc0mmr\x84\xca\x1f3\xb9L:', b's\xe6\xb4M\xd8\x03\xfd\x7f\xae\xf3E\x918j\xa5\xfd\xc9,`\x06\x9d\xe8\x8b x\xdb\x198\x16\x82xl',  b'\x997YT\xabB\xc7B\xcb?\xb4\x90S\xf0\xd3\xbb\xd5\xe8W\x19\xaa\xb47\x99\to\x1fv\xb4\xe5\x99\x1a', b"Y\xfd`\xc0\x1bl\x8f\xaf\xdf\xdb\xe3'\x89\xff\x83\xda.0\xd6\x1b\xce\x11J\x93O\xfe,\xaf\xc7\x07\x87U", b")\xcb\x80\xf0k\xa7\x97\xda\xa0\xef\xc8\x8a\xef,\xa0\xb9PT\xdbE\xfa\xa3'\xf3\xd0H\x17 rb\x1f{", b'\x0fX\xcb\x1e/\xee\xb0;I8Fb\xb3aO\xca\xd7\xd9c\xb9\x03>\x93gQ&\x1d\xe2\x9b\xa1\x12\x19', b'K*\x84 \xb5aq\x82\xba\xf5\x0fv\xa5\x84\x8aw"\x96+\x89\xba\xc1\xe7\xe7\r\x1c\x0bd\xe7b\x86\xb7', b'\xfe\xc9\xf1\xf2\xb1\x941t\xe8\x9a\xd7\x85r\xe5O\x0c\x82\x07\xf3T-8\x10J\x11FJL\xafd\xbe\x05', b"9wC\x879\xeaC\x90z\xabs\x0f\xfaY{\xca\xd3\xcc\xc6>A8'_\xcd.\x14\\\x8csv\xe1"  2017-06-05 12:51:14,954 | WARNING | base_events.py (1308) | _run_once | Executing <Task finished coro=<Looper.runForever() done, defined at /usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py:213> exception=AttributeError("'NoneType' object has no attribute 'encode'",)> took 0.319 seconds 2017-06-05 12:51:14,954 | INFO | looper.py ( 267) | shutdown | Looper shutting down now... Traceback (most recent call last): File "/usr/local/bin/start_sovrin_node", line 49, in <module> looper.run() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 284, in __exit__ self.shutdownSync() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 280, in shutdownSync self.loop.run_until_complete(self.shutdown()) File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete return future.result() File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result raise self._exception File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 270, in shutdown await self.runFut File "/usr/lib/python3.5/asyncio/futures.py", line 363, in __iter__ return self.result() # May raise too. File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result raise self._exception File "/usr/local/bin/start_sovrin_node", line 49, in <module> looper.run() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 254, in run return self.loop.run_until_complete(what) File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete return future.result() File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result raise self._exception File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 218, in runForever await self.runOnceNicely() File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 202, in runOnceNicely msgsProcessed = await self.prodAllOnce() File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 147, in prodAllOnce s += await n.prod(limit) File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/sovrin_node/server/node.py", line 348, in prod c = await super().prod(limit) File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 649, in prod c += await self.serviceNodeMsgs(limit) File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 684, in serviceNodeMsgs await self.processNodeInBox() File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1226, in processNodeInBox await self.nodeMsgRouter.handle(m) File "/usr/lib/python3.5/asyncio/coroutines.py", line 105, in __next__ return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 63, in handle res = self.handleSync(msg) File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 52, in handleSync return self.getFunc(msg 0 )(*msg) File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 442, in processCatchupRep catchUpReplies) File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 476, in _processCatchupReplies ledgerInfo.postTxnAddedToLedgerClbk(ledgerId, txn) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1414, in postTxnFromCatchupAddedToLedger self.updateSeqNoMap( txn ) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1899, in updateSeqNoMap txn F.seqNo.name ) for txn in committedTxns) File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/req_id_to_txn.py", line 28, in addBatch for identifier, reqId, seqNo in batch ) File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/req_id_to_txn.py", line 28, in <listcomp> for identifier, reqId, seqNo in batch ) File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/req_id_to_txn.py", line 18, in getKey h.update(identifier.encode()) AttributeError: 'NoneType' object has no attribute 'encode'{code}  ></description> </Issue>
