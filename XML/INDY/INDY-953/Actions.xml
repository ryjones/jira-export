<Action id="34756" issue="24001" author="ashcherbakov" type="comment" created="2017-11-20 08:10:02.0" updateauthor="ashcherbakov" updated="2017-11-20 14:12:41.0"> <body><! CDATA *Problems* There were multiple issues related to Upgrade: 1) Upgrade on Node4 didn't happen because the Node crashed once it gets NODE_UPGRADE request from other Nodes that already upgraded. Once Upgraded, other Nodes start using protocol version with all requests. Node 4 doesn't understand it before Upgrade and crashes. 2) There is a number of view changes during Upgrade (because Primary gets upgraded).  This caused cancel-schedule entry in Upgrade log for each Upgrade. 3) View changes also caused multiple SUCCESS NODE_UPGRADE txns.  *Changes* 1) Fixed by not sending protocol version for NODE_UPGRADE txns 2) Fixed by checking if we've already scheduled the same Upgrade (no need to cancel-reschedule it) 3) Fixed by changing the logic of how we decide that NODE_UPGRADE txn needs to be sent (have a flag based on Started Upgrade log event; see INDY-799)  *PR*: - to stable: https://github.com/hyperledger/indy-node/pull/460 (as a hotfix)  *New tests*: - test_node_upgrade_unsuccessful.py - test_node_upgrade_rescheduled_view_change.py - test_node_upgrade_no_protocol_version.py - test_node_upgrade_in_progress_no_protocol_version.py - test_node_upgrade_in_progress.py - test_node_upgrade.py  *Builds*: - rc: 1.2.46 - master: 1.2.214  ></body> </Action>
<Action id="34774" issue="24001" author="vladimirwork" type="comment" created="2017-11-20 17:01:14.0" updateauthor="vladimirwork" updated="2017-11-20 17:01:14.0"> <body><! CDATA Build Info: indy-node 1.2.46  Steps to Reproduce: 1. Install 1.2.46 pool. 2. Schedule upgrade: send POOL_UPGRADE name=upgrade_to_the_latest_full version=1.2.46 sha256=ed0a366b4ef36d40c055672a8b83679e99246fec71a706b4ae4cb7958feace3f action=start schedule={'Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv': '2017-11-17T13:47:00.258870+00:00', '8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb': '2017-11-17T13:52:00.258870+00:00', 'DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya': '2017-11-17T13:57:00.258870+00:00', '4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA': '2017-11-17T14:02:00.258870+00:00'} timeout=10 force=False reinstall=False 3. Check the 4th node after its upgrade time.  Actual Results: Pool is upgraded normally.  ></body> </Action>
