<Action id="60551" issue="30288" author="ashcherbakov" type="comment" created="2019-05-31 09:47:29.0" updateauthor="ashcherbakov" updated="2019-08-16 09:06:58.0"> <body><! CDATA *PoA* * `prepared` and `preprepared` should have a list of BatchIDs instead of a list of PrePrepares * Correctly update shared state by dedicated services only ** Ordering: last_ordered_3pc, prepared, prepared ** Checkpointer: checkpoints, stableCheckpoints, lowWatermark, highWatermark ** ViewChanger: primaries. primaryName, viewNo, waitingForNewView * Propagate View change stages to other services via Internal Messages ** NeedViewChange: *** by ViewChangeService: **** starts View Change ** ViewChangeStarted (sent by ViewChangeService) *** by OrderingService: **** Clear 3PC log (prepares/preapares/commits) **** Save all PrePrepares to a list old_view_pre_prepares **** Reset uncommitted state ** ViewChangeFinished (sent by ViewChangeService) *** by CheckpointerService **** updates stable checkpoint ** ApplyNewView (sent by CheckpointerService) *** by OrderingService: * Create a new `*3PCValidator*` class that mostly copies the existing one and performs validation as follows: ** for 3PC messages (PrePrepare, Prepare, Commit) + ApplyNewView msg: *** Stash if **** Catchup in progress **** Future view **** above upper watermark **** waiting for new view (except NewView) *** Discard if **** below watermark **** old view **** already ordered (for PrePrepares only) *** Process otherwise **** it includes processing of already ordered prepares and commits * Make changes in *Orderer* service: ** Make sure that PREPAREs and COMMITs are sent for every 3PC Batch regardless if it's ordered or not ** Do not re-apply PRE_PREPARE if it's already ordered (however send Prepare) ** Do not Order already ordered requests once a quorum of COMMITs is received ** Clear old_view_pre_prepares on GC     ></body> </Action>
<Action id="62988" issue="30288" author="ashcherbakov" type="comment" created="2019-08-16 13:25:57.0" updateauthor="ashcherbakov" updated="2019-08-16 13:25:57.0"> <body><! CDATA Done according to PoA: * Implemented message-based communication between services during view change * Update shared data by dedicated services (Ordering: last_ordered_3pc, prepared, prepared, Checkpointer: checkpoints, stableCheckpoints, lowWatermark, highWatermark, ViewChanger: primaries. primaryName, viewNo, waitingForNewView) * More unit tests for ViewChangeService * Implemented new message validation for Ordering Service * Implemented a first version of applying New View by Ordering service * Improved message validation * get rid of some old code  PR:  https://github.com/hyperledger/indy-plenum/pull/1297      Tests: *  plenum/test/view_change/test_re_order_pre_prepares.py|https://github.com/hyperledger/indy-plenum/pull/1297/files#diff-586bf767b906c4838a760dff1e65fa7e  * plenum/test/consensus/view_change/test_view_change_service.py * plenum/test/consensus/order_service/test_ordering_service_on_view_change.py * plenum/test/consensus/order_service/test_ordering_process_commit.py * plenum/test/consensus/order_service/test_ordering_msg_validator.py  ></body> </Action>
