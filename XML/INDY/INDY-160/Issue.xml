<Issue id="17560" key="INDY-160" number="160" project="10303" reporter="alexander.shekhovcov" assignee="danielhardman" creator="alexander.shekhovcov" type="10004" summary="Pool failure after upgrade (Unicorn)" priority="3" resolution="10200" status="10001" created="2017-06-06 14:02:45.0" updated="2019-03-29 20:33:56.0" resolutiondate="2019-03-29 20:33:56.0" votes="0" watches="3" timeoriginalestimate="28800" timeestimate="28800" workflowId="17564"> <description><! CDATA *Steps:* # Before I came to the pool (shakedown 2) Node 2 had crashed with (looks like a separate issue)  {code:java} May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1004, in serviceReplicaInBox May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : msgCount += replica.serviceQueues(limit) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 522, in serviceQueues May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self.node.isParticipating) else 0 May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 438, in send3PCBatch May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : ppReq = self.create3PCBatch(lid) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 479, in create3PCBatch May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self.processReqDuringBatch(req, validReqs, inValidReqs, rejects) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 456, in processReqDuringBatch May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self.node.applyReq(req) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/sovrin_node/server/node.py", line 393, in applyReq May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : return super().applyReq(request) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1485, in applyReq May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : return self.domainRequestApplication(request) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1491, in domainRequestApplication May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : return self.reqHandler.apply(request) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/domain_req_handler.py", line 52, in apply May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self.updateState(txnsWithSeqNo(start, end,  txn )) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/plenum/server/domain_req_handler.py", line 66, in updateState May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self._updateStateWithSingleTxn(txn, isCommitted=isCommitted) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/sovrin_node/server/domain_req_handler.py", line 56, in _updateStateWithSingleTxn May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : self._addAttr(txn) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/sovrin_node/server/domain_req_handler.py", line 339, in _addAttr May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : attr_key, value = parse(txn) May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : File "/usr/local/lib/python3.5/dist-packages/sovrin_node/server/domain_req_handler.py", line 328, in parse May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : key, _ = data.popitem() May 29 14:06:23 singaporeShakeP2.qatest.evernym.com start_sovrin_node 9347 : KeyError: 'popitem(): dictionary is empty'{code}       2. the _data_ folder is moved to _data-06_11-45_  3. the pool restarted  4. successful POOL_UPGRADE  {code:java} send POOL_UPGRADE name=upgrade-060617 version=0.3.129 sha256=aad1242 action=start schedule={'Gw6pDLhcBcoQesN72q fotTgFa7cbuqZpkX3Xo6pLhPhv': '2017-06-06T15:55:00.258870+03:00', '8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb': '2017-06-06 T16:00:00.258870+03:00', 'DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya':'2017-06-06T16:05:00.258870+03:00','4PS3EDQ3dW1tci1B p6543CfuuebjFrg36kLAUcskGfaA':'2017-06-06T16:10:00.258870+03:00'} timeout=10 {code} 5. after the nodes are upgraded each node's log contains infinite  {code:java} ... 2017-06-06 14:08:58,602 | DEBUG | replica.py ( 823) | isNextPrePrepare | Node2:1 missing PRE-PREPAREs between 2 and 0 2017-06-06 14:08:58,616 | DEBUG | replica.py ( 823) | isNextPrePrepare | Node2:1 missing PRE-PREPAREs between 2 and 0 2017-06-06 14:08:58,629 | DEBUG | replica.py ( 823) | isNextPrePrepare | Node2:1 missing PRE-PREPAREs between 2 and 0 2017-06-06 14:08:58,642 | DEBUG | replica.py ( 823) | isNextPrePrepare | Node2:1 missing PRE-PREPAREs between 2 and 0 ...{code} the pool is not functional   ></description> </Issue>
