<Action id="52015" issue="34564" author="anikitindsr" type="comment" created="2018-10-10 14:15:22.0" updateauthor="anikitindsr" updated="2018-10-10 14:15:22.0"> <body><! CDATA After logs and code analizing was noticed the next problem:  All the token plugin's related packages have not expected version representation, like sovtoken (= 0.9.4+1.59). Node_control_tool is parsing output of apt command for package to update and expect, that version will be in SemVer style, like 0.9.4. But for now, packages sovtoken and sovtokenfees will be not included in deps list and will be not used in apt-get install command. Also this packages are held. For solving it we can:  1) Fix it in node_control_tool side. But this fix will not be included in currently running node_control_tool.  2) Fix version representation for sovtoken and sovtokenfees packages.  ></body> </Action>
<Action id="52092" issue="34564" author="anikitindsr" type="comment" created="2018-10-11 12:24:54.0" updateauthor="anikitindsr" updated="2018-10-11 12:24:54.0"> <body><! CDATA Reasons: * need to fix upgrade procedure from sovrin with plugins to newest version with plugins  Changes: * fix dependency tree building  Versions: * indy-node: rc 1.6.75 * indy-plenum: rc 1.6.53 * sovrin: rc 1.1.27  Reqcomendations for QA: * upgrade sovrin package from version with plugins to sovrin version 1.1.27  ></body> </Action>
<Action id="52151" issue="34564" author="vladimirwork" type="comment" created="2018-10-12 10:27:27.0" updateauthor="vladimirwork" updated="2018-10-12 10:27:27.0"> <body><! CDATA Build Info: sovrin=1.1.24 indy-node=1.6.73 indy-plenum=1.6.51 python3-indy-crypto=0.4.3 libindy-crypto=0.4.3 sovtoken=0.9.3+12.58 sovtokenfees=0.9.3+13.58  Steps to Reproduce: 1. Install sovrin 1.1.24 (0.9.3~ plugins dependency) pool. 2. Try to upgrade it to sovrin 1.1.27 (0.9.5~ plugins dependency) using POOL_UPGRADE command. 3. Check package versions and journalctl.  Actual Result: Upgrade is failed. {noformat} Oct 12 10:00:00 e08efcd808a0 env 72 : WARNING: apt does not have a stable CLI interface. Use with caution in scripts. Oct 12 10:00:12 e08efcd808a0 env 72 : + deps='sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27' Oct 12 10:00:12 e08efcd808a0 env 72 : + ' ' -z 'sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27' ' ' Oct 12 10:00:12 e08efcd808a0 env 72 : + echo 'Try to donwload indy version sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1. Oct 12 10:00:12 e08efcd808a0 env 72 : Try to donwload indy version sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27 Oct 12 10:00:12 e08efcd808a0 env 72 : + apt-get -y update Oct 12 10:00:12 e08efcd808a0 env 72 : Hit:1 http://archive.ubuntu.com/ubuntu xenial InRelease Oct 12 10:00:12 e08efcd808a0 env 72 : Hit:2 http://security.ubuntu.com/ubuntu xenial-security InRelease Oct 12 10:00:12 e08efcd808a0 env 72 : Hit:3 http://archive.ubuntu.com/ubuntu xenial-updates InRelease Oct 12 10:00:12 e08efcd808a0 env 72 : Hit:4 http://archive.ubuntu.com/ubuntu xenial-backports InRelease Oct 12 10:00:13 e08efcd808a0 env 72 : Hit:5 https://repo.sovrin.org/deb xenial InRelease Oct 12 10:00:15 e08efcd808a0 env 72 : Reading package lists... Oct 12 10:00:15 e08efcd808a0 env 72 : + apt-get --download-only -y --allow-downgrades --allow-change-held-packages install sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27 Oct 12 10:00:16 e08efcd808a0 env 72 : Reading package lists... Oct 12 10:00:16 e08efcd808a0 env 72 : Building dependency tree... Oct 12 10:00:16 e08efcd808a0 env 72 : Reading state information... Oct 12 10:00:16 e08efcd808a0 env 72 : indy-anoncreds is already the newest version (1.0.11). Oct 12 10:00:16 e08efcd808a0 env 72 : Some packages could not be installed. This may mean that you have Oct 12 10:00:16 e08efcd808a0 env 72 : requested an impossible situation or if you are using the unstable Oct 12 10:00:16 e08efcd808a0 env 72 : distribution that some required packages have not yet been created Oct 12 10:00:16 e08efcd808a0 env 72 : or been moved out of Incoming. Oct 12 10:00:16 e08efcd808a0 env 72 : The following information may help to resolve the situation: Oct 12 10:00:16 e08efcd808a0 env 72 : The following packages have unmet dependencies: Oct 12 10:00:16 e08efcd808a0 env 72 :  python3-indy-crypto : Depends: libindy-crypto (= 0.4.5) but 0.4.3 is to be installed Oct 12 10:00:16 e08efcd808a0 env 72 : E: Unable to correct problems, you have held broken packages. Oct 12 10:00:16 e08efcd808a0 env 72 : + ret=100 Oct 12 10:00:16 e08efcd808a0 env 72 : + ' ' 100 -ne 0 ' ' Oct 12 10:00:16 e08efcd808a0 env 72 : + echo 'Failed to obtain sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27' Oct 12 10:00:16 e08efcd808a0 env 72 : Failed to obtain sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.75 sovrin=1.1.27 Oct 12 10:00:16 e08efcd808a0 env 72 : + exit 1 Oct 12 10:00:16 e08efcd808a0 env 72 : Upgrade from 1.1.24 to 1.1.27 failed: upgrade script failed, exit code is 1 Oct 12 10:00:16 e08efcd808a0 env 72 : Trying to rollback to the previous version upgrade script failed, exit code is 1 {noformat}   ></body> </Action>
<Action id="52245" issue="34564" author="vladimirwork" type="comment" created="2018-10-15 10:35:24.0" updateauthor="vladimirwork" updated="2018-10-15 10:35:24.0"> <body><! CDATA Build Info: sovrin=1.1.24 indy-node=1.6.73 indy-plenum=1.6.51 python3-indy-crypto=0.4.3 libindy-crypto=0.4.3 sovtoken=0.9.3+12.58 sovtokenfees=0.9.3+13.58  Steps to Reproduce: 1. Install sovrin 1.1.24 (0.9.3~ plugins dependency) pool. 2. Try to upgrade it to sovrin 1.1.29 (0.9.5~ plugins dependency) using POOL_UPGRADE command with *force=False*. 3. Try to upgrade it to sovrin 1.1.29 (0.9.5~ plugins dependency) using POOL_UPGRADE command with *force=True*. 4. Check package versions and journalctl.  Actual Result: 1. Upgrade with *force=False* is not triggered - there is no upgrade log created and no entries in journalctl about upgrade (but it is present in config ledger). 2. Upgrade with *force=True* is triggered successfully but is failed: {noformat} Oct 15 10:16:58 410be396e052 env 74 : WARNING: apt does not have a stable CLI interface. Use with caution in scripts. Oct 15 10:17:13 410be396e052 env 74 : + deps='sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1.29' Oct 15 10:17:13 410be396e052 env 74 : + ' ' -z 'sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1.29' ' ' Oct 15 10:17:13 410be396e052 env 74 : + echo 'Try to donwload indy version sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1. Oct 15 10:17:13 410be396e052 env 74 : Try to donwload indy version sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1.29 Oct 15 10:17:13 410be396e052 env 74 : + apt-get -y update Oct 15 10:17:13 410be396e052 env 74 : Hit:1 http://archive.ubuntu.com/ubuntu xenial InRelease Oct 15 10:17:13 410be396e052 env 74 : Hit:2 http://archive.ubuntu.com/ubuntu xenial-updates InRelease Oct 15 10:17:13 410be396e052 env 74 : Hit:3 http://archive.ubuntu.com/ubuntu xenial-backports InRelease Oct 15 10:17:13 410be396e052 env 74 : Hit:4 http://security.ubuntu.com/ubuntu xenial-security InRelease Oct 15 10:17:14 410be396e052 env 74 : Hit:5 https://repo.sovrin.org/deb xenial InRelease Oct 15 10:17:16 410be396e052 env 74 : Reading package lists... Oct 15 10:17:16 410be396e052 env 74 : + apt-get --download-only -y --allow-downgrades --allow-change-held-packages install sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 Oct 15 10:17:17 410be396e052 env 74 : Reading package lists... Oct 15 10:17:17 410be396e052 env 74 : Building dependency tree... Oct 15 10:17:17 410be396e052 env 74 : Reading state information... Oct 15 10:17:17 410be396e052 env 74 : indy-anoncreds is already the newest version (1.0.11). Oct 15 10:17:17 410be396e052 env 74 : Some packages could not be installed. This may mean that you have Oct 15 10:17:17 410be396e052 env 74 : requested an impossible situation or if you are using the unstable Oct 15 10:17:17 410be396e052 env 74 : distribution that some required packages have not yet been created Oct 15 10:17:17 410be396e052 env 74 : or been moved out of Incoming. Oct 15 10:17:17 410be396e052 env 74 : The following information may help to resolve the situation: Oct 15 10:17:17 410be396e052 env 74 : The following packages have unmet dependencies: Oct 15 10:17:18 410be396e052 env 74 :  python3-indy-crypto : Depends: libindy-crypto (= 0.4.5) but 0.4.3 is to be installed Oct 15 10:17:18 410be396e052 env 74 :  sovrin : Depends: libindy-crypto (= 0.4.5) but 0.4.3 is to be installed Oct 15 10:17:18 410be396e052 env 74 : E: Unable to correct problems, you have held broken packages. Oct 15 10:17:18 410be396e052 env 74 : + ret=100 Oct 15 10:17:18 410be396e052 env 74 : + ' ' 100 -ne 0 ' ' Oct 15 10:17:18 410be396e052 env 74 : + echo 'Failed to obtain sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1.29' Oct 15 10:17:18 410be396e052 env 74 : Failed to obtain sovtokenfees=0.9.5 sovtoken=0.9.5 indy-anoncreds=1.0.11 python3-indy-crypto=0.4.5 indy-plenum=1.6.53 indy-node=1.6.76 sovrin=1.1.29 Oct 15 10:17:18 410be396e052 env 74 : + exit 1 Oct 15 10:17:18 410be396e052 env 74 : Upgrade from 1.1.24 to 1.1.29 failed: upgrade script failed, exit code is 1 Oct 15 10:17:18 410be396e052 env 74 : Trying to rollback to the previous version upgrade script failed, exit code is 1 {noformat}   ></body> </Action>
<Action id="52256" issue="34564" author="ashcherbakov" type="comment" created="2018-10-15 12:44:21.0" updateauthor="ashcherbakov" updated="2018-10-16 06:31:55.0"> <body><! CDATA *PoA for developers:* # Create a new RC of IndyNode=1.6.77 with the same code, but pointing to the previous Plenum (1.6.52) which depends on python3-indy-crypto=0.4.3 # Create a new RC of IndyNode=1.6.78 with the same code, but pointing to Plenum (1.6.53) which depends on python3-indy-crypto=0.4.5 # Create a new RC of Sovrin=1.1.30 depending on Indy-Node=1.6.78 and latest plugins (0.9.5)  *PoA for QA:* # Test STN Upgrade: ** Install sovrin=1.1.24 (emulate different versions of libindy-crypto < 0.4.3) ** Update libindy-crypto manually to 0.4.5 ** Run POOL_UPGRADE for sovrin=1.1.30 (non-forced) # Test SLN Upgrade: ** Install old sovrin and node (indy-node=1.3.x) ** Run POOL_UPGRADE for indy-node=1.6.77 (forced) ** Run POOL_UPGRADE for sovrin=1.1.30 (non-forced)  *Upgrade Workflow* * STN Upgrade: ** Update libindy-crypto manually to 0.4.5 ** Run POOL_UPGRADE for sovrin=1.1.30 (non-forced) * SLN Upgrade: ** Run POOL_UPGRADE for indy-node=1.6.77 (forced) *** will fix Upgrade procedure, but version of IndyCrypto may be different on nodes ** Run POOL_UPGRADE for sovrin=1.1.30 (non-forced) *** will fix IndyCrypto versions, and install Sovrin with Token plugins  ></body> </Action>
<Action id="52316" issue="34564" author="dsurnin" type="comment" created="2018-10-16 11:20:02.0" updateauthor="ashcherbakov" updated="2018-10-16 11:21:23.0"> <body><! CDATA Non forced upgrade was not handled correctly because config_req_handler were replaced with StaticFeesReqHandler by Sovrin Plugins. Method in plenum/node.py {code:java} def commitAndSendReplies(self, ledger_id, ppTime, reqs: List Request , stateRoot, txnRoot) -> List: logger.trace('{} going to commit and send replies to client'.format(self)) *!!*        reqHandler = self.get_req_handler(ledger_id) *!!*        committedTxns = reqHandler.commit(len(reqs), stateRoot, txnRoot, ppTime) self.execute_hook(NodeHooks.POST_BATCH_COMMITTED, ledger_id=ledger_id, pp_time=ppTime, committed_txns=committedTxns, state_root=stateRoot, txn_root=txnRoot) self.updateSeqNoMap(committedTxns, ledger_id) updated_committed_txns = list(map(self.update_txn_with_extra_data, committedTxns)) self.hook_pre_send_reply(updated_committed_txns, ppTime) self.sendRepliesToClients(updated_committed_txns, ppTime) self.hook_post_send_reply(updated_committed_txns, ppTime) return committedTxns {code} indy_node has 3 default ledgers 0 - pool; 1 - domain; 2 - config two marked lines show error - we select req handler by index 2 (which is config in terms of indy_node), but in case of plugins we have the following {code:java} ledger_id 2 reqHandler <sovtokenfees.static_fee_req_handler.StaticFeesReqHandler object at 0x7fcd8a4019b0> self.ledger_to_req_handler {0: <indy_node.server.pool_req_handler.PoolRequestHandler object at 0x7fcd8e9bf048>, 1: <indy_node.server.domain_req_handler.DomainReqHandler object at 0x7fcd8e9bf780>, 2: <sovtokenfees.static_fee_req_handler.StaticFeesReqHandler object at 0x7fcd8a4019b0>, 1001: <sovtoken.token_req_handler.TokenReqHandler object at 0x7fcd8a401940>} {code} so the commit method of wrong req handler is called and upgrade transaction is not handled correctly.  ></body> </Action>
<Action id="52317" issue="34564" author="ashcherbakov" type="comment" created="2018-10-16 11:23:16.0" updateauthor="ashcherbakov" updated="2018-10-16 11:23:16.0"> <body><! CDATA Plugins override ConfigRegHandler incorrectly (using a parent class from Plenum, not from IndyNode) If we want to fix it, we will need: * Make plugins depend on Indy-Node, not Plenum * Change dependencies in Sovrin (depend on Plugins only, not IndyNode?) * Use correct parent class (from Indy-Node) * re-issue Sovrin RCs  There is a workaround: use forced (force=True) Upgrade for STN.  If we don't fix the issue now, then # POOL_CONFIG txn doesn't work (since it's incorrectly overriden by Plugins) # We will have to do forced Upgrades until the issue in plugins is fixed. So, if we use the latest RC for upgrade of the Main Net, then since the issue is still there, the next upgrade (after the Upgrade to 1.6) needs to forced as well.  If we want to do the fix right now, then there is a risk that we will have to change dependency tree, and re-test Plugins.     ></body> </Action>
<Action id="52330" issue="34564" author="vladimirwork" type="comment" created="2018-10-16 15:45:02.0" updateauthor="vladimirwork" updated="2018-10-16 15:55:39.0"> <body><! CDATA Test STN Upgrade: (/) Install sovrin=1.1.24 (emulate different versions of libindy-crypto < 0.4.3) Update libindy-crypto manually to 0.4.5 Run POOL_UPGRADE for sovrin=1.1.30 (-non-forced- forced)  Test SLN Upgrade: (x) Install old sovrin and node (indy-node=1.3.x) Run POOL_UPGRADE for indy-node=1.6.77 (forced) Run POOL_UPGRADE for sovrin=1.1.30 (-non-forced- forced)  {noformat} Oct 16 15:20:05 a839cb478e79 env 3205 : + deps='libindy-crypto=0.4.5 sovrin=1.1.30' Oct 16 15:20:05 a839cb478e79 env 3205 : + ' ' -z 'libindy-crypto=0.4.5 sovrin=1.1.30' ' ' Oct 16 15:20:05 a839cb478e79 env 3205 : + echo 'Try to donwload indy version libindy-crypto=0.4.5 sovrin=1.1.30' Oct 16 15:20:05 a839cb478e79 env 3205 : Try to donwload indy version libindy-crypto=0.4.5 sovrin=1.1.30 Oct 16 15:20:05 a839cb478e79 env 3205 : + apt-get -y update Oct 16 15:20:06 a839cb478e79 env 3205 : Hit:1 http://archive.ubuntu.com/ubuntu xenial InRelease Oct 16 15:20:06 a839cb478e79 env 3205 : Hit:2 http://archive.ubuntu.com/ubuntu xenial-updates InRelease Oct 16 15:20:06 a839cb478e79 env 3205 : Get:3 http://archive.ubuntu.com/ubuntu xenial-backports InRelease  107 kB  Oct 16 15:20:06 a839cb478e79 env 3205 : Get:4 http://security.ubuntu.com/ubuntu xenial-security InRelease  107 kB  Oct 16 15:20:07 a839cb478e79 env 3205 : Hit:5 https://repo.sovrin.org/deb xenial InRelease Oct 16 15:20:07 a839cb478e79 env 3205 : Fetched 214 kB in 1s (163 kB/s) Oct 16 15:20:08 a839cb478e79 env 3205 : Reading package lists... Oct 16 15:20:08 a839cb478e79 env 3205 : + apt-get --download-only -y --allow-downgrades --allow-change-held-packages install libindy-crypto=0.4.5 sovrin=1.1.30 Oct 16 15:20:09 a839cb478e79 env 3205 : Reading package lists... Oct 16 15:20:09 a839cb478e79 env 3205 : Building dependency tree... Oct 16 15:20:09 a839cb478e79 env 3205 : Reading state information... Oct 16 15:20:09 a839cb478e79 env 3205 : libindy-crypto is already the newest version (0.4.5). Oct 16 15:20:09 a839cb478e79 env 3205 : Some packages could not be installed. This may mean that you have Oct 16 15:20:09 a839cb478e79 env 3205 : requested an impossible situation or if you are using the unstable Oct 16 15:20:09 a839cb478e79 env 3205 : distribution that some required packages have not yet been created Oct 16 15:20:09 a839cb478e79 env 3205 : or been moved out of Incoming. Oct 16 15:20:09 a839cb478e79 env 3205 : The following information may help to resolve the situation: Oct 16 15:20:09 a839cb478e79 env 3205 : The following packages have unmet dependencies: Oct 16 15:20:09 a839cb478e79 env 3205 :  sovrin : Depends: indy-node (= 1.6.78) but 1.6.77 is to be installed Oct 16 15:20:09 a839cb478e79 env 3205 :           Depends: sovtoken (= 0.9.5) but it is not going to be installed Oct 16 15:20:09 a839cb478e79 env 3205 :           Depends: sovtokenfees (= 0.9.5) but it is not going to be installed Oct 16 15:20:09 a839cb478e79 env 3205 : E: Unable to correct problems, you have held broken packages. Oct 16 15:20:09 a839cb478e79 env 3205 : + ret=100 Oct 16 15:20:09 a839cb478e79 env 3205 : + ' ' 100 -ne 0 ' ' Oct 16 15:20:09 a839cb478e79 env 3205 : + echo 'Failed to obtain libindy-crypto=0.4.5 sovrin=1.1.30' {noformat}   ></body> </Action>
<Action id="52346" issue="34564" author="ashcherbakov" type="comment" created="2018-10-17 07:05:45.0" updateauthor="ashcherbakov" updated="2018-10-17 07:05:45.0"> <body><! CDATA This is caused by the following: * sovrin 1.1.0 depends on the latest indy-node (without explicit Indy-node version pin) * When upgrade procedure traverses dependencies, it doesn't take indy-node from Sovrin since there is no explicit version pin. * So, the upgrade commands look like `apt-get install libindy-crypto=0.4.5 sovrin=1.1.30` * Sovrin-1.1.30 depends on indy-node 1.6.78; indy-node 1.6.77 is installed * Since indy-node is on hold, and sovrin depends on a newer version of indy-node, update fails  A separate ticket is created to address the issue: INDY-1764  As a workaround for the MainNet Upgrade we can do the following ( ~ozheregelya  verified this): * Run POOL_UPGRADE for indy-node=1.6.78 (forced) * Run POOL_UPGRADE for sovrin=1.1.30 (forced)     ></body> </Action>
<Action id="52359" issue="34564" author="vladimirwork" type="comment" created="2018-10-17 12:42:45.0" updateauthor="vladimirwork" updated="2018-10-17 12:42:45.0"> <body><! CDATA Build Info: indy-anoncreds=1.0.11 indy-plenum=1.2.42 indy-node=1.3.62 sovrin=1.1.10 python3-base58=0.2.4 python3-indy-crypto=0.4.1 libindy-crypto=0.4.0  Steps to Validate: 1. Upgrade 1.3.62 (1.1.10) pool to 1.6.78 version simultaneously with force=True. 2. Check all package versions and send all txn types to the ledger. 3. Upgrade 1.6.78 (1.1.10) pool to 1.1.30 version simultaneously with force=True. 4. Check all package versions and send all txn types to the ledger.  Actual Results: Both upgrades was passed successfully. Pool works normally.  ></body> </Action>
