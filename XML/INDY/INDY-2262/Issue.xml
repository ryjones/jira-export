<Issue id="42973" key="INDY-2262" number="2262" project="10303" reporter="ashcherbakov" assignee="vladimirwork" creator="ashcherbakov" type="10002" summary="All nodes need to select the same primary during view change" priority="2" resolution="10000" status="10001" created="2019-10-24 07:10:57.0" updated="2019-11-25 12:07:32.0" resolutiondate="2019-11-20 09:08:31.0" votes="0" watches="2" workflowId="56075"> <description><! CDATA *Issue* If there are NODE txns for adding/removing nodes interleaved with View Changes (not any view changes, but a specific subset), then either 1) Up to F Nodes may not be able to finish view change  OR 2) All nodes will not be able to finish view change   *Workaround* Restart should help  *When issue is reproduced during demotion* Let X be a demoted Node seqno (historical order of nodes how they have been added), N - number of nodes, viewNo - current viewNo. * If  *X >= (viewNo mod N) + 3*, then no issue is possible. * If  *X < (viewNo mod N) + 3*, then issue *may* be reproduced depending on network conditions.   *When issue is reproduced during new Node adding* Let N - number of nodes, viewNo - current viewNo. * If  *N != (viewNo mod N) + 1*, then no issue is possible. * If  *N == (viewNo mod N) + 1*, then issue *may* be reproduced depending on network conditions.    *Example 1: F nodes out of consensus till next View Change after new Node is added* 1) The pool has 24 Nodes, and the current viewNo is 23, so that master Primary is Node24 (the last one) 2) Node25 is added (NODE txn is sent) 3) N-F Nodes applied NODE txn, and F Nodes haven't applied it yet 4) View Change is started 5) N-F Nodes selected Node25 as a Primary and F Nodes selected Node1 as a Primary 6) N-F Nodes finished view change, but F Nodes didn't  7) If the next View Change is started, the F Nodes will be able to finish it and join consensus  *Example 2: F nodes out of consensus till next View Change after a Node is demoted* 1) The pool has 24 Nodes, and the current viewNo is 10 2) Node10 is demoted 3) N-F Nodes applied NODE txn, and F Nodes haven't applied it yet 4) View Change is started 5) N-F Nodes selected Node12 as a Primary and F Nodes selected Node11 as a Primary 6) N-F Nodes finished view change, but F Nodes didn't  7) If the next View Change is started, the F Nodes will be able to finish it and join consensus  *Example 3: All nodes can not finish view change when adding a Node* In Example 1, if more than F nodes have a different state than others (didn't apply NODE txn for example), then all nodes will not be able to finish the view change  *Example 4: All nodes can not finish view change when demoting a Node* In Example 2, if more than F nodes have a different state than others (didn't apply NODE txn for example), then all nodes will not be able to finish the view change  *Example 5: No issues when a Node is demoted* If current viewNo is 22 in Example 1, then there is no issue  *Example 6: No issues when a Node is demoted* If Node 12 is demoted in Example 2, then there is no issue   *Problem Reason* * As of now, nodes select a Primary at the beginning of View Change (once receive a quorum of Instance Changes). * Primary selection depends on the current node registry state which depends on the Node's uncommitted state (Node txns to add/remove nodes in flight) * Node may come to view change in different states * => The may select different primaries and view change may never finish on some nods since they expect NewView from the Primary they selected  *Acceptance criteria* * Write integration tests reproducing the issue ** Test 1  *** Initial state: Pool with 4 Nodes, viewNo=3, currentPrimary - Node4 *** Delay X msg on Y Nodes **** params: X = PrePrepare/Commit; Y=1 Node/2 Nodes/3 Nodes/4 Nodes *** Add a NODE txn to add a new Node (Node5) *** Start a View Change    *** Make sure that it's finished on all nodes, all nodes have the same state and can order ** Test 2 *** Initial state: Pool with 5 Nodes, viewNo=3, currentPrimary - Node4 *** Delay X msg on Y Nodes **** params: X = PrePrepare/Commit; Y=1 Node/2 Nodes/3 Nodes/4 Nodes *** Add a NODE txn to remove Node5 *** Start a View Change    *** Make sure that it's finished on all nodes, all nodes have the same state and can order ** Test 3 *** Initial state: Pool with 5 Nodes, viewNo=2, currentPrimary - Node3 *** Delay X msg on Y Nodes **** params: X = PrePrepare/Commit; Y=1 Node/2 Nodes/3 Nodes/4 Nodes *** Add a NODE txn to demote Node3 *** Make sure that view change is started and finished on all nodes, all nodes have the same state and can order * Do a fix  *Possible fix* * Do not commit nodeRegistry (current list of nodes used for Primary selection) till the next View Change, so that all nodes can select the same Primaries regardless of their state. * Do view change on every change of nodeRegistry  ></description> </Issue>
