<Issue id="31289" key="INDY-1424" number="1424" project="10303" reporter="zhigunenko.dsr" assignee="zhigunenko.dsr" creator="zhigunenko.dsr" type="10004" summary="Migration from 1.3.x to 1.4.x failed" environment="indy-node 1.3.375 -&gt; 1.4.472" priority="2" resolution="10000" status="10001" created="2018-06-22 09:20:57.0" updated="2019-03-29 20:33:44.0" resolutiondate="2019-03-29 20:33:44.0" votes="0" watches="1" workflowId="31303"> <description><! CDATA *Steps to Validate:* 1. Install pool 1.3.375 master. 2. Send all type of txns to ledger. 3. Upgrade pool to 1.4.472 master. 4. Check `journalctl -ex`.  *Actual Results:* {code:java} Jun 22 09:01:11 c7981384e90a env 3658 : 2018-06-22 09:01:11,529 | DEBUG    | __init__.py          (  60) | register | Registered VCS backend: git Jun 22 09:01:11 c7981384e90a env 3658 : 2018-06-22 09:01:11,569 | DEBUG    | __init__.py          (  60) | register | Registered VCS backend: hg Jun 22 09:01:11 c7981384e90a env 3658 : 2018-06-22 09:01:11,595 | DEBUG    | __init__.py          (  60) | register | Registered VCS backend: svn Jun 22 09:01:11 c7981384e90a env 3658 : 2018-06-22 09:01:11,595 | DEBUG    | __init__.py          (  60) | register | Registered VCS backend: bzr Jun 22 09:01:12 c7981384e90a env 3658 : Traceback (most recent call last): Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/bin/start_indy_node", line 17, in <module> Jun 22 09:01:12 c7981384e90a env 3658 :     run_node(config, self_name, int(sys.argv 2 ), int(sys.argv 3 )) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/utils/node_runner.py", line 57, in run_node Jun 22 09:01:12 c7981384e90a env 3658 :     looper.run() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 261, in run Jun 22 09:01:12 c7981384e90a env 3658 :     return self.loop.run_until_complete(what) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete Jun 22 09:01:12 c7981384e90a env 3658 :     return future.result() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result Jun 22 09:01:12 c7981384e90a env 3658 :     raise self._exception Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step Jun 22 09:01:12 c7981384e90a env 3658 :     result = coro.send(None) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 224, in runForever Jun 22 09:01:12 c7981384e90a env 3658 :     await self.runOnceNicely() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 207, in runOnceNicely Jun 22 09:01:12 c7981384e90a env 3658 :     msgsProcessed = await self.prodAllOnce() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 152, in prodAllOnce Jun 22 09:01:12 c7981384e90a env 3658 :     s += await n.prod(limit) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/server/node.py", line 290, in prod Jun 22 09:01:12 c7981384e90a env 3658 :     c = await super().prod(limit) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 980, in prod Jun 22 09:01:12 c7981384e90a env 3658 :     self.nodestack.serviceLifecycle() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/network/keep_in_touch.py", line 44, in serviceLifecycle Jun 22 09:01:12 c7981384e90a env 3658 :     self.checkConns() Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/network/keep_in_touch.py", line 75, in checkConns Jun 22 09:01:12 c7981384e90a env 3658 :     self.conns = self.connecteds Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/network/keep_in_touch.py", line 69, in conns Jun 22 09:01:12 c7981384e90a env 3658 :     self._connsChanged(ins, outs) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/network/keep_in_touch.py", line 108, in _connsChanged Jun 22 09:01:12 c7981384e90a env 3658 :     self.onConnsChanged(ins, outs) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1117, in onConnsChanged Jun 22 09:01:12 c7981384e90a env 3658 :     self.send_ledger_status_to_newly_connected_node(node) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1143, in send_ledger_status_to_newly_connected_node Jun 22 09:01:12 c7981384e90a env 3658 :     self.ledgerManager.ledger_sync_order 0 ) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1918, in sendLedgerStatus Jun 22 09:01:12 c7981384e90a env 3658 :     ledgerStatus = self.getLedgerStatus(ledgerId) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1915, in getLedgerStatus Jun 22 09:01:12 c7981384e90a env 3658 :     return self.build_ledger_status(ledgerId) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 626, in build_ledger_status Jun 22 09:01:12 c7981384e90a env 3658 :     return LedgerStatus(ledger_id, ledger.size, v, p, ledger.root_hash) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/messages/message_base.py", line 91, in __init__ Jun 22 09:01:12 c7981384e90a env 3658 :     self.validate(input_as_dict) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/messages/message_base.py", line 21, in validate Jun 22 09:01:12 c7981384e90a env 3658 :     self._validate_fields_with_schema(dct, self.schema) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/messages/message_base.py", line 40, in _validate_fields_with_schema Jun 22 09:01:12 c7981384e90a env 3658 :     self._raise_invalid_fields(k, v, validation_error) Jun 22 09:01:12 c7981384e90a env 3658 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/messages/message_base.py", line 62, in _raise_invalid_fields Jun 22 09:01:12 c7981384e90a env 3658 :     field, value)) Jun 22 09:01:12 c7981384e90a env 3658 : TypeError: validation error  LedgerStatus : expected types 'str', got 'bytes' (merkleRoot=b'EXpY2StrjRki5N46aMDdjbwBPfZUz1AnLQupuVa1Tnwk') Jun 22 09:01:12 c7981384e90a systemd 1 : indy-node.service: Main process exited, code=exited, status=1/FAILURE Jun 22 09:01:12 c7981384e90a systemd 1 : indy-node.service: Unit entered failed state. Jun 22 09:01:12 c7981384e90a systemd 1 : indy-node.service: Failed with result 'exit-code'. Jun 22 09:01:23 c7981384e90a systemd 1 : indy-node.service: Service hold-off time over, scheduling restart. Jun 22 09:01:23 c7981384e90a systemd 1 : Stopped Indy Node. -- Subject: Unit indy-node.service has finished shutting down {code} and pool is down without uprgraing {code:java} Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,684 | DEBUG    | node_control_tool.py ( 170) | _create_backup | Creating backup for 1.3.375 Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,722 | INFO     | migration_tool.py    (  52) | migrate | Migrating from 1.3.375 to 1.4.472 on Ubuntu Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,724 | DEBUG    | migration_tool.py    (  54) | migrate | Found migration scripts:  '1_0_96_to_1_0_97', '1_1_150_to_1_1_151', '1_2_188_to_1_2_189', '1_2_233_to_1_2_234', '1_2_273_to_1_2_274', '1_3_396_to_1_3_397',  Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,724 | INFO     | migration_tool.py    (  61) | migrate | Following migrations will be applied:  '1_3_396_to_1_3_397', '1_3_428_to_1_3_429', '1_3_433_to_1_3_434'  Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,724 | INFO     | migration_tool.py    (  63) | migrate | Applying migration 1_3_396_to_1_3_397 Jun 22 08:58:44 3e500d879fe8 env 92 : 2018-06-22 08:58:44,724 | INFO     | migration_tool.py    (  35) | _call_migration_script | script path /usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_396_to_1_3_397.py Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,251 | INFO     | 1_3_396_to_1_3_397.py ( 149) | migrate_all | Starting migration of storages from LevelDB to RocksDB... Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,386 | INFO     | 1_3_396_to_1_3_397.py ( 152) | migrate_all | All storages migrated successfully from LevelDB to RocksDB Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,432 | INFO     | 1_3_396_to_1_3_397.py (  67) | archive_leveldb_ledger | Archive of LevelDB-based ledger created: /tmp/Node1_ledger_leveldb.tar.gz Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,441 | INFO     | 1_3_396_to_1_3_397.py ( 194) | <module> | Migration from LevelDB to RocksDB complete Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,514 | INFO     | migration_tool.py    (  67) | migrate | Migration 1_3_396_to_1_3_397 applied in 0.7893426418304443 seconds Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,514 | INFO     | migration_tool.py    (  63) | migrate | Applying migration 1_3_428_to_1_3_429 Jun 22 08:58:45 3e500d879fe8 env 92 : 2018-06-22 08:58:45,514 | INFO     | migration_tool.py    (  35) | _call_migration_script | script path /usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_428_to_1_3_429.py Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,077 | DEBUG    | __init__.py          (60) | register | Registered VCS backend: git Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,118 | DEBUG    | __init__.py          (60) | register | Registered VCS backend: hg Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,161 | DEBUG    | __init__.py          (60) | register | Registered VCS backend: svn Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,162 | DEBUG    | __init__.py          (60) | register | Registered VCS backend: bzr Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,322 | INFO     | 1_3_428_to_1_3_429.py (346) | archive_old_ledger | Archive of old transaction format ledger created: /tmp/Node1_old_txn_ledger.tar.gz Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,405 | ERROR    | 1_3_428_to_1_3_429.py (241) | migrate_txn_log | None Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,405 | ERROR    | 1_3_428_to_1_3_429.py (242) | migrate_txn_log | Could not put key/value to the new ledger 'domain_transactions' Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,406 | ERROR    | 1_3_428_to_1_3_429.py (295) | migrate_txn_logs | Could not migrate domain_transactions, DB path: /var/lib/indy/sandbox/data/Node1/domain_transactions Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,406 | ERROR    | 1_3_428_to_1_3_429.py (369) | migrate_all | Txn log migration from old to new format failed! Jun 22 08:58:46 3e500d879fe8 env 92 : 2018-06-22 08:58:46,406 | INFO     | 1_3_428_to_1_3_429.py (409) | <module> | Migration of txns format failed! Jun 22 08:58:46 3e500d879fe8 env 92 : Traceback (most recent call last): Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_428_to_1_3_429.py", line 229, in migrate_txn_log Jun 22 08:58:46 3e500d879fe8 env 92 :     digest = put_into_seq_no_db(new_val) Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/data/migrations/deb/1_3_428_to_1_3_429.py", line 180, in put_into_seq_no_db Jun 22 08:58:46 3e500d879fe8 env 92 :     digest = sha256(serialize_msg_for_signing(dct)).hexdigest() Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/common/serializers/serialization.py", line 31, in serialize_msg_for_signing Jun 22 08:58:46 3e500d879fe8 env 92 :     return signing_serializer.serialize(msg, topLevelKeysToIgnore=topLevelKeysToIgnore) Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/common/serializers/signing_serializer.py", line 74, in serialize Jun 22 08:58:46 3e500d879fe8 env 92 :     str(k) + ":" + self.serialize(obj k , level + 1, onm, toBytes=False)) Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/common/serializers/signing_serializer.py", line 74, in serialize Jun 22 08:58:46 3e500d879fe8 env 92 :     str(k) + ":" + self.serialize(obj k , level + 1, onm, toBytes=False)) Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/common/serializers/signing_serializer.py", line 60, in serialize Jun 22 08:58:46 3e500d879fe8 env 92 :     error("invalid type found {}: {}".format(objname, obj)) Jun 22 08:58:46 3e500d879fe8 env 92 :   File "/usr/local/lib/python3.5/dist-packages/common/error.py", line 9, in error Jun 22 08:58:46 3e500d879fe8 env 92 :     raise exc_type(msg) Jun 22 08:58:46 3e500d879fe8 env 92 : Exception: invalid type found operation.id: b'V4SGRU86Z58d6TV7PBUe6f:4:V4SGRU86Z58d6TV7PBUe6f:3:CL:16:tag:CL_ACCUM:0f03cf3ee82e69f36a489100715b48c9' {code}  *Expected Results:* Pool upgraded succesfully, no errors in journalctl  ></description> </Issue>
