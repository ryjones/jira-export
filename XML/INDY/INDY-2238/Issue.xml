<Issue id="42608" key="INDY-2238" number="2238" project="10303" reporter="ashcherbakov" creator="ashcherbakov" type="10002" summary="Persist 3PC messages during Ordering" priority="3" status="3" created="2019-10-03 09:24:41.0" updated="2020-11-25 01:00:13.0" votes="0" watches="2" workflowId="55676"> <description><! CDATA *Problem* * Let's consider the following example:  ** All 4 nodes prepared a batch with ppSeqNo=1 ** All nodes sent commits, but only the 1st Node got then (and possibly committed/ordered the batch) ** Other 3 nodes stopped before receiving Commits ** Only 2 nodes are restarted ** After restart the 1st Node has a Batch with ppSeqNo=1 in its preprepared and prepared queues. ** Other 2 nodes don't have it in preprepared and prepared queues (and INDY-2235 will not help to restore it since it hasn't been ordered yet). ** The 3d Node is still stopped. ** View Change is started ** View Change will not be finished, since according to Fig4 from  https://www.microsoft.com/en-us/research/wp-content/uploads/2017/01/p398-castro-bft-tocs.pdf,  decision procedure can not be complete. ** The problem that we don't have quorums to complete the decision procedure: *** F=1 so we can not trust the 1st Node that committed the batch *** But if we finish the View Change without taking into account the fact that 1st Node may potentially commit the batch, the 1st Node's ledger will be different from others forever  *Acceptance criteria* * Persist all 3PC messages before sending them to others (or before storing them to preprepared and prepared) * Restored stored 3PC messages (put to preprepared and prepared) when node starts up (after catch-up is finsihed). * Write tests (or unskip existing tests showing the problem)  ></description> </Issue>
