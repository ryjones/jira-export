<Issue id="42722" key="INDY-2248" number="2248" project="10303" reporter="ashcherbakov" assignee="vladimirwork" creator="ashcherbakov" type="10004" summary="A Replica may process messages from other Replicas" priority="2" resolution="10000" status="10001" created="2019-10-11 08:36:50.0" updated="2019-10-22 08:35:47.0" resolutiondate="2019-10-15 13:01:55.0" votes="0" watches="3" workflowId="55802"> <description><! CDATA *General Issue* * The node that was demoted/promoted may have less replicas than others for some period of time * If the Node receives a 3PC message with an InstID for an unknown replicas, it's propagated to all Replicas according to `pass_message` in `Replicas` * Ordering Service doesn't check for instId when processing 3PC messages  *Specific failure:*  In particular, it led to the following in  https://build.sovrin.org/job/indy-node/job/indy-node-nightly/130/testReport/junit/system.indy-node-tests/test_vc/test_vc_py___Run_test_vc_py____2__Upload_test_report___test_vc_by_demotion_last/  * A node was demoted and then promoted * It still has 2 Replicas * It has PrePrepare ppSeqNo=1 for master stored * It receives PrePrepare ppSeqNo=1 for instId=2 (3d Replica) * PrePrepare is propagated to all nodes including master * PrePrepare for Backup replica overrides existing correct PrePrepare for master for ppSeqNo=1 * The node does a View change * The node need to re-order a batch with ppSeqNo=1 * It get a Commit ppSeqNo=1 * The corresponding PrePrepare is now Backup's one (incorrectly overridden) * BLS signature is verified: backup PrePrepare doesn't have poolRootHash, and we fail with "TypeError: a bytes-like object is required (also str), not 'NoneType'"  *Acceptance Criteria* * Do not propagated 3pc messages for unknown replicas to all replicas * Validate 3PC message instanceId in Ordering service * Write tests  Â   ></description> </Issue>
