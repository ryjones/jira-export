<Issue id="17101" key="INDY-32" number="32" project="10303" reporter="ashcherbakov" assignee="danielhardman" creator="ashcherbakov" type="10004" summary="Pool was unable to function dealing with a bad network of 2 second latency and 20% dropped packets" priority="1" resolution="10000" status="10001" created="2017-05-25 12:14:46.0" updated="2019-03-29 20:37:00.0" resolutiondate="2019-03-29 20:37:00.0" votes="0" watches="4" workflowId="17105"> <description><! CDATA This is a more extreme scenario. I have a 7 node global pool and used a script called traffic_shaping.sh to simulated a bad network. The script is attached.   *{color:#205081}Setup{color}* Global network pool of 7 nodes 3 client machines running performance scripts to drive traffic.  *{color:#205081}Test{color}* To use traffic_shaping.sh: Just put the following script in /etc/init.d, modify the values to fit your needs, make it executable, and run /etc/init.d/traffic_shaping.sh start to degrade performance accordingly.  Using traffic_shaping.sh on each of the nodes I set the following values: {code} # The network interface we're planning on limiting bandwidth. IF=ens3     # Interface # Latency LAT_1=2000ms          # Base latency LAT_2=100ms           # Plus or minus LAT_3=50%            # Based on previous packet % # Dropping packets DROP_1=20%            # Base probability DROP_2=50%           # Based on previous packet % # Bandwidth DNLD=50kbps          # DOWNLOAD Limit UPLD=50kbps          # UPLOAD Limit {code}  I started traffic_shaping.sh on each of the nodes and then started the following performance scripts one on each of three machines.  *Client 1* python3 load_test.py --clients-list load_test_clients.list -t NYM -c 2 -r 200  *Client 2* python3 load_test.py --clients-list load_test_clients.list -t ATTRIB -c 2 -r 200  *Client 3* python3 load_test.py --clients-list load_test_clients.list -t GET_NYM -c 2 -r 1000  The GET_NYM completed successfully, but on adding a NYM only 60 out of 400 completed and from adding an ATTRIB only 58 out of 400 completed.  *{color:#d04437}Issue{color}* After adding the NYM and ATTRIB stalled I shut down the test and stopped traffic_shaping.sh from running. I then connected with the CLI and tried to add a NYM and was unable to. I then check the service status on all the nodes and found the following error on Node 2  {code} return self.gen.send(None) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 660, in serviceReplicas c = self.serviceReplicaInBox(limit) File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 992, in serviceReplicaInBox msgCount += replica.serviceQueues(limit) File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 519, in serviceQueues r = self.dequeuePrePrepares() if self.node.isParticipating else 0 File "/usr/local/lib/python3.5/dist-packages/plenum/server/replica.py", line 1414, in dequeuePrePrepares pp, sender, _ = self.prePreparesPendingFinReqs.pop(i) IndexError: pop index out of range {code}  I then restarted all the services and the CLI was not able to connect to any of the nodes. I tried again morning and the CLI was again able to connect and add new NYMs. I don't know how long it took for the system to recover.  ></description> </Issue>
