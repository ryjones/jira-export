<Action id="43834" issue="29598" author="anikitindsr" type="comment" created="2018-05-04 14:12:02.0" updateauthor="anikitindsr" updated="2018-05-04 14:12:02.0"> <body><! CDATA Reasons: - need to add read_only option for read_ledger  Changes: - added read_only option while openning storages  Versions: indy-node: 1.3.402-master indy-plenum: 1.2.347-master    ></body> </Action>
<Action id="43939" issue="29598" author="ozheregelya" type="comment" created="2018-05-06 10:32:10.0" updateauthor="ozheregelya" updated="2018-05-06 10:32:10.0"> <body><! CDATA Environment: indy-node 1.3.403 AWS pool of 25 nodes (QA Live)  Reason for Rejection: Read_ledger doesn't work if the indy-node is running. {code:java} ubuntu@sydneyQALarge7:~$ sudo su - indy -c "read_ledger --type domain --count" Traceback (most recent call last): File "/usr/local/bin/read_ledger", line 177, in <module> ledger = get_ledger(args.type, ledger_data_dir) File "/usr/local/bin/read_ledger", line 99, in get_ledger return Ledger(CompactMerkleTree(hashStore=hash_store), dataDir=ledger_data_dir, fileName=ledger_name) File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger.py", line 13, in __init__ super().__init__(*args, **kwargs) File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 60, in __init__ self.start() File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 214, in start config=self.config) File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 26, in _defaultStore dataDir, logName, open) File "/usr/local/lib/python3.5/dist-packages/storage/helper.py", line 36, in initKeyValueStorageIntKeys return KeyValueStorageRocksdbIntKeys(dataLocation, keyValueStorageName, open, read_only) File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb_int_keys.py", line 21, in __init__ super().__init__(db_dir, db_name, open, read_only) File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb.py", line 23, in __init__ self.open() File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb_int_keys.py", line 27, in open self._db = rocksdb.DB(self._db_path, opts) File "rocksdb/_rocksdb.pyx", line 1437, in rocksdb._rocksdb.DB.__cinit__ File "rocksdb/_rocksdb.pyx", line 84, in rocksdb._rocksdb.check_status rocksdb.errors.RocksIOError: b'IO error: While lock file: /var/lib/indy/sandbox/data/Node7/domain_transactions/LOCK: Resource temporarily unavailable'{code}  ></body> </Action>
<Action id="44136" issue="29598" author="ozheregelya" type="comment" created="2018-05-09 16:56:02.0" updateauthor="ozheregelya" updated="2018-05-09 16:56:02.0"> <body><! CDATA Environment: indy-node 1.3.405  Steps to Reproduce: 1. Setup the 'sandbox' pool. 2. Check all read_ledger parameters. 3. Setup the 'live' pool. 4. Check that read_ledger works.  Actual Results: Read_ledger is basically works. Small issue noticed during testing was moved to INDY-1318.     ></body> </Action>
<Action id="44233" issue="29598" author="ozheregelya" type="comment" created="2018-05-11 11:04:13.0" updateauthor="ozheregelya" updated="2018-05-11 11:04:13.0"> <body><! CDATA Environment: indy-node 1.3.410 AWS pool of 25 nodes (QA Large)  Reason for Reopen: Sometimes read_ledger doesn't work when the pool is under writing load.  Steps to Reproduce: 1. Setup the pool and run load test. {code:java} for s in `seq 1 1000000` ; do echo "===$s===" ; sudo python3.6 perf_runner.py -t -c 20 -k "nym" &>>oz_load_additional.log ; done{code} 2. Run read_ledger during writing.  Actual Results: {code:java} ubuntu@ohioQALarge21:~$ sudo su - indy -c "read_ledger --type domain --count" Traceback (most recent call last): File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 82, in recoverTree self.recoverTreeFromHashStore() File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 112, in recoverTreeFromHashStore self.tree.verify_consistency(self._transactionLog.size) File "/usr/local/lib/python3.5/dist-packages/ledger/compact_merkle_tree.py", line 287, in verify_consistency raise ConsistencyVerificationFailed() ledger.util.ConsistencyVerificationFailed  During handling of the above exception, another exception occurred:  Traceback (most recent call last): File "/usr/local/bin/read_ledger", line 177, in <module> ledger = get_ledger(args.type, ledger_data_dir) File "/usr/local/bin/read_ledger", line 99, in get_ledger return Ledger(CompactMerkleTree(hashStore=hash_store), dataDir=ledger_data_dir, fileName=ledger_name, read_only=True) File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger.py", line 13, in __init__ super().__init__(*args, **kwargs) File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 64, in __init__ self.recoverTree() File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 87, in recoverTree self.recoverTreeFromTxnLog() File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 104, in recoverTreeFromTxnLog self._addToTreeSerialized(entry) File "/usr/local/lib/python3.5/dist-packages/ledger/ledger.py", line 144, in _addToTreeSerialized audit_path = self.tree.append(serializedLeafData) File "/usr/local/lib/python3.5/dist-packages/ledger/compact_merkle_tree.py", line 160, in append self._push_subtree( new_leaf ) File "/usr/local/lib/python3.5/dist-packages/ledger/compact_merkle_tree.py", line 130, in _push_subtree self.hashStore.writeLeaf(h) File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/db_hash_store.py", line 33, in writeLeaf self.leavesDb.put(str(self.leafCount + 1), leafHash) File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb.py", line 52, in put self._db.put(key, value) File "rocksdb/_rocksdb.pyx", line 1472, in rocksdb._rocksdb.DB.put File "rocksdb/_rocksdb.pyx", line 78, in rocksdb._rocksdb.check_status rocksdb.errors.NotSupported: b'Not implemented: Not supported operation in read only mode.'{code} Expected Results: Read_ledger should work.  ></body> </Action>
<Action id="44245" issue="29598" author="anikitindsr" type="comment" created="2018-05-11 14:04:51.0" updateauthor="anikitindsr" updated="2018-05-11 14:04:51.0"> <body><! CDATA Version: indy-node: 1.3.411  ></body> </Action>
<Action id="44321" issue="29598" author="ozheregelya" type="comment" created="2018-05-14 11:26:48.0" updateauthor="ozheregelya" updated="2018-05-14 11:26:48.0"> <body><! CDATA Environment: indy-node 1.3.411 AWS pool of 25 nodes  Steps to Validate: 1. Setup the pool. 2. Run the load test. 3. Run the read_ledger during the load on ~1,000 txns. => read_ledger works. 4. Run the read_ledger on ~300,000 txns.  Actual Results: read_ledger works well.  ></body> </Action>
