<Issue id="42610" key="INDY-2239" number="2239" project="10303" reporter="ashcherbakov" assignee="toktar" creator="ashcherbakov" type="10002" summary="Make sure that only valid OldViewPrePrepares are processed" priority="3" resolution="10001" status="10001" created="2019-10-03 12:07:38.0" updated="2019-11-07 05:19:35.0" resolutiondate="2019-11-07 05:19:35.0" votes="0" watches="1" workflowId="55678"> <description><! CDATA *Problem* * When a replica doesn't have a PrePrepare associated with a batch from NewView (that is a PrePrepare to be re-ordered), it requests it from other nodes. * We don't have digital signatures for messages, so we can not trust that a PrePrepare for view X returned by a non-Primary for view X is valid. * We can not ask only a primary for view X (previous view) in this case since it can be malicious or offline (that's why we did view change). * So, we are asking all nodes * As of now, we get an old view PrePrepare from any Node, and try to apply it, which may lead to some problems (raising Suspicious on a new primary which can be honest) if this is not the original PrePrepare we are looking for  *Acceptance criteria* * Write an integration test reproducing the issue:  ** Delay PrePrepares on 1 Node (without processing) ** Delay receiving of OldViewPrePrepareRequest on all nodes but 1 ** Patch OldViewPrePrepareRequest  processing on the node it isn't delayed by returning an invalid PrePrepare ** Start a view change ** Make sure it's finished (NewView is sent) ** Make sure that the lagging node received OldViewPrePrepareReply from the malicious node ** Reset delay for OldViewPrePrepareRequest  on other nodes ** make sure that the lagging node was able to re-order everything ** make sure the pool is functional * Analyze the issue (if it exists and how severe it is) * Do a fix if needed ** Wait for F+1 equal OldViewPrePrepareReply for example  ></description> </Issue>
