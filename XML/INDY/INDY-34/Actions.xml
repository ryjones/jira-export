<Action id="24492" issue="17103" author="andkononykhin" type="comment" created="2017-05-26 17:51:25.0" updateauthor="andkononykhin" updated="2017-05-26 18:36:09.0"> <body><! CDATA Hello  ~jlaw 1   ~lovesh  and  ~ashcherbakov   I want to share the results of testing master's extra work and how it impacts our monitoring logic.  *Main conclusion*:     - master extra work lead to view change  Some stat  ---------  How tested:     I patched plenum code in the following ways:         1. improved logging for failed limits checks to show more valuable numbers         2. check all limits in any case (in current code - until first failed)         3. added synchronous sleeps inside replica.processReqDuringBatch           whic is running for both primary and non-primary replicas  Limits are default:     DELTA = 0.4 (throughput ratio)     LAMBDA = 60 (requests latency)     OMEGA = 5 (avg requests latency)  sleep   num NYM                    diff         diff            diffs (mean / max)  time    requests    repeatable  DELTA   OMEGA   LAMBDA  ------------------------------------------------------------------------------------------ 0       1000        quite               0.13                                                                                 2.88 / 5.0                                                                                 0.08 / 0.09                                                                                 0.52 / 0.53                                                                                 0.96 / 0.97                                                                                1.38 / 1.40                                                                                 ...  0.1     200         quite                               19.62                                                     0.35      43.51  0.2     10          yes                     0.36                                                     0.11  0.3     10          yes                     0.13      1.0  0.4     10          yes                     0.18      3.0  Comments:     diff DELTA = DELTA - (masterThrp / backupThrp)     diff OMEGA = avgLatM - avgLatB - OMEGA     diff LAMBDA (mean) = mean( lat - LAMBDA )     max LAMBDA =  mean( lat - LAMBDA )  I checked the case when we increase replicas work not only for master and didn't see any view changes for the same synthetic delays.   Conclusions:     - without sync sleep master checks fails mostly for LAMBDA,       latencis were quite near LAMBDA. Make sense to try to tune LAMBDA or       use proposed logic of monitor adjustment.     - in case of addtional load (sync sleep) other checks (DELTA, OMEGA) failed       with big difference with current limits. Seems no sense to adjust them.  *Current implementation of monitor adjustment*  --------------------------------------------  1. measure times for all code under 'isMaster' conditional in server/replica.py  2. all time snapshots are added to:     - total counter for master     - counter for each not ordered yet request (master only)  *Why it seems not accurate enough:*  ------------------------------------------------  1. master shares the same looper with backups. Thus, its extra work (and non extra too) delays  all not ordered requests for backups which await async loop too  2. each coming client request splitted (lead to) to many service requests inside pool.    Life cycle for each requests distributes among nodes according to RBFT.    Thus, it's not accurate to measure and adjust latency for requests only on one single node    cause other replicas increase latencies for all requests as well.    So, it seems we need some attribute for request for extra work latencies accumulation.    But it's not clear enough how to accumulate that.  *As a conclusion about monitor adjustment logic:*    we may adjust monitor for each node independently but it neither not enough    nor accurate.     Thanks  ></body> </Action>
<Action id="24690" issue="17103" author="lovesh" type="comment" created="2017-05-30 17:40:57.0" updateauthor="lovesh" updated="2017-05-30 17:42:55.0"> <body><! CDATA From the logs that i have looked at i saw view change happening since latency of one request was higher than the threshold, i propose that "lets not consider master slow if latency of one request is greater than Lambda, but we consider master slow if 10% of  requests". The idea is to bring pragmatism to RBFT's monitoring   ></body> </Action>
