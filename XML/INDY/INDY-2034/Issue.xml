<Issue id="38818" key="INDY-2034" number="2034" project="10303" reporter="ashcherbakov" creator="ashcherbakov" type="10004" summary="Phantom transactions in audit ledger" priority="3" resolution="10000" status="10001" created="2019-03-28 07:19:06.0" updated="2019-04-10 10:51:14.0" resolutiondate="2019-04-10 10:51:11.0" votes="0" watches="1" workflowId="50469"> <description><! CDATA *Test cases where the issues reproduced* The issues are reproduced only when we do forced view change tests and write to domain, pool and config ledgers at the same time. If we write to domain ledger only, the pool successfully survived 120 forced view changes and continues ordering. I think the main difference here is that when we write to multiple ledgers, we created multiple PrePrepares (for each ledger) almost at the same time which increases a risk of out-of-order messages.  *The problem:* 1) Some nodes have "phantom" audit txns that other nodes don't have. Moreover, there is no corresponding main ledger txn written to the ledger for these nodes, so it looks like it's written to audit ledger only. Moreover, there is not Ordered msg in longs corresponding to this phantom audit txn. So, it looks like it was applied, but not committed explicitly. 2) Audit ledger tried to revert txns while it's empty (LogicError). It happens at the same time, as issue 1, so it looks like it's related.  *Important notes* 1) There are a lot of warnings `The first created batch has not been committed or reverted and yet another batch is trying to be committed` from idr_cahce (first time it's raised for Pool ledger batch). So, it looks like idr_cahce is broken. See INDY-2032. 2) Issues 1 and 2 are reproduced from a very long sequence of view changes, where it's called from the PreViewChange strategy. The specific here is that view change (and hence catchup, and hence revert of unordered batches) is called from Replica, not from Node (see node's `prod`). It also leads to the fact that `forceProcessedOredered` ordered non-zero count of Ordered messages before starting a view change. 3) There were cases when we were processing a lot of 3PC messages in one run of replica's service method, and stabilized checkpoints at the same time without letting a chance to execute ordered batches. 4) A lot of PrePrepares are discarded because if incorrect time (because the node was lagging behind). But the corresponding batches were eventually ordered. It looks like the time was accepted eventually because a quorum of Prepares was gathered.  *Logs* 874-master: ev@evernymr33:logs/1993_25_03_2019_view_changes_logs.tar.gz ev@evernymr33:logs/1993_25_03_2019_view_changes_metrics.tar.gz    ></description> </Issue>
