<Issue id="17611" key="INDY-172" number="172" project="10303" reporter="spivachuk" assignee="derashe" creator="spivachuk" type="10004" summary="Result of send GET_NYM command may be unpredictable after demoting a node and further promoting it back" priority="3" resolution="10000" status="10001" created="2017-06-07 10:57:18.0" updated="2019-03-29 20:34:02.0" resolutiondate="2019-03-29 20:34:02.0" votes="0" watches="2" timeoriginalestimate="10800" timeestimate="10800" workflowId="17615"> <description><! CDATA Ledgers may be unsynchronized after demoting a node, sending transactions and further promoting this node back. In result the outcome of send GET_NYM command may be unpredictable.  The bug seems to be related to INDY-158.  The bug was faced on the following versions: * sovrin-node 0.3.129 master deb package, * sovrin-client 0.3.125 master deb package.  I have faced this bug using the steps below. However, it is not stably reproduced using these steps.  Steps and gotten results: # Install a local pool from Vagrant script with changed APT repositories from {{xenial stable}} to {{xenial master}} in {{sovrin-environments/vagrant/training/vb-multi-vm/scripts/agent.sh}} and {{sovrin-environments/vagrant/training/vb-multi-vm/scripts/validator.sh}}. # For each node VM: connect to it via SSH, switch the user to {{sovrin}}, open the identity ledger file {{~/.sovrin/data/nodes/<NODE_ALIAS>/transactions_sandbox/<CURRENT_LOG_FILE>}} in live mode (e.g. using {{tail -f}} command) and leave the session open. # Connect to the client VM via SSH and launch {{sovrin}}. # Execute: {{connect test}} # Execute: {{new key with seed 000000000000000000000000Trustee1}} # Execute: {{send NYM dest=1111111111111111}} *  The transaction creating NYM 1111111111111111 is added to the identity ledgers on all the nodes.  * *  CLI reports: {{Nym 1111111111111111 added}}  * # Execute: {noformat} send NODE dest=Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv data={"alias": "Node1", "services":   } {noformat} *  CLI reports that it has been disconnected from Node1C.  * *  CLI reports that the node request has been completed.  * # Execute: {{send NYM dest=2222222222222222}} *  The transaction creating NYM 2222222222222222 is added to the identity ledgers on Node2, Node3 and Node4.  * *  CLI reports: {{Nym 2222222222222222 added}}  * # Execute: {noformat} send NODE dest=Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv data={"alias": "Node1", "services":  "VALIDATOR" } {noformat} *  The transaction creating NYM 2222222222222222 is added to the identity ledger on Node1.  * *  CLI reports that it has been connected to Node1C.  * *  CLI reports that the node request has been completed.  * # Execute: {{send NYM dest=3333333333333333}} *  The transaction creating NYM 3333333333333333 is added to the identity ledgers on all the nodes.  * *  CLI reports: {{Nym 3333333333333333 added}}  * # Execute: {noformat} send NODE dest=8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb data={"alias": "Node2", "services":   } {noformat} *  CLI reports that it has been disconnected from Node2C.  * *  CLI reports that the node request has been completed.  * # Execute: {{send NYM dest=4444444444444444}} *  The transaction creating NYM 4444444444444444 is added to the identity ledgers on Node1, Node3 and Node4.  * *  CLI reports: {{Nym 4444444444444444 added}}  * # Execute: {noformat} send NODE dest=8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb data={"alias": "Node2", "services":  "VALIDATOR" } {noformat} {color:red}*  The transaction creating NYM 4444444444444444 is NOT added to the identity ledger on Node2.  *{color} *  CLI reports that it has been connected to Node2C.  * *  CLI reports that the node request has been completed.  * # Multiple times execute: {{send GET_NYM dest=4444444444444444}} # Each time CLI reports: {{No verkey ever assigned to the identifier 4444444444444444}} # Execute: {{send NYM dest=5555555555555555}} {color:red}*  The transaction creating NYM 5555555555555555 is added to the identity ledgers ONLY on Node1 and Node3.  *{color} *  CLI reports: {{Nym 5555555555555555 added}}  * # Multiple times execute the following commands mixed together: {{send GET_NYM dest=4444444444444444}} {{send GET_NYM dest=5555555555555555}} *  For 4444444444444444 the CLI reports each time: {{No verkey ever assigned to the identifier 4444444444444444}}  * {color:red}*  For 5555555555555555 the CLI reports sometimes: {{No verkey ever assigned to the identifier 5555555555555555}}, sometimes: {{NYM 5555555555555555 not found}}  *{color}  ></description> </Issue>
