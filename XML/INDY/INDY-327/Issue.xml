<Issue id="18647" key="INDY-327" number="327" project="10303" reporter="aleksey-roldugin" assignee="stevetolman" creator="aleksey-roldugin" type="10004" summary=" SEND ATTRIB  CLI may crash in case of unexpected symbols in raw variable" priority="4" resolution="10001" status="10001" created="2017-06-24 13:13:16.0" updated="2019-03-29 20:35:43.0" resolutiondate="2019-03-29 20:35:43.0" votes="0" watches="3" workflowId="18647"> <description><! CDATA h6. BUILD  sovrin-node 0.3.159 sovrin-client 0.3.143  PRECONDITIONS Issue was found on  Pool 2|https://docs.google.com/spreadsheets/d/1dQs2101Xcb9HMJQufLgtmiHxA-apbjnbXn8CGiCDHp0/edit#gid=0 .  h6. STEPS TO REPRODUCE # Run sovrin-client in environment with not UTF-8 encoding:  {code:java} sovrin@sovrin-VirtualBox:~$ env LANG=C sovrin {code} or {code:java} sovrin@sovrin-VirtualBox:~$ env LANG=ru_RU.cp1251 sovrin {code} # Connect to test and run SEND ATTRIB command with any unexpected unicode symbol (ex. Â©)  {code:java} sovrin@test> send ATTRIB  dest=v8HcafSBNPoJvRs3ZSXT8 raw={"12":"?"} --- Logging error --- Traceback (most recent call last): File "/usr/lib/python3.5/logging/__init__.py", line 982, in emit stream.write(msg) UnicodeEncodeError: 'ascii' codec can't encode character '\xae' in position 147: ordinal not in range(128) Call stack: File "/usr/local/bin/sovrin", line 78, in <module> run_cli() File "/usr/local/bin/sovrin", line 56, in run_cli looper.run(cli.shell(*commands)) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 254, in run return self.loop.run_until_complete(what) File "/usr/lib/python3.5/asyncio/base_events.py", line 375, in run_until_complete self.run_forever() File "/usr/lib/python3.5/asyncio/base_events.py", line 345, in run_forever self._run_once() File "/usr/lib/python3.5/asyncio/base_events.py", line 1312, in _run_once handle._run() File "/usr/lib/python3.5/asyncio/events.py", line 125, in _run self._callback(*self._args) File "/usr/lib/python3.5/asyncio/tasks.py", line 307, in _wakeup self._step() File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 233, in wrapper results.append(await coro) File "/usr/local/lib/python3.5/dist-packages/plenum/cli/cli.py", line 1119, in shell self.parse(c) File "/usr/local/lib/python3.5/dist-packages/plenum/cli/cli.py", line 1900, in parse extra={"cli": False}) Message: 'CLI command entered: send ATTRIB  dest=v8HcafSBNPoJvRs3ZSXT8 raw={"12":"\xae"}' Arguments: () Adding attributes {"12":"?"} for v8HcafSBNPoJvRs3ZSXT8 sovrin@test> --- Logging error --- Traceback (most recent call last): File "/usr/lib/python3.5/logging/__init__.py", line 982, in emit stream.write(msg) UnicodeEncodeError: 'ascii' codec can't encode character '\xae' in position 599: ordinal not in range(128) Call stack: File "/usr/local/bin/sovrin", line 78, in <module> run_cli() File "/usr/local/bin/sovrin", line 56, in run_cli looper.run(cli.shell(*commands)) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 254, in run return self.loop.run_until_complete(what) File "/usr/lib/python3.5/asyncio/base_events.py", line 375, in run_until_complete self.run_forever() File "/usr/lib/python3.5/asyncio/base_events.py", line 345, in run_forever self._run_once() File "/usr/lib/python3.5/asyncio/base_events.py", line 1312, in _run_once handle._run() File "/usr/lib/python3.5/asyncio/events.py", line 125, in _run self._callback(*self._args) File "/usr/lib/python3.5/asyncio/tasks.py", line 307, in _wakeup self._step() File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 218, in runForever await self.runOnceNicely() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 202, in runOnceNicely msgsProcessed = await self.prodAllOnce() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 147, in prodAllOnce s += await n.prod(limit) File "/usr/local/lib/python3.5/dist-packages/sovrin_client/client/client.py", line 188, in prod s = await super().prod(limit) File "/usr/local/lib/python3.5/dist-packages/plenum/client/client.py", line 239, in prod s = await self.nodestack.service(limit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 1202, in service c = await super().service(limit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 570, in service return self.processReceived(pracLimit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 675, in processReceived self.msgHandler((msg, frm)) File "/usr/local/lib/python3.5/dist-packages/sovrin_client/client/client.py", line 103, in handleOneNodeMsg super().handleOneNodeMsg(wrappedMsg, excludeFromCli) File "/usr/local/lib/python3.5/dist-packages/plenum/client/client.py", line 280, in handleOneNodeMsg extra={"cli": printOnCli}) Message: 'Client 55ysjckjmJtgMyZccXdRPKEQRbCvLit9B4d7iPktAc9H got msg from node Node4C: {\'result\': {\'signature\': \'5HwSRwfUJavNkU5mb9GZjMzWh7CJw21qNk1n8b2fHUfE49ssnV2eoLos2z' Arguments: () sovrin@test>  Active keyring "Default-a53dab" saved (/home/sovrin/.sovrin/keyrings/test/default-a53dab.wallet) Goodbye. Traceback (most recent call last): File "/usr/local/bin/sovrin", line 78, in <module> run_cli() File "/usr/local/bin/sovrin", line 56, in run_cli looper.run(cli.shell(*commands)) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 284, in __exit__ self.shutdownSync() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 280, in shutdownSync self.loop.run_until_complete(self.shutdown()) File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete return future.result() File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result raise self._exception File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 270, in shutdown await self.runFut File "/usr/lib/python3.5/asyncio/futures.py", line 363, in __iter__ return self.result()  # May raise too. File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result raise self._exception File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step result = coro.send(None) File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 218, in runForever await self.runOnceNicely() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 202, in runOnceNicely msgsProcessed = await self.prodAllOnce() File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 147, in prodAllOnce s += await n.prod(limit) File "/usr/local/lib/python3.5/dist-packages/sovrin_client/client/client.py", line 188, in prod s = await super().prod(limit) File "/usr/local/lib/python3.5/dist-packages/plenum/client/client.py", line 239, in prod s = await self.nodestack.service(limit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 1202, in service c = await super().service(limit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 570, in service return self.processReceived(pracLimit) File "/usr/local/lib/python3.5/dist-packages/stp_zmq/zstack.py", line 675, in processReceived self.msgHandler((msg, frm)) File "/usr/local/lib/python3.5/dist-packages/sovrin_client/client/client.py", line 103, in handleOneNodeMsg super().handleOneNodeMsg(wrappedMsg, excludeFromCli) File "/usr/local/lib/python3.5/dist-packages/plenum/client/client.py", line 313, in handleOneNodeMsg result) File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/client_req_rep_store_file.py", line 83, in addReply self.delimiter, serializedReply)) File "/usr/local/lib/python3.5/dist-packages/ledger/stores/directory_store.py", line 44, in appendToValue f.write(value) UnicodeEncodeError: 'ascii' codec can't encode character '\xae' in position 218: ordinal not in range(128) {code}  h6. EXPECTED RESULT Probably values for attributes (for _raw_ parameter for now since _hash_ and _enc_ are not implemented) should have some validation.    ></description> </Issue>
