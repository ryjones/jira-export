<Action id="59051" issue="38790" author="ashcherbakov" type="comment" created="2019-04-09 09:03:35.0" updateauthor="ashcherbakov" updated="2019-04-09 09:03:35.0"> <body><! CDATA h2. Issue 1: Causes phantom txns in audit ledger and broken idr_cache (the same as in INDY-2034)  *Problem reason/description:*  - A node performs view change to view X  - It does catch-up as part of view change - Since the node is lagging behind, it caught up till (X+2, Y), that is it got txns from the future view that other nodes are already ordering in. - The Node finishes view change to X, and it turned out that it's a master primary in view X {color:#de350b}- The Node applies and sends PrePrepares for view X, although it last ordered is already for view X+2 => it has Z unordered batches  {color:#172b4d}- The node starts view change to view X+1, and is about to start catchup - The node reverts unordered batches.{color} It can not revert Z unordered batches, since  their 3PC key (view X) is less than last ordered (view X+2) {color}=> The node has phantom txns in audit ledger and idr_cache{color:#de350b} {color}     *Changes:*  - Fix sending of 3PC messages by a primary on an old view during or in between view changes. - Get rid of stashedOrderedRequest - Improved replica 3PC validation to allow only Commits during the view change.     *PR:* -  https://github.com/hyperledger/indy-plenum/pull/1151      *Version:* - 1.7.0.dev888     *Risk factors:* - View Change   *Risk:* - Med     *Covered with tests:* - test_catchup_to_next_view_during_view_change_0_to_1_then_1_to_2 - test_catchup_to_next_view_during_view_change_by_primary - unit tests in  test_replica_3pc_validation.py|https://github.com/hyperledger/indy-plenum/pull/1151/files#diff-e82220bb9f03171e61bf26ab539b2d6a      *Recommendations for QA:* - run load test with forced view change for three ledgers (domain, pool, config) with 10 writes per sec (in the scope of INDY-2025)  ></body> </Action>
<Action id="59090" issue="38790" author="ashcherbakov" type="comment" body="After the fix, the issue is not reproduced during recent load tests (forced view change, writes to all ledgers)." created="2019-04-10 10:50:06.0" updateauthor="ashcherbakov" updated="2019-04-10 10:51:01.0"/>
