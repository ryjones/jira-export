<Action id="52726" issue="33548" author="ashcherbakov" type="comment" created="2018-10-29 09:28:46.0" updateauthor="ashcherbakov" updated="2018-10-29 09:29:21.0"> <body><! CDATA PoA:  We need to make sure that there is a chance for 3PC messages to be processed before continue of paused View Change. Also it's more safe to process only 3PC messaged for the current view (to update last_pp_certificate). So, the following can be done: 1) New messages: `ViewChangeStarted` and `ViewChangeContinued` 2) New strategy with the following methods: - `prepare_view_change` - `on_view_change_started` - `on_view_change_continued`  3) `ViewChanger` calls strategy's `prepare_view_change` on `startViewChange` and exits. 4) `prepare_view_change`: - extends `Node`'s router to call `on_view_change_started` for `ViewChangeStarted` and `on_view_change_continued` for `ViewChangeContinued` - extends Master Replica's router for `ViewChangeStarted` to add `ViewChangeContinued` to node's inBox - appends `ViewChangeStarted` to node's inBox  5) `on_view_change_started`: - reads more messaged from nodestack by calling `self.nodestack.service(limit=None, quota=EXTENDED_QUOTA_MULTIPLIER * self.quota_control.node_quota)`, where `EXTENDED_QUOTA_MULTIPLIER =10` - pops all messages from node's inBox and stashes them in `stashedNodeInNox` - iterate through `stashedNodeInNox` and pop all 3PC (PrePrepare, Prepare, Commit) messages where viewNo=currentViewNo - pass all such 3PC messaged to Replica (by calling `node.nodeMsgRouter.handle(m)` - pass `ViewChangeStarted` to master replica's nodeInBox.  6) `on_view_change_continued`: - call `node.view_changer.startViewChange(continue=True)` - add all stashed messages from `stashedNodeInNox` to the head(!!!) of node's inBox  ></body> </Action>
<Action id="53113" issue="33548" author="anikitindsr" type="comment" created="2018-11-07 07:38:00.0" updateauthor="anikitindsr" updated="2018-11-07 07:38:00.0"> <body><! CDATA Some comments for PoA: * `prepare_view_change` method should not pass ViewChangeStartMessage into master replica's inBox queue, because there is no steps for processing this message on replica's side * `on_view_change_started` method is a handler for processing ViewChangeStartMessage on nodeMsgRouter's side. Also, after all msgs routines like calling nodestack.service, pops all not 3PC msgs into stashedNodeInBox queue this method should append ViewChangeContinueMessage to master replica's inBox queue.  ></body> </Action>
<Action id="53122" issue="33548" author="anikitindsr" type="comment" created="2018-11-07 10:32:41.0" updateauthor="anikitindsr" updated="2018-11-07 10:32:41.0"> <body><! CDATA Reasons: * need to take as much as possible Node-toNode messages from queues before starting ViewChange  Changes: * Added strategy for making some prepration steps before starting ViewChange as described in PoA. * Added unit and integration tests for this strategy  Versions: * indy-plenum: 1.6.582 * indy-node: 1.6.660  Recomendation for QA: - As of now, this strategy is disabled by default. For activating this need to add next lines into indy config:  `  from plenum.common.constants import PreVCStrategies PRE_VC_STRATEGY = PreVCStrategies.VC_START_MSG_STRATEGY  `  - Run load test with forced view_change (for example each 30 minutes) and check, that pool works fine (ledgers are the same on all nodes and there is no any blacklisted nodes) after several VC circles.  Â   ></body> </Action>
<Action id="53205" issue="33548" author="vladimirwork" type="comment" body=" !INDY-1687-NODE-6.PNG|thumbnail!  !INDY-1687-NODE-16.PNG|thumbnail! " created="2018-11-08 10:43:52.0" updateauthor="vladimirwork" updated="2018-11-08 10:43:52.0"/>
<Action id="53217" issue="33548" author="vladimirwork" type="comment" body=" ~Toktar   ~anikitinDSR  all logs/journals/metrics are in ev@evernymr33:logs/1687.7z" created="2018-11-08 14:05:14.0" updateauthor="vladimirwork" updated="2018-11-08 14:05:14.0"/>
<Action id="53248" issue="33548" author="ashcherbakov" type="comment" body="The rest of the testing and enabling the strategy will be done in the scope of INDY-1835." created="2018-11-09 08:05:23.0" updateauthor="ashcherbakov" updated="2018-11-09 08:05:23.0"/>
