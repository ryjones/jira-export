<Issue id="40103" key="INDY-2105" number="2105" project="10303" reporter="andkononykhin" assignee="andkononykhin" creator="andkononykhin" type="10004" summary="Indy node pipelines intermittently fails during deb building" priority="3" resolution="10000" status="10001" created="2019-05-23 14:41:39.0" updated="2019-05-24 11:01:32.0" resolutiondate="2019-05-24 07:18:09.0" votes="0" watches="1" workflowId="53004"> <description><! CDATA The issue happened when fpm tried to build deb and used `setuptools` for some its routine.  Seems related issues: *  https://github.com/pypa/setuptools/issues/196  *  https://github.com/pytest-dev/pytest-runner/issues/11   They provide some info and workarounds since the bug might be not fixed for sure: * move `pytest` to the end of the list in `tests_require` (I tried for the indy-node/setup.py - not worked) * use version of setuptools `>36.4.0`: currently we  use|https://github.com/hyperledger/indy-node/blob/385fbba18a920512a9dc00de23cf369739912c56/build-scripts/ubuntu-1604/Dockerfile#L10 Â setuptools from ubuntu-xenial with very old version `20.7.0`. Possible solution is to add something like `RUN pip install -U setuptools` to that dockerfile. I failed to verify this option since cd pipeline started to work without any changes.  Link to failed run and logs:   https://build.sovrin.org/blue/organizations/jenkins/indy-node%2Findy-node-cd/detail/master/944/pipeline  {noformat} + fpm --input-type python --output-type deb --architecture amd64 --verbose --python-package-name-prefix python3 --python-bin /usr/bin/python3 --exclude '*.pyc' --exclude '*.pyo' --depends at --depends iptables --depends libsodium18 --no-python-fix-dependencies --maintainer 'Hyperledger <hyperledger-indy@lists.hyperledger.org>' --before-install preinst_node --after-install postinst_node --before-remove prerm --name indy-node --version 1.8.0~dev944 --package /output /tmp/tmp.VAL3k8sGxO{:timestamp=>"2019-05-23T12:23:41.706071+0000", :message=>"Setting workdir", :workdir=>"/tmp", :level=>:info}{:timestamp=>"2019-05-23T12:23:41.928231+0000", :message=>"fetching package metadata", :setup_cmd=>"env PYTHONPATH=/var/lib/gems/2.3.0/gems/fpm-1.11.0/lib/fpm/package /usr/bin/python3 setup.py --command-packages=pyfpm get_metadata --output=/tmp/package-python-build-4787beb0d9ecaef836dcb48363b3e229a11a4668836fbeb7f25c9e42d1a5/metadata.json", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.552067+0000", :message=>"/usr/lib/python3.5/distutils/dist.py:261: UserWarning: Unknown distribution option: 'use_scm_version'", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.552385+0000", :message=>"  warnings.warn(msg)", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.552595+0000", :message=>"warning: install_lib: 'build/lib' does not exist -- no Python modules to install", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.552773+0000", :message=>"", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.553869+0000", :message=>"zip_safe flag not set; analyzing archive contents...", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.557977+0000", :message=>"", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.558218+0000", :message=>"Installed /tmp/tmp.VAL3k8sGxO/.eggs/UNKNOWN-0.0.0-py3.5.egg", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.564966+0000", :message=>"Traceback (most recent call last):", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.565196+0000", :message=>"  File \"setup.py\", line 93, in <module>", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.565376+0000", :message=>"    'tools/diagnostics/nsreplay',", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.565542+0000", :message=>"  File \"/usr/lib/python3.5/distutils/core.py\", line 108, in setup", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.565713+0000", :message=>"    _setup_distribution = dist = klass(attrs)", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.565868+0000", :message=>"  File \"/usr/lib/python3/dist-packages/setuptools/dist.py\", line 269, in __init__", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566018+0000", :message=>"    self.fetch_build_eggs(attrs 'setup_requires' )", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566179+0000", :message=>"  File \"/usr/lib/python3/dist-packages/setuptools/dist.py\", line 313, in fetch_build_eggs", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566463+0000", :message=>"    replace_conflicting=True,", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566634+0000", :message=>"  File \"/usr/lib/python3/dist-packages/pkg_resources/__init__.py\", line 829, in resolve", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566801+0000", :message=>"    raise DistributionNotFound(req, requirers)", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.566974+0000", :message=>"pkg_resources.DistributionNotFound: The 'pytest-runner' distribution was not found and is required by the application", :level=>:info}{:timestamp=>"2019-05-23T12:23:42.590869+0000", :message=>"Process failed: /bin/sh failed (exit code 1). Full command was: \"/bin/sh\", \"-c\", \"env PYTHONPATH=/var/lib/gems/2.3.0/gems/fpm-1.11.0/lib/fpm/package /usr/bin/python3 setup.py --command-packages=pyfpm get_metadata --output=/tmp/package-python-build-4787beb0d9ecaef836dcb48363b3e229a11a4668836fbeb7f25c9e42d1a5/metadata.json\" ", :level=>:error}Terminatedscript returned exit code 1{noformat}  ></description> </Issue>
