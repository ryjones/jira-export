<Action id="58655" issue="38799" author="vladimirwork" type="comment" created="2019-03-28 07:41:03.0" updateauthor="vladimirwork" updated="2019-03-28 07:41:29.0"> <body><! CDATA Build Info: indy-node 1.6.862  Steps to Validate: Case 1: 1. Add nym without role by default Trustee. 2. Change nym's role from None to TRUST_ANCHOR by default Trustee.  Case 2: 0. Add new Trustee by default Trustee. 1. Add nym without role by default Trustee. 2. Change nym's role from None to TRUST_ANCHOR by new Trustee from Step 0.  Actual Results: Role has been changed successfully in both cases: {noformat} {'op': 'REPLY', 'result': {'ver': '1', 'txn': {'protocolVersion': 2, 'type': '1', 'metadata': {'digest': '6eef48815c9f3cb44f87efb93fce53684a22f439af52baa6c9b1f8effd5521db', 'reqId': 1553757472302306201, 'from': 'V4SGRU86Z58d6TV7PBUe6f'}, 'data': {'dest': '7m43drkwwM7UGNFFbtVLHn', 'verkey': '4ggZ47wLFa2du1bUAEV8fKAzkGDAExjSXHCCpF2JBYmU'}}, 'txnMetadata': {'txnId': '39d778f6e55642d47b879c3c5e8004333e5e3a5a68a32ea4c24aec6e1451b5fb', 'txnTime': 1553757472, 'seqNo': 10}, 'rootHash': 'Dbf8A8bvgRXvQRcsDCMLta8ByPhF4hyWtTuCE9Nh3Shg', 'reqSignature': {'type': 'ED25519', 'values':  {'value': 'jGNqrbYLrLfJGoWq7s5qogwLEdYxpuAr3CDssByqk8Bo5t5noux26SfbNeBm6wwu9dh6czUvBT2uHjaWoLaurvQ', 'from': 'V4SGRU86Z58d6TV7PBUe6f'} }, 'auditPath':  '2sw2eXpQv3ZxWUztZhbDEaJq9yrPvUiNkGMCsEdiunBs', '6NVGJjQVapQ7HV5Xg5y8u5sHjEMp7hEXDhbcrHZ6SZsV' }}  {'op': 'REPLY', 'result': {'ver': '1', 'txn': {'protocolVersion': 2, 'type': '1', 'metadata': {'digest': '8346f2e56f9dd1f7ac0839f837906a53c8a1f63ef00dac34d746981e49e3f712', 'reqId': 1553757490568587424, 'from': 'V4SGRU86Z58d6TV7PBUe6f'}, 'data': {'role': '101', 'dest': '7m43drkwwM7UGNFFbtVLHn'}}, 'auditPath':  'ANETHcNFEudyBeZbM4wCchkan2xitYwWYvdK6gtNncT9', '6NVGJjQVapQ7HV5Xg5y8u5sHjEMp7hEXDhbcrHZ6SZsV' , 'rootHash': 'AEzS3hmN9PtsW9Gf9ykTkFWyyfQ2CipyxAt6FdSdFYXf', 'reqSignature': {'type': 'ED25519', 'values':  {'value': '2oBuj5KG8SxFt3sz9G57cHXTDQwgsc7xGLVZ4Ehj4MyTFrZvgqniDHUiAPmQxmHNRjrwddpZq922PCVhjTzipBCU', 'from': 'V4SGRU86Z58d6TV7PBUe6f'} }, 'txnMetadata': {'txnId': '39d778f6e55642d47b879c3c5e8004333e5e3a5a68a32ea4c24aec6e1451b5fb', 'txnTime': 1553757490, 'seqNo': 11}}} {noformat} --- {noformat} {'op': 'REPLY', 'result': {'txnMetadata': {'txnTime': 1553758226, 'seqNo': 16, 'txnId': '65c2840f4a85ceef631e04be46ae6db0fc9d3bff5dc64c256d8d8dcc1838c06a'}, 'reqSignature': {'values':  {'from': 'V4SGRU86Z58d6TV7PBUe6f', 'value': '5JmA8cYT6ZyW89dSktseHYLv3u1D4UQZq3ox91fYZ3b1nxudLbsyHMAVAGcuFLu3iSg7vWxV17Jvt8Bp2Lz8MwzL'} , 'type': 'ED25519'}, 'txn': {'protocolVersion': 2, 'metadata': {'digest': 'a5e2bc8a5fd504e1fdcce05534ffd45aa99cd4f9dc4ece47e1fd9087603bc4e9', 'from': 'V4SGRU86Z58d6TV7PBUe6f', 'reqId': 1553758225216949095}, 'data': {'dest': 'UU6dv4unZe4UGGY5VtSm2J', 'verkey': 'FyHwfWsywJfjNxqaAPawRhjSNFgqzkLbFZ5imp4DoboA'}, 'type': '1'}, 'auditPath':  '97YhCeuGC1GmTeECvnoPwbVcbWEyeYE9whyfktmejEYr', '9Cpsh8U3JML7MWNc16VY1anqvz6rzAZQoMqCBypiveV1', '7AMih1DPe2i191CY9CBEqzGbYYsRwY62BQgYfReiDbiD', '6NVGJjQVapQ7HV5Xg5y8u5sHjEMp7hEXDhbcrHZ6SZsV' , 'ver': '1', 'rootHash': 'AKPwa7KTWUyN8sKoD7Tdog1Ur7zaaebtBb2fLaG6jfJn'}}  {'op': 'REPLY', 'result': {'txnMetadata': {'txnTime': 1553758227, 'seqNo': 17, 'txnId': '65c2840f4a85ceef631e04be46ae6db0fc9d3bff5dc64c256d8d8dcc1838c06a'}, 'reqSignature': {'values':  {'from': 'PMvxchTQjSLbXYaCGumABU', 'value': '2LQ3Md8ftRMybMUntPPYjuaG4U8U2izorCmtqURiVqWg4pGBbxrkF7GKHu5774CYMSV4f3LuFeTyEqn2aCDMcd7W'} , 'type': 'ED25519'}, 'txn': {'protocolVersion': 2, 'metadata': {'digest': 'dbb92129715f3a84f20cedbcc039603a715ddaef5bdaa77fc6395fc825a83fdd', 'from': 'PMvxchTQjSLbXYaCGumABU', 'reqId': 1553758226223028738}, 'data': {'dest': 'UU6dv4unZe4UGGY5VtSm2J', 'role': '101'}, 'type': '1'}, 'auditPath':  'AKPwa7KTWUyN8sKoD7Tdog1Ur7zaaebtBb2fLaG6jfJn' , 'ver': '1', 'rootHash': 'H6kyoofiBGeMp12ZnoJbcMpdktLFkAF9YHm46FF7ayr'}} {noformat}   ></body> </Action>
<Action id="58656" issue="38799" author="vladimirwork" type="comment" created="2019-03-28 07:49:05.0" updateauthor="vladimirwork" updated="2019-03-28 09:01:19.0"> <body><! CDATA Build Info: indy-node 1.6.862  Steps to Reproduce: 1. Add nym with TRUST_ANCHOR  by default Trustee. 2. Change nym's role from TRUST_ANCHOR to None by default Trustee << Actually this is not a valid way to remove role since we should send *empty string* to do that but this txn (with None, not with the '') also returns REPLY from the ledger *so we should fix this behaviour anyway*. 3. Change nym's role from None to TRUST_ANCHOR again.  Actual Results: There is an error in Step 3: {'reqId': 1553759057070217822, 'identifier': 'V4SGRU86Z58d6TV7PBUe6f', 'reason': "client request invalid: UnauthorizedClientRequest('TRUSTEE can not touch role field since only the owner can modify it',)", 'op': 'REJECT'}  Expected Results: We should reject txn in Step 2 since it contains None instead of empty string maybe since we send None role only at nym's adding and role removing should be made by empty string according to API.  Additional Info: The case reproduces *for each role* that is different from None:  'TRUSTEE', 'STEWARD', 'TRUST_ANCHOR', 'NETWORK_MONITOR' .  ></body> </Action>
<Action id="58671" issue="38799" author="sklump" type="comment" created="2019-03-28 12:25:44.0" updateauthor="sklump" updated="2019-03-28 12:30:10.0"> <body><! CDATA Role None corresponds to minimal USER, which is a legitimate use case. Empty string corresponds to a role in reset.  To reproduce from indy-sdk (python wrapper), replace in pytest fixture `identity_my` in `indy-sdk/wrappers/python/tests/conftest.py` with: ----- (there is no excuse for how terrible this editor is for code - please see attachment) -----  Then edit `indy-sdk/wrappers/python/tests/ledger/test_role.py` to specify minimalist pytest ----- import pytest   @pytest.mark.asyncio async def test_role(wallet_handle, pool_handle, identity_trustee1, identity_my): pass ----- , engaging the code in the identy_my fixture.  Then, at the prompt, $ cd indy-sdk/wrappers/python/tests/ledger $ docker rm $(docker stop $(docker ps -aq)) $ docker run -d --ip=10.0.0.2 --net=indy_pool_network indy_pool $ pipenv run pytest -s test_role.py  Result: ----- Trustee V4SGRU86Z58d6TV7PBUe6f sending role None, my_verkey 3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L for my_did 4mS58yZJ88qnzcUK4ddYwA .. NYM_REQUEST { "reqId": 1553775619959271270, "identifier": "V4SGRU86Z58d6TV7PBUe6f", "operation": { "dest": "4mS58yZJ88qnzcUK4ddYwA", "type": "1", "verkey": "3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L" }, "protocolVersion": 2 } .. NYM response { "op": "REPLY", "result": { "reqSignature": { "values":   { "value": "3493TYErrWMwuDmGpvyzM9gwhz57uX5vh24rGmj3kryc55zeHjPsxUeJpUzeT33ne7iBjZS5BWG74TWroFB8SEKC", "from": "V4SGRU86Z58d6TV7PBUe6f" }  , "type": "ED25519" }, "ver": "1", "auditPath":   "EsY4hbw8MPXuyQTiq43pvwJqak6pGzfKwJKMXoi6uYS7", "DNHM372JZJoGcxdHdmsj3QSSiomyeZux6ssJXxAJqyvd"  , "txn": { "data": { "dest": "4mS58yZJ88qnzcUK4ddYwA", "verkey": "3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L" }, "metadata": { "reqId": 1553775619959271270, "digest": "4980813af45cd063641c654980f8f51cb74dd34c24aa8945ef71f08aece735b2", "from": "V4SGRU86Z58d6TV7PBUe6f" }, "protocolVersion": 2, "type": "1" }, "rootHash": "58NkzNdFZydAiJyLD4GbHSiu14bmFnYjdNdDyqTfMjyg", "txnMetadata": { "seqNo": 11, "txnId": "ca8fd511afb74b16d87097c22763f37f777427f924e97d3f09d59796811444c7", "txnTime": 1553775620 } } } .. sleeping 5 seconds .. GET_NYM_REQUEST { "reqId": 1553775625865158059, "identifier": "V4SGRU86Z58d6TV7PBUe6f", "operation": { "type": "105", "dest": "4mS58yZJ88qnzcUK4ddYwA" }, "protocolVersion": 2 } .. GET_NYM response { "result": { "identifier": "V4SGRU86Z58d6TV7PBUe6f", "txnTime": 1553775620, "type": "105", "dest": "4mS58yZJ88qnzcUK4ddYwA", "seqNo": 11, "reqId": 1553775625865158059, "data": "{\"dest\":\"4mS58yZJ88qnzcUK4ddYwA\",\"identifier\":\"V4SGRU86Z58d6TV7PBUe6f\",\"role\":null,\"seqNo\":11,\"txnTime\":1553775620,\"verkey\":\"3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L\"}", "state_proof": { "root_hash": "G8EqxT6tBT9MpjJ9SvLbbgTzKtZpoJuAc3ZPXKUdwGKB", "proof_nodes": "+QHo+LKgOo/VEa+3SxbYcJfCJ2Pzf3d0J/kk6X0/CdWXloEURMe4j/iNuIt7ImlkZW50aWZpZXIiOiJWNFNHUlU4Nlo1OGQ2VFY3UEJVZTZmIiwicm9sZSI6bnVsbCwic2VxTm8iOjExLCJ0eG5UaW1lIjoxNTUzNzc1NjIwLCJ2ZXJrZXkiOiIzNDQ1S2JSQ1drbVJjbVVkOW1id2pyQUNLcktUcWlWYVVkaDkxdG9CcWQ3TCJ9+QExoNPSP24JsVps7QufK62cHm4MLrVBpYu1VMlThcJrixajgICgmpq6PvRB/76zSDjdvXO+dATJAmHaV82rEVG2ZoAO+TCAoAIbx/TDY2y4OJtZiJtzVNjJICBQpJ4h68cXrBVl0wEvoEQAggmzS6f2NWpUQAFsJZORzSvJtNWsWBopTosPpyIZgICAgKAkcibehQ5iUOtCXD3lQORF05za0YiwT2DavXYCOkmJQqB5qfd+1iq6sbYvfigSUU9IAfb0K8M2fXBa1H5EomVc3KB9JVxOO1bVJRb8Jwgua4GPO/Juk6XhGUySCneElMV7aqAb0qE5bnVw9F5IUz5uGMXwnAHQmog75MzPMOjuL+f3taA7Ohl8US/Ipw9m90WNb/7n5LAxzanxSmitjBCIzSGcGoA=", "multi_signature": { "value": { "state_root_hash": "G8EqxT6tBT9MpjJ9SvLbbgTzKtZpoJuAc3ZPXKUdwGKB", "pool_state_root_hash": "GT89NJKZFSV4i4L2cRjDRCnfeDXFBjsAZn7SBLEdxoJE", "timestamp": 1553775620, "ledger_id": 1, "txn_root_hash": "58NkzNdFZydAiJyLD4GbHSiu14bmFnYjdNdDyqTfMjyg" }, "signature": "RUxEZprjtaXjLUQqL8EqqjFb7Hqfz2ptAwURVL8YmoTwWbE9o5noSMVBsUQHByVPuYKhhUDYGCKYz742pLFwfKJJoqwaa76gcZWUQdggb4UdiMAV355SiZoazbWCATf4rgSc5qhyNbU2zL8APKvcHz72HaqVDQAk5rse1x4X39kbD9", "participants":   "Node3", "Node2", "Node1"   } } }, "op": "REPLY" }, data role:  None    Trustee V4SGRU86Z58d6TV7PBUe6f sending role TRUST_ANCHOR, my_verkey 3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L for my_did 4mS58yZJ88qnzcUK4ddYwA .. NYM_REQUEST { "reqId": 1553775625907752398, "identifier": "V4SGRU86Z58d6TV7PBUe6f", "operation": { "dest": "4mS58yZJ88qnzcUK4ddYwA", "role": "101", "type": "1", "verkey": "3445KbRCWkmRcmUd9mbwjrACKrKTqiVaUdh91toBqd7L" }, "protocolVersion": 2 } .. NYM response { "identifier": "V4SGRU86Z58d6TV7PBUe6f", "reqId": 1553775625907752398, "reason": "client request invalid: UnauthorizedClientRequest('TRUSTEE can not touch verkey field since only the owner can modify it',)", "op": "REJECT" } E -----   ></body> </Action>
<Action id="58677" issue="38799" author="vladimirwork" type="comment" created="2019-03-28 12:51:30.0" updateauthor="vladimirwork" updated="2019-03-28 12:52:02.0"> <body><! CDATA Please notice that we have two different cases and errors in the main description and in the comment above: 1. We get `TRUSTEE can not touch {color:red}role{color} field since only the owner can modify it` when we demote nym from some role using None instead of '' and than try to promote it back to some role << we should fix this behaviour to reject None-based demotions as an option maybe. 2. We get `TRUSTEE can not touch {color:red}verkey{color} field since only the owner can modify it` when we add nym with None role and than try to add some role to it sending verkey together with new role << this is not a valid case in the current auth map since we should add\remove roles to existing nym without verkeys' sending and this reject is expected.  ></body> </Action>
<Action id="58685" issue="38799" author="sklump" type="comment" created="2019-03-28 15:17:49.0" updateauthor="sklump" updated="2019-03-28 15:27:46.0"> <body><! CDATA Re: #2, good catch. If the trustee builds and sends a NYM request with a verkey value of None along with the role of TRUST_ANCHOR, the test passes. I think I have to change my side a bit to accommodate -- I was sure it used to work at some point if the verkey value was the same as what was on the ledger, but (a) I could be wrong and (b) the right thing is not to send the verkey for a role change.  I'm still not totally convinced it's clean: let me toy with it a bit more.  ></body> </Action>
<Action id="58688" issue="38799" author="vladimirwork" type="comment" created="2019-03-28 15:22:59.0" updateauthor="vladimirwork" updated="2019-03-28 15:23:30.0"> <body><! CDATA > I was sure it used to work at some point if the verkey value was the same as what was on the ledger Yes, in old auth map it was acceptable but in new auth map we treat it as verkey rotation even if verkey is the same so verkey rotation should be performed without role value filled and role rotation should be performed without verkey value filled in the latest versions.  ></body> </Action>
<Action id="58692" issue="38799" author="sklump" type="comment" created="2019-03-28 15:45:52.0" updateauthor="sklump" updated="2019-03-28 15:45:52.0"> <body><! CDATA I've reproduced case #1 with the attached replacements to conftest.py (conftest-ta-none-ta-identity_my.py). Pytest, in building identity_my fixture as specified, now attempts to proceed with: 1 - TRUST_ANCHOR 2 - '' (for role change) 3 - None (minimal USER) 4 - '' (role change) 5 - TRUST_ANCHOR.  The operation succeeds through #3, but fails on #4 with ----- .. NYM response { "identifier": "V4SGRU86Z58d6TV7PBUe6f", "reason": "client request invalid: UnauthorizedClientRequest('TRUSTEE can not touch role field since only the owner can modify it',)", "reqId": 1553787420738213443, "op": "REJECT" } ----- The error message implies a glitch in logic, since the TRUSTEE should have permission to modify the role field. I believe this is the case #1 you've outlined above.  Do we agree that there is still something to look into here?  In particular, moving off role=None (via role='' for replacement step) should either succeed or else documentation should reflect the fact that there is some other process to add a role beyond minimal USER (role=None).  ></body> </Action>
<Action id="58693" issue="38799" author="sklump" type="comment" created="2019-03-28 15:50:28.0" updateauthor="sklump" updated="2019-03-28 15:50:28.0"> <body><! CDATA ... as it turns out, moving off Role=None does not require the intermediate step of sending Role=''. If instead the sequence proceeds like this: 1 - TRUST_ANCHOR 2 - '' (for role change) 3 - None (minimal USER) 4 - TRUST_ANCHOR  then the operation completes successfully. Since '' corresponds to ROLE_REMOVE in the indy-sdk comments, and in a sense Role=None (meaning USER), one can argue that removing a role of None doesn't make sense from point of view of pure data.  I will adapt my code to the reality.  ></body> </Action>
