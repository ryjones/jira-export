<Action id="53754" issue="35312" author="toktar" type="comment" created="2018-11-23 13:50:16.0" updateauthor="toktar" updated="2018-11-23 13:50:16.0"> <body><! CDATA Problem reason: - Node1 is sending a commit message and using committed_pool_root_hash_1 and data from PrePrepare to sign it. Node2 receives the commit from Node1 and validate it with its current committed_pool_root_hash, which is equal to committed_pool_root_hash_2 and different from the one used during signing. So, pool root hashes are different, and, although commit is correct, BLS signature verification fails, Commit is considered as invalid, and this batch will never be ordered.  Changes: - Add the current uncommitted pool state root hash to "POOL_STATE_ROOT_HASH" to PrePrepare message  -  Extend validation of received PrePreapares to check, that POOL_STATE_ROOT_HASH is equal to the node's uncommitted state root hash.  -  Change commit BLS signature creating. Now it should use pool state root hash from PrePrepare message instead committed state root hash. We can do it because pool state root hash from PrePrepare has already been verified in PrePrepare validation. -  Change validation of a commit BLS signature. Now it should use pool state root hash from PrePrepare message instead committed state root hash. -  Change logging message in case with incorrect BLS signature for commit message. Add information about an incorrect Commit message -  Change using BLS key in creating signature from committed state to using key from uncommitted state. - Add tests  PR: *  https://github.com/hyperledger/indy-node/pull/1055  *  https://github.com/hyperledger/indy-plenum/pull/980   Version: * indy-node 1.6.700 -master * indy-plenum 1.6.604  -master  Risk factors: - Node ordering  Risk: - Low  Covered with tests: * test for create3PCBatchwith for empty requests queues - {{test_create_3pc_batch_with_empty_requests}}  *  test for successful finish for create3PCBatch (POOL_STATE_ROOT_HASH added) - {{test_create_3pc_batch}}  *  test for update_commit with _can_process_ledger() = false - {{test_update_commit_pool_ledger}}  *  test for update_commit with can_sign_bls() = false - {{test_update_commit_without_bls_crypto_signer}}  *  test for successful finish for update_commit (signature added) - {{test_update_commit}}  *  test for validate_commit with no BLS_MULTI_SIG in pre_prepare - {{test_validate_commit_correct_sig_first_time}}  *  test for validate_commit with invalid pool_state_root_hash - {{test_validate_commit_signature_without_pool_state_root}}  *  test for validate_commit with correct pool_state_root_hash - {{test_validate_commit_correct_sig_second_time}}  *  test for validate_commit without pool_state_root_hash - {{test_validate_commit_signature_without_pool_state_root}}  *  test for success processPrePrepare - {{test_process_pre_prepare_validation}}  *  test for processPrePrepare without old PrePrepare schema - {{test_process_pre_prepare_validation_old_schema}}  *  test for processPrePrepare with invalid POOL_STATE_ROOT_HASH - {{test_process_pre_prepare_with_pool_state_root}}  *  test for processPrePrepare with correct POOL_STATE_ROOT_HASH - {{test_process_pre_prepare_with_incorrect_pool_state_root}}  *  integration test - {{test_commit_signature_validation_integration}} :  * test_validate_commit_does_not_use_committed_pool_state * test_validate_pre_prepare_does_not_use_committed_pool_state  Recommendations for QA: * Repeat test from INDY-1823  ></body> </Action>
<Action id="53835" issue="35312" author="zhigunenko.dsr" type="comment" created="2018-11-27 13:44:24.0" updateauthor="zhigunenko.dsr" updated="2018-11-27 13:44:24.0"> <body><! CDATA *Environment* indy-node 1.6.700 logLevel = debug   *Step to Reproduce* live_agent4: perf_processes.py -g pool -c 1 -n 1 -l 5 -k nym -y one -b 10 live_agent5: perf_processes.py -g pool -c 1 -n 1 -l 1 -k "demoted_node" -y one -b 10  *Actual Results:* Pool started  sudo read_ledger --type=domain --count >> 55622 sudo read_ledger --type=pool --count >> 13015 "View_No":      22 "Last_complete_view_no":  22  ></body> </Action>
<Action id="53888" issue="35312" author="vladimirwork" type="comment" created="2018-11-28 08:58:01.0" updateauthor="vladimirwork" updated="2018-11-28 08:58:01.0"> <body><! CDATA Build Info: indy-node 1.6.701  Steps to Validate: 1. Run production load without fees against 25 nodes pool for 16+ hours. 2. Check logs for "Commit message has invalid BLS signature" entries.  Actual Results: Pool works normally. There are no "Commit message has invalid BLS signature" entries in the logs.  ></body> </Action>
