<Issue id="20553" key="INDY-797" number="797" project="10303" reporter="ozheregelya" creator="ozheregelya" type="10004" summary="Client does not work with the pool after promotion/demotion of nodes" priority="2" resolution="10200" status="10001" created="2017-08-31 13:24:52.0" updated="2019-03-29 20:33:43.0" resolutiondate="2019-03-29 20:33:43.0" votes="0" watches="2" workflowId="20557"> <environment><! CDATA Build Info: stable repo:   indy-node 1.1.33   indy-anoncreds 1.0.10   indy-plenum 1.1.24   sovrin 1.1.6 OS/Platform: Ubuntu 16.04.2 LTS Setup: 4-5 nodes, 1 client  ></environment> <description><! CDATA *Case 1:* Steps to Reproduce: 1. Set up the pool of 4 nodes. 2. Open the CLI. Only 1 - 4 nodes are in pool_transactions_sandbox_genesis file: {code:java} {"data":{"alias":"Node1","client_ip":"10.0.0.2","client_port":9702,"node_ip":"10.0.0.2","node_port":9701,"services": "VALIDATOR" },"dest":"Gw6pDLhcBcoQesN72qfotTgFa7cbuqZpkX3Xo6pLhPhv","identifier":"FYmoFw55GeQH7SRFa37dkx1d2dZ3zUF8ckg7wmL7ofN4","txnId":"fea82e10e894419fe2bea7d96296a6d46f50f93f9eeda954ec461b2ed2950b62","type":"0"} {"data":{"alias":"Node2","client_ip":"10.0.0.3","client_port":9704,"node_ip":"10.0.0.3","node_port":9703,"services": "VALIDATOR" },"dest":"8ECVSk179mjsjKRLWiQtssMLgp6EPhWXtaYyStWPSGAb","identifier":"8QhFxKxyaFsJy4CyxeYX34dFH8oWqyBv1P4HLQCsoeLy","txnId":"1ac8aece2a18ced660fef8694b61aac3af08ba875ce3026a160acbc3a3af35fc","type":"0"} {"data":{"alias":"Node3","client_ip":"10.0.0.4","client_port":9706,"node_ip":"10.0.0.4","node_port":9705,"services": "VALIDATOR" },"dest":"DKVxG2fXXTU8yT5N7hGEbXB3dfdAnYv1JczDUHpmDxya","identifier":"2yAeV5ftuasWNgQwVYzeHeTuM7LwwNtPR3Zg9N4JiDgF","txnId":"7e9f355dffa78ed24668f0e0e369fd8c224076571c51e2ea8be5f26479edebe4","type":"0"} {"data":{"alias":"Node4","client_ip":"10.0.0.5","client_port":9708,"node_ip":"10.0.0.5","node_port":9707,"services": "VALIDATOR" },"dest":"4PS3EDQ3dW1tci1Bp6543CfuuebjFrg36kLAUcskGfaA","identifier":"FTE95CVthRtrBnK2PYCBbC9LghTcGwi9Zfi1Gz2dnyNx","txnId":"aa5e817d7cc626170eca175822029339a444eb0ee8f0bd20d3b0b76e566fb008","type":"0"}{code} 3. Using CLI, add 1 more node to the pool. 4. Exit the CLI. 5. Open CLI again, connect to test environment. 6. Try to send NYM.  Actual Results: Following message appear in CLI during connection to test: {code:java} FiZUBGTj5sXzKtRHbuYVoXr9ePMeUku8hUjwvecHaKTm could not verify catchup reply CATCHUP_REP{'ledgerId': 0, 'consProof':   , 'txns': {'5': {'signature': '514zkpnsiekKieL9FzJwK3vh4Qq3S9tVDmDr3QLeUS1GuoR231Rs2dM575KVosB8yYrqFR8eYUHJhLZ2YMHWq91S', 'reqId': 1504177080495373, 'txnTime': 1504177080, 'data': {'node_port': 9701, 'node_ip': '10.0.0.6', 'alias': 'Node5', 'client_ip': '10.0.0.6', 'services':  'VALIDATOR' , 'client_port': 9702}, 'identifier': 'XhYtvJqezMUKfF6KVNaGmT', 'dest': '4Tn3wZMNCvhSTXPcLinQDnHyj56DTLQtL61ki4jo2Loc', 'type': '0'}}} since Inconsistency: different root hashes for the same tree size {code} NYM was not send.  Expected Results: NYM should be send, message should not be shown.  *Case 2:* Steps to Reproduce: 0. After steps of Case 1 perform following actions: 1. Add to Node5 to pool_transactions_sandbox_genesis file. 2. Open the CLI, try to send NYM. => NYM is successfully added. 3. Demote Node5 using CLI. 4. Exit the CLI, open it again. 5. Connect to test, try to send NYM.  Actual Results: Following message appear in CLI during connection to test: {code:java} 3y9Q1EXsVcPS6AGd3Ujtf5kfvZVatjuHKidbhNc5aFyN could not verify catchup reply CATCHUP_REP{'txns': {'6': {'type': '0', 'reqId': 1504185580897602, 'dest': '4Tn3wZMNCvhSTXPcLinQDnHyj56DTLQtL61ki4jo2Loc', 'txnTime': 1504185581, 'identifier': 'V4SGRU86Z58d6TV7PBUe6f', 'signature': '4KotWu6AWYdaQtr1Qani71tZzRPfkrWTaMBb81VC2yPhoNDwUqq7qMitKhBmNhrC4xuusszavhd6nsV7NLwe9v16', 'data': {'alias': 'Node5', 'services':   }}}, 'ledgerId': 0, 'consProof':   } since Inconsistency: different root hashes for the same tree size{code} Nym was not send.  Expected Results: NYM should be send, message should not be shown.  *Additional Information:* The issue is also reproduces on previous stable version (indy-node=1.0.28).  Attached files contain nodes logs and .sovrin folder after Case 2.  Possible workaround: Change pool_transactions_sandbox_genesis file manually: add according row in case of adding node and remove according row in case of demotion. Or use generate_sovrin_pool_transactions with remaining nodes in -ips list.  ></description> </Issue>
