<Issue id="43799" key="INDY-2319" number="2319" project="10303" reporter="ashcherbakov" creator="ashcherbakov" type="10004" summary="Up to F Nodes may not be able to finish View Change if there are uncommitted NODE txns" priority="3" resolution="10000" status="10001" created="2019-12-25 12:35:08.0" updated="2020-01-13 15:37:18.0" resolutiondate="2020-01-13 15:37:18.0" votes="0" watches="2" workflowId="57652"> <description><! CDATA *Issue:*  Up to F Nodes may not be able to finish View Change as they select different Primaries during view change if there are uncommitted NODE txns. As uncommitted state is reverted after we select new primaries in new view, it's possible that some Nodes will select incorrect Primaries.  *Case:* * 4 Nodes, viewNo=3, Node4 is a Primary * a NODE txn to add Node5  is sent and received by Nodes, but not yet proposed in a PrePrepare to any Node * A view change to viewNo=3 is triggered, Node4 is selected as a new Primary * View Change is finished on Node4 (next Primary) only * Node4 sent a PrePrepare with a NODE txn to add a new Node (Node5) * Only Node4 applied this PrePrepare, so its node registry is updated (uncommitted) * The PrePrepare can not be committed as only 1 node finished view change * View Change to viewNo=4 is triggered (because of View Change timeout). * Nodes select primaries against (uncommitted) node reg as it was at the beginning of last view. **  Node1, Node2, Node3, Node4  for Nodes 1-3 (for viewNo=2) **  Node1, Node2, Node3, Node4, Node5  for Node 4 (for viewNo=3) * So, for viewNo=4 Nodes 1-3 select Node1 as the next Primary, and Node 4 - Node5. * View Change will not finish on Node4. ** INDY-2308 will help in finishing  *Possible fix:* Either revert uncommitted state before selecting new Primaries in the new view, or keep `node_reg_at_beginning_of_view` for committed txns only.     ></description> </Issue>
