<Action id="42827" issue="28062" author="sergey.khoroshavin" type="comment" created="2018-04-11 15:32:00.0" updateauthor="sergey.khoroshavin" updated="2018-04-11 15:32:00.0"> <body><! CDATA  ~lovesh   ~sergey-shilov   ~anikitinDSR   ~ashcherbakov   After some research I have the following basic proposal: {code} def create3PCBatch(self, ledger_id): ... tm = self.utc_epoch +       if tm < self.last_accepted_pre_prepare_time: +            tm = self.last_accepted_pre_preapre_time ... {code}  Also,  ~sergey-shilov  proposed to add additional check if current system time is not less than last accepted preprepare time minus some tolerance so that if master primary has wrong clock it will stop processing requests, which in turn should trigger view change. It doesn't seem to break anything, but we want to be sure that I didn't miss anything, so please review this.  ></body> </Action>
<Action id="42840" issue="28062" author="lovesh" type="comment" body=" ~sergey.khoroshavin  The ticket says &quot;so that each new transaction (3PC batch)&quot;, since a batch can have more than 1 txn, do you mean each transaction in the batch should have a different timestamp? If yes then why? What does it give us and its technically incorrect too to give each txn of the same batch a different timestamp." created="2018-04-11 20:03:26.0" updateauthor="lovesh" updated="2018-04-11 20:04:13.0"/>
<Action id="42852" issue="28062" author="sergey.khoroshavin" type="comment" body=" ~lovesh  Probably this ticket have imprecise wording. We don&apos;t want to change logic behind transaction timestamps inside batch. The main problem that we are trying to address is that in some cases system time can go back and in this case it&apos;s possible that new batch will get older timestamp. So main change that we propose is to enforce monotonic timestamps for batches. " created="2018-04-12 07:41:30.0" updateauthor="sergey.khoroshavin" updated="2018-04-12 07:41:30.0"/>
<Action id="43043" issue="28062" author="ashcherbakov" type="comment" created="2018-04-17 08:10:47.0" updateauthor="ashcherbakov" updated="2018-04-17 08:10:47.0"> <body><! CDATA  ~sergey.khoroshavin   ~sergey-shilov   The proposed solution can solve the problem of assigning a correct tm for each next 3PC batch by Primary. But what if the primary is malicious? I think we also need to add validation of tm for non-primaries such that they make sure the new 3PC batch's tm is not less than the previous one.  ></body> </Action>
<Action id="43047" issue="28062" author="sergey.khoroshavin" type="comment" created="2018-04-17 08:55:29.0" updateauthor="sergey.khoroshavin" updated="2018-04-17 08:55:29.0"> <body><! CDATA  ~ashcherbakov   This validation is already  implemented|https://github.com/hyperledger/indy-plenum/blob/master/plenum/server/replica.py#L2280   ></body> </Action>
<Action id="43095" issue="28062" author="ashcherbakov" type="comment" body="Please note, that we need to consider the case when `self.last_accepted_pre_prepare_time is None`. We need to go to the storage with our timestamps and take the latest one." created="2018-04-18 12:23:24.0" updateauthor="ashcherbakov" updated="2018-04-18 12:23:24.0"/>
<Action id="43606" issue="28062" author="anikitindsr" type="comment" created="2018-04-28 13:42:31.0" updateauthor="anikitindsr" updated="2018-04-28 13:42:31.0"> <body><! CDATA PRs: - indy-node: https://github.com/hyperledger/indy-node/pull/674 - indy-plenum: https://github.com/hyperledger/indy-plenum/pull/646  Versions: - indy-node: 1.3.395 - indy-plenum: 1.2.342  Reasons: - need to provide, that each next 3PC batch will have a timestamp not less than the previous one  Changes: - move tsDbStorage from indy-node into indy-plenum - save each transaction's time into storage - check, that preprepare's timestamp greater than last ordered  Steps to check: - send txn - for primary node, set system time less than previous ordered. - send new txn - check, that transaction's time for new txn greater or equal previous ordered txn  ></body> </Action>
<Action id="43928" issue="28062" author="ozheregelya" type="comment" created="2018-05-05 17:48:49.0" updateauthor="ozheregelya" updated="2018-05-05 17:48:49.0"> <body><! CDATA *Environment:* indy-node 1.3.403 indy-cli 1.3.1~505  *Steps to Validate:* 1. Setup the pool. 2. Write several txns. 3. Change time on primary to ~5 min earlier. 4. Write one more transaction.  *Actual Results:* New txn was written with the same time as previous one.  Need to clarify expected behavior for time changed on more than 10 minutes.  ></body> </Action>
<Action id="43991" issue="28062" author="ozheregelya" type="comment" body="UPD for changing time on more than 10 minutes: in case of changing time to the past, txns are successfully written. Case of changing time to the future is not affected by this ticket and will be tested separately." created="2018-05-07 12:55:53.0" updateauthor="ozheregelya" updated="2018-05-07 12:55:53.0"/>
