<Issue id="26283" key="INDY-1073" number="1073" project="10303" reporter="vladimirwork" assignee="anikitindsr" creator="vladimirwork" type="10004" summary="Pool doesn&apos;t work in in-memory mode" priority="3" resolution="10001" status="10001" created="2017-12-26 15:54:38.0" updated="2019-03-29 20:35:45.0" resolutiondate="2019-03-29 20:35:45.0" votes="0" watches="5" workflowId="26292"> <description><! CDATA Build Info: indy-node 1.2.251  Steps to Reproduce: 1. Install pool. 2. Stop all nodes. 3. Clear all nodes by `clear_node.py --full FULL`. 4. Execute `generate_indy_pool_transactions` on all nodes. 5. Add to /etc/indy/indy_config.py: {noformat} hashStore = { "type": "memory" }  domainStateStorage = 2 poolStateStorage = 2 reqIdToTxnStorage = 2 stateSignatureStorage = 2 {noformat} 6. Start all nodes.  Actual Results: Nodes disconnect from each other spontaneously after start in Step 6. There is a tracelog in journalctl and indy-node status: {noformat} Dec 26 11:37:19 c0f20025ee61 env 189 : Traceback (most recent call last): Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/bin/start_indy_node", line 17, in <module> Dec 26 11:37:19 c0f20025ee61 env 189 :     run_node(config, self_name, int(sys.argv 2 ), int(sys.argv 3 )) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/utils/node_runner.py", line 34, in run_node Dec 26 11:37:19 c0f20025ee61 env 189 :     looper.run() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 290, in __exit__ Dec 26 11:37:19 c0f20025ee61 env 189 :     self.shutdownSync() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 286, in shutdownSync Dec 26 11:37:19 c0f20025ee61 env 189 :     self.loop.run_until_complete(self.shutdown()) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete Dec 26 11:37:19 c0f20025ee61 env 189 :     return future.result() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result Dec 26 11:37:19 c0f20025ee61 env 189 :     raise self._exception Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step Dec 26 11:37:19 c0f20025ee61 env 189 :     result = coro.send(None) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 276, in shutdown Dec 26 11:37:19 c0f20025ee61 env 189 :     await self.runFut Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/futures.py", line 363, in __iter__ Dec 26 11:37:19 c0f20025ee61 env 189 :     return self.result()  # May raise too. Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result Dec 26 11:37:19 c0f20025ee61 env 189 :     raise self._exception Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/utils/node_runner.py", line 34, in run_node Dec 26 11:37:19 c0f20025ee61 env 189 :     looper.run() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 260, in run Dec 26 11:37:19 c0f20025ee61 env 189 :     return self.loop.run_until_complete(what) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete Dec 26 11:37:19 c0f20025ee61 env 189 :     return future.result() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result Dec 26 11:37:19 c0f20025ee61 env 189 :     raise self._exception Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step Dec 26 11:37:19 c0f20025ee61 env 189 :     result = coro.send(None) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 223, in runForever Dec 26 11:37:19 c0f20025ee61 env 189 :     await self.runOnceNicely() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 206, in runOnceNicely Dec 26 11:37:19 c0f20025ee61 env 189 :     msgsProcessed = await self.prodAllOnce() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 151, in prodAllOnce Dec 26 11:37:19 c0f20025ee61 env 189 :     s += await n.prod(limit) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/server/node.py", line 351, in prod Dec 26 11:37:19 c0f20025ee61 env 189 :     c = await super().prod(limit) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 910, in prod Dec 26 11:37:19 c0f20025ee61 env 189 :     c += await self.serviceNodeMsgs(limit) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 944, in serviceNodeMsgs Dec 26 11:37:19 c0f20025ee61 env 189 :     await self.processNodeInBox() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1503, in processNodeInBox Dec 26 11:37:19 c0f20025ee61 env 189 :     await self.nodeMsgRouter.handle(m) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 81, in handle Dec 26 11:37:19 c0f20025ee61 env 189 :     res = self.handleSync(msg) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 70, in handleSync Dec 26 11:37:19 c0f20025ee61 env 189 :     return self.getFunc(msg 0 )(*msg) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/message_req_processor.py", line 50, in process_message_rep Dec 26 11:37:19 c0f20025ee61 env 189 :     return handler.process(msg, frm) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/message_handlers.py", line 63, in process Dec 26 11:37:19 c0f20025ee61 env 189 :     return self.processor(valid_msg, params, frm) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/message_handlers.py", line 81, in processor Dec 26 11:37:19 c0f20025ee61 env 189 :     self.node.ledgerManager.processLedgerStatus(validated_msg, frm=frm) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 329, in processLedgerStatus Dec 26 11:37:19 c0f20025ee61 env 189 :     self.mark_ledger_synced(ledgerId) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 876, in mark_ledger_synced Dec 26 11:37:19 c0f20025ee61 env 189 :     self.postAllLedgersCaughtUp() Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1737, in allLedgersCaughtUp Dec 26 11:37:19 c0f20025ee61 env 189 :     if self.is_catchup_needed(): Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1753, in is_catchup_needed Dec 26 11:37:19 c0f20025ee61 env 189 :     if self.caught_up_for_current_view(): Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1789, in caught_up_for_current_view Dec 26 11:37:19 c0f20025ee61 env 189 :     ledger.tree.merkle_tree_hash(0, size)) != root_hash: Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/ledger/compact_merkle_tree.py", line 211, in merkle_tree_hash Dec 26 11:37:19 c0f20025ee61 env 189 :     foldedHash = self.__hasher._hash_fold(hashes ::-1 ) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/ledger/tree_hasher.py", line 77, in _hash_fold Dec 26 11:37:19 c0f20025ee61 env 189 :     accum = self.hash_children(cur, accum) Dec 26 11:37:19 c0f20025ee61 env 189 :   File "/usr/local/lib/python3.5/dist-packages/ledger/tree_hasher.py", line 29, in hash_children Dec 26 11:37:19 c0f20025ee61 env 189 :     hasher.update(b"\x01" + left + right) Dec 26 11:37:19 c0f20025ee61 env 189 : TypeError: can't concat bytes to tuple {noformat}  Expected Results: Pool should work normally in in-memory mode.  ></description> </Issue>
