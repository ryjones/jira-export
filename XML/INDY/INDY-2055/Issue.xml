<Issue id="39330" key="INDY-2055" number="2055" project="10303" reporter="sergey.khoroshavin" assignee="vladimirwork" creator="sergey.khoroshavin" type="10004" summary="Some nodes failed to join consensus after upgrade" priority="2" resolution="10000" status="10001" created="2019-04-15 15:49:26.0" updated="2019-04-18 12:05:18.0" resolutiondate="2019-04-18 10:19:04.0" votes="0" watches="3" workflowId="52209"> <description><! CDATA During testing INDY-2047 it was found that during upgrade to version which has INDY-1757 implemented nodes that need to do catchup will fail with traceback: {code} Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/catchup/catchup_rep_service.py", line 104, in process_catchup_rep Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     num_processed = self._process_catchup_txns(txns_already_rcvd_in_catchup) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/catchup/catchup_rep_service.py", line 338, in _process_catchup_txns Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     self._add_txn(txn) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/catchup/catchup_rep_service.py", line 418, in _add_txn Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     self._provider.notify_transaction_added_to_ledger(self._ledger_id, txn) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/catchup/node_catchup_data.py", line 58, in notify_transaction_added_to_ledger Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     info.postTxnAddedToLedgerClbk(ledger_id, txn) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 2188, in postTxnFromCatchupAddedToLedger Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     self.updateSeqNoMap( txn , ledger_id) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 3350, in updateSeqNoMap Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     for txn in committedTxns) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/plenum/persistence/req_id_to_txn.py", line 30, in addBatch Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     self._keyValueStorage.setBatch(payload) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "/usr/local/lib/python3.5/dist-packages/storage/kv_store_rocksdb.py", line 126, in setBatch Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :     b.put(key, value) Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "rocksdb/_rocksdb.pyx", line 1347, in rocksdb._rocksdb.WriteBatch.put Apr 15 14:08:01 londonQALive13.qatest.evernym.com env 1049 :   File "rocksdb/_rocksdb.pyx", line 103, in rocksdb._rocksdb.bytes_to_slice {code}  This is due to changes in transaction metadata format.   *Acceptance criteria* Bug should be fixed   ></description> </Issue>
