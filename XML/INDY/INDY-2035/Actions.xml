<Action id="58661" issue="38819" author="sergey.khoroshavin" type="comment" created="2019-03-28 10:06:37.0" updateauthor="sergey.khoroshavin" updated="2019-03-28 10:06:37.0"> <body><! CDATA Load test on last stable failed with most nodes falling out of consensus. Moreover, these nodes crashed with following traceback: {code} Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 : Traceback (most recent call last): Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/bin/start_indy_node", line 19, in <module> Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     client_ip=sys.argv 4 , client_port=int(sys.argv 5 )) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/utils/node_runner.py", line 54, in run_node Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     looper.run() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 263, in run Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return self.loop.run_until_complete(what) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/lib/python3.5/asyncio/base_events.py", line 387, in run_until_complete Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return future.result() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/lib/python3.5/asyncio/futures.py", line 274, in result Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     raise self._exception Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/lib/python3.5/asyncio/tasks.py", line 239, in _step Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     result = coro.send(None) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 227, in runForever Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     await self.runOnceNicely() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 210, in runOnceNicely Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     msgsProcessed = await self.prodAllOnce() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/stp_core/loop/looper.py", line 152, in prodAllOnce Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     s += await n.prod(limit) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/server/node.py", line 313, in prod Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     c = await super().prod(limit) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 376, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return await f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1357, in prod Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     c += await self.serviceNodeMsgs(limit) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 376, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return await f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 1406, in serviceNodeMsgs Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     await self.processNodeInBox() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 376, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return await f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 2003, in processNodeInBox Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     await self.process_one_node_message(m) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 2007, in process_one_node_message Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     await self.nodeMsgRouter.handle(m) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 81, in handle Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     res = self.handleSync(msg) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/router.py", line 70, in handleSync Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return self.getFunc(msg 0 )(*msg) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 363, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 538, in processCatchupRep Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.mark_catchup_completed_if_possible(ledger_info) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 667, in mark_catchup_completed_if_possible Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.catchupCompleted(ledger_info.id, (cp.viewNo, cp.ppSeqNo)) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 883, in catchupCompleted Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.mark_ledger_synced(ledgerId) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/ledger_manager.py", line 898, in mark_ledger_synced Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.postAllLedgersCaughtUp() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 2293, in allLedgersCaughtUp Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.processStashedOrderedReqs() Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 3569, in processStashedOrderedReqs Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     self.processOrdered(msg) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 363, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 2771, in processOrdered Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     ordered.txnRootHash) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/common/metrics_collector.py", line 363, in wrapper Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     return f(self, *args, **kwargs) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 3351, in executeBatch Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     state_root, txn_root) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 705, in default_executer Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     pp_time, reqs_keys, state_root, txn_root) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/node.py", line 3441, in commitAndSendReplies Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     committedTxns = reqHandler.commit(len(reqs_keys), stateRoot, txnRoot, ppTime) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/indy_node/server/config_req_handler.py", line 143, in commit Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     committedTxns = super().commit(txnCount, stateRoot, txnRoot, ppTime) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/ledger_req_handler.py", line 67, in commit Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     txnRoot, ppTime, ts_store=self.ts_store) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :   File "/usr/local/lib/python3.5/dist-packages/plenum/server/ledger_req_handler.py", line 106, in _commit Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 :     .format(ledger.root_hash)) Mar 27 21:59:30 seoulQALive8.qatest.evernym.com env 16600 : common.exceptions.PlenumValueError: variable 'txnRoot', value EeEsMRnQK6JKTvAcL16RJ4Y6KEmnwvVStsANsyLviW14, expected: equal to current ledger root hash HsbcJCXyZ3vH6mAM9zUCqe4pBoQ6tmi837DpUPojBSdc {code}  ></body> </Action>
<Action id="59190" issue="38819" author="sergey.khoroshavin" type="comment" created="2019-04-12 11:12:12.0" updateauthor="sergey.khoroshavin" updated="2019-04-12 11:12:12.0"> <body><! CDATA *Problem reason* Commits received out of order are stashed and periodically checked whether they can be processed. This check didn't take into account ledger state, and could actually process commits and apply batches in the middle of catch-up.  *Changes made* Necessary checks are added to process_stashed_out_of_order_commits  *PRs* https://github.com/hyperledger/indy-plenum/pull/1149 https://github.com/hyperledger/indy-plenum/pull/1156  *Covered with tests* test_catchup_with_skipped_commits test_catchup_with_skipped_commits_received_before_catchup_audit test_catchup_with_skipped_commits_received_before_catchup_pool   ></body> </Action>
