<Action id="38672" issue="26736" author="sergey-shilov" type="comment" created="2018-01-16 10:49:37.0" updateauthor="sergey-shilov" updated="2018-01-17 13:43:31.0"> <body><! CDATA *Problem state / reason:*  There is no way to limit the number of simultaneous clients connections using ZMQ API, so some external firewall is needed.  *Changes:* * Added iptables dependency to indy-node package * Added a script _setup_iptables_ that adds an iptables rule that limits the number of simultaneous connections per client port * Added a wrapper script _setup_indy_node_iptables_ for the script described above, this script uses indy-node environment file to get client port and recommended clients connections limit  *Committed into:* *  https://github.com/hyperledger/indy-node/pull/520  *  https://github.com/hyperledger/indy-node/pull/523  * indy-node 1.2.272-master  *Risk factors:* - Nothing is expected.  *Risk:* - Low  *Recommendations for QA:*  Check installation of indy-node deb package using apt, as a result of the installation process the iptables should be installed as a dependency,  Then run the _setup_indy_node_iptables_ script as a non-root, the following error message should appear:  _"Warning: iptables is not installed or permission denied, clients connections limit is not set."_  Then run the _setup_indy_node_iptables_ script as a root, no any messages are expected. Then as a root check that a rule has been added using command below (example);  ====================================================================== # iptables -L  Chain INPUT (policy ACCEPT) target     prot opt source               destination          REJECT     tcp  --  anywhere             anywhere             tcp dpt:9702 flags:FIN,SYN,RST,ACK/SYN #conn src/0 > 15360 reject-with tcp-reset  Chain FORWARD (policy ACCEPT) target     prot opt source               destination           Chain OUTPUT (policy ACCEPT) target     prot opt source               destination  ======================================================================  *NOTE:* if the indy-node package is installed under the docker image and the docker container is run without _--privileged_ option (default for us now) then iptables should be installed as a dependency, but all operations on it are denied due to lack of privileges even if you are a root.  Also check upgrade (migration), expected: * clients connections limit is appended to /etc/indy/indy.env * setup_indy_node_iptables works  ></body> </Action>
<Action id="38861" issue="26736" author="vladimirwork" type="comment" created="2018-01-18 16:11:32.0" updateauthor="vladimirwork" updated="2018-01-18 16:11:32.0"> <body><! CDATA Build Info: indy-node 1.2.275  Steps to Validate: 0. Install pool. 1. Set connections limit using `setup_indy_node_iptables`. 2. Set connections limit using `setup_iptables` (e.g. `setup_iptables 9702 1`). 3. Install pool of version without iptables changes. 4. Upgrade it to 1.2.275+ version. 5. Retest Steps 1, 2 on upgraded pool.  Actual Results: Script sets iptables policies as expected. CLIENT_CONNECTIONS_LIMIT is written into indy.env during migration.  ></body> </Action>
