<Issue id="32356" key="INDY-1532" number="1532" project="10303" reporter="ckochenower" creator="ckochenower" type="10002" summary="Chaos Experiment - Retry if executor fails in paramiko" priority="3" status="10200" created="2018-07-27 21:29:15.0" updated="2018-07-27 21:30:20.0" votes="0" watches="1" workflowId="43559"> <description><! CDATA Running Chaos experiments in perpetuity (1000x) is intended to test how resilient Indy Node is after repeated chaos experiments.  The last few times experiments have been run, Indy Node didn't fail any of the experiments, but paramiko failed with differing reasons. Paramiko is used by Python Fabric, which is used for remote SSH execution of commands that are run as part of Chaos experiments (i.e. stop/start indy-node service, block/unblock node port, get validator information, etc.)  Paramiko failures are described by the following stack traces. In both cases a simple retry (try-except-retry) may have been sufficient to keep the perpetual execution going. In both of the following cases, experiment execution appeared to hang instead of failing and returning. Perhaps that may have something to do with running within a screen session. {code:java} Traceback (most recent call last): File "/usr/lib/python3.5/multiprocessing/process.py", line 249, in _bootstrap self.run() File "/usr/lib/python3.5/multiprocessing/process.py", line 93, in run self._target(*self._args, **self._kwargs) File "/home/ubuntu/chaosindy/chaosindy/execute/execute.py", line 262, in do_work as_sudo=as_sudo, **kwargs_dict) File "/home/ubuntu/chaosindy/chaosindy/execute/execute.py", line 205, in _parallel_execute_on_host rtn = c.sudo(action, hide=True) File "<decorator-gen-4>", line 2, in sudo File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/fabric-2.1.3-py3.5.egg/fabric/connection.py", line 29, in opens self.open() File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/fabric-2.1.3-py3.5.egg/fabric/connection.py", line 501, in open self.client.connect(**kwargs) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 424, in connect passphrase, File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 714, in _auth raise saved_exception File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 630, in _auth key_filename, pkey_class, passphrase, File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 551, in _key_from_filepath key = klass.from_private_key_file(key_path, password) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/pkey.py", line 206, in from_private_key_file key = cls(filename=filename, password=password) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/ed25519key.py", line 74, in __init__ data = self._read_private_key("OPENSSH", f) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/pkey.py", line 289, in _read_private_key  raise SSHException('not a valid ' + tag + ' private key file') paramiko.ssh_exception.SSHException: not a valid OPENSSH private key file {code} {code:java}  2018-07-27 09:30:57 DEBUG   execute:248  kwargs: {"connect_kwargs": null, "connect_timeout": 10} Process Process-93: Traceback (most recent call last): File "/usr/lib/python3.5/multiprocessing/process.py", line 249, in _bootstrap self.run() File "/usr/lib/python3.5/multiprocessing/process.py", line 93, in run self._target(*self._args, **self._kwargs) File "/home/ubuntu/chaosindy/chaosindy/execute/execute.py", line 262, in do_work as_sudo=as_sudo, **kwargs_dict) File "/home/ubuntu/chaosindy/chaosindy/execute/execute.py", line 205, in _parallel_execute_on_host rtn = c.sudo(action, hide=True) File "<decorator-gen-4>", line 2, in sudo File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/fabric-2.1.3-py3.5.egg/fabric/connection.py", line 29, in opens self.open() File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/fabric-2.1.3-py3.5.egg/fabric/connection.py", line 501, in open self.client.connect(**kwargs) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 338, in connect retry_on_signal(lambda: sock.connect(addr)) File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/util.py", line 279, in retry_on_signal return function() File "/home/ubuntu/.venvs/chaostoolkit/lib/python3.5/site-packages/paramiko-2.4.1-py3.5.egg/paramiko/client.py", line 338, in <lambda> retry_on_signal(lambda: sock.connect(addr)) socket.timeout: timed out  2018-07-27 09:31:00 DEBUG   execute:243  Execute on host...  2018-07-27 09:31:00 DEBUG   execute:244  host: Node10  2018-07-27 09:31:00 DEBUG   execute:245  action: validator-info -v --json  2018-07-27 09:31:00 DEBUG   execute:246  user: None  2018-07-27 09:31:00 DEBUG   execute:247  as_sudo: True  2018-07-27 09:31:00 DEBUG   execute:248  kwargs: {"connect_kwargs": null, "connect_timeout": 10}  2018-07-27 09:31:04 DEBUG   execute:229   P0  routine quits {code}  ></description> </Issue>
