<Action id="69163" issue="45000" author="denyeart" type="comment" created="2020-05-06 03:20:32.0" updateauthor="denyeart" updated="2020-05-06 03:20:32.0"> <body><! CDATA  ~c0deh0use   Below are the relevant log statements, look at the timestamps.  It looks like the roundtrip from chaincode to peer to couchdb and back took 158 milliseconds, with 73 milliseconds within couchdb.  Something else took the remaining 55 seconds. Maybe the logger? Or something in the chaincode? {code:java} dev-peer0.org1.example.com-poc-services-0ee3e7c149908228391bb8edbbf19e1f16834b32b49233000177a57703e6ecec|19:10:10:305 INFO org.hyperledger.fabric.shim.impl.ChaincodeInvocationTask invoke Sending message to the peer  peer0.org1.example.com| 36m2020-05-04 19:10:10.324 UTC  chaincode  HandleTransaction -> DEBU 29de 0m  efb2ae8e  handling GET_QUERY_RESULT from chaincode   2020-05-04T19:10:10.400888Z nonode@nohost <0.16504.0> b7a66025b5 couchdb0:5984 172.21.0.5 undefined POST /banyan-channel_poc-services/_find 200 ok *73*  peer0.org1.example.com| 36m2020-05-04 19:10:10.457 UTC  chaincode  HandleTransaction -> DEBU 2adf 0m  efb2ae8e  Completed GET_QUERY_RESULT. Sending RESPONSE 0m  dev-peer0.org1.example.com-poc-services-0ee3e7c149908228391bb8edbbf19e1f16834b32b49233000177a57703e6ecec|19:10:10:463 INFO org.hyperledger.fabric.shim.impl.ChaincodeInvocationTask invoke Got response back from the peer  dev-peer0.org1.example.com-poc-services-0ee3e7c149908228391bb8edbbf19e1f16834b32b49233000177a57703e6ecec| pool-2-thread-4  INFO pl.itds.kurnik.blockchain.smartcodes.poc.service.debt.DebtStorageService - Query for project debt payments finished in 55 seconds. {code}  ></body> </Action>
<Action id="69164" issue="45000" author="JIRAUSER20137" type="comment" created="2020-05-06 07:37:37.0" updateauthor="JIRAUSER20137" updated="2020-05-06 07:40:59.0"> <body><! CDATA Hi David, Thank you for your response.Â  This was my initial thought also, I was parsing the response and trying to map it into an object using the Jackson library. I have removed that in place of using the raw byte result. But I still could see the log:Â    {code:java} Next -> DEBU 2584 0m queryResultsItr.Next() returned a record:{"data_type":"debt_service","id":"c0019b12-8ea4-41a3-9e2b-5082cfa43f20","interestDue":"101","interestPaid":null,"period":"2022-02","principalDue":"100","principalLeftActual":null,"principalLeftSchedule":"105","principalPaid":null,"projectId":"bf82235a-bf21-4965-a6b5-16b99a14e449"}{code} This is my code inside the chaincode related to the couchDB call:  Â  {code:java} public List<String> queryBy(String querySelector) { hasText(querySelector, "QuerySelector is required!"); try (QueryResultsIterator<KeyValue> queryResult = ctx.getStub().getQueryResult(querySelector)) { log.info("{}. {} query returned finished {} sec.", LocalDateTime.now(), domainName, querySelector); return stream(queryResult.spliterator(), false) .map(KeyValue::getStringValue) .collect(toList()); } catch (Exception e) { log.error("error when querying the state db", e); throw new RuntimeException("Error when querying the state db", e); } } {code}  ></body> </Action>
<Action id="69171" issue="45000" author="denyeart" type="comment" created="2020-05-07 03:51:22.0" updateauthor="denyeart" updated="2020-05-07 03:51:22.0"> <body><! CDATA I've been able to reproduce the problem.  I updated FabCar to initialize 140 cars instead of 10. Query all cars takes the following times:  Go chaincode - 70ms  Javascript chaincode - 90ms  Java chaincode - 3500ms.  I added debug to the Java chaincode... the 3 second delay happens AFTER the chaincode container receives a batch of 100 records, but BEFORE control is passed to the user chaincode. Therefore the problem appears to be somewhere in the Java chaincode shim.  ></body> </Action>
<Action id="69176" issue="45000" author="mbwhite" type="comment" body=" ~c0deh0use Â  could you let me know the version of Fabric you&apos;re using and the version of the Java chaincode that you are using as well please?" created="2020-05-07 09:37:17.0" updateauthor="mbwhite" updated="2020-05-07 09:37:17.0"/>
<Action id="69177" issue="45000" author="JIRAUSER20137" type="comment" created="2020-05-07 09:44:07.0" updateauthor="JIRAUSER20137" updated="2020-05-07 09:44:07.0"> <body><! CDATA Hi,  ~mbwhite Â I'm using currently version 2.0Â  If you have any ideas where could this delay be I happy to help.  ></body> </Action>
<Action id="69178" issue="45000" author="mbwhite" type="comment" created="2020-05-07 09:52:22.0" updateauthor="mbwhite" updated="2020-05-07 09:52:22.0"> <body><! CDATA thanks  ~c0deh0use Â could you get me the exact version of the Java Chaincode you're using please?  If it's not the latest would be worth updating to 2.1  ></body> </Action>
<Action id="69179" issue="45000" author="mbwhite" type="comment" created="2020-05-07 10:07:10.0" updateauthor="mbwhite" updated="2020-05-07 10:07:10.0"> <body><! CDATA  ~c0deh0use   ~denyeart Â  Â based on what you've seen do think this is specifically related to couchdb rich queries, or any type of query.  Dave's test with FabCar and getting all cars suggests it's any type of query.  ></body> </Action>
<Action id="69180" issue="45000" author="JIRAUSER20137" type="comment" created="2020-05-07 11:22:08.0" updateauthor="JIRAUSER20137" updated="2020-05-07 11:23:00.0"> <body><! CDATA I was testing it on the 2.0.0 version of java chaincodes, updating the entire network and my chaincode libs to 2.1.0 locally to verify.Â  Yes,Â  I have only tested the rich query feature - CouchDB.Â   ></body> </Action>
<Action id="69181" issue="45000" author="JIRAUSER20137" type="comment" body="tested onÂ fabric-chaincode-java:fabric-chaincode-shim:2.1.0, still the same result.Â " created="2020-05-07 11:53:49.0" updateauthor="JIRAUSER20137" updated="2020-05-07 11:53:49.0"/>
<Action id="69182" issue="45000" author="denyeart" type="comment" body=" ~mbwhite  Right, the delay appears when doing either range query or json rich query with java chaincode. I was using v2.1 in my trial." created="2020-05-07 12:16:13.0" updateauthor="denyeart" updated="2020-05-07 12:16:13.0"/>
<Action id="69189" issue="45000" author="JIRAUSER20137" type="comment" created="2020-05-08 14:47:25.0" updateauthor="JIRAUSER20137" updated="2020-05-09 22:59:03.0"> <body><! CDATA Hi  ~mbwhite Â , any updates on this one ?Â  Can I somehow assist help with it? It's a critical issue for my team, any news would be fantastic.Â   ></body> </Action>
<Action id="69198" issue="45000" author="mbwhite" type="comment" body=" ~c0deh0use Â thanks for the offer... it was a public holiday end of last week.... now looking at this issue.Â  Â Would RocketChat be a good way to contact you?" created="2020-05-11 08:50:04.0" updateauthor="mbwhite" updated="2020-05-11 08:50:04.0"/>
<Action id="69200" issue="45000" author="JIRAUSER20137" type="comment" created="2020-05-11 10:24:38.0" updateauthor="JIRAUSER20137" updated="2020-05-11 10:24:38.0"> <body><! CDATA Sorry, didn't mind to tell someone to work on the weekend,Â I meant to say that I happy to help You during the week :)Â  Yes, I'm no RocketChat. I'm not sure why but I got logged out from it and logged in using the Jira account -> c0deh0use  ></body> </Action>
<Action id="69202" issue="45000" author="mbwhite" type="comment" created="2020-05-11 14:18:07.0" updateauthor="mbwhite" updated="2020-05-11 14:18:07.0"> <body><! CDATA  ~c0deh0use Â  Â no it's fine... just not knowing which time zone everybody is in!  Believe that I've isolated the problem to this line   https://github.com/hyperledger/fabric-chaincode-java/blob/22f762c10c35e1f23628f373f8684010ef11e5b3/fabric-chaincode-shim/src/main/java/org/hyperledger/fabric/shim/impl/ChaincodeInvocationTask.java#L176   Â   github pr =>Â  https://github.com/hyperledger/fabric-chaincode-java/pull/111   ></body> </Action>
<Action id="69211" issue="45000" author="lesleyannj" type="comment" body="Master branch to be completed." created="2020-05-12 12:36:04.0" updateauthor="lesleyannj" updated="2020-05-12 12:36:04.0"/>
<Action id="69240" issue="45000" author="lesleyannj" type="comment" body="PRs into release-2.x and master complete" created="2020-05-14 15:27:17.0" updateauthor="lesleyannj" updated="2020-05-14 15:27:17.0"/>
<Action id="69242" issue="45000" author="JIRAUSER20137" type="comment" body="Great, thank you for such a quick fix! I will be testing it next week." created="2020-05-14 16:53:56.0" updateauthor="JIRAUSER20137" updated="2020-05-14 16:53:56.0"/>
<Action id="69272" issue="45000" author="mbwhite" type="comment" body=" ~c0deh0use Â release 2.1.1 is now available with this fix in" created="2020-05-19 07:42:35.0" updateauthor="mbwhite" updated="2020-05-19 07:42:35.0"/>
