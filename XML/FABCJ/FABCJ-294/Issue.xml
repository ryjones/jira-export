<Issue id="46220" key="FABCJ-294" number="294" project="11208" reporter="JIRAUSER20958" assignee="JIRAUSER20816" creator="JIRAUSER20958" type="10004" summary="GetHistoryForKey throws a nullpointer exception" priority="3" resolution="10000" status="6" created="2020-10-20 08:18:56.0" updated="2020-12-07 17:17:38.0" resolutiondate="2020-12-07 17:17:38.0" votes="0" watches="2" workflowId="60130" archived="N"> <description><! CDATA I'm using the fabric-samples project, a modified asset-transfer-basic module, that uses couchdb. I tried to add the stub.getHistoryForKey() functionality to it but it fails with a nullpointer. The same happened when I switched back to leveldb.  Currently this method in my chaincode looks like this. I tried to catch the error but with no success.    {code:java} @Transaction(intent = Transaction.TYPE.EVALUATE) public ArrayList<String> GetAssetHistory(final Context ctx, final String assetID) { if(assetID == null){ throw new RuntimeException("No ID given"); } ChaincodeStub stub = ctx.getStub(); ArrayList<String> results = new ArrayList<>(); try { QueryResultsIterator<KeyModification> history = stub.getHistoryForKey(assetID);  if (history == null) { String errorMessage = String.format("Asset %s does not exist", assetID); System.out.println(errorMessage); throw new ChaincodeException(errorMessage, AssetTransferErrors.ASSET_NOT_FOUND.toString()); } Iterator<KeyModification> iter = history.iterator(); while(iter.hasNext()){ results.add(iter.next().getStringValue()); } } catch(Exception e){ results.add(e.getMessage()); results.add(e.getCause().getMessage()); results.add(e.getStackTrace().toString()); } return results; } {code} The application code calling it: {code:java} System.out.println("Asset History for asset1"); System.out.println(contract.evaluateTransaction("GetAssetHistory", "asset1")); {code} Output in the IntelliJ console:    {code:java} Asset History for asset1 org.hyperledger.fabric.gateway.ContractException: error in simulation: transaction returned with failure: Unexpected error {code} Note that asset1 definitely exists, "contract.evaluateTransaction("ReadAsset", "asset1");" works perfectly.     Log from "docker logs peer0.org1.example.com" command:    {code:java} 2020-10-20 07:53:17.145 UTC  endorser  callChaincode -> INFO 0a2 finished chaincode: basic duration: 18ms channel=mychannel txID=bc0695bd 2020-10-20 07:53:17.145 UTC  endorser  SimulateProposal -> ERRO 0a3 failed to invoke chaincode basic, error: transaction returned with failure: Unexpected error github.com/hyperledger/fabric/core/chaincode.processChaincodeExecutionResult /go/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:182 github.com/hyperledger/fabric/core/chaincode.(*ChaincodeSupport).Execute /go/src/github.com/hyperledger/fabric/core/chaincode/chaincode_support.go:156 github.com/hyperledger/fabric/core/endorser.(*SupportImpl).Execute /go/src/github.com/hyperledger/fabric/core/endorser/support.go:126 github.com/hyperledger/fabric/core/endorser.(*Endorser).callChaincode /go/src/github.com/hyperledger/fabric/core/endorser/endorser.go:119 github.com/hyperledger/fabric/core/endorser.(*Endorser).SimulateProposal /go/src/github.com/hyperledger/fabric/core/endorser/endorser.go:187 github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposalSuccessfullyOrError /go/src/github.com/hyperledger/fabric/core/endorser/endorser.go:397 github.com/hyperledger/fabric/core/endorser.(*Endorser).ProcessProposal /go/src/github.com/hyperledger/fabric/core/endorser/endorser.go:340 github.com/hyperledger/fabric/core/handlers/auth/filter.(*expirationCheckFilter).ProcessProposal /go/src/github.com/hyperledger/fabric/core/handlers/auth/filter/expiration.go:61 github.com/hyperledger/fabric/core/handlers/auth/filter.(*filter).ProcessProposal /go/src/github.com/hyperledger/fabric/core/handlers/auth/filter/filter.go:32 github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler.func1 /go/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:107 github.com/hyperledger/fabric/internal/peer/node.unaryGrpcLimiter.func1 /go/src/github.com/hyperledger/fabric/internal/peer/node/grpc_limiters.go:51 github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1 /go/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 github.com/hyperledger/fabric/common/grpclogging.UnaryServerInterceptor.func1 /go/src/github.com/hyperledger/fabric/common/grpclogging/server.go:92 github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1 /go/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 github.com/hyperledger/fabric/common/grpcmetrics.UnaryServerInterceptor.func1 /go/src/github.com/hyperledger/fabric/common/grpcmetrics/interceptor.go:31 github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1.1.1 /go/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:25 github.com/grpc-ecosystem/go-grpc-middleware.ChainUnaryServer.func1 /go/src/github.com/hyperledger/fabric/vendor/github.com/grpc-ecosystem/go-grpc-middleware/chain.go:34 github.com/hyperledger/fabric-protos-go/peer._Endorser_ProcessProposal_Handler /go/src/github.com/hyperledger/fabric/vendor/github.com/hyperledger/fabric-protos-go/peer/peer.pb.go:109 google.golang.org/grpc.(*Server).processUnaryRPC /go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1082 google.golang.org/grpc.(*Server).handleStream /go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:1405 google.golang.org/grpc.(*Server).serveStreams.func1.1 /go/src/github.com/hyperledger/fabric/vendor/google.golang.org/grpc/server.go:746 runtime.goexit /usr/local/go/src/runtime/asm_amd64.s:1373 channel=mychannel txID=bc0695bd 2020-10-20 07:53:17.145 UTC  comm.grpc.server  1 -> INFO 0a4 unary call completed grpc.service=protos.Endorser grpc.method=ProcessProposal grpc.peer_address=172.18.0.1:57312 grpc.code=OK grpc.call_duration=19.1368ms {code}       Log from "docker logs dev-peer0.org1.example.com-basic_1.0-..." command:    {code:java} 07:53:17:136 INFO    org.hyperledger.fabric.shim.impl.ChaincodeInvocationTask invoke                  Got response back from the peerbc0695bd999270ad3204af171e3f22fb162277a88e5f0575a9058e2466b51314 07:53:17:138 SEVERE  org.hyperledger.fabric.Logger error                                              nulljava.lang.NullPointerException at org.hyperledger.fabric.contract.execution.JSONTransactionSerializer.toBuffer(JSONTransactionSerializer.java:84) at org.hyperledger.fabric.contract.execution.impl.ContractExecutionService.convertReturn(ContractExecutionService.java:89) at org.hyperledger.fabric.contract.execution.impl.ContractExecutionService.executeRequest(ContractExecutionService.java:67) at org.hyperledger.fabric.contract.ContractRouter.processRequest(ContractRouter.java:115) at org.hyperledger.fabric.contract.ContractRouter.invoke(ContractRouter.java:126) at org.hyperledger.fabric.shim.impl.ChaincodeInvocationTask.call(ChaincodeInvocationTask.java:91) at org.hyperledger.fabric.shim.impl.InvocationTaskManager.lambda$newTask$17(InvocationTaskManager.java:225) at java.base/java.util.concurrent.CompletableFuture$AsyncRun.run(CompletableFuture.java:1736) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) at java.base/java.lang.Thread.run(Thread.java:834)07:53:17:143 SEVERE  org.hyperledger.fabric.shim.impl.ChaincodeInvocationTask call                     bc0695bd  Invoke failed with error code 500. Sending ERROR {code}       Network is the test-network, startFabric.sh:    {code:java} pushd ../test-network ./network.sh down ./network.sh up createChannel -c mychannel -ca -s couchdb -i 2.2 ./network.sh deployCC -ccn basic -ccl java popd{code}    In fabric-samples/config/core.yaml: {code:java} ledger: history: enableHistoryDatabase: true{code} My OS is Windows (WSL2). The same error occurred when I tried it on 2.2.1 fabric version (fresh repo).  ></description> </Issue>
