<Issue id="40685" key="FABJ-452" number="452" project="10605" reporter="bestbeforetoday" assignee="rickr" creator="bestbeforetoday" type="10004" summary="Calling Channel.shutdown() can cause spurious NullPointerExceptions" priority="3" resolution="10000" status="6" created="2019-06-19 12:52:58.0" updated="2019-06-19 20:51:48.0" resolutiondate="2019-06-19 20:51:48.0" votes="0" watches="1" workflowId="53635"> <description><! CDATA Gerrit CR  https://gerrit.hyperledger.org/r/c/fabric-sdk-java/+/31985 n   |https://gerrit.hyperledger.org/r/c/fabric-sdk-java/+/31985 v1.4  https://gerrit.hyperledger.org/r/c/fabric-sdk-java/+/31986    Running a suite of unit tests, some of which create and then shutdown channel objects, the following spurious NullPointerException occurs on a different thread to the test execution thread: {code:java} Exception in thread "pool-45-thread-1" java.lang.NullPointerException 	at org.hyperledger.fabric.sdk.PeerEventServiceClient.<init>(PeerEventServiceClient.java:84) 	at org.hyperledger.fabric.sdk.Peer$1.reconnect(Peer.java:431) 	at org.hyperledger.fabric.sdk.Peer$2.disconnected(Peer.java:559) 	at org.hyperledger.fabric.sdk.Peer.lambda$reconnectPeerEventServiceClient$0(Peer.java:398) 	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) 	at java.lang.Thread.run(Thread.java:748) {code}  I narrowed the cause down to the case where we have created a channel from a connection profile that contains the definition of the channel and also a peer, which in the case of our unit tests is not actually running.  Looking at the fabric-sdk-java code where the error is occurring, it looks to be this line in the PeerEventServiceClient constructor: {code:java} this.channelName = peer.getChannel().getName(); {code} Running the tests in the debugger I can see the peer instance has its channelName member set correctly, but the channel member is null. The Peer shutdown() looks to null the channel before calling removeEndorserClient().  Since the error occurs on a different thread, I suspect the fact that the test suite continues to run for some time (so the JVM doesn't immediately exit) after the call that causes this issue is a factor in observing the NullPointerException.  Sample client code, representative of what my tests are doing: {code:java} HFClient client = HFClient.createNewInstance(); CryptoSuite cryptoSuite = CryptoSuiteFactory.getDefault().getCryptoSuite(); client.setCryptoSuite(cryptoSuite); client.setUserContext(user); Channel channel = client.loadChannelFromConfig("mychannel", networkConfig); channel.initialize(); channel.registerBlockListener(event -> {}); // Not sure this is relevant channel.shutdown(false); {code} Connection profile (i.e. NetworkConfig) file:  https://raw.githubusercontent.com/hyperledger/fabric-gateway-java/master/src/test/java/org/hyperledger/fabric/gateway/connection.json         ></description> </Issue>
