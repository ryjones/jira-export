<Issue id="43362" key="FABJ-499" number="499" project="10605" reporter="tommy-park" assignee="tommy-park" creator="tommy-park" type="10004" summary="ServiceDiscovery.run() does not terminate thread executor." priority="3" status="10708" created="2019-11-18 06:45:42.0" updated="2021-01-27 14:34:55.0" votes="0" watches="4" workflowId="56470"> <description><! CDATA ServiceDiscovery.run() has same memory leak problem with FABJ-389.   The codes which have the problem are:   {code:java} void run() { ...        if (seviceDiscovery == null) {            seviceDiscovery = Executors.newSingleThreadScheduledExecutor(r -> {                Thread t = Executors.defaultThreadFactory().newThread(r);                t.setDaemon(true);                return t;            }).scheduleAtFixedRate(() -> {                logger.debug(format(“Channel %s starting service rediscovery after %d seconds.“, channelName, SERVICE_DISCOVER_FREQ_SECONDS));                fullNetworkDiscovery(true);            }, SERVICE_DISCOVER_FREQ_SECONDS, SERVICE_DISCOVER_FREQ_SECONDS, TimeUnit.SECONDS);        }    }{code}     which can be: {code:java} ...    private transient ScheduledExecutorService serviceDiscoveryExecutorService; ...    void run() { ...        if (seviceDiscovery == null) {            serviceDiscoveryExecutorService = Executors.newSingleThreadScheduledExecutor(r -> {                Thread t = Executors.defaultThreadFactory().newThread(r);                t.setDaemon(true);                return t;            });            seviceDiscovery = serviceDiscoveryExecutorService.scheduleAtFixedRate(() -> {                logger.debug(format(“Channel %s starting service rediscovery after %d seconds.“, channelName, SERVICE_DISCOVER_FREQ_SECONDS));                fullNetworkDiscovery(true);            }, SERVICE_DISCOVER_FREQ_SECONDS, SERVICE_DISCOVER_FREQ_SECONDS, TimeUnit.SECONDS);        }    } ...    void shutdown() {        logger.trace(“Service discovery shutdown.“);        try {            final ScheduledFuture<?> lseviceDiscovery = seviceDiscovery;            seviceDiscovery = null;            if (null != lseviceDiscovery) {                lseviceDiscovery.cancel(true);            }            ScheduledExecutorService lsde = serviceDiscoveryExecutorService;            serviceDiscoveryExecutorService = null;            if (null != lsde) {                lsde.shutdownNow();            }        } catch (Exception e) {            logger.error(e);            //best effort.        }    }       {code}          ></description> </Issue>
