<Issue id="45193" key="FABC-913" number="913" project="10607" reporter="tatsu-sato" assignee="tatsu-sato" creator="tatsu-sato" type="10004" summary="Set a primary key to users table for SQLite" priority="3" resolution="10000" status="6" created="2020-06-02 18:02:09.0" updated="2021-03-06 19:00:37.0" resolutiondate="2020-10-15 09:04:31.0" votes="0" watches="1" workflowId="59104" archived="N"> <description><! CDATA When using SQLite, duplicate registration of the same ID would occur depending on the timing. After that, the ID would not work.     The reproduction procedures with fabric-samples/test-network are shown below: {code:bash} $ cd fabric-samles/test-network $ ./network.sh up -ca $ export PATH=${PWD}/../bin:$PATH $ export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/peerOrganizations/org1.example.com/  # Enroll as a admin $ fabric-ca-client enroll -u https://peer0:peer0pw@localhost:7054 --caname ca-org1 -M ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp --csr.hosts peer0.org1.example.com --tls.certfiles ${PWD}/organizations/fabric-ca/org1/tls-cert.pem  # Issue 2 register requests to the same ID at about the same time $ fabric-ca-client register --caname ca-org1 --id.name testuser --id.secret userpw --id.type client --tls.certfiles ${PWD}/organizations/fabric-ca/org1/tls-cert.pem & fabric-ca-client register --caname ca-org1 --id.name testuser --id.secret userpw --id.type client --tls.certfiles ${PWD}/organizations/fabric-ca/org1/tls-cert.pem  1  29986 2020/06/01 18:55:22  INFO  Configuration file location: /home/ubuntu/workspace/src/github.com/hyperledger/fabric-samples/test-network/organizations/peerOrganizations/org1.example.com/fabric-ca-client-config.yaml 2020/06/01 18:55:22  INFO  Configuration file location: /home/ubuntu/workspace/src/github.com/hyperledger/fabric-samples/test-network/organizations/peerOrganizations/org1.example.com/fabric-ca-client-config.yaml 2020/06/01 18:55:22  INFO  TLS Enabled 2020/06/01 18:55:22  INFO  TLS Enabled 2020/06/01 18:55:22  INFO  TLS Enabled 2020/06/01 18:55:22  INFO  TLS Enabled Password: userpw Password: userpw  1 +  Done                    fabric-ca-client register --caname ca-org1 --id.name testuser --id.secret userpw --id.type client --tls.certfiles ${PWD}/organizations/fabric-ca/org1/tls-cert.pem  # Problem: duplicate registration of the same ID occurs (depending on the timing) $ fabric-ca-client enroll -u https://testuser:userpw@localhost:7054 --caname ca-org1 --csr.hosts peer0.org1.example.com --tls.certfiles ${PWD}/organizations/fabric-ca/org1/tls-cert.pem 2020/06/02 00:47:49  INFO  TLS Enabled 2020/06/02 00:47:49  INFO  generating key: &{A:ecdsa S:256} 2020/06/02 00:47:49  INFO  encoded CSR Error: Response from server: Error Code: 0 - 2 rows were affected when updating the state of identity testuser {code} I have confirmed that it reproduces in both version 1.4.x and 2.x.     *Route cause analysis:*  This is probably because the users table does not have the primary key ‘ID’.  https://github.com/hyperledger/fabric-ca/blob/567b2c0f94abbe47ad39f2b306b0577b79d33e89/lib/server/db/sqlite/sqlite.go#L138   The implementations for other RDBs (MySQL, PostgreSQL) set ID as the primary key in users table. (In the past, the MySQL implementation also had been the same problem (Link to FABC-801).)  ></description> </Issue>
