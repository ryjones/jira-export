<Issue id="14329" key="FABC-379" number="379" project="10607" reporter="rennman" assignee="skarim" creator="rennman" type="10004" summary="Certificate revocation fails to update user state in DB" priority="3" resolution="10000" status="6" created="2017-01-24 19:54:53.0" updated="2018-07-18 22:04:29.0" resolutiondate="2017-04-18 14:35:06.0" votes="0" watches="3" workflowId="32559"> <description><! CDATA 1) Start fabric-ca # ./scripts/fabric-ca_setup.sh -I -S -X  2) Enroll admin # ./scripts/enroll.sh 2017/01/24 14:31:45  DEBUG  Getting user admin from the database 2017/01/24 14:31:45  DEBUG  DB: Login user admin with max enrollments of 1 and state of 0 2017/01/24 14:31:45  DEBUG  Successfully incremented state for user admin to 1 2017/01/24 14:31:45  DEBUG  DB: user admin successfully logged in 2017/01/24 14:31:45  DEBUG  User/Pass was correct 2017/01/24 14:31:45  DEBUG  Received request for endpoint enroll 2017/01/24 14:31:45  INFO  signed certificate with serial number 144790095028100641934921797894228565652597329902 2017/01/24 14:31:45  DEBUG  DB: Insert Certificate 2017/01/24 14:31:45  DEBUG  saved certificate with serial number 144790095028100641934921797894228565652597329902 2017/01/24 14:31:45  INFO  127.0.0.1:51542 - "POST /api/v1/cfssl/enroll" 200 2017/01/24 14:31:45  INFO  enrollment information was successfully stored in /home/ibmadmin/fabric-ca/key.pem and /home/ibmadmin/fabric-ca/cert.pem  3) Database contents of user and cert after enrollment (user status: '1' and cert status good, revoke date not set) # sqlite3 ./testdata/fabric_ca.db "SELECT * FROM users WHERE (id='admin');" admin|adminpw|client|bank_a| {"name":"hf.Registrar.Roles","value":"client,user,peer,validator,auditor"},{"name":"hf.Registrar.DelegateRoles","value":"client,user,validator,auditor"},{"name":"hf.Revoker","value":"true"} |1|1  sqlite3 ./testdata/fabric_ca.db "SELECT * FROM certificates WHERE (id='admin');" admin|1.44790095028101e+47|54a784b1639c88b38b3111e80057233520940422||good|0|2017-11-28 08:00:00+00:00|0001-01-01 00:00:00+00:00|-----BEGIN CERTIFICATE-----  4) Revoke admin cert: # ./bin/fabric-ca client revoke '127.0.0.1:8888' admin 2017/01/24 14:33:43  DEBUG  Revoke request received 2017/01/24 14:33:43  DEBUG  getUserAttrValue user=admin, attr=hf.Revoker 2017/01/24 14:33:43  DEBUG  Getting user admin from the database 2017/01/24 14:33:43  DEBUG  getUserAttrValue user=admin, name=hf.Revoker, value=true 2017/01/24 14:33:43  DEBUG  Revoke request: {RevocationRequest:{Name:admin Serial: AKI: Reason:0}} 2017/01/24 14:33:43  DEBUG  Getting user admin from the database 2017/01/24 14:33:43  DEBUG  Getting user admin information from the database 2017/01/24 14:33:43  DEBUG  userInfo: {admin adminpw client bank_a  {hf.Registrar.Roles client,user,peer,validator,auditor} {hf.Registrar.DelegateRoles client,user,validator,auditor} {hf.Revoker true}  1 1} 2017/01/24 14:33:43  DEBUG  DB: Update User (admin) in database 2017/01/24 14:33:43  DEBUG  Revoke was successful: %+v{{admin   0}} 2017/01/24 14:33:43  INFO  127.0.0.1:51546 - "POST /api/v1/cfssl/revoke" 200  5) Database contents of user and cert after revoke (user status: '1' and cert status good, revoke date not set): sqlite3 ./testdata/fabric_ca.db "SELECT * FROM users WHERE (id='admin');" admin|adminpw|client|bank_a| {"name":"hf.Registrar.Roles","value":"client,user,peer,validator,auditor"},{"name":"hf.Registrar.DelegateRoles","value":"client,user,validator,auditor"},{"name":"hf.Revoker","value":"true"} |1|1  sqlite3 ./testdata/fabric_ca.db "SELECT * FROM certificates WHERE (id='admin');" admin|1.44790095028101e+47|54a784b1639c88b38b3111e80057233520940422||good|0|2017-11-28 08:00:00+00:00|0001-01-01 00:00:00+00:00|-----BEGIN CERTIFICATE-----   ></description> </Issue>
