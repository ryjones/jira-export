<Issue id="12693" key="FABC-681" number="681" project="10607" reporter="rennman" assignee="pvle@us.ibm.com" creator="rennman" type="10004" summary="ACA combined with TLS fails" priority="1" resolution="10000" status="6" created="2016-09-14 01:58:08.0" updated="2018-07-19 13:16:59.0" resolutiondate="2016-10-17 10:16:10.0" votes="0" watches="8" workflowId="34647"> <description><! CDATA While running with TLS enabled, combined with MEMBERSRVC_CA_ACA_ENABLED=true  the asset-mgmt-with-roles.js fails.   ok 1 setup successful # assign asset management with roles Wed, 14 Sep 2016 01:47:31 GMT hfc Member.getNextTCert: key=  ,role,account Wed, 14 Sep 2016 01:47:31 GMT hfc Member.getNextTCert: key=  ,role,account, creating new getter Wed, 14 Sep 2016 01:47:31 GMT hfc shouldGetTCerts: yes, we have no tcerts not ok 2 Failure:  Failed getting Application certificate for Alice. :  undefined  --- operator: fail at: fail (/home/ibmadmin/gopath/src/github.com/hyperledger/fabric/sdk/node/test/unit/asset-mgmt-with-roles.js:88:7) ...   In the Ca log, there is a whole series of internal connection failures (since it is loopback, and I am not using loopback for the sdk client connections), presumably TLS-related.   01:47:31.108  tcap  CreateCertificateSet -> DEBU 4c5 grpc TCAP:CreateCertificateSet 01:47:31.108  ca  readCertificateByKeyUsage -> DEBU 4c6 Reading certificate for alice and usage 1 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken write tcp  ::1 :35660-> ::1 :7054: write: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken read tcp  ::1 :35661-> ::1 :7054: read: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken unexpected EOF. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken write tcp  ::1 :35663-> ::1 :7054: write: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken read tcp  ::1 :35664-> ::1 :7054: read: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken read tcp  ::1 :35665-> ::1 :7054: read: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:31 transport: http2Client.notifyError got notified that the client transport was broken read tcp  ::1 :35666-> ::1 :7054: read: connection reset by peer. 2016/09/14 01:47:31 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:32 grpc: ClientConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp  ::1 :35667-> ::1 :7054: write: broken pipe"; Reconnecting to "localhost:7054" 2016/09/14 01:47:32 grpc: Server.Serve failed to complete security handshake. 2016/09/14 01:47:34 grpc: ClientConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp  ::1 :35668-> ::1 :7054: write: broken pipe"; Reconnecting to "localhost:7054" 2016/09/14 01:47:34 transport: http2Client.notifyError got notified that the client transport was broken write tcp  ::1 :35669-> ::1 :7054: write: connection reset by peer.   I think this may be a more general issue. The registrar test, although it passes, takes a *really* long time. In the meantime, I see similar messages to the above:  ^  36m21:53:58.277  ca  readUser -> DEBU 13a^  0m Reading token for admin. ^  36m21:53:58.278  ca  readRole -> DEBU 13b^  0m Reading role for admin. ^  36m21:53:58.278  ca  createCertificateFromSpec -> DEBU 13c^  0m Creating certificate for admin. ^  36m21:53:58.284  ca  readRole -> DEBU 13d^  0m Reading role for admin. ^  36m21:53:58.284  ca  createCertificateFromSpec -> DEBU 13e^  0m Creating certificate for admin. 2016/09/13 21:53:58 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:53:58 transport: http2Client.notifyError got notified that the client transport was broken read tcp 127.0.0.1:32409->127.0.0.1:7054: read: connection reset by peer. 2016/09/13 21:53:58 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:53:59 grpc: ClientConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp 127.0.0.1:32410->127.0.0.1:7054: write: broken pipe"; Reconnecting to "localhost:7054" 2016/09/13 21:53:59 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:53:59 transport: http2Client.notifyError got notified that the client transport was broken read tcp 127.0.0.1:32411->127.0.0.1:7054: read: connection reset by peer. 2016/09/13 21:53:59 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:54:00 grpc: ClientConn.resetTransport failed to create client transport: connection error: desc = "transport: write tcp 127.0.0.1:32412->127.0.0.1:7054: write: broken pipe"; Reconnecting to "localhost:7054" 2016/09/13 21:54:00 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:54:00 transport: http2Client.notifyError got notified that the client transport was broken read tcp 127.0.0.1:32413->127.0.0.1:7054: read: connection reset by peer. 2016/09/13 21:54:00 grpc: Server.Serve failed to complete security handshake. 2016/09/13 21:54:00 transport: http2Client.notifyError got notified that the client transport was broken read tcp 127.0.0.1:32414->127.0.0.1:7054: read: connection reset by peer. 2016/09/13 21:54:00 transport: http2Client.notifyError got notified that the client transport was broken write tcp 127.0.0.1:32415->127.0.0.1:7054: write: connection reset by peer. 2016/09/13 21:54:00 grpc: Server.Serve failed to complete security handshake.    ></description> </Issue>
