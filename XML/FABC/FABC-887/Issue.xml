<Issue id="43230" key="FABC-887" number="887" project="10607" reporter="adarshajha" creator="adarshajha" type="10000" summary="when i enable TLS in tls section of fabric-ca-server-config.yaml while trying to connect fabric-ca to postgres using sslmode=verify-full" priority="3" status="10100" created="2019-11-08 11:08:44.0" updated="2019-11-08 11:10:57.0" votes="0" watches="1" workflowId="56336"> <description><! CDATA when i enable TLS by doing this :    {code:java} tls: # Enable TLS (default: false) enabled: true # TLS for the server's listening port certfile: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem keyfile:  clientauth: type: NoClientCert certfiles:  {code}  my db-postgres logs are :    {code:java} adarsha@adarsha-HP-Z240-Tower-Workstation:~/Documents/ica-setup/consigner$ docker logs db-postgres  2019-11-08 11:04:58.555 UTC  1  LOG:  starting PostgreSQL 12.0 (Debian 12.0-2.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit 2019-11-08 11:04:58.555 UTC  1  LOG:  listening on IPv4 address "0.0.0.0", port 5432 2019-11-08 11:04:58.556 UTC  1  LOG:  listening on IPv6 address "::", port 5432 2019-11-08 11:04:58.707 UTC  1  LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432" 2019-11-08 11:04:58.831 UTC  24  LOG:  database system was interrupted; last known up at 2019-11-08 11:03:18 UTC 2019-11-08 11:04:59.067 UTC  24  LOG:  database system was not properly shut down; automatic recovery in progress 2019-11-08 11:04:59.107 UTC  24  LOG:  redo starts at 0/16468B0 2019-11-08 11:04:59.107 UTC  24  LOG:  invalid record length at 0/16468E8: wanted 24, got 0 2019-11-08 11:04:59.107 UTC  24  LOG:  redo done at 0/16468B0 2019-11-08 11:04:59.309 UTC  1  LOG:  database system is ready to accept connections 2019-11-08 11:04:59.797 UTC  31  LOG:  could not accept SSL connection: certificate verify failed 2019-11-08 11:04:59.828 UTC  32  LOG:  could not accept SSL connection: certificate verify failed 2019-11-08 11:04:59.833 UTC  33  LOG:  could not accept SSL connection: certificate verify failed  {code}  and my CA logs are :   {code:java} adarsha@adarsha-HP-Z240-Tower-Workstation:~/Documents/ica-setup/consigner$ docker logs ica.consigner.lynkit.io  2019/11/08 11:04:59  DEBUG  Home directory: /etc/hyperledger/fabric-ca-server 2019/11/08 11:04:59  INFO  Configuration file location: /etc/hyperledger/fabric-ca-server/fabric-ca-server-config.yaml 2019/11/08 11:04:59  INFO  Starting server in home directory: /etc/hyperledger/fabric-ca-server 2019/11/08 11:04:59  WARNING  Unknown provider type: ; metrics disabled 2019/11/08 11:04:59  DEBUG  Set log level:  2019/11/08 11:04:59  INFO  Server Version: 1.4.1 2019/11/08 11:04:59  INFO  Server Levels: &{Identity:2 Affiliation:1 Certificate:1 Credential:1 RAInfo:1 Nonce:1} 2019/11/08 11:04:59  DEBUG  Making server filenames absolute 2019/11/08 11:04:59  DEBUG  Initializing default CA in directory /etc/hyperledger/fabric-ca-server 2019/11/08 11:04:59  DEBUG  Init CA with home /etc/hyperledger/fabric-ca-server and config {Version:1.4.0-stable Cfg:{Identities:{PasswordAttempts:10 AllowRemove:false} Affiliations:{AllowRemove:false}} CA:{Name:ica.consigner.lynkit.io Keyfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem Certfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem Chainfile:/etc/hyperledger/fabric-ca-server-config/chain.consigner.lynkit.io.crt.pem} Signing:0xc0001f6370 CSR:{CN: ica.consigner.lynkit.io Names: {C:US ST:North Carolina L: O:Hyperledger OU:Fabric SerialNumber:}  Hosts: 0.0.0.0  KeyRequest:0xc000348780 CA:0xc000348820 SerialNumber:} Registry:{MaxEnrollments:-1 Identities: { Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:0 Attrs:map hf.Registrar.DelegateRoles:* hf.Revoker:1 hf.IntermediateCA:1 hf.GenCRL:1 hf.Registrar.Attributes:* hf.AffiliationMgr:1 hf.Registrar.Roles:*   } } Affiliations:map consigner: department1 department2   LDAP:{ Enabled:false URL:ldap://****:****@<host>:<port>/<base> UserFilter:(uid=%s) GroupFilter:(memberUid=%s) Attribute:{ uid member   { }  map groups: { }  } TLS:{false    { }}  } DB:{ Type:postgres ****user=**** password=**** dbname=fabriccaserver sslmode=verify-ca TLS:{true   /tmp/postgresCerts/root.crt   {/tmp/postgresCerts/server.key /tmp/postgresCerts/server.crt}}  } CSP:0xc000349ce0 Client:<nil> Intermediate:{ParentServer:{ URL: CAName:  } TLS:{Enabled:false CertFiles:   Client:{KeyFile: CertFile:}} Enrollment:{ Name: Secret:**** CAName: AttrReqs:   Profile: Label: CSR:<nil> Type:x509  }} CRL:{Expiry:24h0m0s} Idemix:{IssuerPublicKeyfile: IssuerSecretKeyfile: RevocationPublicKeyfile: RevocationPrivateKeyfile: RHPoolSize:100 NonceExpiration:15s NonceSweepInterval:15m}} 2019/11/08 11:04:59  DEBUG  CA Home Directory: /etc/hyperledger/fabric-ca-server 2019/11/08 11:04:59  DEBUG  Checking configuration file version '1.4.0-stable' against server version: '1.4.1' 2019/11/08 11:04:59  DEBUG  Initializing BCCSP: &{ProviderName:SW SwOpts:0xc000041240 PluginOpts:<nil>} 2019/11/08 11:04:59  DEBUG  Initializing BCCSP with software options &{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:0xc0001ae040 DummyKeystore:<nil> InmemKeystore:<nil>} 2019/11/08 11:04:59  DEBUG  Initialize key material 2019/11/08 11:04:59  DEBUG  Making CA filenames absolute 2019/11/08 11:04:59  INFO  The CA key and certificate files already exist 2019/11/08 11:04:59  INFO  Key file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem 2019/11/08 11:04:59  INFO  Certificate file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem 2019/11/08 11:04:59  DEBUG  Validating the CA certificate and key 2019/11/08 11:04:59  DEBUG  Check CA certificate for valid dates 2019/11/08 11:04:59  DEBUG  Check CA certificate for valid usages 2019/11/08 11:04:59  DEBUG  Check CA certificate for valid IsCA value 2019/11/08 11:04:59  DEBUG  Check that key type is supported 2019/11/08 11:04:59  DEBUG  Check that key size is of appropriate length 2019/11/08 11:04:59  DEBUG  Check that public key and private key match 2019/11/08 11:04:59  DEBUG  Validation of CA certificate and key successful 2019/11/08 11:04:59  DEBUG  Loading CN from existing enrollment information 2019/11/08 11:04:59  DEBUG  Initializing DB 2019/11/08 11:04:59  DEBUG  Initializing 'postgres' database at 'host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-ca' 2019/11/08 11:04:59  DEBUG  Using postgres database, connecting to database... 2019/11/08 11:04:59  DEBUG  Database Name: fabriccaserver 2019/11/08 11:04:59  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-ca sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 11:04:59  WARNING  Failed to connect to database 'fabriccaserver' 2019/11/08 11:04:59  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=postgres sslmode=verify-ca sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 11:04:59  WARNING  Failed to connect to database 'postgres' 2019/11/08 11:04:59  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=template1 sslmode=verify-ca sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 11:04:59  WARNING  Failed to connect to database 'template1' 2019/11/08 11:04:59  ERROR  Error occurred initializing database: Failed to connect to Postgres database. Postgres requires connecting to a specific database, the following databases were tried:  fabriccaserver postgres template1 . Please create one of these database before continuing 2019/11/08 11:04:59  DEBUG  Initializing enrollment signer 2019/11/08 11:04:59  DEBUG  validating configuration 2019/11/08 11:04:59  DEBUG  validate local profile 2019/11/08 11:04:59  DEBUG  profile is valid 2019/11/08 11:04:59  DEBUG  validate local profile 2019/11/08 11:04:59  DEBUG  profile is valid 2019/11/08 11:04:59  DEBUG  validate local profile 2019/11/08 11:04:59  DEBUG  profile is valid 2019/11/08 11:04:59  DEBUG  CA initialization successful 2019/11/08 11:04:59  DEBUG  Initializing Idemix issuer... 2019/11/08 11:04:59  DEBUG  Returning without initializing Idemix issuer for CA 'ica.consigner.lynkit.io' as the database is not initialized 2019/11/08 11:04:59  INFO  Home directory for default CA: /etc/hyperledger/fabric-ca-server 2019/11/08 11:04:59  DEBUG  1 CA instance(s) running on server 2019/11/08 11:04:59  INFO  Operation Server Listening on 127.0.0.1:8443 2019/11/08 11:04:59  DEBUG  TLS is enabled 2019/11/08 11:04:59  DEBUG  Client authentication type requested: NoClientCert 2019/11/08 11:04:59  INFO  Listening on https://0.0.0.0:7054  {code}   ></description> </Issue>
