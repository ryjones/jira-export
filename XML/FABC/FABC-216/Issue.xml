<Issue id="16176" key="FABC-216" number="216" project="10607" reporter="skarim" assignee="skarim" creator="skarim" type="10004" summary="Copy relative paths and deep copy pointers from default CA" priority="2" resolution="10000" status="6" created="2017-05-02 20:42:17.0" updated="2018-07-18 22:03:54.0" resolutiondate="2017-05-12 00:29:56.0" votes="0" watches="2" workflowId="32396"> <description><! CDATA Missing values in configuration of additional CA must be replaced with values from the default CA configuration. If relative paths are specified in the default CA configuration, the same relative paths must copied over to additional CAs if missing before the paths are made absolute.  If absolute paths are specified in the default CA, then the entire absolute path should also be copied over to additional CAs if missing.  Also, need to do a deep copy of any pointers that exist in the default CA. Otherwise, it creates conflicts with additional CAs and values get overwritten.  For example, assume the default CA and one non-default CA (CA1), with two files as follows:  1) fabric-ca-server-config.yaml (for the default CA)  This is the main config file which contains among other things, the following two relative filenames.  keystore: msp/keystore cafiles: cas/ca1/config.yaml  The cafiles property points to the file below.  2) cas/ca1/config.yaml (for CA1)  This is a sparse file which contains the name of the CA but need not contain anything else since it inherits values from the default CA; obviously you can override any of the values that you want.  Consider where CA1 gets its "keystore" value. It should be at "msp/keystore" relative to the "cas/ca1/config.yaml" file. In order to make this work, we are supposed to do the following: a) read CA1's sparse config b) copy the missing values from the default CA's config, doing a deep copy  There are two problems with the current code: 1) Not doing a deep copy, so the keystore wasn't copied because it wasn't at the top level. And a lot of other info was missing of course. This is fixed by  https://gerrit.hyperledger.org/r/#/c/8853  2) The filenames in the default CA's config were being made absolute before the copy rather than after, which meant they pointed to the same path as the default CA.     This also fixes some problems with intermediate CA support.  For example, this fixes the following error when starting an intermediate CA:  Start the root CA as follows: {code:java} # fabric-ca-server start -c root/config.yaml -b a:b -p 7055 2017/05/09 09:24:17  INFO  Created default configuration file at /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/root/config.yaml 2017/05/09 09:24:17  INFO  Starting server in home directory: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/root 2017/05/09 09:24:17  INFO  generating key: &{A:ecdsa S:256} 2017/05/09 09:24:17  INFO  encoded CSR 2017/05/09 09:24:17  INFO  signed certificate with serial number 501629925030367703483356481723098271810642071467 2017/05/09 09:24:17  INFO  The CA key and certificate were generated for CA 2017/05/09 09:24:17  INFO  The key was stored by BCCSP provider 'SW' 2017/05/09 09:24:17  INFO  The certificate is at: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/root/ca-cert.pem 2017/05/09 09:24:17  INFO  Initialized sqlite3 database at /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/root/fabric-ca-server.db 2017/05/09 09:24:17  INFO  Home directory for default CA: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/root 2017/05/09 09:24:17  INFO  Listening at http://0.0.0.0:7055 2017/05/09 09:24:41  INFO  signed certificate with serial number 669469741261274226287810516031688469970869826451 2017/05/09 09:24:41  INFO   ::1 :60832 - "POST /enroll" 200{code}    Attempt to start the intermediate CA as follows: {code:java} # fabric-ca-server start -c intermediate/config.yaml -b c:d -u http://a:b@localhost:7055 2017/05/09 09:18:19  INFO  Created default configuration file at /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate/config.yaml 2017/05/09 09:18:19  INFO  Starting server in home directory: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate 2017/05/09 09:18:19  INFO  CA Home Directory: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate 2017/05/09 09:18:19  INFO  generating key: &{A:ecdsa S:256} 2017/05/09 09:18:19  INFO  encoded CSR 2017/05/09 09:18:19  INFO  The CA key and certificate were generated for CA 2017/05/09 09:18:19  INFO  The key was stored by BCCSP provider 'SW' 2017/05/09 09:18:19  INFO  The certificate is at: /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate/ca-cert.pem 2017/05/09 09:18:19  INFO  Initialized sqlite3 database at /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate/fabric-ca-server.db Error: Could not find the private key in BCCSP keystore nor in keyfile /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate/ca-key.pem: open /Users/keith/go/src/github.com/hyperledger/fabric-ca/bin/intermediate/ca-key.pem: no such file or directory{code}    ></description> </Issue>
