<Issue id="43212" key="FABC-886" number="886" project="10607" reporter="adarshajha" creator="adarshajha" type="10000" summary="How to add postgres as a db in hyperledger fabric-ca using sslmode =verify-ca or verify-full?" priority="1" status="10100" created="2019-11-07 12:48:22.0" updated="2021-11-17 12:24:02.0" votes="0" watches="3" workflowId="56318"> <description><! CDATA I am trying to add postgres as a db in fabric-ca and successfully did it in {{ssl=require}} mode but not able to do using {{ssl=verify-ca}} or verify-full  my docker-compose.yaml file is like this :    {code:java} version: '2'  networks: basic:  services: orderer.lynkit.io: container_name: orderer.lynkit.io image: hyperledger/fabric-orderer:1.4.1 environment: - ORDERER_GENERAL_LOGLEVEL=DEBUG - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/etc/hyperledger/configtx/genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/etc/hyperledger/msp/orderer/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/orderer command: orderer ports: - 7050:7050 volumes: - ./config/:/etc/hyperledger/configtx - ./crypto-config/ordererOrganizations/lynkit.io/orderers/orderer.lynkit.io/:/etc/hyperledger/msp/orderer networks: - basic  pgadmin4: image: dpage/pgadmin4 environment: PGADMIN_DEFAULT_EMAIL: admin@root.com PGADMIN_DEFAULT_PASSWORD: SuperSecret volumes: - ./pgadmin-data:/var/lib/postgresql/data ports: - 80:80 networks: - basic  ica.consigner.lynkit.io: image: hyperledger/fabric-ca:1.4.1 environment: - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=127.0.0.1:8443 - FABRIC_CA_SERVER_DB_TYPE=postgres - FABRIC_CA_SERVER_CSR_CN= ica.consigner.lynkit.io - FABRIC_CA_SERVER_CSR_HOSTS=0.0.0.0 - FABRIC_CA_SERVER_DB_DATASOURCE=host=db-postgres port=5432 user=postgres password=caDbPass12345 dbname=fabriccaserver sslmode=verify-ca  - FABRIC_CA_SERVER_DB_TLS_ENABLED=true - FABRIC_CA_SERVER_DB_TLS_CERTFILES= /tmp/postgresCerts/root.crt  - FABRIC_CA_SERVER_DB_TLS_CLIENT_CERTFILE=/tmp/postgresCerts/server.crt - FABRIC_CA_SERVER_DB_TLS_CLIENT_KEYFILE=/tmp/postgresCerts/server.key    ports: - "7054:7054" command: sh -c 'fabric-ca-server start -b admin:adminpw -d'  volumes: - ./crypto-config/peerOrganizations/consigner.lynkit.io/ca/:/etc/hyperledger/fabric-ca-server-config - ./ca-config/:/etc/hyperledger/fabric-ca-server # - ./ca-config/ssl/postgres:/etc/hyperledger/fabric-ca-server/ssl - /home/adarsha/postgresCerts:/tmp/postgresCerts  container_name: ica.consigner.lynkit.io networks: - basic  depends_on: - db-postgres  db-postgres: container_name: db-postgres # network_mode: "host" image: postgres:latest environment: - POSTGRES_PASSWORD=caDbPass12345 - POSTGRES_USER=postgres - POSTGRES_DB=fabriccaserver volumes: - ./postgres-test-data:/var/lib/postgresql/data ports: - 5432:5432 networks: - basic  {code}  here is my postgresql.conf file :    {code:java}  # - SSL -  ssl = on ssl_ca_file = 'root.crt' ssl_cert_file = 'server.crt' #ssl_crl_file = '' ssl_key_file = 'server.key' #ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL' # allowed SSL ciphers #ssl_prefer_server_ciphers = on #ssl_ecdh_curve = 'prime256v1' {code}  and here is my pg_hba.conf file   {code:java} # CAUTION: Configuring the system for local "trust" authentication # allows any local user to connect as any PostgreSQL user, including # the database superuser.  If you do not trust all your local users, # use another authentication method.   # TYPE  DATABASE        USER            ADDRESS                 METHOD  # "local" is for Unix domain socket connections only local   all             all                                     trust # IPv4 local connections: host    all             all             127.0.0.1/32            trust # IPv6 local connections: host    all             all             ::1/128                 trust # Allow replication connections from localhost, by a user with the # replication privilege. local   replication     all                                     trust host    replication     all             127.0.0.1/32            trust host    replication     all             ::1/128                 trust   hostssl all all all md5    {code}  and this is how i am generating my certificates for postgres :    {code:java}  openssl req -new -nodes -text -out root.csr -keyout root.key -subj "/CN=ica.consigner.lynkit.io" chmod og-rwx root.key openssl x509 -req -in root.csr -text -days 3650 -extfile /etc/ssl/openssl.cnf -extensions v3_ca -signkey root.key -out root.crt openssl req -new -nodes -text -out server.csr -keyout server.key -subj "/CN=db-postgres" chmod og-rwx server.key openssl x509 -req -in server.csr -text -days 365 -CA root.crt -CAkey root.key -CAcreateserial -out server.crt  {code}  my CA logs are :   {code:java} docker logs ica.consigner.lynkit.io  2019/11/07 10:08:09  DEBUG  Home directory: /etc/hyperledger/fabric-ca-server 2019/11/07 10:08:09  INFO  Configuration file location: /etc/hyperledger/fabric-ca-server/fabric-ca-server-config.yaml 2019/11/07 10:08:09  INFO  Starting server in home directory: /etc/hyperledger/fabric-ca-server 2019/11/07 10:08:09  WARNING  Unknown provider type: ; metrics disabled 2019/11/07 10:08:09  DEBUG  Set log level:  2019/11/07 10:08:09  INFO  Server Version: 1.4.1 2019/11/07 10:08:09  INFO  Server Levels: &{Identity:2 Affiliation:1 Certificate:1 Credential:1 RAInfo:1 Nonce:1} 2019/11/07 10:08:09  DEBUG  Making server filenames absolute 2019/11/07 10:08:09  DEBUG  Initializing default CA in directory /etc/hyperledger/fabric-ca-server 2019/11/07 10:08:09  DEBUG  Init CA with home /etc/hyperledger/fabric-ca-server and config {Version:1.4.0-stable Cfg:{Identities:{PasswordAttempts:10 AllowRemove:false} Affiliations:{AllowRemove:false}} CA:{Name:ica.consigner.lynkit.io Keyfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem Certfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem Chainfile:/etc/hyperledger/fabric-ca-server-config/chain.consigner.lynkit.io.crt.pem} Signing:0xc0003cd720 CSR:{CN: ica.consigner.lynkit.io Names: {C:US ST:North Carolina L: O:Hyperledger OU:Fabric SerialNumber:}  Hosts: 0.0.0.0  KeyRequest:0xc0003e8360 CA:0xc0003e83e0 SerialNumber:} Registry:{MaxEnrollments:-1 Identities: { Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:0 Attrs:map hf.Registrar.Attributes:* hf.AffiliationMgr:1 hf.Registrar.Roles:* hf.Registrar.DelegateRoles:* hf.Revoker:1 hf.IntermediateCA:1 hf.GenCRL:1   } } Affiliations:map consigner: department1 department2   LDAP:{ Enabled:false URL:ldap://****:****@<host>:<port>/<base> UserFilter:(uid=%s) GroupFilter:(memberUid=%s) Attribute:{ uid member   { }  map groups: { }  } TLS:{false    { }}  } DB:{ Type:postgres ****user=**** password=**** dbname=fabriccaserver sslmode=verify-ca TLS:{false   /tmp/postgresCerts/root.crt   {/tmp/postgresCerts/server.key /tmp/postgresCerts/server.crt}}  } CSP:0xc0003e8660 Client:<nil> Intermediate:{ParentServer:{ URL: CAName:  } TLS:{Enabled:false CertFiles:   Client:{KeyFile: CertFile:}} Enrollment:{ Name: Secret:**** CAName: AttrReqs:   Profile: Label: CSR:<nil> Type:x509  }} CRL:{Expiry:24h0m0s} Idemix:{IssuerPublicKeyfile: IssuerSecretKeyfile: RevocationPublicKeyfile: RevocationPrivateKeyfile: RHPoolSize:100 NonceExpiration:15s NonceSweepInterval:15m}} 2019/11/07 10:08:09  DEBUG  CA Home Directory: /etc/hyperledger/fabric-ca-server 2019/11/07 10:08:09  DEBUG  Checking configuration file version '1.4.0-stable' against server version: '1.4.1' 2019/11/07 10:08:09  DEBUG  Initializing BCCSP: &{ProviderName:SW SwOpts:0xc00022d400 PluginOpts:<nil>} 2019/11/07 10:08:09  DEBUG  Initializing BCCSP with software options &{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:0xc0003ea470 DummyKeystore:<nil> InmemKeystore:<nil>} 2019/11/07 10:08:09  DEBUG  Initialize key material 2019/11/07 10:08:09  DEBUG  Making CA filenames absolute 2019/11/07 10:08:09  INFO  The CA key and certificate files already exist 2019/11/07 10:08:09  INFO  Key file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem 2019/11/07 10:08:09  INFO  Certificate file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem 2019/11/07 10:08:09  DEBUG  Validating the CA certificate and key 2019/11/07 10:08:09  DEBUG  Check CA certificate for valid dates 2019/11/07 10:08:09  DEBUG  Check CA certificate for valid usages 2019/11/07 10:08:09  DEBUG  Check CA certificate for valid IsCA value 2019/11/07 10:08:09  DEBUG  Check that key type is supported 2019/11/07 10:08:09  DEBUG  Check that key size is of appropriate length 2019/11/07 10:08:09  DEBUG  Check that public key and private key match 2019/11/07 10:08:09  DEBUG  Validation of CA certificate and key successful 2019/11/07 10:08:09  DEBUG  Loading CN from existing enrollment information 2019/11/07 10:08:09  DEBUG  Initializing DB 2019/11/07 10:08:09  DEBUG  Initializing 'postgres' database at 'host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-ca' 2019/11/07 10:08:09  DEBUG  Using postgres database, connecting to database... 2019/11/07 10:08:09  DEBUG  Database Name: fabriccaserver 2019/11/07 10:08:09  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-ca 2019/11/07 10:08:09  WARNING  Failed to connect to database 'fabriccaserver' 2019/11/07 10:08:09  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=postgres sslmode=verify-ca 2019/11/07 10:08:09  WARNING  Failed to connect to database 'postgres' 2019/11/07 10:08:09  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=template1 sslmode=verify-ca 2019/11/07 10:08:09  WARNING  Failed to connect to database 'template1' 2019/11/07 10:08:09  ERROR  Error occurred initializing database: Failed to connect to Postgres database. Postgres requires connecting to a specific database, the following databases were tried:  fabriccaserver postgres template1 . Please create one of these database before continuing 2019/11/07 10:08:09  DEBUG  Initializing enrollment signer 2019/11/07 10:08:09  DEBUG  validating configuration 2019/11/07 10:08:09  DEBUG  validate local profile 2019/11/07 10:08:09  DEBUG  profile is valid 2019/11/07 10:08:09  DEBUG  validate local profile 2019/11/07 10:08:09  DEBUG  profile is valid 2019/11/07 10:08:09  DEBUG  validate local profile 2019/11/07 10:08:09  DEBUG  profile is valid 2019/11/07 10:08:09  DEBUG  CA initialization successful 2019/11/07 10:08:09  DEBUG  Initializing Idemix issuer... 2019/11/07 10:08:09  DEBUG  Returning without initializing Idemix issuer for CA 'ica.consigner.lynkit.io' as the database is not initialized 2019/11/07 10:08:09  INFO  Home directory for default CA: /etc/hyperledger/fabric-ca-server 2019/11/07 10:08:09  DEBUG  1 CA instance(s) running on server 2019/11/07 10:08:09  INFO  Operation Server Listening on 127.0.0.1:8443 2019/11/07 10:08:09  INFO  Listening on http://0.0.0.0:7054  {code} and my db-postgres logs are :   {code:java} docker logs db-postgres  2019-11-08 06:55:52.181 UTC  1  LOG:  starting PostgreSQL 12.0 (Debian 12.0-2.pgdg100+1) on x86_64-pc-linux-gnu, compiled by gcc (Debian 8.3.0-6) 8.3.0, 64-bit 2019-11-08 06:55:52.181 UTC  1  LOG:  listening on IPv4 address "0.0.0.0", port 5432 2019-11-08 06:55:52.181 UTC  1  LOG:  listening on IPv6 address "::", port 5432 2019-11-08 06:55:52.630 UTC  1  LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432" 2019-11-08 06:55:53.110 UTC  24  LOG:  database system was interrupted; last known up at 2019-11-08 06:54:10 UTC 2019-11-08 06:55:57.621 UTC  24  LOG:  database system was not properly shut down; automatic recovery in progress 2019-11-08 06:55:57.835 UTC  24  LOG:  redo starts at 0/1689558 2019-11-08 06:55:57.835 UTC  24  LOG:  invalid record length at 0/1689590: wanted 24, got 0 2019-11-08 06:55:57.835 UTC  24  LOG:  redo done at 0/1689558 2019-11-08 06:55:58.605 UTC  1  LOG:  database system is ready to accept connections 2019-11-08 06:55:58.633 UTC  25  LOG:  could not accept SSL connection: certificate verify failed 2019-11-08 06:55:58.732 UTC  32  LOG:  could not accept SSL connection: certificate verify failed 2019-11-08 06:55:58.736 UTC  33  LOG:  could not accept SSL connection: certificate verify failed  {code}  and when i add sslmode=verify-ca then my CA logs are :   {code:java} docker logs ica.consigner.lynkit.io  2019/11/08 07:08:49  DEBUG  Home directory: /etc/hyperledger/fabric-ca-server 2019/11/08 07:08:49  INFO  Configuration file location: /etc/hyperledger/fabric-ca-server/fabric-ca-server-config.yaml 2019/11/08 07:08:49  INFO  Starting server in home directory: /etc/hyperledger/fabric-ca-server 2019/11/08 07:08:49  WARNING  Unknown provider type: ; metrics disabled 2019/11/08 07:08:49  DEBUG  Set log level:  2019/11/08 07:08:49  INFO  Server Version: 1.4.1 2019/11/08 07:08:49  INFO  Server Levels: &{Identity:2 Affiliation:1 Certificate:1 Credential:1 RAInfo:1 Nonce:1} 2019/11/08 07:08:49  DEBUG  Making server filenames absolute 2019/11/08 07:08:49  DEBUG  Initializing default CA in directory /etc/hyperledger/fabric-ca-server 2019/11/08 07:08:49  DEBUG  Init CA with home /etc/hyperledger/fabric-ca-server and config {Version:1.4.0-stable Cfg:{Identities:{PasswordAttempts:10 AllowRemove:false} Affiliations:{AllowRemove:false}} CA:{Name:ica.consigner.lynkit.io Keyfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem Certfile:/etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem Chainfile:/etc/hyperledger/fabric-ca-server-config/chain.consigner.lynkit.io.crt.pem} Signing:0xc0002ee8f0 CSR:{CN: ica.consigner.lynkit.io Names: {C:US ST:North Carolina L: O:Hyperledger OU:Fabric SerialNumber:}  Hosts: 0.0.0.0  KeyRequest:0xc00000c980 CA:0xc00000c700 SerialNumber:} Registry:{MaxEnrollments:-1 Identities: { Name:**** Pass:**** Type:client Affiliation: MaxEnrollments:0 Attrs:map hf.IntermediateCA:1 hf.GenCRL:1 hf.Registrar.Attributes:* hf.AffiliationMgr:1 hf.Registrar.Roles:* hf.Registrar.DelegateRoles:* hf.Revoker:1   } } Affiliations:map consigner: department1 department2   LDAP:{ Enabled:false URL:ldap://****:****@<host>:<port>/<base> UserFilter:(uid=%s) GroupFilter:(memberUid=%s) Attribute:{ uid member   { }  map groups: { }  } TLS:{false    { }}  } DB:{ Type:postgres ****user=**** password=**** dbname=fabriccaserver sslmode=verify-full TLS:{true   /tmp/postgresCerts/root.crt   {/tmp/postgresCerts/server.key /tmp/postgresCerts/server.crt}}  } CSP:0xc000494ea0 Client:<nil> Intermediate:{ParentServer:{ URL: CAName:  } TLS:{Enabled:false CertFiles:   Client:{KeyFile: CertFile:}} Enrollment:{ Name: Secret:**** CAName: AttrReqs:   Profile: Label: CSR:<nil> Type:x509  }} CRL:{Expiry:24h0m0s} Idemix:{IssuerPublicKeyfile: IssuerSecretKeyfile: RevocationPublicKeyfile: RevocationPrivateKeyfile: RHPoolSize:100 NonceExpiration:15s NonceSweepInterval:15m}} 2019/11/08 07:08:49  DEBUG  CA Home Directory: /etc/hyperledger/fabric-ca-server 2019/11/08 07:08:49  DEBUG  Checking configuration file version '1.4.0-stable' against server version: '1.4.1' 2019/11/08 07:08:49  DEBUG  Initializing BCCSP: &{ProviderName:SW SwOpts:0xc000040200 PluginOpts:<nil>} 2019/11/08 07:08:49  DEBUG  Initializing BCCSP with software options &{SecLevel:256 HashFamily:SHA2 Ephemeral:false FileKeystore:0xc000515c30 DummyKeystore:<nil> InmemKeystore:<nil>} 2019/11/08 07:08:49  DEBUG  Initialize key material 2019/11/08 07:08:49  DEBUG  Making CA filenames absolute 2019/11/08 07:08:49  INFO  The CA key and certificate files already exist 2019/11/08 07:08:49  INFO  Key file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem 2019/11/08 07:08:49  INFO  Certificate file location: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem 2019/11/08 07:08:49  DEBUG  Validating the CA certificate and key 2019/11/08 07:08:49  DEBUG  Check CA certificate for valid dates 2019/11/08 07:08:49  DEBUG  Check CA certificate for valid usages 2019/11/08 07:08:49  DEBUG  Check CA certificate for valid IsCA value 2019/11/08 07:08:49  DEBUG  Check that key type is supported 2019/11/08 07:08:49  DEBUG  Check that key size is of appropriate length 2019/11/08 07:08:49  DEBUG  Check that public key and private key match 2019/11/08 07:08:49  DEBUG  Validation of CA certificate and key successful 2019/11/08 07:08:49  DEBUG  Loading CN from existing enrollment information 2019/11/08 07:08:49  DEBUG  Initializing DB 2019/11/08 07:08:49  DEBUG  Initializing 'postgres' database at 'host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-full' 2019/11/08 07:08:49  DEBUG  Using postgres database, connecting to database... 2019/11/08 07:08:49  DEBUG  Database Name: fabriccaserver 2019/11/08 07:08:49  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=fabriccaserver sslmode=verify-full sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 07:08:49  WARNING  Failed to connect to database 'fabriccaserver' 2019/11/08 07:08:49  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=postgres sslmode=verify-full sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 07:08:49  WARNING  Failed to connect to database 'postgres' 2019/11/08 07:08:49  DEBUG  Connecting to PostgreSQL server, using connection string: host=db-postgres port=5432 user=**** password=**** dbname=template1 sslmode=verify-full sslrootcert=/tmp/postgresCerts/root.crt sslcert=/tmp/postgresCerts/server.crt sslkey=/tmp/postgresCerts/server.key 2019/11/08 07:08:49  WARNING  Failed to connect to database 'template1' 2019/11/08 07:08:49  ERROR  Error occurred initializing database: Failed to connect to Postgres database. Postgres requires connecting to a specific database, the following databases were tried:  fabriccaserver postgres template1 . Please create one of these database before continuing 2019/11/08 07:08:49  DEBUG  Initializing enrollment signer 2019/11/08 07:08:49  DEBUG  validating configuration 2019/11/08 07:08:49  DEBUG  validate local profile 2019/11/08 07:08:49  DEBUG  profile is valid 2019/11/08 07:08:49  DEBUG  validate local profile 2019/11/08 07:08:49  DEBUG  profile is valid 2019/11/08 07:08:49  DEBUG  validate local profile 2019/11/08 07:08:49  DEBUG  profile is valid 2019/11/08 07:08:49  DEBUG  CA initialization successful 2019/11/08 07:08:49  DEBUG  Initializing Idemix issuer... 2019/11/08 07:08:49  DEBUG  Returning without initializing Idemix issuer for CA 'ica.consigner.lynkit.io' as the database is not initialized 2019/11/08 07:08:49  INFO  Home directory for default CA: /etc/hyperledger/fabric-ca-server 2019/11/08 07:08:49  DEBUG  1 CA instance(s) running on server 2019/11/08 07:08:49  INFO  Operation Server Listening on 127.0.0.1:8443 2019/11/08 07:08:49  DEBUG  TLS is enabled 2019/11/08 07:08:49  DEBUG  TLS Certificate: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.crt.pem, TLS Key: /etc/hyperledger/fabric-ca-server-config/ica.consigner.lynkit.io.key.pem 2019/11/08 07:08:49  DEBUG  Client authentication type requested: NoClientCert 2019/11/08 07:08:49  INFO  Listening on https://0.0.0.0:7054  {code}    ></description> </Issue>
