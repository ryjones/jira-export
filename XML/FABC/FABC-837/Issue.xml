<Issue id="39266" key="FABC-837" number="837" project="10607" reporter="nyet" assignee="mastersingh24" creator="nyet" type="10004" summary="Metrics provider(s) and --cafiles is incompatible" priority="3" resolution="10000" status="6" created="2019-04-11 23:32:20.0" updated="2019-06-15 09:34:23.0" resolutiondate="2019-06-11 14:14:43.0" votes="1" watches="3" workflowId="52143"> <description><! CDATA When setting both {{FABRIC_CA_SERVER_METRICS_PROVIDER=prometheus}} via env and specifying {{--cafiles}} on the command line, the server panics with {code} panic: duplicate metrics collector registration attempted goroutine 1  running : github.com/hyperledger/fabric-ca/vendor/github.com/prometheus/client_golang/prometheus.(*Registry).MustRegister(0xc0000bc7d0, 0xc00054faa0, 0x1, 0x1) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/prometheus/client_golang/prometheus/registry.go:391 +0xad github.com/hyperledger/fabric-ca/vendor/github.com/prometheus/client_golang/prometheus.MustRegister(0xc00054faa0, 0x1, 0x1) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/prometheus/client_golang/prometheus/registry.go:176 +0x53 github.com/hyperledger/fabric-ca/vendor/github.com/go-kit/kit/metrics/prometheus.NewCounterFrom(0xde0693, 0xe, 0x0, 0x0, 0xdd9146, 0x5, 0xdfd4f6, 0x29, 0x0, 0x16454c0, ...) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/go-kit/kit/metrics/prometheus/prometheus.go:24 +0xe3 github.com/hyperledger/fabric-ca/vendor/github.com/hyperledger/fabric/common/metrics/prometheus.(*Provider).NewCounter(0x16bbbe0, 0xde0693, 0xe, 0x0, 0x0, 0xdd9146, 0x5, 0xdfd4f6, 0x29, 0x16454c0, ...) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/hyperledger/fabric/common/metrics/prometheus/provider.go:20 +0x138 github.com/hyperledger/fabric-ca/lib/server/db.New(0xee2b80, 0xc00012faa0, 0xc0000380a9, 0xc, 0x7f3a19c72630, 0xc000032180, 0x0) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/server/db/db.go:94 +0x74 github.com/hyperledger/fabric-ca/lib/server/db/sqlite.(*Sqlite).Connect(0xc0000bcdc0, 0x7, 0xc00050fdd0) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/server/db/sqlite/sqlite.go:59 +0x14a github.com/hyperledger/fabric-ca/lib.(*CA).initDB(0xc00034e078, 0x0, 0x0) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/ca.go:603 +0x47c github.com/hyperledger/fabric-ca/lib.(*CA).init(0xc00034e078, 0x0, 0x14, 0x7a5f466) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/ca.go:173 +0x1be github.com/hyperledger/fabric-ca/lib.initCA(0xc00034e078, 0xc00003a240, 0x1b, 0xc0000180a8, 0xc00034e000, 0x0, 0xda3280, 0x4) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/ca.go:136 +0x8e github.com/hyperledger/fabric-ca/lib.(*Server).initDefaultCA(0xc00034e000, 0x0, 0x0, 0x1) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/server.go:366 +0xd3 github.com/hyperledger/fabric-ca/lib.(*Server).init(0xc00034e000, 0x0, 0xc000259c20, 0x1) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/server.go:132 +0x2e3 github.com/hyperledger/fabric-ca/lib.(*Server).Start(0xc00034e000, 0xc00034e000, 0x4) /opt/gopath/src/github.com/hyperledger/fabric-ca/lib/server.go:166 +0xdd main.(*ServerCmd).init.func3(0xc0000cafc0, 0xc000216280, 0x0, 0x5, 0x0, 0x0) /opt/gopath/src/github.com/hyperledger/fabric-ca/cmd/fabric-ca-server/servercmd.go:121 +0xe8 github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra.(*Command).execute(0xc0000cafc0, 0xc000216230, 0x5, 0x5, 0xc0000cafc0, 0xc000216230) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra/command.go:643 +0x3e8 github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra.(*Command).ExecuteC(0xc0000ca6c0, 0xcba240, 0xecd830, 0xc0003ebf08) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra/command.go:734 +0x2cc github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra.(*Command).Execute(0xc0000ca6c0, 0xc000142000, 0xc0002160f0) /opt/gopath/src/github.com/hyperledger/fabric-ca/vendor/github.com/spf13/cobra/command.go:692 +0x2b main.(*ServerCmd).Execute(0xc0002160f0, 0x5, 0xda3201) /opt/gopath/src/github.com/hyperledger/fabric-ca/cmd/fabric-ca-server/servercmd.go:69 +0x2f main.RunMain(0xc0000ba000, 0x7, 0x7, 0xc0003ebf88, 0xc000094058) /opt/gopath/src/github.com/hyperledger/fabric-ca/cmd/fabric-ca-server/main.go:45 +0xaf main.main() /opt/gopath/src/github.com/hyperledger/fabric-ca/cmd/fabric-ca-server/main.go:27 +0x45 {code}  Attempting to enable metrics in only one config file with {code} metrics: provider: prometheus {code} in one file and  {code} metrics: provider: disabled {code} in the other(s) does not help (which is expected, since the environment variable should override both)  ></description> </Issue>
