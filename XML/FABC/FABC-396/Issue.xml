<Issue id="24834" key="FABC-396" number="396" project="10607" reporter="nishi" assignee="tsrb" creator="nishi" type="10004" summary="Fabric-Ca : Max Enrollments number not accounted for a user during enrollment" priority="2" resolution="10000" status="6" created="2017-12-06 21:14:15.0" updated="2018-07-18 22:04:32.0" resolutiondate="2018-01-05 22:51:00.0" votes="0" watches="2" workflowId="32576"> <description><! CDATA Fabric-CA commit level: * d365e506186e6291f2a0b0512360462bad4bc4b0*  Steps to Reproduce:  -----------------------  1. Set maxenrollments to 4 while registering a user {code:java} FABRIC_CA_CLIENT_HOME=~/hyperledger/fabric-ca/clients/admin fabric-ca-client register --id.maxenrollments 4 --id.name userTest --id.secret userTestpw --id.affiliation org1.department1 --id.type user {code} 2. Now try to enroll user 5 times {code:java} FABRIC_CA_CLIENT_HOME=~/hyperledger/fabric-ca/clients/userTest fabric-ca-client enroll -u http://userTest:userTestpw@localhost:7054{code} Expected Result:  fabric-ca-client to report an error that user has reached his maxenrollments  Actual Result:  Enrollment succeeds even for a 5th attempt and for subsequent enrolments.  Message during enrollment:  -------------------------------------- {code:java} 2017/12/06 20:58:51  DEBUG  DB: Getting identity userTest200 2017/12/06 20:58:51  DEBUG  DB: Login user userTest200 with max enrollments of 3 and state of 3 2017/12/06 20:58:51  DEBUG  Max enrollment value (3) of identity is greater than allowed by CA, using CA max enrollment value of -1 2017/12/06 20:58:51  DEBUG  DB: identity userTest200 successfully logged in 2017/12/06 20:58:51  DEBUG  Processing sign request: id=userTest200, CommonName=userTest200, Subject=<nil> 2017/12/06 20:58:51  DEBUG  Checking CSR fields to make sure that they do not exceed maximum character limits 2017/12/06 20:58:51  DEBUG  DB: Getting identity userTest200 2017/12/06 20:58:51  DEBUG  Finished processing sign request 2017/12/06 20:58:51  DEBUG  DB: Getting identity userTest200 2017/12/06 20:58:51  INFO  signed certificate with serial number 196990544392883754706432797384407312383469496202 2017/12/06 20:58:51  DEBUG  DB: Insert Certificate 2017/12/06 20:58:51  DEBUG  Saved serial number as hex 22815c8c3f83cae29aee7ab5ab2defdb9771278a 2017/12/06 20:58:51  DEBUG  saved certificate with serial number 196990544392883754706432797384407312383469496202 2017/12/06 20:58:51  DEBUG  Successfully incremented state for identity userTest200 to 4 2017/12/06 20:58:51  INFO  127.0.0.1:58430 POST /enroll 201 0 "OK" 2017/12/06 20:58:51  INFO  Stored client certificate at /root/hyperledger/fabric-ca/clients/userTest200/msp/signcerts/cert.pem 2017/12/06 20:58:51  INFO  Stored root CA certificate at /root/hyperledger/fabric-ca/clients/userTest200/msp/cacerts/localhost-7054.pem 2017/12/06 20:58:51  INFO  Stored intermediate CA certificates at /root/hyperledger/fabric-ca/clients/userTest200/msp/intermediatecerts/localhost-7054.pem {code}  ></description> </Issue>
