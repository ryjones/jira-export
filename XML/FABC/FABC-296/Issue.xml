<Issue id="16009" key="FABC-296" number="296" project="10607" reporter="rennman" assignee="smithbk" creator="rennman" type="10004" summary="fabric-ca-server ldap should supersede registry configuration" priority="3" resolution="10000" status="6" created="2017-04-25 21:10:52.0" updated="2018-07-18 22:04:11.0" resolutiondate="2017-06-06 20:20:26.0" votes="0" watches="2" workflowId="32476"> <description><! CDATA The LDAP server should obviate the need for the registry entry. The enablement of LDAP should disable the local registry. Moreover, it can cause the server to crash unexpectedly at startup, and without warning.  There is an entire class of errors that could cause this to happen.  e.g., presuming the ldap server is non-responsive, and the config is as follows: {code:java} ldap: enabled: true url: ldap://CN=admin@localhost:389/dc=example,dc=com registry: identities: - name: admin - pass: adminpw {code} and the ldap server is down for some reason. We attempt to retrieve the userid: 2017/04/25 21:07:42  DEBUG  Loading identity 'admin' 2017/04/25 21:07:42  DEBUG  Getting user 'admin' 2017/04/25 21:07:42  DEBUG  Connecting to LDAP server over TCP  and then exit without ever logging the error. If debugging is disabled, it is even more cryptic: {code:java} 2017/04/25 21:04:05  INFO  Configuration file location: /tmp/fabric-ca/runFabricCaFvt.yaml 2017/04/25 21:04:05 Initialize BCCSP  SW  2017/04/25 21:04:05  INFO  The CA key and certificate files already exist 2017/04/25 21:04:05  INFO  Key file location: /tmp/fabric-ca/fabric-ca-key.pem 2017/04/25 21:04:05  INFO  Certificate file location: /tmp/fabric-ca/fabric-ca-cert.pem {code} There's no indication of an error, but the server never starts.     ------------------------------------------------ Fixes include the following changes ------------------------------------------------  1) Do not try to load users into the DB when LDAP is enabled.  2) Don't require the -b option when LDAP is enabled.  Specifically, changes are as follows:  a) cmd/fabric-ca-server/config.go Added some comments (per Yang's request). Require the '--boot' option only if LDAP is disabled.  b) cmd/fabric-ca-server/main.go Change server usage message to denote that "--boot" is required only if ldap.enabled is false.  c) cmd/fabric-ca-server/main_test.go Added test case  d) doc/source/users-guide.rst Updated doc to indicate that "-b" (or "--boot") is required only if ldap.enabled is false.  e) lib/ca.go Load the user's table into the DB only if LDAP is disabled.  f) lib/client_test.go Remove test directories that weren't being cleaned up.  ></description> </Issue>
